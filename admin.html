<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <!-- Sentry éŒ¯èª¤ç›£æ§ SDK -->
  <script src="https://browser.sentry-cdn.com/7.100.0/bundle.min.js" crossorigin="anonymous"></script>
  <title>NFC åç‰‡ç®¡ç†å¾Œå°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="styles.css?v=20260105">
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#22c55e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="æ•¸ä½èº«åˆ†">
  <link rel="apple-touch-icon" href="icon-192.svg">
  <style>
    body { padding: 20px; max-width: 1200px; margin: 0 auto; background: #111; color: #fff; }
    h1 { color: var(--uvaco-green); margin-bottom: 30px; }
    .toolbar { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .toolbar-actions { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input[type="text"] { padding: 10px; border-radius: 8px; border: 1px solid #444; background: #222; color: #fff; width: 100%; box-sizing: border-box; }
    
    .table-wrap{width:100%;overflow:auto;-webkit-overflow-scrolling:touch;border-radius:12px}
    table { width: 100%; min-width: 860px; border-collapse: collapse; background: #222; border-radius: 12px; overflow: hidden; }
    th, td { padding: 15px; text-align: left; border-bottom: 1px solid #333; vertical-align: top; }
    th { background: #333; color: #aaa; font-weight: normal; }
    tr:hover { background: #2a2a2a; }
    
    .btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; margin-right: 5px; white-space: nowrap; width: auto; }
    .btn-green { background: var(--uvaco-green); color: #fff; }
    .btn-outline { background: transparent; border: 1px solid #555; color: #ccc; }

    /* é•·ç¶²å€ä¸è¦æ’çˆ†ç‰ˆé¢ */
    .nfc-url-cell a{color:#9ca3af;text-decoration:none;word-break:break-all;overflow-wrap:anywhere}
    .actions-cell{white-space:normal}
    .actions-cell .actions-wrap{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end}

    /* å°è¢å¹•ï¼šè¡¨æ ¼è½‰å¡ç‰‡åˆ—è¡¨ï¼ˆUXï¼šé¿å…è¶…å‡ºç•«é¢ã€æ¬„åç›´æ’ï¼‰
       æ³¨æ„ï¼šåŒæ™‚æä¾› media query èˆ‡ body classï¼ˆadmin-narrowï¼‰ï¼Œé¿å…æŸäº›ç’°å¢ƒ media query æ²’åƒåˆ° */
    @media (max-width: 900px){
      body{padding:14px}
      table{min-width:0}
      #userTable thead{display:none !important}
      #userTable tbody{display:block}
      #userTable tbody tr{display:block;background:#1f1f1f;border:1px solid #2b2b2b;border-radius:14px;padding:12px;margin:12px 0}
      #userTable tbody td{display:flex !important;gap:10px;padding:8px 0;border:none;align-items:flex-start}
      #userTable tbody td::before{content:attr(data-label);flex:0 0 86px;color:#9ca3af;font-size:12px;font-weight:700;letter-spacing:.08em}
      #userTable tbody td.actions-cell{display:block !important}
      #userTable tbody td.actions-cell::before{content:'';display:none}
      #userTable tbody td.actions-cell .actions-wrap{justify-content:flex-start}
    }
    body.admin-narrow{padding:14px}
    body.admin-narrow table{min-width:0}
    body.admin-narrow #userTable thead{display:none !important}
    body.admin-narrow #userTable tbody{display:block}
    body.admin-narrow #userTable tbody tr{display:block;background:#1f1f1f;border:1px solid #2b2b2b;border-radius:14px;padding:12px;margin:12px 0}
    body.admin-narrow #userTable tbody td{display:flex !important;gap:10px;padding:8px 0;border:none;align-items:flex-start}
    body.admin-narrow #userTable tbody td::before{content:attr(data-label);flex:0 0 86px;color:#9ca3af;font-size:12px;font-weight:700;letter-spacing:.08em}
    body.admin-narrow #userTable tbody td.actions-cell{display:block !important}
    body.admin-narrow #userTable tbody td.actions-cell::before{content:'';display:none}
    body.admin-narrow #userTable tbody td.actions-cell .actions-wrap{justify-content:flex-start}
    
    .qr-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index:999; }
    .qr-box { background:#fff; padding:30px; border-radius:16px; text-align:center; color:#000; }
    #qrImage { width: 250px; height: 250px; margin: 20px 0; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="cloud.js?v=20260107"></script>
</head>
<body>

<h1>NFC åç‰‡é‡ç”¢ç®¡ç†</h1>

<div class="toolbar">
  <div class="toolbar-actions">
    <button class="btn btn-green" onclick="reloadData()">é‡æ–°æ•´ç†</button>
    <button class="btn btn-outline" onclick="location.href='directory.html'">è¿”å›é€šè¨ŠéŒ„</button>
    <button class="btn btn-outline" onclick="location.href='settings.html'">å‰å¾€è¨­å®š</button>
    <button class="btn btn-outline" id="companyAdminBtn" onclick="location.href='company-admin.html'" style="display:none;">âš™ï¸ ç®¡ç†ä¼æ¥­ç®¡ç†å“¡</button>
    <button class="btn btn-outline" id="subscriptionAdminBtn" onclick="toggleSubscriptionView()" style="display:none;">ğŸ’ è¨‚é–±ç®¡ç†</button>
  </div>
  <input type="text" id="searchInput" placeholder="æœå°‹å§“åã€å…¬å¸..." onkeyup="filterTable()">
</div>

<div id="adminHint" style="margin:10px 0 18px;color:#aaa;font-size:13px"></div>

<div class="table-wrap">
<table id="userTable">
  <thead>
    <tr>
      <th>å§“å</th>
      <th>å…¬å¸/è·ç¨±</th>
      <th>NFC å¡ç‰‡ ID</th>
      <th>æ›´æ–°æ™‚é–“</th>
      <th>NFC ç¶²å€</th>
      <th>æ“ä½œ</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="6" style="text-align:center">è¼‰å…¥ä¸­...</td></tr>
  </tbody>
</table>
</div>

<!-- Super Adminï¼šç®¡ç†å“¡ç®¡ç† -->
<div id="adminMgmt" style="display:none;margin-top:26px;background:#1b1b1b;border:1px solid #2b2b2b;border-radius:12px;padding:16px">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px">
    <div style="font-size:16px;color:var(--uvaco-green);font-weight:700">ç®¡ç†å“¡ç®¡ç†ï¼ˆè¶…ç´šç®¡ç†å“¡ï¼‰</div>
    <button class="btn btn-outline" onclick="loadAdmins()">é‡æ–°æ•´ç†ç®¡ç†å“¡åˆ—è¡¨</button>
  </div>

  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px">
    <input type="text" id="adminUserIdInput" placeholder="User ID (uuid)" style="flex:2;min-width:280px">
    <input type="text" id="adminCompanyInput" placeholder="ç®¡ç†å…¬å¸ï¼ˆç•™ç©ºï¼è¶…ç´šç®¡ç†å“¡ï¼‰" style="flex:1;min-width:220px">
    <button class="btn btn-green" onclick="saveAdminUser()">æ–°å¢/æ›´æ–°</button>
    <button class="btn btn-outline" onclick="removeAdminUser()">ç§»é™¤</button>
  </div>

  <div class="table-wrap">
  <table id="adminTable" style="width:100%;border-collapse:collapse;background:#222;border-radius:12px;overflow:hidden;min-width:520px">
    <thead>
      <tr>
        <th style="background:#333;color:#aaa;font-weight:normal;padding:12px;border-bottom:1px solid #333">User ID</th>
        <th style="background:#333;color:#aaa;font-weight:normal;padding:12px;border-bottom:1px solid #333">managed_company</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="2" style="padding:12px;text-align:center;color:#888">è¼‰å…¥ä¸­...</td></tr>
    </tbody>
  </table>
  </div>
</div>

<div id="qrModal" class="qr-modal" onclick="this.style.display='none'">
  <div class="qr-box" onclick="event.stopPropagation()">
    <h3 id="qrName"></h3>
    <div id="qrcode"></div>
    <p>è«‹æƒææˆ–æˆªåœ–æä¾›çµ¦å°åˆ·å» </p>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:15px;">
      <button class="btn btn-green" onclick="downloadQR()">ä¸‹è¼‰ QR Code</button>
      <button class="btn btn-outline" onclick="document.getElementById('qrModal').style.display='none'">é—œé–‰</button>
    </div>
  </div>
</div>

<!-- NFC å¡ç‰‡ ID ç·¨è¼¯å½ˆçª— -->
<div id="nfcModal" class="qr-modal" onclick="this.style.display='none'">
  <div class="qr-box" onclick="event.stopPropagation()" style="max-width:400px;">
    <h3 id="nfcModalTitle">ç¶å®š NFC å¡ç‰‡</h3>
    <p style="color:#9ca3af;font-size:13px;margin-bottom:16px;">è¼¸å…¥å¯¦é«” NFC å¡ç‰‡ä¸Šçš„ç·¨è™Ÿï¼Œç”¨æ–¼è­˜åˆ¥æ­¤ç”¨æˆ¶</p>
    <input type="text" id="nfcIdInput" placeholder="ä¾‹å¦‚ï¼šNFC001" style="width:100%;padding:12px;border-radius:8px;border:1px solid #333;background:#1b1b1b;color:#fff;font-family:monospace;font-size:14px;box-sizing:border-box;">
    <input type="hidden" id="nfcTargetUserId">
    <p style="color:#6b7280;font-size:12px;margin-top:12px;">
      NFC å¡ç‰‡é€£çµæ ¼å¼ï¼š<br>
      <code style="color:#22c55e;">card.html?nfc=NFC001</code>
    </p>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:20px;">
      <button class="btn btn-green" onclick="saveNfcId()">å„²å­˜</button>
      <button class="btn btn-outline" onclick="clearNfcId()">æ¸…é™¤ç¶å®š</button>
      <button class="btn btn-outline" onclick="document.getElementById('nfcModal').style.display='none'">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- è¨‚é–±å»¶é•·å½ˆçª— -->
<div id="subscriptionModal" class="qr-modal" onclick="this.style.display='none'">
  <div class="qr-box" onclick="event.stopPropagation()" style="max-width:450px;">
    <h3 id="subModalTitle">å»¶é•·è¨‚é–±</h3>
    <div id="subUserInfo" style="color:#9ca3af;font-size:13px;margin-bottom:16px;"></div>
    
    <div style="margin-bottom:16px;">
      <label style="display:block;color:#9ca3af;font-size:13px;margin-bottom:6px;">å»¶é•·å¤©æ•¸</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn btn-outline" onclick="setExtendDays(30)">30 å¤©</button>
        <button class="btn btn-outline" onclick="setExtendDays(90)">90 å¤©</button>
        <button class="btn btn-outline" onclick="setExtendDays(180)">åŠå¹´</button>
        <button class="btn btn-outline" onclick="setExtendDays(365)">ä¸€å¹´</button>
      </div>
      <input type="number" id="extendDaysInput" placeholder="è‡ªè¨‚å¤©æ•¸" min="1" style="width:100%;padding:12px;border-radius:8px;border:1px solid #333;background:#1b1b1b;color:#fff;font-size:14px;box-sizing:border-box;margin-top:10px;">
    </div>
    
    <div style="margin-bottom:16px;">
      <label style="display:block;color:#9ca3af;font-size:13px;margin-bottom:6px;">å»¶é•·åŸå› ï¼ˆé¸å¡«ï¼‰</label>
      <input type="text" id="extendReasonInput" placeholder="ä¾‹å¦‚ï¼šVIP å®¢æˆ¶å„ªæƒ " style="width:100%;padding:12px;border-radius:8px;border:1px solid #333;background:#1b1b1b;color:#fff;font-size:14px;box-sizing:border-box;">
    </div>
    
    <input type="hidden" id="subTargetUserId">
    
    <div style="display:flex;gap:10px;justify-content:center;margin-top:20px;">
      <button class="btn btn-green" onclick="confirmExtendSubscription()">ç¢ºèªå»¶é•·</button>
      <button class="btn btn-outline" onclick="document.getElementById('subscriptionModal').style.display='none'">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script>
let allData = [];
let adminStatus = null;

function applyResponsiveAdminLayout() {
  try {
    const narrow = (window.innerWidth || 0) <= 900;
    document.body.classList.toggle('admin-narrow', !!narrow);
  } catch (e) {}
}

async function init() {
  applyResponsiveAdminLayout();
  window.addEventListener('resize', applyResponsiveAdminLayout);
  // 1. æª¢æŸ¥ç™»å…¥
  const { session } = await UVACO_CLOUD.getSession();
  if (!session) {
    window.location.href = 'auth.html?next=admin.html';
    return;
  }

  // 2. æª¢æŸ¥æ¬Šé™
  adminStatus = await UVACO_CLOUD.isAdmin();
  if (!adminStatus || !adminStatus.isAdmin) {
    alert('æ¬Šé™ä¸è¶³ï¼šæ‚¨ä¸æ˜¯ç®¡ç†å“¡ã€‚');
    window.location.href = 'directory.html';
    return;
  }

  // é¡¯ç¤ºç®¡ç†å“¡æç¤ºï¼ˆè¶…ç´šç®¡ç†å“¡ / ä¼æ¥­ç®¡ç†å“¡ï¼‰
  const hint = document.getElementById('adminHint');
  if (hint) {
    hint.textContent = adminStatus.managedCompany
      ? `ç›®å‰èº«åˆ†ï¼šä¼æ¥­ç®¡ç†å“¡ï¼ˆåªé¡¯ç¤ºå…¬å¸åŒ…å«ã€Œ${adminStatus.managedCompany}ã€çš„åç‰‡ï¼‰`
      : 'ç›®å‰èº«åˆ†ï¼šè¶…ç´šç®¡ç†å“¡ï¼ˆå¯ç®¡ç†å…¨éƒ¨åç‰‡èˆ‡ç®¡ç†å“¡åå–®ï¼‰';
  }

  // Super Admin æ‰é¡¯ç¤ºç®¡ç†å“¡ç®¡ç†å€
  const mgmt = document.getElementById('adminMgmt');
  if (mgmt) {
    mgmt.style.display = (!adminStatus.managedCompany) ? 'block' : 'none';
  }
  
  // Super Admin æ‰é¡¯ç¤ºã€Œç®¡ç†ä¼æ¥­ç®¡ç†å“¡ã€æŒ‰éˆ•
  const companyAdminBtn = document.getElementById('companyAdminBtn');
  if (companyAdminBtn) {
    companyAdminBtn.style.display = (!adminStatus.managedCompany) ? 'inline-block' : 'none';
  }
  
  // Super Admin æ‰é¡¯ç¤ºã€Œè¨‚é–±ç®¡ç†ã€æŒ‰éˆ•
  const subscriptionAdminBtn = document.getElementById('subscriptionAdminBtn');
  if (subscriptionAdminBtn) {
    subscriptionAdminBtn.style.display = (!adminStatus.managedCompany) ? 'inline-block' : 'none';
  }

  await reloadData();
  if (!adminStatus.managedCompany) {
    await loadAdmins();
  }
}

async function reloadData() {
  const { rows } = await UVACO_CLOUD.getAllCardsAdmin();
  allData = rows || [];
  renderTable(allData);
}

function renderTable(data) {
  const tbody = document.querySelector('#userTable tbody');
  tbody.innerHTML = '';
  
  if (data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">ç›®å‰æ²’æœ‰è³‡æ–™</td></tr>';
    return;
  }

  data.forEach(row => {
    const url = `${window.location.origin}${window.location.pathname.replace('admin.html', '')}card.html?id=${row.user_id}`;
    const urlLabel = `card.html?id=${row.user_id}`;
    const nfcId = row.nfc_card_id || '';
    const nfcDisplay = nfcId ? `<span style="color:#22c55e;font-family:monospace;">${nfcId}</span>` : '<span style="color:#6b7280;">æœªç¶å®š</span>';
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td data-label="å§“å">${row.name || 'æœªå‘½å'}</td>
      <td data-label="å…¬å¸/è·ç¨±">${row.company || '-'} <br> <small style="color:#9ca3af">${row.title || '-'}</small></td>
      <td data-label="NFC å¡ç‰‡ ID">
        ${nfcDisplay}
        <button class="btn btn-outline" style="padding:4px 8px;font-size:11px;margin-left:8px;" onclick="editNfcId('${row.user_id}', '${nfcId}', '${(row.name || '').replace(/'/g, "\\'")}')">
          ${nfcId ? 'ä¿®æ”¹' : 'ç¶å®š'}
        </button>
      </td>
      <td data-label="æ›´æ–°æ™‚é–“">${new Date(row.updated_at).toLocaleDateString()}</td>
      <td data-label="NFC ç¶²å€" class="nfc-url-cell"><a href="${url}" target="_blank" rel="noopener noreferrer">${urlLabel}</a></td>
      <td class="actions-cell">
        <div class="actions-wrap">
          <button class="btn btn-green" onclick="copyLink('${url}')">è¤‡è£½é€£çµ</button>
          <button class="btn btn-outline" onclick="showQR('${row.name}', '${url}')">QR Code</button>
          <button class="btn btn-outline" onclick="editCard('${row.user_id}')">ç·¨è¼¯</button>
          <button class="btn btn-outline" onclick="deleteCard('${row.user_id}')">åˆªé™¤</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function filterTable() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  const filtered = allData.filter(r => 
    (r.name && r.name.toLowerCase().includes(q)) || 
    (r.company && r.company.toLowerCase().includes(q))
  );
  renderTable(filtered);
}

function copyLink(url) {
  navigator.clipboard.writeText(url).then(() => alert('å·²è¤‡è£½é€£çµï¼š\n' + url));
}

let currentQRName = '';

function showQR(name, url) {
  currentQRName = name;
  document.getElementById('qrModal').style.display = 'flex';
  document.getElementById('qrName').textContent = name + ' çš„åç‰‡';
  document.getElementById('qrcode').innerHTML = '';
  new QRCode(document.getElementById('qrcode'), {
    text: url,
    width: 200,
    height: 200
  });
}

function downloadQR() {
  const qrContainer = document.getElementById('qrcode');
  const canvas = qrContainer.querySelector('canvas');
  if (canvas) {
    const link = document.createElement('a');
    link.download = `${currentQRName || 'QRCode'}_åç‰‡.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
  } else {
    // å¦‚æœæ˜¯ img å…ƒç´ 
    const img = qrContainer.querySelector('img');
    if (img) {
      const link = document.createElement('a');
      link.download = `${currentQRName || 'QRCode'}_åç‰‡.png`;
      link.href = img.src;
      link.click();
    }
  }
}

// NFC å¡ç‰‡ ID ç®¡ç†
function editNfcId(userId, currentNfcId, userName) {
  document.getElementById('nfcModalTitle').textContent = (userName || 'ç”¨æˆ¶') + ' - NFC å¡ç‰‡ç¶å®š';
  document.getElementById('nfcIdInput').value = currentNfcId || '';
  document.getElementById('nfcTargetUserId').value = userId;
  document.getElementById('nfcModal').style.display = 'flex';
  document.getElementById('nfcIdInput').focus();
}

async function saveNfcId() {
  const userId = document.getElementById('nfcTargetUserId').value;
  const nfcId = document.getElementById('nfcIdInput').value.trim();
  
  if (!userId) {
    alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ç”¨æˆ¶ ID');
    return;
  }
  
  try {
    if (UVACO_CLOUD.setNfcCardId) {
      const result = await UVACO_CLOUD.setNfcCardId(userId, nfcId || null);
      if (result.success) {
        alert(nfcId ? `NFC å¡ç‰‡ ID å·²è¨­å®šç‚ºï¼š${nfcId}` : 'NFC å¡ç‰‡ç¶å®šå·²æ¸…é™¤');
        document.getElementById('nfcModal').style.display = 'none';
        reloadData(); // é‡æ–°è¼‰å…¥è¡¨æ ¼
      } else {
        alert('è¨­å®šå¤±æ•—ï¼š' + (result.error?.message || 'æœªçŸ¥éŒ¯èª¤'));
      }
    } else {
      alert('åŠŸèƒ½å°šæœªå•Ÿç”¨ï¼Œè«‹ç¢ºèª cloud.js ç‰ˆæœ¬');
    }
  } catch (e) {
    console.error('NFC è¨­å®šéŒ¯èª¤:', e);
    alert('è¨­å®šå¤±æ•—ï¼š' + (e.message || e));
  }
}

async function clearNfcId() {
  if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ­¤ç”¨æˆ¶çš„ NFC å¡ç‰‡ç¶å®šï¼Ÿ')) return;
  
  document.getElementById('nfcIdInput').value = '';
  await saveNfcId();
}

function editCard(userId) {
  const u = encodeURIComponent(userId);
  window.location.href = `edit.html?adminMode=true&targetUserId=${u}&next=admin.html`;
}

async function deleteCard(userId) {
  const ok = confirm('ç¢ºå®šè¦åˆªé™¤æ­¤åç‰‡å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚');
  if (!ok) return;
  try {
    await UVACO_CLOUD.deleteCard(userId);
    await reloadData();
    alert('å·²åˆªé™¤ã€‚');
  } catch (e) {
    try { console.error('deleteCard failed', e); } catch (_e) {}
    const msg = String(e?.message || e || '');
    const code = String(e?.code || '');
    const details = String(e?.details || '');
    const hint = String(e?.hint || '');
    const extra = [code && ('code=' + code), details && ('details=' + details), hint && ('hint=' + hint)]
      .filter(Boolean)
      .join('\n');
    // å¸¸è¦‹ï¼šSupabase / Postgres RLS policy è‡ªæˆ‘åƒç…§ï¼Œæœƒå›å‚³ stack depth limit exceeded
    if (/stack\s+depth\s+limit\s+exceeded/i.test(msg)) {
      alert(
        'åˆªé™¤å¤±æ•—ï¼šè³‡æ–™åº«æ¬Šé™è¦å‰‡ï¼ˆRLS policyï¼‰å¯èƒ½æœ‰ã€Œè‡ªæˆ‘æŸ¥è¡¨ã€é€ æˆéè¿´ï¼Œå°è‡´ stack depth limit exceededã€‚\n\n' +
        'è«‹åˆ° Supabase SQL Editor é‡æ–°åŸ·è¡Œå°ˆæ¡ˆçš„ update_admin_schema.sqlï¼ˆæœ€æ–°ç‰ˆå·²ä¿®æ­£æ­¤å•é¡Œï¼‰ï¼Œå†é‡è©¦åˆªé™¤ã€‚\n\n' +
        (extra ? ('\n\n' + extra) : '')
      );
      return;
    }
    alert('åˆªé™¤å¤±æ•—ï¼š' + msg + (extra ? ('\n\n' + extra) : ''));
  }
}

async function loadAdmins() {
  const tbody = document.querySelector('#adminTable tbody');
  if (!tbody) return;
  tbody.innerHTML = '<tr><td colspan="2" style="padding:12px;text-align:center;color:#888">è¼‰å…¥ä¸­...</td></tr>';
  try {
    const { rows } = await UVACO_CLOUD.getAdminUsers();
    const list = rows || [];
    if (!list.length) {
      tbody.innerHTML = '<tr><td colspan="2" style="padding:12px;text-align:center;color:#888">ç„¡è³‡æ–™</td></tr>';
      return;
    }
    tbody.innerHTML = '';
    list.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="padding:12px;border-bottom:1px solid #333;color:#ddd;font-family:monospace">${r.user_id}</td>
        <td style="padding:12px;border-bottom:1px solid #333;color:#aaa">${r.managed_company || '(Super Admin)'}</td>
      `;
      tbody.appendChild(tr);
    });
  } catch (e) {
    tbody.innerHTML = '<tr><td colspan="2" style="padding:12px;text-align:center;color:#ef4444">è¼‰å…¥å¤±æ•—</td></tr>';
  }
}

async function saveAdminUser() {
  const uid = (document.getElementById('adminUserIdInput')?.value || '').trim();
  const company = (document.getElementById('adminCompanyInput')?.value || '').trim();
  if (!uid) {
    alert('è«‹è¼¸å…¥ User ID');
    return;
  }
  try {
    await UVACO_CLOUD.upsertAdminUser(uid, company);
    await loadAdmins();
    alert('å·²æ›´æ–°ç®¡ç†å“¡ã€‚');
  } catch (e) {
    alert('æ›´æ–°å¤±æ•—ï¼š' + String(e?.message || e || ''));
  }
}

async function removeAdminUser() {
  const uid = (document.getElementById('adminUserIdInput')?.value || '').trim();
  if (!uid) {
    alert('è«‹è¼¸å…¥è¦ç§»é™¤çš„ User ID');
    return;
  }
  const ok = confirm('ç¢ºå®šè¦ç§»é™¤æ­¤ç®¡ç†å“¡å—ï¼Ÿ');
  if (!ok) return;
  try {
    await UVACO_CLOUD.deleteAdminUser(uid);
    await loadAdmins();
    alert('å·²ç§»é™¤ç®¡ç†å“¡ã€‚');
  } catch (e) {
    alert('ç§»é™¤å¤±æ•—ï¼š' + String(e?.message || e || ''));
  }
}

// ===== è¨‚é–±ç®¡ç†åŠŸèƒ½ =====
let showSubscriptionView = false;
let subscriptionData = [];

function toggleSubscriptionView() {
  showSubscriptionView = !showSubscriptionView;
  const btn = document.getElementById('subscriptionAdminBtn');
  if (btn) {
    btn.textContent = showSubscriptionView ? 'ğŸ“‹ åç‰‡ç®¡ç†' : 'ğŸ’ è¨‚é–±ç®¡ç†';
  }
  
  if (showSubscriptionView) {
    loadSubscriptions();
  } else {
    reloadData();
  }
}

async function loadSubscriptions() {
  const tbody = document.querySelector('#userTable tbody');
  tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">è¼‰å…¥è¨‚é–±è³‡æ–™ä¸­...</td></tr>';
  
  try {
    const result = await UVACO_CLOUD.getAllSubscriptionsAdmin();
    subscriptionData = result.rows || [];
    renderSubscriptionTable(subscriptionData);
  } catch (e) {
    console.error('è¼‰å…¥è¨‚é–±å¤±æ•—:', e);
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#ef4444">è¼‰å…¥å¤±æ•—</td></tr>';
  }
}

function renderSubscriptionTable(data) {
  const thead = document.querySelector('#userTable thead tr');
  thead.innerHTML = `
    <th>å§“å</th>
    <th>å…¬å¸</th>
    <th>ç‹€æ…‹</th>
    <th>å‰©é¤˜å¤©æ•¸</th>
    <th>åˆ°æœŸæ—¥</th>
    <th>æ“ä½œ</th>
  `;
  
  const tbody = document.querySelector('#userTable tbody');
  tbody.innerHTML = '';
  
  if (data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">ç›®å‰æ²’æœ‰è¨‚é–±è³‡æ–™</td></tr>';
    return;
  }
  
  data.forEach(row => {
    const statusColors = {
      trial: '#3b82f6',
      active: '#22c55e',
      expired: '#ef4444',
      cancelled: '#9ca3af'
    };
    const statusLabels = {
      trial: 'è©¦ç”¨ä¸­',
      active: 'è¨‚é–±ä¸­',
      expired: 'å·²éæœŸ',
      cancelled: 'å·²å–æ¶ˆ'
    };
    
    const statusColor = statusColors[row.status] || '#9ca3af';
    const statusLabel = statusLabels[row.status] || row.status;
    const endDate = row.endDate ? new Date(row.endDate).toLocaleDateString('zh-TW') : '-';
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td data-label="å§“å">${row.userName || 'æœªå‘½å'}</td>
      <td data-label="å…¬å¸">${row.userCompany || '-'}</td>
      <td data-label="ç‹€æ…‹"><span style="color:${statusColor};font-weight:600;">${statusLabel}</span></td>
      <td data-label="å‰©é¤˜å¤©æ•¸"><span style="font-size:18px;font-weight:700;color:${row.daysLeft > 7 ? '#22c55e' : '#ef4444'}">${row.daysLeft}</span> å¤©</td>
      <td data-label="åˆ°æœŸæ—¥">${endDate}</td>
      <td class="actions-cell">
        <div class="actions-wrap">
          <button class="btn btn-green" onclick="openExtendModal('${row.user_id}', '${(row.userName || '').replace(/'/g, "\\'")}', ${row.daysLeft}, '${endDate}')">å»¶é•·è¨‚é–±</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function openExtendModal(userId, userName, daysLeft, endDate) {
  document.getElementById('subModalTitle').textContent = (userName || 'ç”¨æˆ¶') + ' - å»¶é•·è¨‚é–±';
  document.getElementById('subUserInfo').innerHTML = `
    ç›®å‰å‰©é¤˜ï¼š<strong style="color:#22c55e;">${daysLeft}</strong> å¤©<br>
    åˆ°æœŸæ—¥ï¼š${endDate}
  `;
  document.getElementById('subTargetUserId').value = userId;
  document.getElementById('extendDaysInput').value = '';
  document.getElementById('extendReasonInput').value = '';
  document.getElementById('subscriptionModal').style.display = 'flex';
}

function setExtendDays(days) {
  document.getElementById('extendDaysInput').value = days;
}

async function confirmExtendSubscription() {
  const userId = document.getElementById('subTargetUserId').value;
  const days = parseInt(document.getElementById('extendDaysInput').value);
  const reason = document.getElementById('extendReasonInput').value.trim();
  
  if (!userId) {
    alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ç”¨æˆ¶ ID');
    return;
  }
  
  if (!days || days < 1) {
    alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„å»¶é•·å¤©æ•¸');
    return;
  }
  
  try {
    const result = await UVACO_CLOUD.extendSubscription(userId, days, reason);
    if (result.success) {
      const newEnd = new Date(result.newEndDate).toLocaleDateString('zh-TW');
      alert(`è¨‚é–±å·²å»¶é•· ${days} å¤©\næ–°åˆ°æœŸæ—¥ï¼š${newEnd}`);
      document.getElementById('subscriptionModal').style.display = 'none';
      loadSubscriptions();
    } else {
      alert('å»¶é•·å¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
    }
  } catch (e) {
    console.error('å»¶é•·è¨‚é–±éŒ¯èª¤:', e);
    alert('å»¶é•·å¤±æ•—ï¼š' + (e.message || e));
  }
}

// ä¿®æ”¹åŸæœ¬çš„ reloadData å‡½æ•¸
const originalReloadData = reloadData;
reloadData = async function() {
  if (showSubscriptionView) {
    await loadSubscriptions();
  } else {
    // æ¢å¾©åŸæœ¬çš„è¡¨é ­
    const thead = document.querySelector('#userTable thead tr');
    thead.innerHTML = `
      <th>å§“å</th>
      <th>å…¬å¸/è·ç¨±</th>
      <th>NFC å¡ç‰‡ ID</th>
      <th>æ›´æ–°æ™‚é–“</th>
      <th>NFC ç¶²å€</th>
      <th>æ“ä½œ</th>
    `;
    await originalReloadData();
  }
};

init();
</script>
</body>
</html>
