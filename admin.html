<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>NFC 名片管理後台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="styles.css?v=20260104">
  <style>
    body { padding: 20px; max-width: 1200px; margin: 0 auto; background: #111; color: #fff; }
    h1 { color: var(--uvaco-green); margin-bottom: 30px; }
    .toolbar { display: flex; gap: 10px; margin-bottom: 20px; }
    input[type="text"] { padding: 10px; border-radius: 8px; border: 1px solid #444; background: #222; color: #fff; flex: 1; }
    
    table { width: 100%; border-collapse: collapse; background: #222; border-radius: 12px; overflow: hidden; }
    th, td { padding: 15px; text-align: left; border-bottom: 1px solid #333; }
    th { background: #333; color: #aaa; font-weight: normal; }
    tr:hover { background: #2a2a2a; }
    
    .btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; margin-right: 5px; }
    .btn-green { background: var(--uvaco-green); color: #fff; }
    .btn-outline { background: transparent; border: 1px solid #555; color: #ccc; }
    
    .qr-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index:999; }
    .qr-box { background:#fff; padding:30px; border-radius:16px; text-align:center; color:#000; }
    #qrImage { width: 250px; height: 250px; margin: 20px 0; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="cloud.js?v=20260104"></script>
</head>
<body>

<h1>NFC 名片量產管理</h1>

<div class="toolbar">
  <input type="text" id="searchInput" placeholder="搜尋姓名、公司..." onkeyup="filterTable()">
  <button class="btn btn-green" onclick="location.reload()">重新整理</button>
  <button class="btn btn-outline" onclick="location.href='edit.html'">返回編輯</button>
</div>

<table id="userTable">
  <thead>
    <tr>
      <th>姓名</th>
      <th>公司/職稱</th>
      <th>更新時間</th>
      <th>NFC 網址</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="5" style="text-align:center">載入中...</td></tr>
  </tbody>
</table>

<div id="qrModal" class="qr-modal" onclick="this.style.display='none'">
  <div class="qr-box" onclick="event.stopPropagation()">
    <h3 id="qrName"></h3>
    <div id="qrcode"></div>
    <p>請掃描或截圖提供給印刷廠</p>
    <button class="btn btn-outline" onclick="document.getElementById('qrModal').style.display='none'">關閉</button>
  </div>
</div>

<script>
let allData = [];

async function init() {
  // 1. 檢查登入
  const { session } = await UVACO_CLOUD.getSession();
  if (!session) {
    window.location.href = 'auth.html?next=admin.html';
    return;
  }

  // 2. 抓取資料
  const { rows } = await UVACO_CLOUD.getAllCardsAdmin();
  allData = rows;
  renderTable(rows);
}

function renderTable(data) {
  const tbody = document.querySelector('#userTable tbody');
  tbody.innerHTML = '';
  
  if (data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">目前沒有資料</td></tr>';
    return;
  }

  data.forEach(row => {
    const url = `${window.location.origin}${window.location.pathname.replace('admin.html', '')}card.html?id=${row.user_id}`;
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.name || '未命名'}</td>
      <td>${row.company || '-'} <br> <small style="color:#666">${row.title || '-'}</small></td>
      <td>${new Date(row.updated_at).toLocaleDateString()}</td>
      <td><a href="${url}" target="_blank" style="color:#666;text-decoration:none">${url}</a></td>
      <td>
        <button class="btn btn-green" onclick="copyLink('${url}')">複製連結</button>
        <button class="btn btn-outline" onclick="showQR('${row.name}', '${url}')">QR Code</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function filterTable() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  const filtered = allData.filter(r => 
    (r.name && r.name.toLowerCase().includes(q)) || 
    (r.company && r.company.toLowerCase().includes(q))
  );
  renderTable(filtered);
}

function copyLink(url) {
  navigator.clipboard.writeText(url).then(() => alert('已複製連結：\n' + url));
}

function showQR(name, url) {
  document.getElementById('qrModal').style.display = 'flex';
  document.getElementById('qrName').textContent = name + ' 的名片';
  document.getElementById('qrcode').innerHTML = '';
  new QRCode(document.getElementById('qrcode'), {
    text: url,
    width: 200,
    height: 200
  });
}

init();
</script>
</body>
</html>
