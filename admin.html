<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>NFC 名片管理後台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="styles.css?v=20260105">
  <style>
    body { padding: 20px; max-width: 1200px; margin: 0 auto; background: #111; color: #fff; }
    h1 { color: var(--uvaco-green); margin-bottom: 30px; }
    .toolbar { display: flex; gap: 10px; margin-bottom: 20px; }
    input[type="text"] { padding: 10px; border-radius: 8px; border: 1px solid #444; background: #222; color: #fff; flex: 1; }
    
    table { width: 100%; border-collapse: collapse; background: #222; border-radius: 12px; overflow: hidden; }
    th, td { padding: 15px; text-align: left; border-bottom: 1px solid #333; }
    th { background: #333; color: #aaa; font-weight: normal; }
    tr:hover { background: #2a2a2a; }
    
    .btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; margin-right: 5px; }
    .btn-green { background: var(--uvaco-green); color: #fff; }
    .btn-outline { background: transparent; border: 1px solid #555; color: #ccc; }
    
    .qr-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index:999; }
    .qr-box { background:#fff; padding:30px; border-radius:16px; text-align:center; color:#000; }
    #qrImage { width: 250px; height: 250px; margin: 20px 0; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="cloud.js?v=20260106"></script>
</head>
<body>

<h1>NFC 名片量產管理</h1>

<div class="toolbar">
  <input type="text" id="searchInput" placeholder="搜尋姓名、公司..." onkeyup="filterTable()">
  <button class="btn btn-green" onclick="reloadData()">重新整理</button>
  <button class="btn btn-outline" onclick="location.href='directory.html'">返回通訊錄</button>
  <button class="btn btn-outline" onclick="location.href='settings.html'">前往設定</button>
</div>

<div id="adminHint" style="margin:10px 0 18px;color:#aaa;font-size:13px"></div>

<table id="userTable">
  <thead>
    <tr>
      <th>姓名</th>
      <th>公司/職稱</th>
      <th>更新時間</th>
      <th>NFC 網址</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="5" style="text-align:center">載入中...</td></tr>
  </tbody>
</table>

<!-- Super Admin：管理員管理 -->
<div id="adminMgmt" style="display:none;margin-top:26px;background:#1b1b1b;border:1px solid #2b2b2b;border-radius:12px;padding:16px">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px">
    <div style="font-size:16px;color:var(--uvaco-green);font-weight:700">管理員管理（超級管理員）</div>
    <button class="btn btn-outline" onclick="loadAdmins()">重新整理管理員列表</button>
  </div>

  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px">
    <input type="text" id="adminUserIdInput" placeholder="User ID (uuid)" style="flex:2;min-width:280px">
    <input type="text" id="adminCompanyInput" placeholder="管理公司（留空＝超級管理員）" style="flex:1;min-width:220px">
    <button class="btn btn-green" onclick="saveAdminUser()">新增/更新</button>
    <button class="btn btn-outline" onclick="removeAdminUser()">移除</button>
  </div>

  <table id="adminTable" style="width:100%;border-collapse:collapse;background:#222;border-radius:12px;overflow:hidden">
    <thead>
      <tr>
        <th style="background:#333;color:#aaa;font-weight:normal;padding:12px;border-bottom:1px solid #333">User ID</th>
        <th style="background:#333;color:#aaa;font-weight:normal;padding:12px;border-bottom:1px solid #333">managed_company</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="2" style="padding:12px;text-align:center;color:#888">載入中...</td></tr>
    </tbody>
  </table>
</div>

<div id="qrModal" class="qr-modal" onclick="this.style.display='none'">
  <div class="qr-box" onclick="event.stopPropagation()">
    <h3 id="qrName"></h3>
    <div id="qrcode"></div>
    <p>請掃描或截圖提供給印刷廠</p>
    <button class="btn btn-outline" onclick="document.getElementById('qrModal').style.display='none'">關閉</button>
  </div>
</div>

<script>
let allData = [];
let adminStatus = null;

async function init() {
  // 1. 檢查登入
  const { session } = await UVACO_CLOUD.getSession();
  if (!session) {
    window.location.href = 'auth.html?next=admin.html';
    return;
  }

  // 2. 檢查權限
  adminStatus = await UVACO_CLOUD.isAdmin();
  if (!adminStatus || !adminStatus.isAdmin) {
    alert('權限不足：您不是管理員。');
    window.location.href = 'directory.html';
    return;
  }

  // 顯示管理員提示（超級管理員 / 企業管理員）
  const hint = document.getElementById('adminHint');
  if (hint) {
    hint.textContent = adminStatus.managedCompany
      ? `目前身分：企業管理員（只顯示公司包含「${adminStatus.managedCompany}」的名片）`
      : '目前身分：超級管理員（可管理全部名片與管理員名單）';
  }

  // Super Admin 才顯示管理員管理區
  const mgmt = document.getElementById('adminMgmt');
  if (mgmt) {
    mgmt.style.display = (!adminStatus.managedCompany) ? 'block' : 'none';
  }

  await reloadData();
  if (!adminStatus.managedCompany) {
    await loadAdmins();
  }
}

async function reloadData() {
  const { rows } = await UVACO_CLOUD.getAllCardsAdmin();
  allData = rows || [];
  renderTable(allData);
}

function renderTable(data) {
  const tbody = document.querySelector('#userTable tbody');
  tbody.innerHTML = '';
  
  if (data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">目前沒有資料</td></tr>';
    return;
  }

  data.forEach(row => {
    const url = `${window.location.origin}${window.location.pathname.replace('admin.html', '')}card.html?id=${row.user_id}`;
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.name || '未命名'}</td>
      <td>${row.company || '-'} <br> <small style="color:#666">${row.title || '-'}</small></td>
      <td>${new Date(row.updated_at).toLocaleDateString()}</td>
      <td><a href="${url}" target="_blank" style="color:#666;text-decoration:none">${url}</a></td>
      <td>
        <button class="btn btn-green" onclick="copyLink('${url}')">複製連結</button>
        <button class="btn btn-outline" onclick="showQR('${row.name}', '${url}')">QR Code</button>
        <button class="btn btn-outline" onclick="editCard('${row.user_id}')">編輯</button>
        <button class="btn btn-outline" onclick="deleteCard('${row.user_id}')">刪除</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function filterTable() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  const filtered = allData.filter(r => 
    (r.name && r.name.toLowerCase().includes(q)) || 
    (r.company && r.company.toLowerCase().includes(q))
  );
  renderTable(filtered);
}

function copyLink(url) {
  navigator.clipboard.writeText(url).then(() => alert('已複製連結：\n' + url));
}

function showQR(name, url) {
  document.getElementById('qrModal').style.display = 'flex';
  document.getElementById('qrName').textContent = name + ' 的名片';
  document.getElementById('qrcode').innerHTML = '';
  new QRCode(document.getElementById('qrcode'), {
    text: url,
    width: 200,
    height: 200
  });
}

function editCard(userId) {
  const u = encodeURIComponent(userId);
  window.location.href = `edit.html?adminMode=true&targetUserId=${u}&next=admin.html`;
}

async function deleteCard(userId) {
  const ok = confirm('確定要刪除此名片嗎？此動作無法復原。');
  if (!ok) return;
  try {
    await UVACO_CLOUD.deleteCard(userId);
    await reloadData();
    alert('已刪除。');
  } catch (e) {
    alert('刪除失敗：' + String(e?.message || e || ''));
  }
}

async function loadAdmins() {
  const tbody = document.querySelector('#adminTable tbody');
  if (!tbody) return;
  tbody.innerHTML = '<tr><td colspan="2" style="padding:12px;text-align:center;color:#888">載入中...</td></tr>';
  try {
    const { rows } = await UVACO_CLOUD.getAdminUsers();
    const list = rows || [];
    if (!list.length) {
      tbody.innerHTML = '<tr><td colspan="2" style="padding:12px;text-align:center;color:#888">無資料</td></tr>';
      return;
    }
    tbody.innerHTML = '';
    list.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="padding:12px;border-bottom:1px solid #333;color:#ddd;font-family:monospace">${r.user_id}</td>
        <td style="padding:12px;border-bottom:1px solid #333;color:#aaa">${r.managed_company || '(Super Admin)'}</td>
      `;
      tbody.appendChild(tr);
    });
  } catch (e) {
    tbody.innerHTML = '<tr><td colspan="2" style="padding:12px;text-align:center;color:#ef4444">載入失敗</td></tr>';
  }
}

async function saveAdminUser() {
  const uid = (document.getElementById('adminUserIdInput')?.value || '').trim();
  const company = (document.getElementById('adminCompanyInput')?.value || '').trim();
  if (!uid) {
    alert('請輸入 User ID');
    return;
  }
  try {
    await UVACO_CLOUD.upsertAdminUser(uid, company);
    await loadAdmins();
    alert('已更新管理員。');
  } catch (e) {
    alert('更新失敗：' + String(e?.message || e || ''));
  }
}

async function removeAdminUser() {
  const uid = (document.getElementById('adminUserIdInput')?.value || '').trim();
  if (!uid) {
    alert('請輸入要移除的 User ID');
    return;
  }
  const ok = confirm('確定要移除此管理員嗎？');
  if (!ok) return;
  try {
    await UVACO_CLOUD.deleteAdminUser(uid);
    await loadAdmins();
    alert('已移除管理員。');
  } catch (e) {
    alert('移除失敗：' + String(e?.message || e || ''));
  }
}

init();
</script>
</body>
</html>
