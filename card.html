<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<!-- Sentry éŒ¯èª¤ç›£æ§ SDK -->
<script src="https://browser.sentry-cdn.com/7.100.0/bundle.min.js" crossorigin="anonymous"></script>
<!-- é˜²æ­¢ç€è¦½å™¨å¿«å–ï¼ˆGitHub Pages / æœ¬æ©Ÿæ¸¬è©¦çš†å¯èƒ½è¢«å¿«å–èˆŠç‰ˆ HTML/CSS/JSï¼‰ -->
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
  <meta name="robots" content="noindex" />
  <title>æ•¸ä½èº«åˆ† | Digital Identity</title>
  <link rel="stylesheet" href="styles.css?v=20260105">
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#22c55e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="æ•¸ä½èº«åˆ†">
  <link rel="apple-touch-icon" href="icon-192.svg">
<!-- Supabase JSï¼ˆCDNï¼‰ -->
  <script src="supabase.min.js"></script>
  <!-- QR Code ç”Ÿæˆå™¨ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="cloud.js?v=20260127"></script>
  <script src="common.js?v=20260205c"></script>
  <style>
    .qr-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index:999; }
    .qr-box { background:#fff; padding:30px; border-radius:16px; text-align:center; color:#000; max-width:90%; }
    .qr-box h3 { margin: 0 0 15px 0; font-size: 1.2em; }
    #qrcode { margin: 20px auto; }
    #qrcode canvas { border-radius: 8px; }
    
    /* Toast å‹•ç•« */
    @keyframes toastFadeIn {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    @keyframes toastFadeOut {
      from { opacity: 1; transform: translateX(-50%) translateY(0); }
      to { opacity: 0; transform: translateX(-50%) translateY(20px); }
    }
    
    /* ç§»é™¤ LOGO å€çš„é»ƒè‰²å¤–æ¡† */
    .hero-frame {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      animation: none !important;
    }
    .hero-frame::before {
      display: none !important;
    }
    
    /* è¿”å›æŒ‰éˆ• */
    .back-btn {
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 100;
      background: rgba(0,0,0,0.5);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      transition: background 0.2s;
    }
    .back-btn:hover {
      background: rgba(0,0,0,0.7);
    }
    
    /* åŠ å…¥ä¸»ç•«é¢æç¤ºæ©«å¹… */
    .add-home-banner {
      display: none;
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 32px);
      max-width: 400px;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.95), rgba(22, 163, 74, 0.95));
      border-radius: 16px;
      padding: 16px 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      z-index: 9998;
      animation: bannerSlideUp 0.4s ease-out;
    }
    @keyframes bannerSlideUp {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    .add-home-banner.show {
      display: block;
    }
    .add-home-banner-content {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .add-home-banner-icon {
      font-size: 28px;
      flex-shrink: 0;
    }
    .add-home-banner-text {
      flex: 1;
    }
    .add-home-banner-title {
      font-size: 15px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 4px;
    }
    .add-home-banner-desc {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.9);
      line-height: 1.4;
    }
    .add-home-banner-close {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: #fff;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .add-home-banner-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    .add-home-banner-action {
      margin-top: 12px;
      display: flex;
      gap: 8px;
    }
    .add-home-banner-btn {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .add-home-banner-btn.primary {
      background: #fff;
      color: #16a34a;
    }
    .add-home-banner-btn.primary:hover {
      background: rgba(255, 255, 255, 0.9);
    }
    .add-home-banner-btn.secondary {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
    }
    .add-home-banner-btn.secondary:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  </style>
</head>

<body class="theme-dark lang-zh">

<!-- åŠ å…¥ä¸»ç•«é¢æç¤ºæ©«å¹… -->
<div id="addHomeBanner" class="add-home-banner">
  <button class="add-home-banner-close" onclick="dismissAddHomeBanner()" title="é—œé–‰">âœ•</button>
  <div class="add-home-banner-content">
    <div class="add-home-banner-icon">ğŸ“±</div>
    <div class="add-home-banner-text">
      <div class="add-home-banner-title lang-zh">åŠ å…¥ä¸»ç•«é¢ï¼Œå¿«é€Ÿé–‹å•Ÿåç‰‡</div>
      <div class="add-home-banner-title lang-en" style="display:none;">Add to Home Screen</div>
      <div class="add-home-banner-desc lang-zh">å°‡åç‰‡åŠ å…¥æ‰‹æ©Ÿä¸»ç•«é¢ï¼Œä¸‹æ¬¡é»æ“Šåœ–ç¤ºå³å¯ç›´æ¥é–‹å•Ÿæ‚¨çš„åç‰‡ï¼</div>
      <div class="add-home-banner-desc lang-en" style="display:none;">Add your card to home screen for quick access!</div>
      <div class="add-home-banner-action">
        <button class="add-home-banner-btn primary" onclick="showAddHomeInstructions()">
          <span class="lang-zh">äº†è§£å¦‚ä½•åŠ å…¥</span>
          <span class="lang-en" style="display:none;">Learn How</span>
        </button>
        <button class="add-home-banner-btn secondary" onclick="dismissAddHomeBanner()">
          <span class="lang-zh">ç¨å¾Œå†èªª</span>
          <span class="lang-en" style="display:none;">Later</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- èƒŒæ™¯æ³¡æ³¡ -->
<div class="bg-blob blob1"></div>
<div class="bg-blob blob2"></div>

<!-- LOGO å€ -->
<div class="hero">
  <div class="hero-frame">
    <img src="uvaco-logo.svg?v=20260125" class="hero-logo" alt="æ•¸ä½èº«åˆ†å¹³å°" id="viewerLogo" loading="lazy">
          </div>
        </div>

<!-- è³‡æ–™å¡ï¼ˆèˆ‡ yuyuko.html å®Œå…¨ä¸€è‡´çš„çµæ§‹ï¼‰ -->
<div class="card" id="previewCard">

  <!-- å¤§é ­ç…§ï¼ˆæ”¾ç½®æ–¼å¡ç‰‡å³ä¸Šè§’ï¼‰ -->
  <img class="avatar" src="default-avatar.svg" alt="Avatar" loading="lazy" id="viewerAvatar">

  <!-- å§“å -->
  <div class="name lang-zh" id="viewerNameZh">-</div>
  <div class="name lang-en" id="viewerNameEn">-</div>

  <!-- è·å‹™ -->
  <div class="tagline lang-zh" id="viewerTitleZh">-</div>
  <div class="tagline lang-en" id="viewerTitleEn">-</div>

  <!-- æ¨™èªï¼ˆç”± JS å‹•æ…‹å¡«å…¥ï¼Œæˆ– fallback åˆ°é è¨­ï¼‰ -->
  <div id="viewerSlogansZh">
    <div class="tagline lang-zh">å¥åº·ãƒ»äº‹æ¥­ãƒ»æœªä¾†</div>
    <div class="tagline lang-zh"><strong id="viewerCompanyStrongZh">-</strong></div>
  </div>

  <div id="viewerSlogansEn">
    <div class="tagline lang-en">Health â€¢ Business â€¢ Future</div>
    <div class="tagline lang-en"><strong id="viewerCompanyStrongEn">-</strong></div>
  </div>

  <div class="divider"></div>

  <!-- å…¬å¸è³‡è¨Šå€å¡Šï¼ˆç›´æ¥ä½¿ç”¨ edit.html å„²å­˜çš„ companyInfoHtmlï¼‰ -->
  <div class="company-info-section" id="companyInfoSection" style="display:none"></div>

  <div class="divider"></div>

  <!-- æ¨™é¡Œï¼šè¯çµ¡æ–¹å¼ -->
  <div class="section-label lang-zh">è¯çµ¡æ–¹å¼ CONTACT</div>
  <div class="section-label lang-en">CONTACT</div>

  <!-- æŒ‰éˆ•ç¾¤çµ„ -->
  <div class="btn-group" id="viewerContacts">
    <!-- æœƒç”± profile_json.contactsHtml å‹•æ…‹å¡«å…¥ï¼›è‹¥ä¸å­˜åœ¨å‰‡ fallback ä½¿ç”¨ phone/email -->
  </div>

  <!-- æç¤ºæ–‡å­— -->
    <div class="hint lang-zh">
      å¦‚éœ€ç”³è«‹å¯¦é«” <strong>NFC åç‰‡</strong>ï¼Œè«‹æ´½ <a href="https://line.me/R/ti/p/@632nedvu" target="_blank" style="color: #06c755; text-decoration: underline;">LINE å®˜æ–¹å¸³è™Ÿ</a>èˆ‡æˆ‘å€‘è¯ç¹«ã€‚
    </div>
    <div class="hint lang-en">
      To apply for a physical <strong>NFC card</strong>, please contact us via <a href="https://line.me/R/ti/p/@632nedvu" target="_blank" style="color: #06c755; text-decoration: underline;">LINE Official Account</a>.
    </div>
    
    <!-- åˆ†äº«åç‰‡åŠŸèƒ½ -->
    <div style="margin-top: 20px; text-align: center; display: flex; flex-direction: column; gap: 12px; align-items: center;">
      <button class="btn btn-primary" onclick="shareMyCard()" style="background-color: var(--uvaco-green); color: white; display: inline-flex; align-items: center; gap: 8px; width: auto; min-width: 160px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5zm-8.5 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm11 5.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3z"/>
        </svg>
        <span class="lang-zh">åˆ†äº«åç‰‡</span>
        <span class="lang-en">Share Card</span>
      </button>
      
      <!-- å¿«é€Ÿæ“ä½œæŒ‰éˆ•çµ„ -->
      <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
        <!-- QR Code -->
        <button class="btn btn-secondary" onclick="showQRCode()" style="display: inline-flex; align-items: center; gap: 8px; width: auto;">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M0 .5A.5.5 0 0 1 .5 0h3a.5.5 0 0 1 0 1H1v2.5a.5.5 0 0 1-1 0v-3Zm12 0a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0V1h-2.5a.5.5 0 0 1-.5-.5ZM.5 12a.5.5 0 0 1 .5.5V15h2.5a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5Zm15 0a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1H15v-2.5a.5.5 0 0 1 .5-.5ZM4 4h1v1H4V4Z"/>
            <path d="M7 2H2v5h5V2ZM3 3h3v3H3V3Zm2 8H4v1h1v-1Z"/>
            <path d="M7 9H2v5h5V9Zm-4 1h3v3H3v-3Zm8-6h1v1h-1V4Z"/>
            <path d="M9 2h5v5H9V2Zm1 1v3h3V3h-3ZM8 8v2h1v1H8v1h2v-2h1v2h1v-1h2v-1h-3V8H8Zm2 2H9V9h1v1Zm4 2h-1v1h-2v1h3v-2Zm-4 2v-1H8v1h2Z"/>
            <path d="M12 9h2V8h-2v1Z"/>
          </svg>
          <span class="lang-zh">QR Code</span>
          <span class="lang-en">QR Code</span>
        </button>
      </div>
    </div>

</div>

<!-- QR Code å½ˆçª— -->
<div id="qrModal" class="qr-modal" onclick="closeQRModal()">
  <div class="qr-box" onclick="event.stopPropagation()">
    <h3 class="lang-zh">æˆ‘çš„åç‰‡ QR Code</h3>
    <h3 class="lang-en">My Card QR Code</h3>
    <div id="qrcode"></div>
    <p class="lang-zh" style="color:#666;font-size:0.9em;">æƒææ­¤ QR Code å¯ç›´æ¥é–‹å•Ÿåç‰‡</p>
    <p class="lang-en" style="color:#666;font-size:0.9em;">Scan to open this business card</p>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:15px;flex-wrap:wrap;">
      <button class="btn btn-primary" onclick="downloadQRCode()" style="background-color: var(--uvaco-green); color: white;">
        <span class="lang-zh">ä¸‹è¼‰ QR Code</span>
        <span class="lang-en">Download</span>
      </button>
      <button class="btn btn-secondary" onclick="closeQRModal()">
        <span class="lang-zh">é—œé–‰</span>
        <span class="lang-en">Close</span>
      </button>
    </div>
  </div>
</div>

<!-- åº•éƒ¨å°èˆªæ¬„ -->
<nav class="bottom-nav">
  <a href="#" class="nav-item primary" id="navMyCard" onclick="gotoMyCard(event)">
    <span class="nav-icon">ğŸ‘¤</span>
    <span class="nav-label lang-zh">æˆ‘çš„åç‰‡</span>
    <span class="nav-label lang-en">My Card</span>
  </a>
  <a href="directory.html" class="nav-item">
    <span class="nav-icon">ğŸ“‹</span>
    <span class="nav-label lang-zh">é€šè¨ŠéŒ„</span>
    <span class="nav-label lang-en">Directory</span>
  </a>
  <a href="settings.html" class="nav-item">
    <span class="nav-icon">âš™ï¸</span>
    <span class="nav-label lang-zh">è¨­å®š</span>
    <span class="nav-label lang-en">Settings</span>
  </a>
</nav>

<script>
// è¿”å›ä¸Šä¸€é 
function goBack() {
  if (window.history.length > 1) {
    window.history.back();
  } else {
    window.location.href = 'directory.html';
  }
}

// å‰å¾€ã€Œæˆ‘çš„åç‰‡ã€é é¢
async function gotoMyCard(event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  try {
    if (!window.UVACO_CLOUD || !UVACO_CLOUD.hasConfig()) {
      window.location.href = 'auth.html?next=directory.html';
      return false;
    }
    const s = await UVACO_CLOUD.getSession();
    const uid = s && s.session && s.session.user ? String(s.session.user.id || '').trim() : '';
    if (!uid) {
      window.location.href = 'auth.html?next=directory.html';
      return false;
    }
    window.location.href = 'card.html?id=' + encodeURIComponent(uid);
    return false;
  } catch (e) {
    window.location.href = 'auth.html?next=directory.html';
    return false;
  }
}
</script>

<script>
function safeText(v) {
  return String(v ?? '').replace(/\s+/g, ' ').trim();
}

// ç³»çµ±ä½”ä½æ–‡å­—éæ¿¾ - éæ¿¾è¢«èª¤å­˜çš„ç³»çµ±æç¤ºæ–‡å­—
function filterSystemText(text) {
  if (!text) return text;
  const systemPatterns = [
    'å¦‚éœ€æ›´æ”¹è«‹è¯çµ¡ç®¡ç†å“¡',
    'å…¬å¸å·²é–å®š',
    'å…¬å¸ï¼šå¿…é¸ä¸‹æ‹‰',
    'å¯è¼¸å…¥é—œéµå­—å¿«é€Ÿå¸¶å…¥',
    'è«‹è¼¸å…¥å…§å®¹',
    'Enter content'
  ];
  for (const pattern of systemPatterns) {
    if (text.includes(pattern)) return '';
  }
  return text;
}

// éæ¿¾ HTML ä¸­çš„ç³»çµ±ä½”ä½æ–‡å­—
function filterSystemHtml(html) {
  if (!html) return html;
  const systemPatterns = [
    'å¦‚éœ€æ›´æ”¹è«‹è¯çµ¡ç®¡ç†å“¡',
    'å…¬å¸å·²é–å®š',
    'å…¬å¸ï¼šå¿…é¸ä¸‹æ‹‰',
    'å¯è¼¸å…¥é—œéµå­—å¿«é€Ÿå¸¶å…¥',
    'è«‹è¼¸å…¥å…§å®¹',
    'Enter content'
  ];
  // å»ºç«‹ DOM ä¾†è™•ç† HTML
  const temp = document.createElement('div');
  temp.innerHTML = html;
  // ç§»é™¤åŒ…å«ç³»çµ±æ–‡å­—çš„å…ƒç´ 
  temp.querySelectorAll('*').forEach(el => {
    const text = el.textContent || '';
    for (const pattern of systemPatterns) {
      if (text.includes(pattern)) {
        el.remove();
        return;
      }
    }
  });
  return temp.innerHTML;
}

function renderBilingualName(htmlTargetId, raw) {
  const el = document.getElementById(htmlTargetId);
  if (!el) return;
  const s = safeText(raw);
  if (!s) { el.textContent = '-'; return; }
  // æ”¯æ´ï¼š
  // - ã€Œå·¦ï½œå³ã€â†’ è‹±æ–‡æ›åˆ°ä¸‹ä¸€åˆ—
  // - ã€Œä¸­æ–‡ï¼ˆè‹±æ–‡ï¼‰ã€/ã€Œä¸­æ–‡(è‹±æ–‡)ã€â†’ è‹±æ–‡æ›åˆ°ä¸‹ä¸€åˆ—
  const parts = s.split(/\s*ï½œ\s*/);
  if (parts.length >= 2) {
    const left = parts[0] || '';
    const right = parts.slice(1).join(' ï½œ ');
    el.innerHTML = `${left}<span class="en">${right}</span>`;
    return;
  }
  const m = s.match(/^(.+?)\s*[ï¼ˆ(]\s*([^)ï¼‰]+)\s*[)ï¼‰]\s*$/);
  if (m) {
    el.innerHTML = `${m[1].trim()}<span class="en">${m[2].trim()}</span>`;
    return;
  }
  el.textContent = s;
}

async function applyAssets(pj) {
  try {
    if (pj.logoPath) {
      const u = await UVACO_CLOUD.getSignedAssetUrl(String(pj.logoPath), { bucket: 'card-assets', expiresIn: 3600 });
      if (u && u.url) document.getElementById('viewerLogo')?.setAttribute('src', u.url);
    } else if (pj.logoSrc) {
      document.getElementById('viewerLogo')?.setAttribute('src', String(pj.logoSrc));
    }
  } catch (e) {}

  try {
    if (pj.avatarPath) {
      const u = await UVACO_CLOUD.getSignedAssetUrl(String(pj.avatarPath), { bucket: 'card-assets', expiresIn: 3600 });
      if (u && u.url) document.getElementById('viewerAvatar')?.setAttribute('src', u.url);
    } else if (pj.avatarSrc) {
      document.getElementById('viewerAvatar')?.setAttribute('src', String(pj.avatarSrc));
    }
  } catch (e) {}
}

function applyCompanyInfo(pj) {
  const section = document.getElementById('companyInfoSection');
  if (!section) return;
  let html = String(pj.companyInfoHtml || '').trim();
  if (!html) {
    section.style.display = 'none';
    return;
  }
  // éæ¿¾ç³»çµ±ä½”ä½æ–‡å­—
  html = filterSystemHtml(html);
  if (!html.trim()) {
    section.style.display = 'none';
    return;
  }
  section.innerHTML = html;
  // å±•ç¤ºé ï¼šç§»é™¤ç·¨è¼¯ç”¨æŒ‰éˆ•ï¼ˆä¾‹å¦‚ã€Œ+ æ–°å¢å…¬å¸è³‡è¨Šã€ï¼‰
  try {
    section.querySelectorAll('.edit-add-btn').forEach(btn => btn.remove());
    // é †ä¾¿ç§»é™¤ä»»ä½• contenteditable/onclickï¼ˆé¿å…åœ¨å±•ç¤ºé ä»å¯é»æ“Šç·¨è¼¯ï¼‰
    section.querySelectorAll('[contenteditable="true"]').forEach(el => el.removeAttribute('contenteditable'));
    section.querySelectorAll('.edit-clickable').forEach(el => el.removeAttribute('onclick'));
  } catch (e) {}
  section.style.display = 'block';
}

function applyContacts(pj, card) {
  const group = document.getElementById('viewerContacts');
  if (!group) return;
  group.innerHTML = '';
  
  let html = String(pj.contactsHtml || '').trim();
  if (html) {
    // éæ¿¾ç³»çµ±ä½”ä½æ–‡å­—
    html = filterSystemHtml(html);
    group.innerHTML = html;
    // å±•ç¤ºé ï¼šç§»é™¤ç·¨è¼¯ç”¨çš„åˆªé™¤æŒ‰éˆ•ï¼ˆé¿å…æŠŠ edit.html çš„ UI å¸¶åˆ° card.htmlï¼‰
    try {
      group.querySelectorAll('.contact-delete-btn').forEach(btn => btn.remove());
      // å±•ç¤ºé ï¼šç§»é™¤ç·¨è¼¯ç”¨æŒ‰éˆ•ï¼ˆä¾‹å¦‚ã€Œ+ æ–°å¢è¯çµ¡æ–¹å¼ã€ï¼‰
      group.querySelectorAll('.edit-add-btn').forEach(btn => btn.remove());
      // ç§»é™¤ contenteditable/onclick
      group.querySelectorAll('[contenteditable="true"]').forEach(el => el.removeAttribute('contenteditable'));
      group.querySelectorAll('.edit-clickable').forEach(el => el.removeAttribute('onclick'));
    } catch (e) {}
  } else {
    // fallbackï¼šåªç”¨ phone/email
    const phone = safeText(card.phone);
    const email = safeText(card.email);

    if (phone) {
      group.insertAdjacentHTML('beforeend', `
        <a class="btn btn-primary lang-zh" href="tel:${phone}">
          <img src="phone-icon.svg" alt="Phone" class="btn-icon-phone"> ç«‹å³ä¾†é›»
        </a>
        <a class="btn btn-primary lang-en" href="tel:${phone}">
          <img src="phone-icon.svg" alt="Phone" class="btn-icon-phone"> Call Now
        </a>
      `);
    }

    if (email) {
      group.insertAdjacentHTML('beforeend', `
        <a class="btn btn-secondary lang-zh" href="mailto:${email}">
          <img src="email-icon.svg" alt="Email" class="btn-icon-email"> å¯„é€ Email
        </a>
        <a class="btn btn-secondary lang-en" href="mailto:${email}">
          <img src="email-icon.svg" alt="Email" class="btn-icon-email"> Send Email
        </a>
      `);
    }
  }

  // ç‰ˆå‹ï¼ˆgrid/listï¼‰
  try {
    const layout = String(pj.contactLayout || '').toLowerCase() === 'grid' ? 'grid' : 'list';
    group.classList.toggle('contact-layout-grid', layout === 'grid');
  } catch (e) {}
}

function openMap(addressType, event) {
  event.stopPropagation();
  event.preventDefault();
  const typeCapitalized = addressType.charAt(0).toUpperCase() + addressType.slice(1);
  const zhEl = document.getElementById(`preview${typeCapitalized}Zh`);
  const enEl = document.getElementById(`preview${typeCapitalized}En`);
  const address = zhEl?.querySelector('.address-text')?.textContent || enEl?.querySelector('.address-text')?.textContent || '';
  if (address && address !== 'ï¼ˆæœªè¨­å®šï¼‰' && address !== 'ï¼ˆNot Setï¼‰') {
    const encodedAddress = encodeURIComponent(address);
    const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
    window.open(mapUrl, '_blank');
}
}

document.addEventListener('DOMContentLoaded', function () {
  (async function () {
    const params = new URLSearchParams(window.location.search || '');
    let userId = params.get('id');
    const nfcCardId = params.get('nfc');
    
    if (!window.UVACO_CLOUD || !UVACO_CLOUD.hasConfig()) {
      alert('å°šæœªè¨­å®š Supabaseï¼ˆè«‹å…ˆè¨­å®š cloud.jsï¼‰');
      return;
    }
    
    // å¦‚æœæ˜¯ NFC å¡ç‰‡é€£çµï¼Œå…ˆæŸ¥è©¢å°æ‡‰çš„ç”¨æˆ¶ ID
    if (nfcCardId && !userId) {
      try {
        const nfcRes = await UVACO_CLOUD.getCardByNfcId(nfcCardId);
        if (nfcRes?.card?.user_id) {
          userId = nfcRes.card.user_id;
          // æ›´æ–° URLï¼ˆä¸é‡æ–°è¼‰å…¥é é¢ï¼‰
          const newUrl = new URL(window.location.href);
          newUrl.searchParams.set('id', userId);
          newUrl.searchParams.delete('nfc');
          window.history.replaceState({}, '', newUrl);
        } else {
          alert('æ­¤ NFC å¡ç‰‡å°šæœªç¶å®šç”¨æˆ¶');
          return;
        }
      } catch (e) {
        console.error('NFC æŸ¥è©¢å¤±æ•—:', e);
        alert('NFC å¡ç‰‡æŸ¥è©¢å¤±æ•—');
        return;
      }
    }
    
    if (!userId) {
      alert('ç¶²å€ç„¡æ•ˆï¼ˆç¼ºå°‘ idï¼‰');
      return;
    }

    let ownerTheme = 1;
    try {
      const res = await UVACO_CLOUD.getCardPublic(userId, { trackView: true });
      const card = res?.card || null;
      if (!card) {
        alert('æ‰¾ä¸åˆ°åç‰‡è³‡æ–™');
        return;
      }

      ownerTheme = parseInt(card.theme || 1, 10) || 1;

      let pj = card.profile_json;
      if (typeof pj === 'string') {
        try { pj = JSON.parse(pj); } catch (e) { pj = null; }
      }
      pj = (pj && typeof pj === 'object') ? pj : {};
  
      const nameZh = (pj.nameZh !== undefined) ? safeText(pj.nameZh) : safeText(card.name);
      const nameEn = (pj.nameEn !== undefined) ? safeText(pj.nameEn) : safeText(card.name);
      const titleZh = (pj.titleZh !== undefined) ? safeText(pj.titleZh) : safeText(card.title);
      const titleEn = (pj.titleEn !== undefined) ? safeText(pj.titleEn) : safeText(card.title);
      const companyZh = (pj.companyZh !== undefined) ? safeText(pj.companyZh) : safeText(card.company);
      const companyEn = (pj.companyEn !== undefined) ? safeText(pj.companyEn) : safeText(card.company);

      renderBilingualName('viewerNameZh', nameZh);
      renderBilingualName('viewerNameEn', nameEn);
      document.getElementById('viewerTitleZh').textContent = titleZh || '-';
      document.getElementById('viewerTitleEn').textContent = titleEn || '-';
      document.getElementById('viewerCompanyStrongZh').textContent = companyZh || '-';
      document.getElementById('viewerCompanyStrongEn').textContent = companyEn || '-';
      
      // å¥—ç”¨å­—é«”æ¨£å¼
      if (pj.fontStyles) {
        const applyFontStyle = (elementId, styleObj, isName) => {
          const el = document.getElementById(elementId);
          if (!el || !styleObj) return;
          
          const sizeMap = isName ? {
            'small': '18px', 'medium': '24px', 'large': '32px'
          } : {
            'small': '12px', 'medium': '16px', 'large': '20px'
          };
          
          if (styleObj.size && sizeMap[styleObj.size]) {
            el.style.fontSize = sizeMap[styleObj.size];
          }
          if (styleObj.weight) {
            el.style.fontWeight = styleObj.weight === 'bold' ? '700' : '400';
          }
          if (styleObj.color) {
            el.style.color = styleObj.color;
          }
        };
        
        applyFontStyle('viewerNameZh', pj.fontStyles.name, true);
        applyFontStyle('viewerNameEn', pj.fontStyles.name, true);
        applyFontStyle('viewerTitleZh', pj.fontStyles.titleZh, false);
        applyFontStyle('viewerTitleEn', pj.fontStyles.titleEn, false);
      }

      // æ¢å¾©è‡ªå®šç¾©æ¨™èªï¼ˆè‹¥æœ‰ï¼‰- éæ¿¾ç³»çµ±ä½”ä½æ–‡å­—
      if (pj.slogansZhHtml) {
        const container = document.getElementById('viewerSlogansZh');
        if (container) {
          container.innerHTML = filterSystemHtml(pj.slogansZhHtml);
          // æ¸…é™¤ç·¨è¼¯æ¨¡å¼å¯èƒ½å¸¶ä¾†çš„å±¬æ€§
          container.querySelectorAll('[contenteditable]').forEach(el => el.removeAttribute('contenteditable'));
          container.querySelectorAll('.slogan-delete-btn').forEach(el => el.remove());
          container.querySelectorAll('.edit-clickable').forEach(el => el.classList.remove('edit-clickable'));
        }
      }
      if (pj.slogansEnHtml) {
        const container = document.getElementById('viewerSlogansEn');
        if (container) {
          container.innerHTML = filterSystemHtml(pj.slogansEnHtml);
          container.querySelectorAll('[contenteditable]').forEach(el => el.removeAttribute('contenteditable'));
          container.querySelectorAll('.slogan-delete-btn').forEach(el => el.remove());
          container.querySelectorAll('.edit-clickable').forEach(el => el.classList.remove('edit-clickable'));
        }
      }

      await applyAssets(pj);
      applyCompanyInfo(pj);
      applyContacts(pj, card);
    } catch (e) {
      console.error(e);
      alert('è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
      // å¥—ç”¨ã€Œè§€çœ‹è€…èƒŒæ™¯ä¸»é¡Œã€+ã€Œåç‰‡ä¸»é¡Œã€çš„è¦å‰‡ï¼ˆèˆ‡ yuyuko.html ä¸€è‡´ï¼‰
      if (typeof initViewerPage === 'function') {
        initViewerPage(ownerTheme);
      } else if (typeof setTheme === 'function') {
        setTheme(ownerTheme);
}
    }
  })();
});

function shareMyCard() {
  const url = window.location.href;
  const title = document.title;
  const text = 'é€™æ˜¯æˆ‘çš„é›»å­åç‰‡ï¼Œè«‹æƒ è³œæŒ‡æ•™ï¼';

  if (navigator.share) {
    navigator.share({
      title: title,
      text: text,
      url: url,
    })
    .catch((error) => console.log('Error sharing', error));
  } else {
    // Fallback for browsers that don't support Web Share API
    copyCardLink();
  }
}

// è¤‡è£½åç‰‡é€£çµ
function copyCardLink() {
  const url = window.location.href;
  const lang = localStorage.getItem('lang') || 'zh';
  
  navigator.clipboard.writeText(url).then(function() {
    // é¡¯ç¤ºæˆåŠŸæç¤º
    showCopyToast(lang === 'zh' ? 'é€£çµå·²è¤‡è£½ï¼' : 'Link copied!');
  }, function(err) {
    console.error('Could not copy text: ', err);
    prompt(lang === 'zh' ? 'è«‹æ‰‹å‹•è¤‡è£½é€£çµï¼š' : 'Please copy manually:', url);
  });
}

// é¡¯ç¤ºè¤‡è£½æˆåŠŸæç¤º
function showCopyToast(message) {
  // ç§»é™¤èˆŠçš„ toast
  const oldToast = document.getElementById('copyToast');
  if (oldToast) oldToast.remove();
  
  // å»ºç«‹æ–°çš„ toast
  const toast = document.createElement('div');
  toast.id = 'copyToast';
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--uvaco-green, #22c55e);
    color: white;
    padding: 12px 24px;
    border-radius: 24px;
    font-size: 14px;
    font-weight: 600;
    z-index: 9999;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    animation: toastFadeIn 0.3s ease;
  `;
  document.body.appendChild(toast);
  
  // 2 ç§’å¾Œç§»é™¤
  setTimeout(() => {
    toast.style.animation = 'toastFadeOut 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 2000);
}

// ç¤¾ç¾¤åˆ†äº«åŠŸèƒ½
function getShareInfo() {
  const url = window.location.href;
  const nameEl = document.getElementById('viewerNameZh');
  const name = nameEl?.textContent?.trim() || 'æ•¸ä½åç‰‡';
  const lang = localStorage.getItem('lang') || 'zh';
  const text = lang === 'zh' 
    ? `${name} çš„æ•¸ä½åç‰‡ï¼Œæ­¡è¿äº¤æµï¼` 
    : `${name}'s Digital Business Card`;
  return { url, name, text };
}

// åˆ†äº«åˆ° LINE
function shareToLine() {
  const { url, text } = getShareInfo();
  const lineUrl = `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
  window.open(lineUrl, '_blank', 'width=600,height=500');
}

// åˆ†äº«åˆ° Facebook
function shareToFacebook() {
  const { url } = getShareInfo();
  const fbUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
  window.open(fbUrl, '_blank', 'width=600,height=500');
}

// åˆ†äº«åˆ° Twitter/X
function shareToTwitter() {
  const { url, text } = getShareInfo();
  const twitterUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
  window.open(twitterUrl, '_blank', 'width=600,height=500');
}

// åˆ†äº«åˆ° Email
function shareToEmail() {
  const { url, text, name } = getShareInfo();
  const lang = localStorage.getItem('lang') || 'zh';
  const subject = lang === 'zh' ? `${name} çš„æ•¸ä½åç‰‡` : `${name}'s Digital Business Card`;
  const body = `${text}\n\n${url}`;
  window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}

// QR Code åŠŸèƒ½
let qrCodeInstance = null;

function showQRCode() {
  const modal = document.getElementById('qrModal');
  const qrcodeContainer = document.getElementById('qrcode');
  const url = window.location.href;
  
  // æ¸…é™¤èˆŠçš„ QR Code
  qrcodeContainer.innerHTML = '';
  
  // ç”Ÿæˆæ–°çš„ QR Code
  qrCodeInstance = new QRCode(qrcodeContainer, {
    text: url,
    width: 220,
    height: 220,
    colorDark: '#000000',
    colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.H
  });
  
  modal.style.display = 'flex';
}

function closeQRModal() {
  document.getElementById('qrModal').style.display = 'none';
}

function downloadQRCode() {
  const qrcodeContainer = document.getElementById('qrcode');
  const canvas = qrcodeContainer.querySelector('canvas');
  const nameEl = document.getElementById('viewerNameZh');
  const cardName = nameEl?.textContent || 'åç‰‡';
  
  if (canvas) {
    // å‰µå»ºä¸€å€‹æ–°çš„ canvas ä¾†æ·»åŠ é‚Šè·å’ŒèƒŒæ™¯
    const newCanvas = document.createElement('canvas');
    const padding = 40;
    newCanvas.width = canvas.width + padding * 2;
    newCanvas.height = canvas.height + padding * 2;
    
    const ctx = newCanvas.getContext('2d');
    // ç™½è‰²èƒŒæ™¯
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, newCanvas.width, newCanvas.height);
    // ç¹ªè£½ QR Code
    ctx.drawImage(canvas, padding, padding);
    
    const link = document.createElement('a');
    link.download = `${cardName}_QRCode.png`;
    link.href = newCanvas.toDataURL('image/png');
    link.click();
  } else {
    // å¦‚æœæ˜¯ img å…ƒç´ 
    const img = qrcodeContainer.querySelector('img');
    if (img) {
      const link = document.createElement('a');
      link.download = `${cardName}_QRCode.png`;
      link.href = img.src;
      link.click();
    }
  }
}

// ===== åŠ å…¥ä¸»ç•«é¢æç¤ºåŠŸèƒ½ =====

// æª¢æŸ¥æ˜¯å¦æ‡‰è©²é¡¯ç¤ºæç¤º
function shouldShowAddHomeBanner() {
  // å·²ç¶“é—œé–‰éï¼Œä¸å†é¡¯ç¤º
  if (localStorage.getItem('addHomeBannerDismissed') === 'true') {
    return false;
  }
  
  // å·²ç¶“æ˜¯ PWA æ¨¡å¼ï¼ˆå·²åŠ å…¥ä¸»ç•«é¢ï¼‰ï¼Œä¸é¡¯ç¤º
  if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
    return false;
  }
  
  return true;
}

// æª¢æŸ¥æ˜¯å¦ç‚ºè‡ªå·±çš„åç‰‡ä¸¦é¡¯ç¤ºæç¤º
async function checkAndShowAddHomeBanner() {
  try {
    if (!shouldShowAddHomeBanner()) return;
    
    // å–å¾— URL ä¸­çš„ id åƒæ•¸
    const urlParams = new URLSearchParams(window.location.search);
    const cardId = urlParams.get('id');
    if (!cardId) return;
    
    // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
    if (!window.UVACO_CLOUD || !UVACO_CLOUD.hasConfig()) return;
    
    const sessionResult = await UVACO_CLOUD.getSession();
    const session = sessionResult && sessionResult.session;
    const user = session && session.user;
    const userId = user ? String(user.id || '').trim() : '';
    
    // åªæœ‰åœ¨æŸ¥çœ‹è‡ªå·±çš„åç‰‡æ™‚æ‰é¡¯ç¤º
    if (userId && cardId === userId) {
      // å»¶é² 2 ç§’å¾Œé¡¯ç¤ºï¼Œé¿å…æ‰“æ“¾ç”¨æˆ¶ç€è¦½
      setTimeout(() => {
        const banner = document.getElementById('addHomeBanner');
        if (banner) {
          banner.classList.add('show');
        }
      }, 2000);
    }
  } catch (e) {
    console.error('æª¢æŸ¥åŠ å…¥ä¸»ç•«é¢æç¤ºå¤±æ•—:', e);
  }
}

// é—œé–‰æç¤ºä¸¦è¨˜ä½é¸æ“‡
function dismissAddHomeBanner() {
  const banner = document.getElementById('addHomeBanner');
  if (banner) {
    banner.classList.remove('show');
  }
  localStorage.setItem('addHomeBannerDismissed', 'true');
}

// é¡¯ç¤ºåŠ å…¥ä¸»ç•«é¢èªªæ˜
function showAddHomeInstructions() {
  const lang = localStorage.getItem('lang') || 'zh';
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  const isAndroid = /Android/.test(navigator.userAgent);
  
  let instructions = '';
  
  if (lang === 'zh') {
    if (isIOS) {
      instructions = `ğŸ“± iOS åŠ å…¥ä¸»ç•«é¢æ­¥é©Ÿï¼š

1. é»æ“Šç€è¦½å™¨åº•éƒ¨çš„ã€Œåˆ†äº«ã€æŒ‰éˆ• (æ–¹å½¢+ç®­é ­åœ–ç¤º)
2. å‘ä¸‹æ»‘å‹•æ‰¾åˆ°ã€ŒåŠ å…¥ä¸»ç•«é¢ã€
3. é»æ“Šã€Œæ–°å¢ã€ç¢ºèª

å®Œæˆå¾Œï¼Œä¸»ç•«é¢æœƒå‡ºç¾ã€Œæˆ‘çš„åç‰‡ã€åœ–ç¤ºï¼Œé»æ“Šå³å¯å¿«é€Ÿé–‹å•Ÿæ‚¨çš„åç‰‡ï¼`;
    } else if (isAndroid) {
      instructions = `ğŸ“± Android åŠ å…¥ä¸»ç•«é¢æ­¥é©Ÿï¼š

1. é»æ“Šç€è¦½å™¨å³ä¸Šè§’çš„ã€Œé¸å–®ã€(â‹®)
2. é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€æˆ–ã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ã€
3. é»æ“Šã€Œæ–°å¢ã€ç¢ºèª

å®Œæˆå¾Œï¼Œä¸»ç•«é¢æœƒå‡ºç¾ã€Œæˆ‘çš„åç‰‡ã€åœ–ç¤ºï¼Œé»æ“Šå³å¯å¿«é€Ÿé–‹å•Ÿæ‚¨çš„åç‰‡ï¼`;
    } else {
      instructions = `ğŸ“± åŠ å…¥ä¸»ç•«é¢æ­¥é©Ÿï¼š

1. åœ¨ç€è¦½å™¨ä¸­æ‰¾åˆ°ã€Œåˆ†äº«ã€æˆ–ã€Œé¸å–®ã€æŒ‰éˆ•
2. é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€æˆ–ã€Œå®‰è£ã€
3. ç¢ºèªæ–°å¢

å®Œæˆå¾Œï¼Œä¸»ç•«é¢æœƒå‡ºç¾ã€Œæˆ‘çš„åç‰‡ã€åœ–ç¤ºï¼`;
    }
  } else {
    if (isIOS) {
      instructions = `ğŸ“± iOS - Add to Home Screen:

1. Tap the "Share" button at the bottom (square with arrow)
2. Scroll down and tap "Add to Home Screen"
3. Tap "Add" to confirm

Done! You'll see "My Card" icon on your home screen.`;
    } else if (isAndroid) {
      instructions = `ğŸ“± Android - Add to Home Screen:

1. Tap the menu button (â‹®) in the browser
2. Select "Add to Home Screen" or "Install App"
3. Tap "Add" to confirm

Done! You'll see "My Card" icon on your home screen.`;
    } else {
      instructions = `ğŸ“± Add to Home Screen:

1. Find the "Share" or "Menu" button in your browser
2. Select "Add to Home Screen" or "Install"
3. Confirm

Done! You'll see the icon on your home screen.`;
    }
  }
  
  alert(instructions);
  dismissAddHomeBanner();
}

// é é¢è¼‰å…¥å¾Œæª¢æŸ¥æ˜¯å¦é¡¯ç¤ºæç¤º
document.addEventListener('DOMContentLoaded', function() {
  // å»¶é²åŸ·è¡Œï¼Œç­‰å¾…é é¢è³‡æ–™è¼‰å…¥
  setTimeout(checkAndShowAddHomeBanner, 1000);
});
</script>

</body>
</html>
