<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<!-- Sentry éŒ¯èª¤ç›£æ§ SDK -->
<script src="https://browser.sentry-cdn.com/7.100.0/bundle.min.js" crossorigin="anonymous"></script>
<title>è¨­å®š | Settings - æ•¸ä½èº«åˆ†å¹³å°</title>
<link rel="stylesheet" href="styles.css?v=20260105">
<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#22c55e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="æ•¸ä½èº«åˆ†">
<link rel="apple-touch-icon" href="icon-192.svg">
<style>
body {
  padding-bottom: 0;
}
.settings-page {
  width: 100%;
  max-width: 600px; /* åŠ å¤§å¯¬åº¦ä»¥å®¹ç´æ©«å‘ä½ˆå±€ */
  margin: 0 auto;
  min-height: 100vh;
  padding: 20px;
  padding-top: 80px;
  padding-bottom: 100px; /* ç‚ºåº•éƒ¨å°èˆªæ¬„ç•™å‡ºç©ºé–“ */
}

/* èªè¨€å’Œä¸»é¡Œè¨­å®šé …ç›®æ©«å‘æ’åˆ— */
.settings-theme-item {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 16px !important;
}

.settings-theme-item .settings-item-content {
  flex: 0 0 auto;
}

.settings-theme-item .settings-item-title {
  font-size: 15px;
  font-weight: 600;
  line-height: 1.4;
  white-space: nowrap;
}

.settings-theme-buttons {
  display: flex;
  flex-direction: row;
  gap: 8px;
  flex-shrink: 0;
}

.settings-theme-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 8px 16px;
  white-space: nowrap;
  min-width: 60px;
}

.settings-theme-btn-text {
  font-size: 14px;
  font-weight: 500;
}

</style>
</head>

<body class="theme-dark lang-zh">

<!-- èƒŒæ™¯æ³¡æ³¡ -->
<div class="bg-blob blob1"></div>
<div class="bg-blob blob2"></div>

<!-- è¨­å®šé é¢å…§å®¹ -->
<div class="settings-page">
  <div class="settings-panel">
    <div class="settings-header">
      <h2 class="settings-title lang-zh">è¨­å®š</h2>
      <h2 class="settings-title lang-en">Settings</h2>
      <a href="directory.html" class="settings-close">âœ•</a>
    </div>
    
    <div class="settings-menu">
      <!-- è¨‚é–±ç®¡ç† -->
      <a href="subscription.html" class="settings-item">
        <div class="settings-item-icon">ğŸ’</div>
        <div class="settings-item-content">
          <div class="settings-item-title lang-zh">è¨‚é–±ç®¡ç†</div>
          <div class="settings-item-title lang-en">Subscription</div>
          <div class="settings-item-subtitle lang-zh">æŸ¥çœ‹è¨‚é–±ç‹€æ…‹èˆ‡æ¨è–¦çå‹µ</div>
          <div class="settings-item-subtitle lang-en">View subscription status & referral rewards</div>
        </div>
        <div class="settings-item-arrow">â†’</div>
      </a>
      
      <!-- ç·¨è¼¯åç‰‡ï¼šç›´æ¥é€²å…¥ edit.htmlï¼ˆå¸¶ uid/nextï¼Œç¢ºä¿å¯ç·¨è¼¯ä¸”ä¸€å®šæ˜¯æœ¬äººï¼‰ -->
      <a href="edit.html" class="settings-item" onclick="return gotoMyEdit(event)">
        <div class="settings-item-icon">âœï¸</div>
        <div class="settings-item-content">
          <div class="settings-item-title lang-zh">ç·¨è¼¯åç‰‡</div>
          <div class="settings-item-title lang-en">Edit Business Card</div>
          <div class="settings-item-subtitle lang-zh">ç·¨è¼¯åç‰‡å…§å®¹</div>
          <div class="settings-item-subtitle lang-en">Edit business card content</div>
        </div>
        <div class="settings-item-arrow">â†’</div>
      </a>
      
      <!-- ç®¡ç†å¾Œå°ï¼ˆåªå°ç®¡ç†å“¡é¡¯ç¤ºï¼‰ -->
      <a href="admin.html" class="settings-item" id="adminBackendLink" style="display: none;">
        <div class="settings-item-icon">âš™ï¸</div>
        <div class="settings-item-content">
          <div class="settings-item-title lang-zh">ç®¡ç†å¾Œå°</div>
          <div class="settings-item-title lang-en">Management Backend</div>
          <div class="settings-item-subtitle lang-zh">ä¼æ¥­ç®¡ç†å¾Œå°</div>
          <div class="settings-item-subtitle lang-en">Enterprise management backend</div>
        </div>
        <div class="settings-item-arrow">â†’</div>
      </a>
      
      <!-- åŒ¯å…¥è¯çµ¡äºº -->
      <!-- åŒ¯å…¥è¯çµ¡äººï¼šå·²æ•´åˆåˆ°ã€Œå¹³å°é€šè¨ŠéŒ„ â†’ æ–°å¢å¥½å‹ã€ä¸­ -->
      
      <!-- èªè¨€è¨­å®š -->
      <div class="settings-item settings-theme-item">
        <div class="settings-item-content">
          <div class="settings-item-title lang-zh">èªè¨€è¨­å®š</div>
          <div class="settings-item-title lang-en">Language</div>
        </div>
        <div class="settings-theme-buttons">
          <button class="settings-theme-btn" id="langZhBtn" onclick="setLang('zh')">
            <span class="settings-theme-btn-text lang-zh">ä¸­æ–‡</span>
            <span class="settings-theme-btn-text lang-en">Chinese</span>
          </button>
          <button class="settings-theme-btn" id="langEnBtn" onclick="setLang('en')">
            <span class="settings-theme-btn-text lang-zh">è‹±æ–‡</span>
            <span class="settings-theme-btn-text lang-en">English</span>
          </button>
        </div>
      </div>

      <!-- ç³»çµ±è³‡è¨Š (User ID) - åƒ…ç®¡ç†å“¡å¯è¦‹ -->
      <div class="settings-item" id="userIdItem" onclick="copyMyUserId()" style="display: none; background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3);">
        <div class="settings-item-icon">ğŸ†”</div>
        <div class="settings-item-content">
          <div class="settings-item-title lang-zh">ä½¿ç”¨è€… IDï¼ˆé»æ“Šè¤‡è£½ï¼‰</div>
          <div class="settings-item-title lang-en">User ID (Click to copy)</div>
          <div class="settings-item-subtitle" id="myUserIdDisplay" style="font-family: monospace; font-size: 11px; word-break: break-all; color: #22c55e;">è¼‰å…¥ä¸­...</div>
        </div>
        <div class="settings-item-arrow">ğŸ“‹</div>
      </div>
      
      <!-- åç‰‡ç€è¦½çµ±è¨ˆ -->
      <div class="settings-item" id="viewStatsItem" style="display: none; background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3);">
        <div class="settings-item-icon">ğŸ“Š</div>
        <div class="settings-item-content">
          <div class="settings-item-title lang-zh">åç‰‡ç€è¦½çµ±è¨ˆ</div>
          <div class="settings-item-title lang-en">Card View Statistics</div>
          <div class="settings-item-subtitle" id="viewStatsDisplay" style="color: #3b82f6;">è¼‰å…¥ä¸­...</div>
        </div>
      </div>
      
      <!-- é‚€è«‹å¥½å‹ -->
      <div class="settings-item" onclick="shareInviteLink()" id="inviteLinkItem" style="display: none; background: rgba(168,85,247,0.1); border: 1px solid rgba(168,85,247,0.3);">
        <div class="settings-item-icon">ğŸ”—</div>
        <div class="settings-item-content">
          <div class="settings-item-title lang-zh">é‚€è«‹å¥½å‹ï¼ˆé»æ“Šåˆ†äº«ï¼‰</div>
          <div class="settings-item-title lang-en">Invite Friends (Tap to share)</div>
          <div class="settings-item-subtitle" id="inviteLinkDisplay" style="color: #a855f7; font-size: 11px;">è¼‰å…¥ä¸­...</div>
        </div>
        <div class="settings-item-arrow">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="#a855f7">
            <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/>
          </svg>
        </div>
      </div>
      
      <!-- æ¨è–¦çµ±è¨ˆ -->
      <div class="settings-item" id="referralStatsItem" style="display: none; background: rgba(236,72,153,0.1); border: 1px solid rgba(236,72,153,0.3);">
        <div class="settings-item-icon">ğŸ‘¥</div>
        <div class="settings-item-content">
          <div class="settings-item-title lang-zh">æ¨è–¦æˆæœ</div>
          <div class="settings-item-title lang-en">Referral Results</div>
          <div class="settings-item-subtitle" id="referralStatsDisplay" style="color: #ec4899;">è¼‰å…¥ä¸­...</div>
        </div>
      </div>
      
      <!-- ç®¡ç†å“¡ç‹€æ…‹æª¢æŸ¥ -->
      <div class="settings-item" id="adminStatusItem" style="display: none;">
        <div class="settings-item-icon">ğŸ‘‘</div>
        <div class="settings-item-content">
          <div class="settings-item-title lang-zh">ç®¡ç†å“¡ç‹€æ…‹</div>
          <div class="settings-item-title lang-en">Admin Status</div>
          <div class="settings-item-subtitle" id="adminStatusDisplay">æª¢æŸ¥ä¸­...</div>
        </div>
      </div>
      
      <!-- æœå‹™è³‡è¨Šåˆ†éš”ç·š -->
      <div style="margin: 20px 0 12px 0; padding: 0 4px;">
        <div style="font-size: 12px; color: #9ca3af; font-weight: 600; letter-spacing: 0.5px;">
          <span class="lang-zh">æœå‹™è³‡è¨Š</span>
          <span class="lang-en">Service Info</span>
        </div>
      </div>
      
      <!-- LINE å®˜æ–¹å¸³è™Ÿå®¢æœ -->
      <a href="https://line.me/R/ti/p/@632nedvu" target="_blank" class="settings-item" style="background: rgba(6,199,85,0.1); border: 1px solid rgba(6,199,85,0.3);">
        <div class="settings-item-icon">
          <img src="line-logo.svg" alt="LINE" style="width: 24px; height: 24px;">
        </div>
        <div class="settings-item-content">
          <div class="settings-item-title lang-zh">è¯ç¹«å®¢æœ</div>
          <div class="settings-item-title lang-en">Contact Support</div>
          <div class="settings-item-subtitle" style="color: #06c755;">
            <span class="lang-zh">LINE å®˜æ–¹å¸³è™Ÿï¼š@632nedvu</span>
            <span class="lang-en">LINE Official: @632nedvu</span>
          </div>
        </div>
        <div class="settings-item-arrow">â†’</div>
      </a>

      <!-- ç™»å‡º -->
      <div class="settings-item" onclick="handleLogout()">
        <div class="settings-item-icon">ğŸšª</div>
        <div class="settings-item-content">
          <div class="settings-item-title lang-zh">ç™»å‡º</div>
          <div class="settings-item-title lang-en">Logout</div>
          <div class="settings-item-subtitle lang-zh">ç™»å‡ºç³»çµ±</div>
          <div class="settings-item-subtitle lang-en">Sign out from system</div>
        </div>
        <div class="settings-item-arrow">â†’</div>
      </div>

      
    </div>
  </div>
</div>

<!-- åº•éƒ¨å°èˆªæ¬„ -->
<nav class="bottom-nav">
  <a href="#" class="nav-item primary" id="navMyCard" onclick="gotoMyCard(event)">
    <span class="nav-icon">ğŸ‘¤</span>
    <span class="nav-label lang-zh">æˆ‘çš„åç‰‡</span>
    <span class="nav-label lang-en">My Card</span>
  </a>
  <a href="directory.html" class="nav-item">
    <span class="nav-icon">ğŸ“‹</span>
    <span class="nav-label lang-zh">é€šè¨ŠéŒ„</span>
    <span class="nav-label lang-en">Directory</span>
  </a>
  <a href="settings.html" class="nav-item active">
    <span class="nav-icon">âš™ï¸</span>
    <span class="nav-label lang-zh">è¨­å®š</span>
    <span class="nav-label lang-en">Settings</span>
  </a>
</nav>

<script src="supabase.min.js"></script>
<script src="cloud.js?v=20260127"></script>
<script src="common.js?v=20260126"></script>
<script>
// å‰å¾€ã€Œæˆ‘çš„åç‰‡ã€é é¢
async function gotoMyCard(event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  try {
    if (!window.UVACO_CLOUD || !UVACO_CLOUD.hasConfig()) {
      window.location.href = 'auth.html?next=settings.html';
      return false;
    }
    const s = await UVACO_CLOUD.getSession();
    const uid = s && s.session && s.session.user ? String(s.session.user.id || '').trim() : '';
    if (!uid) {
      window.location.href = 'auth.html?next=settings.html';
      return false;
    }
    window.location.href = 'card.html?id=' + encodeURIComponent(uid);
    return false;
  } catch (e) {
    window.location.href = 'auth.html?next=settings.html';
    return false;
  }
}

async function initUserId() {
  try {
    if (window.UVACO_CLOUD) {
      const s = await UVACO_CLOUD.getSession();
      const uid = s.session ? s.session.user.id : 'å°šæœªç™»å…¥';
      document.getElementById('myUserIdDisplay').textContent = uid;
      
      // è¼‰å…¥ç€è¦½çµ±è¨ˆ
      if (s.session && uid && UVACO_CLOUD.getCardViewStats) {
        loadViewStats(uid);
      }
      
      // è¼‰å…¥é‚€è«‹é€£çµ
      if (s.session && uid) {
        loadInviteLink(uid);
        loadReferralStats();
      }
      
      // æª¢æŸ¥ç®¡ç†å“¡ç‹€æ…‹ - åƒ…ã€Œè¶…ç´šç®¡ç†å“¡ã€å¯è¦‹ä»¥ä¸‹ä¸‰å€‹é …ç›®
      if (s.session && UVACO_CLOUD.isAdmin) {
        const adminStatus = await UVACO_CLOUD.isAdmin();
        const statusItem = document.getElementById('adminStatusItem');
        const statusDisplay = document.getElementById('adminStatusDisplay');
        const adminLink = document.getElementById('adminBackendLink');
        const userIdItem = document.getElementById('userIdItem');
        
        // åªæœ‰ã€Œè¶…ç´šç®¡ç†å“¡ã€æ‰é¡¯ç¤ºé€™ä¸‰å€‹é …ç›®ï¼ˆä¼æ¥­ç®¡ç†å“¡ä¸é¡¯ç¤ºï¼‰
        const isSuperAdmin = adminStatus && adminStatus.isAdmin && !adminStatus.managedCompany;
        
        if (isSuperAdmin) {
          // é¡¯ç¤ºç®¡ç†å¾Œå°é€£çµ
          if (adminLink) adminLink.style.display = 'flex';
          // é¡¯ç¤ºä½¿ç”¨è€… ID
          if (userIdItem) userIdItem.style.display = 'flex';
          // é¡¯ç¤ºç®¡ç†å“¡ç‹€æ…‹
          if (statusItem) statusItem.style.display = 'flex';
          
          if (statusDisplay) {
            statusDisplay.innerHTML = '<span style="color:#22c55e;">âœ“ è¶…ç´šç®¡ç†å“¡</span>';
          }
        }
        // ä¼æ¥­ç®¡ç†å“¡å’Œä¸€èˆ¬ç”¨æˆ¶ï¼šé€™ä¸‰å€‹é …ç›®ä¿æŒéš±è—ï¼ˆé è¨­ display: noneï¼‰
      }
    }
  } catch (e) {
    document.getElementById('myUserIdDisplay').textContent = 'Error';
    console.error('initUserId error:', e);
  }
}

function copyMyUserId() {
  const uid = document.getElementById('myUserIdDisplay').textContent;
  if (uid && uid !== '...' && uid !== 'å°šæœªç™»å…¥') {
    navigator.clipboard.writeText(uid).then(() => {
      alert('User ID å·²è¤‡è£½ï¼š' + uid);
    });
  }
}

// è¼‰å…¥ç€è¦½çµ±è¨ˆ
async function loadViewStats(userId) {
  const statsItem = document.getElementById('viewStatsItem');
  const statsDisplay = document.getElementById('viewStatsDisplay');
  
  try {
    const stats = await UVACO_CLOUD.getCardViewStats(userId);
    if (stats && stats.count !== undefined) {
      statsItem.style.display = 'flex';
      
      // è¨ˆç®—æœ€è¿‘ 7 å¤©çš„ç€è¦½æ•¸
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      const recentViews = (stats.views || []).filter(v => new Date(v.viewed_at) > sevenDaysAgo).length;
      
      const savedLang = localStorage.getItem('lang') || 'zh';
      if (savedLang === 'zh') {
        statsDisplay.innerHTML = `<strong>${stats.count}</strong> æ¬¡ç¸½ç€è¦½<br><small>è¿‘ 7 å¤©ï¼š${recentViews} æ¬¡</small>`;
      } else {
        statsDisplay.innerHTML = `<strong>${stats.count}</strong> total views<br><small>Last 7 days: ${recentViews}</small>`;
      }
    }
  } catch (e) {
    console.log('[ViewStats] ç„¡æ³•è¼‰å…¥ç€è¦½çµ±è¨ˆï¼ˆcard_views è¡¨å¯èƒ½å°šæœªå»ºç«‹ï¼‰');
    // ä¸é¡¯ç¤ºéŒ¯èª¤ï¼Œåªæ˜¯éš±è—çµ±è¨ˆå€å¡Š
    statsItem.style.display = 'none';
  }
}

// è¼‰å…¥é‚€è«‹é€£çµ
let myInviteLink = '';
function loadInviteLink(userId) {
  if (!UVACO_CLOUD.generateInviteLink) return;
  
  const inviteItem = document.getElementById('inviteLinkItem');
  const inviteDisplay = document.getElementById('inviteLinkDisplay');
  
  myInviteLink = UVACO_CLOUD.generateInviteLink(userId);
  inviteItem.style.display = 'flex';
  
  // é¡¯ç¤ºç¸®çŸ­ç‰ˆçš„é€£çµ
  const shortLink = myInviteLink.length > 50 ? myInviteLink.substring(0, 47) + '...' : myInviteLink;
  inviteDisplay.textContent = shortLink;
}

// åˆ†äº«é‚€è«‹é€£çµï¼ˆå„ªå…ˆä½¿ç”¨ç³»çµ±åˆ†äº«ä»‹é¢ï¼‰
async function shareInviteLink() {
  if (!myInviteLink) return;
  
  const savedLang = localStorage.getItem('lang') || 'zh';
  const shareData = {
    title: savedLang === 'zh' ? 'åŠ å…¥æ•¸ä½èº«åˆ†å¹³å°' : 'Join Digital Identity Platform',
    text: savedLang === 'zh' 
      ? 'æˆ‘é‚€è«‹ä½ åŠ å…¥æ•¸ä½èº«åˆ†å¹³å°ï¼Œä¸€èµ·å»ºç«‹å°ˆå±¬é›»å­åç‰‡ï¼' 
      : 'I invite you to join the Digital Identity Platform!',
    url: myInviteLink
  };
  
  // å„ªå…ˆä½¿ç”¨ç³»çµ±åˆ†äº«ï¼ˆæ”¯æ´ LINEã€è¨Šæ¯ã€Email ç­‰ï¼‰
  if (navigator.share) {
    try {
      await navigator.share(shareData);
      return;
    } catch (err) {
      // ç”¨æˆ¶å–æ¶ˆåˆ†äº«ï¼Œç›´æ¥è¿”å›
      if (err.name === 'AbortError') return;
      // å…¶ä»–éŒ¯èª¤ï¼Œfallback åˆ°è¤‡è£½
      console.log('Share failed, fallback to copy:', err);
    }
  }
  
  // Fallback: è¤‡è£½åˆ°å‰ªè²¼ç°¿
  try {
    await navigator.clipboard.writeText(myInviteLink);
    alert(savedLang === 'zh' 
      ? 'é‚€è«‹é€£çµå·²è¤‡è£½ï¼\nåˆ†äº«çµ¦æœ‹å‹å³å¯é‚€è«‹ä»–å€‘åŠ å…¥ã€‚' 
      : 'Invite link copied!\nShare with friends to invite them.');
  } catch (err) {
    prompt(savedLang === 'zh' ? 'è«‹æ‰‹å‹•è¤‡è£½é€£çµï¼š' : 'Please copy the link:', myInviteLink);
  }
}

// ä¿ç•™èˆŠå‡½æ•¸åç¨±ä»¥é˜²å…¶ä»–åœ°æ–¹èª¿ç”¨
function copyInviteLink() {
  shareInviteLink();
}

// è¼‰å…¥æ¨è–¦çµ±è¨ˆ
async function loadReferralStats() {
  if (!UVACO_CLOUD.getMyReferralCount) return;
  
  const statsItem = document.getElementById('referralStatsItem');
  const statsDisplay = document.getElementById('referralStatsDisplay');
  
  try {
    const result = await UVACO_CLOUD.getMyReferralCount();
    const count = result.count || 0;
    
    statsItem.style.display = 'flex';
    
    const savedLang = localStorage.getItem('lang') || 'zh';
    if (savedLang === 'zh') {
      statsDisplay.innerHTML = `å·²æˆåŠŸé‚€è«‹ <strong>${count}</strong> ä½å¥½å‹åŠ å…¥`;
    } else {
      statsDisplay.innerHTML = `Successfully invited <strong>${count}</strong> friends`;
    }
  } catch (e) {
    console.log('[Referral] ç„¡æ³•è¼‰å…¥æ¨è–¦çµ±è¨ˆ');
    statsItem.style.display = 'none';
  }
}

// ç™»å‡ºè™•ç†
function handleLogout() {
  if (confirm('ç¢ºå®šè¦ç™»å‡ºç³»çµ±å—ï¼Ÿ\nAre you sure you want to logout?')) {
    if (window.UVACO_CLOUD) {
      UVACO_CLOUD.clearCustomJwt();
    } else {
      // Fallback if cloud.js not loaded
      try { localStorage.removeItem('UVACO_CUSTOM_JWT'); } catch (e) {}
    }
    // å›åˆ°é¦–é ï¼ˆæœƒè‡ªå‹•åˆ¤æ–·æ˜¯å¦éœ€ç™»å…¥ï¼‰
    window.location.replace('index.html');
  }
}

// å‰å¾€ã€Œæˆ‘çš„ç·¨è¼¯é ã€ï¼šä¸€å¾‹å¸¶ uid/nextï¼Œç¢ºä¿ç·¨è¼¯åˆ°è‡ªå·±çš„åç‰‡
async function gotoMyEdit(event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  try {
    if (!window.UVACO_CLOUD || !UVACO_CLOUD.hasConfig()) {
      window.location.href = 'edit.html';
      return false;
    }
    const s = await UVACO_CLOUD.getSession();
    const uid = s && s.session && s.session.user ? String(s.session.user.id || '').trim() : '';
    if (!uid) {
      window.location.href = 'auth.html?next=' + encodeURIComponent('settings.html');
      return false;
    }
    const next = 'card.html?id=' + encodeURIComponent(uid);
    window.location.href = 'edit.html?uid=' + encodeURIComponent(uid) + '&next=' + encodeURIComponent(next);
    return false;
  } catch (e) {
    window.location.href = 'edit.html';
    return false;
  }
}

// è™•ç†è¨­å®šé¸é …é»æ“Š
function handleSettingsClick(action) {
  const zhElements = document.querySelectorAll('.lang-zh');
  const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';
  
  const messages = {
    'edit': { zh: 'ç·¨è¼¯åç‰‡åŠŸèƒ½é–‹ç™¼ä¸­', en: 'Edit card feature coming soon' },
    'admin': { zh: 'ç®¡ç†å¾Œå°åŠŸèƒ½é–‹ç™¼ä¸­', en: 'Admin backend feature coming soon' },
    'import': { zh: 'åŒ¯å…¥è¯çµ¡äººå·²æ•´åˆåˆ°å¹³å°é€šè¨ŠéŒ„çš„ã€Œæ–°å¢å¥½å‹ã€ä¸­', en: 'Import contacts is now inside Platform Directory â†’ Add Friend' }
  };
  
  const msg = messages[action] ? messages[action][currentLang] : (currentLang === 'zh' ? 'åŠŸèƒ½é–‹ç™¼ä¸­' : 'Feature coming soon');
  alert(msg);
}

// æ›´æ–°è¨­å®šé é¢çš„èªè¨€æŒ‰éˆ•ç‹€æ…‹
function updateSettingsLangButtons() {
  const zhBtn = document.getElementById('langZhBtn');
  const enBtn = document.getElementById('langEnBtn');
  
  if (zhBtn && enBtn) {
    const zhElements = document.querySelectorAll('.lang-zh');
    const isZh = zhElements.length > 0 && zhElements[0].style.display !== 'none';
    
    zhBtn.classList.remove('active');
    enBtn.classList.remove('active');
    
    if (isZh) {
      zhBtn.classList.add('active');
    } else {
      enBtn.classList.add('active');
    }
  }
}


// è¦†å¯« setLang å‡½æ•¸ä»¥æ›´æ–°è¨­å®šé é¢çš„èªè¨€æŒ‰éˆ•
// ç¢ºä¿åœ¨ common.js è¼‰å…¥å¾ŒåŸ·è¡Œ
(function() {
  function setupSetLangOverride() {
    if (typeof window.setLang === 'function') {
      const originalSetLang = window.setLang;
      window.setLang = function(lang) {
        // å…ˆèª¿ç”¨åŸå§‹å‡½æ•¸ï¼ˆå®ƒæœƒæ›´æ–° body class å’Œæ‰€æœ‰å…ƒç´ ï¼‰
        originalSetLang(lang);
        
        // å»¶é²ä¸€ä¸‹ç¢ºä¿ DOM å·²æ›´æ–°
        setTimeout(function() {
          updateSettingsLangButtons();
          
          // å†æ¬¡ç¢ºä¿æ‰€æœ‰å…ƒç´ éƒ½æ­£ç¢ºé¡¯ç¤º/éš±è—ï¼ˆé›™é‡ä¿éšªï¼‰
          // ç‰¹åˆ¥é‡å° settings-panel å…§çš„å…ƒç´ 
          const allZhElements = document.querySelectorAll('.lang-zh');
          const allEnElements = document.querySelectorAll('.lang-en');
          const isZh = lang === 'zh';
          
          allZhElements.forEach(el => {
            el.style.display = isZh ? 'block' : 'none';
          });
          allEnElements.forEach(el => {
            el.style.display = isZh ? 'none' : 'block';
          });
          
          // ç¢ºä¿ settings-panel å’Œ settings-menu å®¹å™¨å¯è¦‹
          const settingsPanel = document.querySelector('.settings-panel');
          const settingsMenu = document.querySelector('.settings-menu');
          if (settingsPanel) {
            settingsPanel.style.display = 'block';
          }
          if (settingsMenu) {
            settingsMenu.style.display = 'flex';
          }
        }, 50);
      };
      return true;
    }
    return false;
  }
  
  // å˜—è©¦ç«‹å³è¨­ç½®
  if (!setupSetLangOverride()) {
    // å¦‚æœå¤±æ•—ï¼Œç­‰å¾… DOM è¼‰å…¥
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(setupSetLangOverride, 100);
      });
    } else {
      setTimeout(setupSetLangOverride, 100);
    }
  }
})();


// é é¢è¼‰å…¥æ™‚æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ä¸¦ç¢ºä¿èªè¨€æ­£ç¢ºé¡¯ç¤º
function initSettingsPage() {
  // é¡¯ç¤º User ID
  initUserId();

  // ç¢ºä¿èªè¨€åˆ‡æ›æ­£ç¢º
  const savedLang = localStorage.getItem('lang') || 'zh';
  if (typeof setLang === 'function') {
    // é‡æ–°æ‡‰ç”¨èªè¨€è¨­å®šï¼Œç¢ºä¿æ‰€æœ‰å…ƒç´ æ­£ç¢ºé¡¯ç¤º
    setLang(savedLang);
  }
  
  setTimeout(function() {
    updateSettingsLangButtons();
  }, 100);
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initSettingsPage);
} else {
  initSettingsPage();
}
</script>

</body>
</html>

