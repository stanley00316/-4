<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- 防止瀏覽器快取（GitHub Pages / 本機測試皆可能被快取舊版 HTML/CSS/JS） -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>LINE 登入 | LINE Login - UVACO</title>
  <link rel="stylesheet" href="styles.css?v=20260105">
  <style>
    body { padding-bottom: 0; }
    .auth-page { width: 100%; max-width: 520px; margin: 0 auto; padding: 20px; padding-top: 90px; }
    .auth-card { border-radius: 20px; padding: 22px; }
    body.theme-dark .auth-card { background: rgba(22,22,24,0.85); border: 1px solid rgba(255,255,255,0.08); }
    body.theme-light .auth-card { background: #fff; border: 1px solid rgba(15,23,42,0.08); }
    .auth-title { font-size: 22px; font-weight: 800; color: var(--uvaco-green); margin-bottom: 8px; }
    .auth-desc { font-size: 14px; line-height: 1.7; color: #9ca3af; margin-bottom: 14px; }
    body.theme-light .auth-desc { color: #6b7280; }
    .auth-input { width: 100%; padding: 12px 14px; border-radius: 12px; font-size: 15px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color: #fff; box-sizing: border-box; }
    body.theme-light .auth-input { background: #fff; border-color: rgba(15,23,42,0.12); color: #111827; }
    .auth-btn { width: 100%; padding: 14px; border-radius: 12px; border: none; background: var(--uvaco-green); color: #fff; font-weight: 700; font-size: 15px; cursor: pointer; margin-top: 12px; }
    .auth-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .auth-btn.secondary { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.10); color: #fff; }
    body.theme-light .auth-btn.secondary { background: rgba(15,23,42,0.04); border-color: rgba(15,23,42,0.10); color: #111827; }
    .auth-divider { height: 1px; background: rgba(255,255,255,0.10); margin: 16px 0; }
    body.theme-light .auth-divider { background: rgba(15,23,42,0.10); }
    .auth-note { font-size: 12px; line-height: 1.7; margin-top: 14px; color: #9ca3af; }
    body.theme-light .auth-note { color: #6b7280; }
    .auth-status { margin-top: 14px; padding: 12px 14px; border-radius: 12px; display: none; }
    .auth-status.show { display: block; }
    .auth-status.ok { background: rgba(34,197,94,0.12); border: 1px solid rgba(34,197,94,0.3); color: #22c55e; }
    .auth-status.err { background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.3); color: #ef4444; }
    a { color: var(--uvaco-green); }
  </style>
  <!-- Supabase JS（CDN） -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="cloud.js?v=20260106"></script>
  <script src="common.js?v=20260105"></script>
</head>
<body class="theme-dark lang-zh">
  <!-- 背景泡泡 -->
  <div class="bg-blob blob1"></div>
  <div class="bg-blob blob2"></div>

  <div class="auth-page">
    <div class="auth-card">
      <div class="auth-title">LINE 登入驗證</div>
      <div class="auth-desc">
        點擊下方按鈕將跳轉至 LINE 完成登入驗證，完成後會自動回到系統繼續操作。<br>
        （本機測試需使用 HTTPS，例如 ngrok；LINE 不接受 http://localhost）<br>
        LINE Developers 的 Callback URL 建議填：<strong>https://stanley00316.github.io/Electronic-business-card--4/auth.html</strong>
      </div>

      <button type="button" class="auth-btn" onclick="startLine()">使用 LINE 登入</button>
      <button type="button" class="auth-btn secondary" onclick="diagLine()">診斷（不會顯示密鑰）</button>
      <button type="button" class="auth-btn secondary" onclick="explainLineAuth()">部署/設定教學</button>

      <!-- 開發者登入區塊（僅 Localhost 顯示） -->
      <div id="devLoginArea" style="display:none; margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
        <div style="font-size:13px; color:#f59e0b; margin-bottom:8px; font-weight:bold;">⚠️ 開發者模式 (Localhost Only)</div>
        <div style="font-size:12px; color:#9ca3af; margin-bottom:8px;">無法使用 LINE 登入時，請貼上 Access Token 強制登入。</div>
        <input type="text" id="devJwtInput" class="auth-input" placeholder="Paste JWT here..." style="font-family:monospace; font-size:12px;">
        <button type="button" class="auth-btn" style="background:#f59e0b; margin-top:8px;" onclick="doDevLogin()">開發者強制登入</button>
      </div>

      <div id="statusBox" class="auth-status"></div>
      <div class="auth-note">
        隱私權政策：<a href="privacy.html" target="_blank" rel="noopener">查看</a>
      </div>
    </div>
  </div>

  <script>
    function setStatus(type, msg) {
      var box = document.getElementById('statusBox');
      box.className = 'auth-status show ' + (type === 'ok' ? 'ok' : 'err');
      box.textContent = msg;
    }

    function getNext() {
      try {
        var p = new URLSearchParams(window.location.search || '');
        return p.get('next') || 'directory.html';
      } catch (e) {
        return 'directory.html';
      }
    }

    async function bootstrap() {
      if (!window.UVACO_CLOUD || !UVACO_CLOUD.hasConfig()) {
        setStatus('err', '尚未設定 Supabase（請在 cloud.js 填入 SUPABASE_URL / SUPABASE_ANON_KEY）。');
        return;
      }

      // 若是 LINE callback，先處理（成功會自動導回 next）
      var lineRes = await UVACO_CLOUD.finishLineLoginFromUrl();
      if (lineRes && lineRes.ok === false) {
        var detail = '';
        try {
          if (lineRes.status) detail += 'HTTP ' + lineRes.status + ' ';
          if (lineRes.error) detail += String(lineRes.error) + ' ';
          if (lineRes.detail) detail += JSON.stringify(lineRes.detail);
        } catch (e) {}
        setStatus('err', 'LINE 登入失敗，請重試。' + (detail ? ('\\n' + detail) : ''));
        return;
      }

      var s = await UVACO_CLOUD.getSession();
      if (s.session) {
        // 已登入：回到 next
        window.location.replace(getNext());
      }
    }

    function startLine() {
      try {
        UVACO_CLOUD.startLineLogin(getNext());
      } catch (e) {
        setStatus('err', 'LINE 登入尚未設定完成（請先看「部署/設定教學」）。');
      }
    }

    async function diagLine() {
      try {
        var r = await UVACO_CLOUD.lineAuthDiag();
        setStatus('ok', 'line-auth 診斷：\\n' + JSON.stringify(r, null, 2));
      } catch (e) {
        setStatus('err', '診斷失敗：' + String(e && e.message ? e.message : e));
      }
    }

    function explainLineAuth() {
      alert(
        '目前這個專案是「純前端 + Supabase RLS/Storage」。\\n\\n' +
        '我已改成「自訂 JWT 模式」，不依賴 Supabase 的 LINE Provider。\\n' +
        '你需要做 3 件事（照做就能跑）：\\n\\n' +
        '1) Supabase SQL Editor 執行：supabase-setup.sql（確保已建立 public.line_identities）\\n' +
        '2) Supabase Edge Functions 設定 Secrets：\\n' +
        '   - SUPABASE_URL\\n' +
        '   - SUPABASE_SERVICE_ROLE_KEY\\n' +
        '   - JWT_SECRET（或舊名 SUPABASE_JWT_SECRET）\\n' +
        '   - LINE_CHANNEL_ID\\n' +
        '   - LINE_CHANNEL_SECRET\\n' +
        '3) 用 Supabase CLI 部署 function：line-auth\\n\\n' +
        '部署後，GitHub Pages 直接按「使用 LINE 登入」即可。\\n\\n' +
        '本機測試：請用 ngrok 產生 https 網址並把 redirect URI 設在 LINE Developers，否則 LINE 會擋 http://localhost。'
      );
    }

    function checkDevMode() {
      const h = window.location.hostname;
      // 允許 localhost, 127.0.0.1, 192.168.*, 172.*, 10.* 等區域網路 IP
      if (h === 'localhost' || h === '127.0.0.1' || 
          h.startsWith('192.168.') || h.startsWith('172.') || h.startsWith('10.')) {
        const el = document.getElementById('devLoginArea');
        if (el) el.style.display = 'block';
      }
    }

    async function doDevLogin() {
      const input = document.getElementById('devJwtInput');
      const token = (input.value || '').trim();
      if (!token) {
        alert('請輸入 Token');
        return;
      }
      // 簡單格式檢查
      if (!token.includes('.')) {
        alert('Token 格式看起來不正確 (不是 JWT)');
        return;
      }
      
      if (UVACO_CLOUD.setCustomJwt(token)) {
        // 立即驗證 Token 是否有效
        try {
          const s = await UVACO_CLOUD.getSession();
          if (s && s.session && s.session.user && s.session.user.id) {
            alert('Token 驗證成功 (User ID: ' + s.session.user.id + ')，即將跳轉...');
            window.location.replace(getNext());
          } else {
            alert('Token 設定成功但無法取得 Session (無效或過期)。\n請檢查 Token 是否正確。');
            UVACO_CLOUD.clearCustomJwt();
          }
        } catch (e) {
          alert('Token 驗證發生錯誤：' + e.message);
          UVACO_CLOUD.clearCustomJwt();
        }
      } else {
        alert('設定失敗');
      }
    }

    bootstrap();
    checkDevMode();
  </script>
</body>
</html>
