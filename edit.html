<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Sentry éŒ¯èª¤ç›£æ§ SDK -->
  <script src="https://browser.sentry-cdn.com/7.100.0/bundle.min.js" crossorigin="anonymous"></script>
<!-- é˜²æ­¢ç€è¦½å™¨å¿«å–ï¼ˆGitHub Pages / æœ¬æ©Ÿæ¸¬è©¦çš†å¯èƒ½è¢«å¿«å–èˆŠç‰ˆ HTML/CSS/JSï¼‰ -->
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
  <title>ç·¨è¼¯åç‰‡ | Edit Business Card - æ•¸ä½èº«åˆ†å¹³å°</title>
<link rel="stylesheet" href="styles.css?v=20260105">
<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#22c55e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="æ•¸ä½èº«åˆ†">
<link rel="apple-touch-icon" href="icon-192.svg">
  <!-- ä¸»é¡Œ CSS æ”¹ç‚ºæŒ‰éœ€è¼‰å…¥ï¼ˆç”± common.js å‹•æ…‹è¼‰å…¥ï¼‰ -->
  <!-- Supabase JSï¼ˆCDNï¼‰ -->
  <script src="supabase.min.js"></script>
<script src="cloud.js?v=20260127"></script>
  <style>
.edit-page-wrapper {
  padding-bottom: 100px;
}

/* =========================
   ä¸»é¡Œ UI è‰²å½©ç³»çµ±ï¼ˆç·¨è¼¯é å°ˆç”¨ï¼‰
   - ç›®çš„ï¼šä¸»é¡Œé¸æ“‡å™¨/å½ˆçª—/é ‚éƒ¨æ¬„ ç­‰ä»‹é¢å­—è‰²èˆ‡èƒŒæ™¯èƒ½éš¨ä¸»é¡Œå®Œæ•´è®Šæ›
   - ä»¥ body.card-theme-* ç‚ºæº–ï¼ˆç”± JS å¥—ç”¨ï¼‰
   ========================= */

/* é è¨­ï¼ˆæ·±è‰² / ä¸»é¡Œ1ï¼‰ */
body {
  --ui-header-bg: rgba(22, 22, 24, 0.95);
  --ui-header-border: rgba(255, 255, 255, 0.10);
  --ui-surface-bg: rgba(22, 22, 24, 0.98);
  --ui-surface-border: rgba(255, 255, 255, 0.10);
  --ui-text: #ffffff;
  --ui-muted: rgba(255, 255, 255, 0.75);
  --ui-field-bg: rgba(255, 255, 255, 0.08);
  --ui-field-border: rgba(255, 255, 255, 0.14);
  --ui-field-text: #ffffff;
  --ui-btn-muted-bg: rgba(255, 255, 255, 0.10);
  --ui-btn-muted-text: #ffffff;
  --ui-btn-muted-bg-hover: rgba(255, 255, 255, 0.18);
  --ui-overlay: rgba(0, 0, 0, 0.70);

  /* accentï¼ˆä¸»è‰²ï¼‰èˆ‡å…¶å°æ¯”æ–‡å­— */
  --ui-accent: #1faf53; /* é è¨­ç¶ ï¼ˆä¸»é¡Œ1ï¼‰ */
  --ui-accent-rgb: 31, 175, 83;
  --ui-accent-contrast: #0b1220; /* æ·±è‰²å­—ï¼ˆç”¨åœ¨æ·ºè‰² accent èƒŒæ™¯ï¼‰ */
  --ui-accent-soft-bg: rgba(var(--ui-accent-rgb), 0.12);
  --ui-accent-soft-bg-hover: rgba(var(--ui-accent-rgb), 0.20);
  --ui-accent-border: rgba(var(--ui-accent-rgb), 0.70);

  /* é—œéµï¼šæŠŠèˆŠç³»çµ±çš„å“ç‰Œç¶ åœ¨ edit.html å…§æ”¹ç‚ºã€Œè·Ÿä¸»é¡Œ accent èµ°ã€ */
  --uvaco-green: var(--ui-accent);
}

/* æ·ºè‰²æ¨¡å¼åŸºç¤å‚™æ´ï¼ˆé¿å…ä¸»é¡Œé¡åˆ¥æœªåŠæ™‚è¼‰å…¥æ™‚å‡ºç¾ç™½å­—åœ¨æ·ºèƒŒæ™¯ï¼‰ */
body.theme-light {
  --ui-text: #111827;
  --ui-header-bg: #f3f4f6;
  --ui-surface-bg: rgba(255, 255, 255, 0.98);
  --ui-header-border: rgba(15, 23, 42, 0.12);
}

/* ä¸»é¡Œ2ï¼ˆæ·ºè‰²ï¼‰ */
body.card-theme-2 {
  --ui-header-bg: rgba(255, 255, 255, 0.95);
  --ui-header-border: rgba(15, 23, 42, 0.12);
  --ui-surface-bg: rgba(255, 255, 255, 0.98);
  --ui-surface-border: rgba(15, 23, 42, 0.12);
  --ui-text: #111827;
  --ui-muted: rgba(17, 24, 39, 0.70);
  --ui-field-bg: rgba(15, 23, 42, 0.04);
  --ui-field-border: rgba(15, 23, 42, 0.12);
  --ui-field-text: #111827;
  --ui-btn-muted-bg: rgba(15, 23, 42, 0.08);
  --ui-btn-muted-text: #111827;
  --ui-btn-muted-bg-hover: rgba(15, 23, 42, 0.14);
  --ui-overlay: rgba(0, 0, 0, 0.55);

  --ui-accent: #1faf53;
  --ui-accent-rgb: 31, 175, 83;
  --ui-accent-contrast: #0b1220;
  --ui-accent-soft-bg: rgba(var(--ui-accent-rgb), 0.10);
  --ui-accent-soft-bg-hover: rgba(var(--ui-accent-rgb), 0.16);
  --ui-accent-border: rgba(var(--ui-accent-rgb), 0.65);
}

/* ä¸»é¡Œ3ï¼ˆè—ï¼‰ */
body.card-theme-3 {
  --ui-header-bg: rgba(30, 58, 138, 0.95);
  --ui-header-border: rgba(255, 255, 255, 0.18);
  --ui-surface-bg: rgba(30, 58, 138, 0.98);
  --ui-surface-border: rgba(96, 165, 250, 0.35);
  --ui-text: #ffffff;
  --ui-muted: rgba(224, 231, 255, 0.85);
  --ui-field-bg: rgba(255, 255, 255, 0.10);
  --ui-field-border: rgba(255, 255, 255, 0.20);
  --ui-field-text: #ffffff;
  --ui-btn-muted-bg: rgba(255, 255, 255, 0.12);
  --ui-btn-muted-text: #ffffff;
  --ui-btn-muted-bg-hover: rgba(255, 255, 255, 0.20);
  --ui-overlay: rgba(0, 0, 0, 0.65);

  /* è—ä¸»é¡Œï¼šä½¿ç”¨æ·ºè—ä½œ accentï¼Œç¢ºä¿åœ¨æ·±è—èƒŒæ™¯å°æ¯”æ¸…æ¥š */
  --ui-accent: #60a5fa;
  --ui-accent-rgb: 96, 165, 250;
  --ui-accent-contrast: #1e3a8a;
  --ui-accent-soft-bg: rgba(var(--ui-accent-rgb), 0.18);
  --ui-accent-soft-bg-hover: rgba(var(--ui-accent-rgb), 0.28);
  --ui-accent-border: rgba(var(--ui-accent-rgb), 0.65);
}

/* ä¸»é¡Œ4ï¼ˆé‡‘ï¼‰ */
body.card-theme-4 {
  --ui-header-bg: rgba(180, 83, 9, 0.95);
  --ui-header-border: rgba(255, 255, 255, 0.20);
  --ui-surface-bg: rgba(180, 83, 9, 0.98);
  --ui-surface-border: rgba(251, 191, 36, 0.35);
  --ui-text: #ffffff;
  --ui-muted: rgba(254, 243, 199, 0.92);
  --ui-field-bg: rgba(255, 255, 255, 0.12);
  --ui-field-border: rgba(255, 255, 255, 0.22);
  --ui-field-text: #ffffff;
  --ui-btn-muted-bg: rgba(255, 255, 255, 0.14);
  --ui-btn-muted-text: #ffffff;
  --ui-btn-muted-bg-hover: rgba(255, 255, 255, 0.22);
  --ui-overlay: rgba(0,  0,  0, 0.65);

  /* é‡‘ä¸»é¡Œï¼šç”¨é‡‘è‰²ä½œ accentï¼Œæ–‡å­—ç”¨æ·±å’–æå‡å¯è®€æ€§ */
  --ui-accent: #fbbf24;
  --ui-accent-rgb: 251, 191, 36;
  --ui-accent-contrast: #78350f;
  --ui-accent-soft-bg: rgba(var(--ui-accent-rgb), 0.18);
  --ui-accent-soft-bg-hover: rgba(var(--ui-accent-rgb), 0.28);
  --ui-accent-border: rgba(var(--ui-accent-rgb), 0.70);
}

/* ä¸»é¡Œ5ï¼ˆç´«ï¼‰ */
body.card-theme-5 {
  --ui-header-bg: rgba(88, 28, 135, 0.95);
  --ui-header-border: rgba(255, 255, 255, 0.20);
  --ui-surface-bg: rgba(88, 28, 135, 0.98);
  --ui-surface-border: rgba(196, 181, 253, 0.35);
  --ui-text: #ffffff;
  --ui-muted: rgba(243, 232, 255, 0.92);
  --ui-field-bg: rgba(255, 255, 255, 0.12);
  --ui-field-border: rgba(255, 255, 255, 0.22);
  --ui-field-text: #ffffff;
  --ui-btn-muted-bg: rgba(255, 255, 255, 0.14);
  --ui-btn-muted-text: #ffffff;
  --ui-btn-muted-bg-hover: rgba(255, 255, 255, 0.22);
  --ui-overlay: rgba(0, 0, 0, 0.65);

  /* ç´«ä¸»é¡Œï¼šç”¨æ·¡ç´«ä½œ accentï¼Œæ·±ç´«åšå°æ¯”æ–‡å­— */
  --ui-accent: #a78bfa;
  --ui-accent-rgb: 167, 139, 250;
  --ui-accent-contrast: #581c87;
  --ui-accent-soft-bg: rgba(var(--ui-accent-rgb), 0.18);
  --ui-accent-soft-bg-hover: rgba(var(--ui-accent-rgb), 0.28);
  --ui-accent-border: rgba(var(--ui-accent-rgb), 0.70);
}

/* ä¸»é¡Œ6ï¼ˆæ·±é»‘ + ç¶“å…¸è—ï¼‰ */
body.card-theme-6 {
  --ui-header-bg: rgba(0, 0, 0, 0.95);
  --ui-header-border: rgba(255, 255, 255, 0.10);
  --ui-surface-bg: rgba(0, 0, 0, 0.98);
  --ui-surface-border: rgba(255, 255, 255, 0.12);
  --ui-text: #ffffff;
  --ui-muted: rgba(255, 255, 255, 0.80);
  --ui-field-bg: rgba(255, 255, 255, 0.10);
  --ui-field-border: rgba(255, 255, 255, 0.20);
  --ui-field-text: #ffffff;
  --ui-btn-muted-bg: rgba(255, 255, 255, 0.12);
  --ui-btn-muted-text: #ffffff;
  --ui-btn-muted-bg-hover: rgba(255, 255, 255, 0.20);
  --ui-overlay: rgba(0, 0, 0, 0.72);

  /* Classic Blue */
  --ui-accent: #0033A0;
  --ui-accent-rgb: 0, 51, 160;
  --ui-accent-contrast: #ffffff;
  --ui-accent-soft-bg: rgba(var(--ui-accent-rgb), 0.16);
  --ui-accent-soft-bg-hover: rgba(var(--ui-accent-rgb), 0.26);
  --ui-accent-border: rgba(var(--ui-accent-rgb), 0.72);
}

/* ä¸»é¡Œ7ï¼ˆç™½åº• + ç¶“å…¸è—ï¼‰ */
body.card-theme-7 {
  --ui-header-bg: rgba(255, 255, 255, 0.95);
  --ui-header-border: rgba(15, 23, 42, 0.12);
  --ui-surface-bg: rgba(255, 255, 255, 0.98);
  --ui-surface-border: rgba(15, 23, 42, 0.12);
  --ui-text: #111827;
  --ui-muted: rgba(17, 24, 39, 0.70);
  --ui-field-bg: rgba(15, 23, 42, 0.04);
  --ui-field-border: rgba(15, 23, 42, 0.12);
  --ui-field-text: #111827;
  --ui-btn-muted-bg: rgba(15, 23, 42, 0.08);
  --ui-btn-muted-text: #111827;
  --ui-btn-muted-bg-hover: rgba(15, 23, 42, 0.14);
  --ui-overlay: rgba(0, 0, 0, 0.55);

  /* Classic Blue */
  --ui-accent: #0033A0;
  --ui-accent-rgb: 0, 51, 160;
  --ui-accent-contrast: #ffffff;
  --ui-accent-soft-bg: rgba(var(--ui-accent-rgb), 0.10);
  --ui-accent-soft-bg-hover: rgba(var(--ui-accent-rgb), 0.16);
  --ui-accent-border: rgba(var(--ui-accent-rgb), 0.60);
}

/* ä¸»é¡Œ8ï¼ˆæ·±é»‘ + é’ç¶ ï¼‰ */
body.card-theme-8 {
  --ui-header-bg: rgba(0, 0, 0, 0.95);
  --ui-header-border: rgba(255, 255, 255, 0.10);
  --ui-surface-bg: rgba(0, 0, 0, 0.98);
  --ui-surface-border: rgba(255, 255, 255, 0.12);
  --ui-text: #ffffff;
  --ui-muted: rgba(255, 255, 255, 0.80);
  --ui-field-bg: rgba(255, 255, 255, 0.10);
  --ui-field-border: rgba(255, 255, 255, 0.20);
  --ui-field-text: #ffffff;
  --ui-btn-muted-bg: rgba(255, 255, 255, 0.12);
  --ui-btn-muted-text: #ffffff;
  --ui-btn-muted-bg-hover: rgba(255, 255, 255, 0.20);
  --ui-overlay: rgba(0, 0, 0, 0.72);

  /* Teal */
  --ui-accent: #00B7A9;
  --ui-accent-rgb: 0, 183, 169;
  --ui-accent-contrast: #001b18;
  --ui-accent-soft-bg: rgba(var(--ui-accent-rgb), 0.16);
  --ui-accent-soft-bg-hover: rgba(var(--ui-accent-rgb), 0.26);
  --ui-accent-border: rgba(var(--ui-accent-rgb), 0.72);
}

/* ä¸»é¡Œ9ï¼ˆç™½åº• + é’ç¶ ï¼‰ */
body.card-theme-9 {
  --ui-header-bg: rgba(255, 255, 255, 0.95);
  --ui-header-border: rgba(15, 23, 42, 0.12);
  --ui-surface-bg: rgba(255, 255, 255, 0.98);
  --ui-surface-border: rgba(15, 23, 42, 0.12);
  --ui-text: #111827;
  --ui-muted: rgba(17, 24, 39, 0.70);
  --ui-field-bg: rgba(15, 23, 42, 0.04);
  --ui-field-border: rgba(15, 23, 42, 0.12);
  --ui-field-text: #111827;
  --ui-btn-muted-bg: rgba(15, 23, 42, 0.08);
  --ui-btn-muted-text: #111827;
  --ui-btn-muted-bg-hover: rgba(15, 23, 42, 0.14);
  --ui-overlay: rgba(0, 0, 0, 0.55);

  /* Teal */
  --ui-accent: #00B7A9;
  --ui-accent-rgb: 0, 183, 169;
  --ui-accent-contrast: #001b18;
  --ui-accent-soft-bg: rgba(var(--ui-accent-rgb), 0.10);
  --ui-accent-soft-bg-hover: rgba(var(--ui-accent-rgb), 0.16);
  --ui-accent-border: rgba(var(--ui-accent-rgb), 0.60);
}

/* ===== ä¸»é¡Œä»‹é¢ï¼šå…±ç”¨æ–‡å­—/æŒ‰éˆ•é¡è‰²ï¼ˆè·Ÿä¸»é¡Œèµ°ï¼‰ ===== */

/* é ‚éƒ¨è¿”å›ç®­é ­ï¼ˆåŸæœ¬ inline ç¶å“ç‰Œç¶ ï¼Œé€™è£¡å¼·åˆ¶è·Ÿä¸»é¡Œ accent èµ°ï¼‰ */
.edit-top-header a {
  color: var(--ui-accent) !important;
}

/* æ¨™é¡Œï¼šæ”¹ç‚ºè·Ÿéš¨ä¸»é¡Œï¼ˆåœ¨æ·±è‰²ä¸»é¡Œç”¨ç™½å­—ï¼Œæ·ºè‰²ä¸»é¡Œç”¨æ·±å­—ï¼‰ */
.edit-header-top .edit-title {
  color: var(--ui-text) !important;
}

/* ä¸»é¡ŒæŒ‰éˆ• */
.edit-theme-btn {
  border-color: var(--ui-accent) !important;
  color: var(--ui-accent) !important;
  background: var(--ui-accent-soft-bg) !important;
}
.edit-theme-btn:hover {
  background: var(--ui-accent-soft-bg-hover) !important;
  border-color: var(--ui-accent) !important;
  color: var(--ui-accent) !important;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25), 0 0 0 3px rgba(255,255,255,0.06);
}

/* å„²å­˜æŒ‰éˆ•ï¼šä½¿ç”¨ä¸»é¡Œ accent èƒŒæ™¯ï¼Œç¢ºä¿æ–‡å­—å°æ¯” */
.edit-save-btn {
  background: var(--ui-accent) !important;
  color: var(--ui-accent-contrast) !important;
}
.edit-save-btn:hover {
  filter: brightness(0.95);
  transform: translateY(-1px);
}

/* ä¸»é¡Œ/é€£çµè¼¸å…¥ç­‰å½ˆçª—æ¨™é¡Œï¼šç”¨ä¸»é¡Œ accentï¼ˆæ›´ç¬¦åˆä¸åŒä¸»é¡Œï¼‰ */
.theme-selector-title,
.link-input-title,
.contact-type-title,
.company-info-type-title,
.address-edit-title {
  color: var(--ui-accent) !important;
}

/* ===== å¡ç‰‡é è¦½å€ï¼ˆå…§å®¹æ–‡å­—/å¼·èª¿è‰²ï¼‰ ===== */

/* å¡ç‰‡å…§çš„è‹±æ–‡å `.en` èˆ‡ strongï¼šä¸å†å›ºå®šå“ç‰Œç¶ ï¼Œæ”¹è·Ÿä¸»é¡Œ accent */
#previewCard .name .en,
#previewCard .tagline strong {
  color: var(--ui-accent) !important;
}

/* å…¬å¸è³‡è¨Š label ä¹Ÿè·Ÿä¸»é¡Œ accentï¼ˆé¿å…è—/é‡‘/ç´«é‚„æ˜¯ç¶ ï¼‰ */
#previewCard .info-label,
#previewCard .address-map-link {
  color: var(--ui-accent) !important;
}

/* +æ–°å¢ æŒ‰éˆ•ï¼šè·Ÿä¸»é¡Œ accent */
.edit-add-btn {
  background: var(--ui-accent-soft-bg) !important;
  color: var(--ui-accent) !important;
  border: 1px solid var(--ui-accent-border) !important;
}
.edit-add-btn:hover {
  background: var(--ui-accent-soft-bg-hover) !important;
  border-color: var(--ui-accent) !important;
}

/* å›ºå®šé ‚éƒ¨å°èˆªæ¬„ */
.edit-top-header {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  width: 100% !important;
  z-index: 1000 !important;
  background: var(--ui-header-bg) !important;
  border-bottom: 1px solid var(--ui-header-border);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 20px;
  box-sizing: border-box;
}

body.theme-light .edit-top-header {
  background: #f3f4f6 !important;
  border-bottom-color: rgba(15, 23, 42, 0.1);
}

.edit-header-top {
  position: fixed !important;
  top: 44px !important; /* edit-top-header çš„é«˜åº¦ */
  left: 0 !important;
  right: 0 !important;
  width: 100% !important;
  z-index: 999 !important;
  background: var(--ui-header-bg) !important;
  border-bottom: 1px solid var(--ui-header-border);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  margin-bottom: 0;
  box-sizing: border-box;
}

body.theme-light .edit-header-top {
  border-bottom-color: rgba(15, 23, 42, 0.1);
  background: #f3f4f6 !important;
}

.edit-page-wrapper {
  padding-top: 120px; /* ç‚ºå…©å€‹å›ºå®šé ‚éƒ¨æ¬„ç•™å‡ºç©ºé–“ (44px + 60px + 16px) */
}

/* ä¸»é¡Œé¸æ“‡æŒ‰éˆ• */
.edit-theme-btn {
  display: flex !important;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 8px 14px;
  border: 2px solid var(--uvaco-green);
  border-radius: 8px;
  color: var(--uvaco-green);
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.2s;
  white-space: nowrap;
  background: rgba(var(--ui-accent-rgb), 0.12);
  min-width: auto;
  height: auto;
}

body.theme-dark .edit-theme-btn {
  background: rgba(var(--ui-accent-rgb), 0.12);
  color: var(--uvaco-green);
  border-color: var(--uvaco-green);
}

body.theme-light .edit-theme-btn {
  background: rgba(var(--ui-accent-rgb), 0.12);
  color: var(--uvaco-green);
  border-color: var(--uvaco-green);
}

.edit-theme-btn:hover {
  background: rgba(var(--ui-accent-rgb), 0.20) !important;
  border-color: var(--uvaco-green) !important;
  color: var(--uvaco-green) !important;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(var(--ui-accent-rgb), 0.35);
}

body.theme-light .edit-theme-btn:hover {
  background: rgba(var(--ui-accent-rgb), 0.20) !important;
}

/* ä¸»é¡Œé¸æ“‡å™¨æ¨¡æ…‹æ¡† */
.theme-selector-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--ui-overlay);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: 5000;
  display: none;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease;
}

.theme-selector-overlay.show {
  display: flex;
}

.theme-selector-modal {
  width: 90%;
  max-width: 800px;
  max-height: 85vh;
  border-radius: 24px;
  padding: 32px;
  animation: slideUp 0.3s ease;
  position: relative;
  overflow-y: auto;
}

/* ä½¿ç”¨ä¸»é¡Œè®Šæ•¸ï¼Œè®“ 1~5 éƒ½æœ‰ä¸€è‡´ä¸”å¯è®€çš„ UI é…è‰² */
.theme-selector-modal {
  background: var(--ui-surface-bg);
  border: 1px solid var(--ui-surface-border);
  color: var(--ui-text);
}

.theme-selector-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.theme-selector-title {
  font-size: 24px;
  font-weight: 700;
  color: var(--uvaco-green);
  margin: 0;
}

.theme-selector-close {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--ui-btn-muted-bg);
  border: none;
  color: var(--ui-btn-muted-text);
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

body.theme-light .theme-selector-close {
  background: rgba(15, 23, 42, 0.1);
  color: #111827;
}

.theme-selector-close:hover {
  background: rgba(239, 68, 68, 0.2);
  color: #ef4444;
  transform: rotate(90deg);
}

.theme-selector-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

.theme-card-preview {
  cursor: pointer;
  border-radius: 16px;
  overflow: hidden;
  transition: all 0.3s;
  border: 3px solid transparent;
  position: relative;
}

.theme-card-preview:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 24px rgba(0,0,0,0.3);
}

.theme-card-preview.active {
  border-color: var(--uvaco-green);
  box-shadow: 0 0 0 4px rgba(var(--ui-accent-rgb), 0.30);
}

.theme-card-preview.active::after {
  content: 'âœ“';
  position: absolute;
  top: 12px;
  right: 12px;
  width: 32px;
  height: 32px;
  background: var(--uvaco-green);
  color: #ffffff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 700;
  box-shadow: 0 4px 12px rgba(var(--ui-accent-rgb), 0.38);
}

.theme-preview-wrapper {
  width: 100%;
  aspect-ratio: 3 / 4;
  display: flex;
  flex-direction: column;
  padding: 16px;
  gap: 12px;
}

.theme-preview-top-bar {
  height: 32px;
  border-radius: 8px;
  opacity: 0.9;
}

.theme-preview-card {
  flex: 1;
  border-radius: 12px;
  opacity: 0.85;
  display: flex;
  flex-direction: column;
  padding: 16px;
  gap: 8px;
}

.theme-preview-text {
  height: 12px;
  border-radius: 4px;
  opacity: 0.6;
}

.theme-preview-text.long {
  width: 80%;
}

.theme-preview-text.short {
  width: 50%;
}

.theme-preview-button {
  height: 36px;
  border-radius: 8px;
  opacity: 0.9;
  margin-top: auto;
}

.theme-card-name {
  text-align: center;
  padding: 12px;
  font-size: 15px;
  font-weight: 600;
}

.theme-card-name { color: var(--ui-text); }

/* ä¸»é¡Œ 1ï¼šæ·±è‰² */
.theme-card-preview[data-theme="1"] .theme-preview-wrapper {
  background: #050608;
}
.theme-card-preview[data-theme="1"] .theme-preview-top-bar {
  background: rgba(22, 22, 24, 0.95);
}
.theme-card-preview[data-theme="1"] .theme-preview-card {
  background: rgba(22,22,24,0.85);
}
.theme-card-preview[data-theme="1"] .theme-preview-text {
  background: rgba(255,255,255,0.3);
}
.theme-card-preview[data-theme="1"] .theme-preview-button {
  background: var(--uvaco-green);
}

/* ä¸»é¡Œ 2ï¼šæ·ºè‰² */
.theme-card-preview[data-theme="2"] .theme-preview-wrapper {
  background: #f3f4f6;
}
.theme-card-preview[data-theme="2"] .theme-preview-top-bar {
  background: rgba(255, 255, 255, 0.95);
}
.theme-card-preview[data-theme="2"] .theme-preview-card {
  background: #ffffff;
}
.theme-card-preview[data-theme="2"] .theme-preview-text {
  background: rgba(0,0,0,0.15);
}
.theme-card-preview[data-theme="2"] .theme-preview-button {
  background: var(--uvaco-green);
}

/* ä¸»é¡Œ 3ï¼šè—è‰² */
.theme-card-preview[data-theme="3"] .theme-preview-wrapper {
  background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 50%, #3b82f6 100%);
}
.theme-card-preview[data-theme="3"] .theme-preview-top-bar {
  background: rgba(30, 58, 138, 0.95);
}
.theme-card-preview[data-theme="3"] .theme-preview-card {
  background: rgba(30,58,138,0.85);
}
.theme-card-preview[data-theme="3"] .theme-preview-text {
  background: rgba(255,255,255,0.3);
}
.theme-card-preview[data-theme="3"] .theme-preview-button {
  background: #60a5fa;
}

/* ä¸»é¡Œ 4ï¼šé‡‘è‰² */
.theme-card-preview[data-theme="4"] .theme-preview-wrapper {
  background: linear-gradient(135deg, #b45309 0%, #d97706 50%, #f59e0b 100%);
}
.theme-card-preview[data-theme="4"] .theme-preview-top-bar {
  background: rgba(180, 83, 9, 0.95);
}
.theme-card-preview[data-theme="4"] .theme-preview-card {
  background: rgba(180,83,9,0.85);
}
.theme-card-preview[data-theme="4"] .theme-preview-text {
  background: rgba(255,255,255,0.3);
}
.theme-card-preview[data-theme="4"] .theme-preview-button {
  background: #fbbf24;
}

/* ä¸»é¡Œ 5ï¼šç´«è‰² */
.theme-card-preview[data-theme="5"] .theme-preview-wrapper {
  background: linear-gradient(135deg, #581c87 0%, #7c3aed 50%, #9333ea 100%);
}
.theme-card-preview[data-theme="5"] .theme-preview-top-bar {
  background: rgba(88, 28, 135, 0.95);
}
.theme-card-preview[data-theme="5"] .theme-preview-card {
  background: rgba(88,28,135,0.85);
}
.theme-card-preview[data-theme="5"] .theme-preview-text {
  background: rgba(255,255,255,0.3);
}
.theme-card-preview[data-theme="5"] .theme-preview-button {
  background: #a78bfa;
}

/* ä¸»é¡Œ 6ï¼šæ·±é»‘ + ç¶“å…¸è— */
.theme-card-preview[data-theme="6"] .theme-preview-wrapper {
  background: #000000;
}
.theme-card-preview[data-theme="6"] .theme-preview-top-bar {
  background: rgba(0, 0, 0, 0.95);
}
.theme-card-preview[data-theme="6"] .theme-preview-card {
  background: rgba(10,10,12,0.90);
}
.theme-card-preview[data-theme="6"] .theme-preview-text {
  background: rgba(255,255,255,0.30);
}
.theme-card-preview[data-theme="6"] .theme-preview-button {
  background: #0033A0;
}

/* ä¸»é¡Œ 7ï¼šç™½åº• + ç¶“å…¸è— */
.theme-card-preview[data-theme="7"] .theme-preview-wrapper {
  background: #ffffff;
}
.theme-card-preview[data-theme="7"] .theme-preview-top-bar {
  background: rgba(255, 255, 255, 0.95);
}
.theme-card-preview[data-theme="7"] .theme-preview-card {
  background: #ffffff;
  border: 1px solid rgba(15,23,42,0.08);
}
.theme-card-preview[data-theme="7"] .theme-preview-text {
  background: rgba(15,23,42,0.14);
}
.theme-card-preview[data-theme="7"] .theme-preview-button {
  background: #0033A0;
}

/* ä¸»é¡Œ 8ï¼šæ·±é»‘ + é’ç¶  */
.theme-card-preview[data-theme="8"] .theme-preview-wrapper {
  background: #000000;
}
.theme-card-preview[data-theme="8"] .theme-preview-top-bar {
  background: rgba(0, 0, 0, 0.95);
}
.theme-card-preview[data-theme="8"] .theme-preview-card {
  background: rgba(10,10,12,0.90);
}
.theme-card-preview[data-theme="8"] .theme-preview-text {
  background: rgba(255,255,255,0.30);
}
.theme-card-preview[data-theme="8"] .theme-preview-button {
  background: #00B7A9;
}

/* ä¸»é¡Œ 9ï¼šç™½åº• + é’ç¶  */
.theme-card-preview[data-theme="9"] .theme-preview-wrapper {
  background: #ffffff;
}
.theme-card-preview[data-theme="9"] .theme-preview-top-bar {
  background: rgba(255, 255, 255, 0.95);
}
.theme-card-preview[data-theme="9"] .theme-preview-card {
  background: #ffffff;
  border: 1px solid rgba(15,23,42,0.08);
}
.theme-card-preview[data-theme="9"] .theme-preview-text {
  background: rgba(15,23,42,0.14);
}
.theme-card-preview[data-theme="9"] .theme-preview-button {
  background: #00B7A9;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ===== å…¬å¸é¸æ“‡å™¨ï¼ˆå°è¢å¹•å †ç–Šä¿®æ­£ï¼‰===== */
.uvaco-company-picker-wrap {
  display: inline-flex;
  align-items: flex-start;
  gap: 10px;
  margin-top: 8px;
}
.uvaco-company-picker-badge {
  color: #9ca3af;
  font-size: 12px;
  line-height: 1.4;
}
/* æ”¾åœ¨æ¨™èª item å…§æ™‚å¼·åˆ¶æ›è¡Œåˆ°ä¸‹ä¸€åˆ—ï¼ˆé¿å…æ“ åˆ° strong æ—ï¼‰ */
.slogan-item { flex-wrap: wrap; }
.slogan-item .uvaco-company-picker-wrap {
  flex: 0 0 100%;
  width: 100%;
  margin-left: 0;
}
@media (max-width: 420px) {
  .uvaco-company-picker-wrap {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
    width: 100%;
  }
  /* æŒ‰éˆ•å¯¬åº¦èˆ‡ã€Œ+ æ–°å¢ä¸­æ–‡æ¨™èªã€ä¸€è‡´ï¼Œé¿å…è¢«æ’æ»¿æ•´è¡Œ */
  /* éœ€è¦è¦†è“‹ .edit-preview-section .edit-add-btn { width:100% !important } */
  .edit-preview-section .uvaco-company-picker-wrap .edit-add-btn { width: 135px !important; }
  .uvaco-company-picker-badge {
    margin-top: 0;
  }
}

/* ===== iPhone SEï¼šå§“åå‘ˆç¾ï¼ˆä¸­æ–‡ï½œè‹±æ–‡ï¼‰===== */
/* ç›®æ¨™ï¼šå§“åå¿…é ˆå–®è¡Œæ°´å¹³å‘ˆç¾ï¼›è‹¥å¤ªé•·ï¼Œè‡ªå‹•ç¸®å°å­—é«”ç¶­æŒå–®è¡Œ */
/* éœ€è¦è¦†è“‹ .edit-preview-section .name { display:inline-block } é€ æˆçš„çª„æ¬„æ›è¡Œ */
.edit-preview-section #previewNameZh,
  display: block !important;
  width: 100% !important;
  max-width: 100% !important;
  white-space: nowrap !important;
}
.edit-preview-section #previewNameZh .en,
.edit-preview-section #previewNameZh .en { display: inline; }

/* å¯ç·¨è¼¯å…ƒç´ æ¨£å¼ */
.edit-clickable {
  cursor: pointer;
  transition: all 0.2s;
}

/* åªæœ‰éçµ•å°å®šä½çš„å…ƒç´ æ‰è¨­ç½® relative */
.edit-clickable:not(.avatar):not([style*="position: absolute"]) {
  position: relative;
}

.edit-clickable:hover {
  opacity: 0.8;
  outline: 2px dashed var(--uvaco-green);
  outline-offset: 4px;
}

/* ç§»é™¤ç·¨è¼¯é  LOGO å€çš„é‡‘è‰²å¤–æ¡† */
.edit-preview-section .hero-frame {
  background: transparent;
  border: none;
  box-shadow: none;
  animation: none;
}

.edit-preview-section .hero-frame::before {
  display: none;
}

/* ç¢ºä¿é ­åƒä¿æŒçµ•å°å®šä½ */
.avatar.edit-clickable {
  position: absolute !important;
  top: 14px !important;
  right: 16px !important;
  width: 104px !important;
  height: 104px !important;
  border-radius: 50% !important;
  object-fit: cover !important;
}

.edit-clickable[contenteditable="true"] {
  outline: none;
  padding: 2px 4px;
  border-radius: 4px;
}

.edit-clickable[contenteditable="true"]:focus {
  outline: 2px solid var(--uvaco-green);
  outline-offset: 2px;
  background: rgba(var(--ui-accent-rgb), 0.12);
}

/* æ¨™èªå®¹å™¨å’Œåˆªé™¤æŒ‰éˆ• */
.slogans-container {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.slogan-item {
  position: relative;
  display: flex;
  align-items: center;
  gap: 8px;
}

.slogan-delete-btn {
  display: block;
  padding: 4px 8px;
  background: rgba(239, 68, 68, 0.1);
  color: #ef4444;
  border: 1px solid rgba(239, 68, 68, 0.3);
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.2s;
  flex-shrink: 0;
}

.slogan-delete-btn:hover {
  background: rgba(239, 68, 68, 0.2);
}

/* é è¦½å€åŸŸå±…ä¸­ - åŠ å¤§å¯¬åº¦ä»¥æ”¯æŒæ©«å‘æ’åˆ— */
.edit-preview-section {
  max-width: 1200px;
  margin: 0 auto;
  width: 100%;
}

/* å¡ç‰‡ä¹ŸåŠ å¤§å¯¬åº¦ */
.edit-preview-section .card {
  max-width: 1200px;
  width: 100%;
  padding: 26px 110px 26px 22px; /* å³å´ç•™ç©ºçµ¦é ­åƒï¼ˆé™ä½ç•™ç™½ï¼Œé¿å…éå¤šç©ºç™½ï¼‰ */
}

/* iPhone ç­‰çª„è¢å¹•ï¼šç¸®å°å·¦å³ç™½é‚Šï¼ˆå³å´é ­åƒé ç•™ä¸è¦å¤ªå¤§ï¼‰ */
@media (max-width: 420px) {
  .edit-preview-section {
    padding-left: 0;
    padding-right: 0;
  }
  .edit-preview-section .card {
    /* å³å´ä»éœ€é ç•™çµ¦é ­åƒï¼Œé¿å…å§“å/è·å‹™è“‹åˆ°é ­åƒæ¡† */
    padding: 22px 96px 22px 18px !important;
  }
  /* é è¦½é ­åƒç¸®å°ï¼Œé¿å…éœ€è¦é ç•™è¶…å¤§å³é‚Šç©ºç™½ */
  #previewCard .avatar {
    width: 68px;
    height: 68px;
    right: 18px;
    top: 18px;
  }
}

/* iPhone SEï¼šå§“åé¿å…è“‹åˆ°é ­åƒï¼ˆé™åˆ¶æœ€å¤§å­—ç´šï¼‰ */
@media (max-width: 420px) {
  .edit-preview-section #previewNameZh {
    font-size: clamp(18px, 7vw, 30px) !important;
  }
}

/* æŒ‰éˆ•ç¾¤çµ„å‚ç›´æ’åˆ— */
.edit-preview-section .btn-group {
  display: flex;
  flex-direction: column;
  gap: 12px;
  width: 100%;
}

/* è¯çµ¡æ–¹å¼ï¼šå°å¡ç‰‡ï¼ˆGridï¼‰ */
.edit-preview-section .btn-group.contact-layout-grid {
  display: grid;
  /* å›ºå®šè‡³å°‘ 3 å¼µï¼šä¸å…è¨±è®Šæˆ 2/1 */
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 14px;
}
@media (min-width: 980px) {
  .edit-preview-section .btn-group.contact-layout-grid {
    grid-template-columns: repeat(4, minmax(0, 1fr));
  }
}

/* è¯çµ¡æ–¹å¼æŒ‰éˆ•å‚ç›´æ’åˆ— */
.edit-preview-section .contact-btn-wrapper {
  width: 100%;
  flex: 0 0 auto;
}

.edit-preview-section .btn-group.contact-layout-grid .contact-btn-wrapper {
  width: 100%;
}

/* Grid å°¾åˆ—è£œæ»¿ï¼šé¿å… 3 æ¬„æ™‚æœ€å¾Œä¸€æ’ç•™å¤§ç©ºç™½ï¼ˆç‰¹åˆ¥æ˜¯ iPhone SEï¼‰ */
.edit-preview-section .btn-group.contact-layout-grid .contact-btn-wrapper {
  min-width: 0;
}
/* ç¸½æ•¸ = 3n + 1ï¼šæœ€å¾Œä¸€å¼µè·¨ 3 æ¬„ */
.edit-preview-section .btn-group.contact-layout-grid .contact-btn-wrapper:nth-last-of-type(1):nth-of-type(3n+1) {
  grid-column: 1 / -1;
}
/* ç¸½æ•¸ = 3n + 2ï¼šæœ€å¾Œä¸€å¼µè·¨ 2 æ¬„ */
.edit-preview-section .btn-group.contact-layout-grid .contact-btn-wrapper:nth-last-of-type(1):nth-of-type(3n+2) {
  grid-column: span 2;
}

/* 4 æ¬„ï¼ˆæ¡Œé¢ï¼‰å°¾åˆ—è£œæ»¿ï¼šé¿å…æœ€å¾Œä¸€æ’ç•™ç©ºç™½ */
@media (min-width: 980px) {
  .edit-preview-section .btn-group.contact-layout-grid .contact-btn-wrapper:nth-last-of-type(1):nth-of-type(4n+1) {
    grid-column: 1 / -1;
  }
  .edit-preview-section .btn-group.contact-layout-grid .contact-btn-wrapper:nth-last-of-type(1):nth-of-type(4n+2) {
    grid-column: span 3;
  }
  .edit-preview-section .btn-group.contact-layout-grid .contact-btn-wrapper:nth-last-of-type(1):nth-of-type(4n+3) {
    grid-column: span 2;
  }
}

/* æŒ‰éˆ•å¯¬åº¦è‡ªé©æ‡‰ */
.edit-preview-section .btn {
  width: 100%;
  white-space: nowrap;
  justify-content: flex-start;
  padding-left: 16px;
}

.edit-preview-section .btn-group.contact-layout-grid .btn {
  border-radius: 18px;
  height: 92px;
  /* åœ–æ¨™ä¸Šã€æ–‡å­—ä¸‹ï¼›æ–‡å­—éœ€åƒç¯„ä¾‹å¯è®€ï¼šå…è¨±æœ€å¤šå…©è¡Œæ›è¡Œï¼ˆä»ä¿æŒæ°´å¹³ï¼‰ */
  font-size: clamp(11px, 2.6vw, 14px);
  line-height: 1.15;
  display: flex;
  justify-content: center;
  padding-left: 12px;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  text-align: center;
  overflow: hidden;
  white-space: normal;
}

/* å°å¡ï¼šæ–‡å­—å…©è¡Œï¼ˆçœç•¥è™Ÿï¼‰ */
.edit-preview-section .btn-group.contact-layout-grid .btn .contact-btn-label {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  word-break: break-word;
  overflow-wrap: anywhere;
}

/* å°å¡ï¼šicon æ°´å¹³ç½®ä¸­ */
.edit-preview-section .btn-group.contact-layout-grid .btn img {
  margin: 0 auto;
  display: block;
}

/* æ–°å¢æŒ‰éˆ•å‚ç›´æ’åˆ— */
.edit-preview-section .edit-add-btn {
  width: 100% !important;
  margin-top: 8px !important;
}

/* Grid æ¨¡å¼ä¸‹ï¼šæŠŠã€Œæ–°å¢è¯çµ¡æ–¹å¼ã€é€™é¡æŒ‰éˆ•ç§»åˆ°æ•´è¡Œï¼Œé¿å…ä½”ä¸€æ ¼é€ æˆç©ºç™½ */
.edit-preview-section .btn-group.contact-layout-grid > button.edit-add-btn {
  grid-column: 1 / -1;
  width: 100% !important;
}

/* æ¨™èªå®¹å™¨æ©«å‘æ’åˆ— */
.edit-preview-section .slogans-container {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
}

.edit-preview-section .slogan-item {
  width: auto;
  flex: 0 0 auto;
  min-width: 200px;
  max-width: 350px;
}

/* æ¨™é¡Œå’Œæ¨™èªå€åŸŸæ©«å‘ä½ˆå±€ */
.edit-preview-section .name,
.edit-preview-section .tagline,
.edit-preview-section .section-label {
  display: inline-block;
  margin-right: 16px;
}

/* æç¤ºæ–‡å­—æ©«å‘æ’åˆ— */
.edit-preview-section .hint {
  max-width: 600px;
  display: inline-block;
}

/* è¯çµ¡æ–¹å¼æŒ‰éˆ•åŒ…è£å™¨ */
.contact-btn-wrapper {
  position: relative;
  width: 100%;
}

.contact-delete-btn {
  display: none;
  position: absolute;
  top: 8px;
  right: 8px;
  padding: 4px 8px;
  background: rgba(239, 68, 68, 0.9);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  z-index: 10;
  transition: all 0.2s;
}

.contact-btn-wrapper:hover .contact-delete-btn {
  display: block;
}

.contact-delete-btn:hover {
  background: rgba(239, 68, 68, 1);
}

/* é€£çµè¼¸å…¥æ¨¡æ…‹æ¡†æ¨£å¼ */
.link-input-overlay {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
  background: var(--ui-overlay);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: 4000 !important;
  display: none;
  align-items: center !important;
  justify-content: center !important;
  animation: fadeIn 0.3s ease;
}

.link-input-overlay.show {
  display: flex !important;
}

.link-input-modal {
  width: 90%;
  max-width: 400px;
  border-radius: 20px;
  padding: 24px;
  animation: slideUp 0.3s ease;
  position: relative;
  margin: auto;
}

.link-input-modal {
  background: var(--ui-surface-bg);
  border: 1px solid var(--ui-surface-border);
  color: var(--ui-text);
}

.link-input-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--uvaco-green);
  text-align: center;
  margin-bottom: 20px;
}

.link-input-field {
  width: 100%;
  padding: 12px 16px;
  border-radius: 12px;
  border: 1px solid var(--ui-field-border);
  background: var(--ui-field-bg);
  color: var(--ui-field-text);
  font-size: 16px;
  margin-bottom: 20px;
  box-sizing: border-box;
}

body.theme-light .link-input-field {
  border-color: rgba(15, 23, 42, 0.1);
  background: rgba(15, 23, 42, 0.03);
  color: #111827;
}

.link-input-field:focus {
  outline: none;
  border-color: var(--uvaco-green);
  background: rgba(var(--ui-accent-rgb), 0.12);
}

.link-input-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.link-input-btn {
  padding: 10px 20px;
  border-radius: 8px;
  border: none;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.link-input-cancel {
  background: var(--ui-btn-muted-bg);
  color: var(--ui-btn-muted-text);
}

body.theme-light .link-input-cancel {
  background: rgba(15, 23, 42, 0.1);
  color: #111827;
}

.link-input-cancel:hover {
  background: var(--ui-btn-muted-bg-hover);
}

body.theme-light .link-input-cancel:hover {
  background: rgba(15, 23, 42, 0.2);
}

.link-input-submit {
  background: var(--uvaco-green);
  color: #ffffff;
}

.link-input-submit:hover {
  background: #1fa05a;
  transform: translateY(-1px);
}

/* è‡ªè¨‚é¡å‹ï¼ˆå…¶ä»–ï¼‰æ¨¡æ…‹æ¡† */
.custom-type-overlay {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
  background: var(--ui-overlay);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: 4500 !important;
  display: none;
  align-items: center !important;
  justify-content: center !important;
}

.custom-type-overlay.show {
  display: flex !important;
}

.custom-type-modal {
  width: 92%;
  max-width: 420px;
  border-radius: 20px;
  padding: 24px;
  background: var(--ui-surface-bg);
  border: 1px solid var(--ui-surface-border);
  color: var(--ui-text);
}

.custom-type-title {
  font-size: 18px;
  font-weight: 800;
  margin: 0 0 16px 0;
  color: var(--ui-accent);
}

.custom-type-label {
  font-size: 13px;
  font-weight: 700;
  margin-bottom: 6px;
  color: var(--ui-muted);
}

.custom-type-field {
  width: 100%;
  padding: 12px 14px;
  border-radius: 12px;
  border: 1px solid var(--ui-field-border);
  background: var(--ui-field-bg);
  color: var(--ui-field-text);
  font-size: 15px;
  box-sizing: border-box;
  margin-bottom: 12px;
}

.custom-type-field:focus {
  outline: none;
  border-color: var(--ui-accent);
  box-shadow: 0 0 0 3px rgba(var(--ui-accent-rgb), 0.18);
}

.custom-type-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  margin-top: 8px;
}

.custom-type-btn {
  padding: 10px 18px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: 700;
  transition: all 0.2s;
}

.custom-type-cancel {
  background: var(--ui-btn-muted-bg);
  color: var(--ui-btn-muted-text);
}

.custom-type-cancel:hover {
  background: var(--ui-btn-muted-bg-hover);
}

.custom-type-confirm {
  background: var(--ui-accent);
  color: var(--ui-accent-contrast);
}

.custom-type-confirm:hover {
  filter: brightness(0.96);
  transform: translateY(-1px);
}
/* ===== æ¨¡æ…‹æ¡†å…±ç”¨æ»¾å‹•èˆ‡é…è‰²å„ªåŒ– ===== */
.contact-type-modal,
.link-input-modal,
.custom-type-modal,
.company-info-type-modal,
.address-edit-modal {
  max-height: 85vh;
  overflow-y: auto;
  scrollbar-width: thin;
  -webkit-overflow-scrolling: touch; /* iOS æ»¾å‹•å„ªåŒ– */
}

/* æ²è»¸ç¾åŒ– */
.contact-type-modal::-webkit-scrollbar,
.link-input-modal::-webkit-scrollbar,
.custom-type-modal::-webkit-scrollbar,
.company-info-type-modal::-webkit-scrollbar,
.address-edit-modal::-webkit-scrollbar {
  width: 6px;
}

.contact-type-modal::-webkit-scrollbar-thumb,
.link-input-modal::-webkit-scrollbar-thumb,
.custom-type-modal::-webkit-scrollbar-thumb,
.company-info-type-modal::-webkit-scrollbar-thumb,
.address-edit-modal::-webkit-scrollbar-thumb {
  background: var(--ui-accent);
  border-radius: 10px;
}

.contact-type-modal::-webkit-scrollbar-track,
.link-input-modal::-webkit-scrollbar-track,
.custom-type-modal::-webkit-scrollbar-track,
.company-info-type-modal::-webkit-scrollbar-track,
.address-edit-modal::-webkit-scrollbar-track {
  background: var(--ui-btn-muted-bg);
}

/* è¯çµ¡æ–¹å¼é¡å‹é¸æ“‡å½ˆçª—å°ˆå±¬æ¨£å¼ */
.contact-type-overlay {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
  background: var(--ui-overlay);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: 3500 !important; /* ç¢ºä¿åœ¨å…¶ä»– UI ä¹‹ä¸‹ï¼Œä½†åœ¨èƒŒæ™¯ä¹‹ä¸Š */
  display: none;
  align-items: center !important;
  justify-content: center !important;
  animation: fadeIn 0.3s ease;
}

.contact-type-overlay.show {
  display: flex !important;
}

.contact-type-modal {
  width: 92%;
  max-width: 500px;
  border-radius: 24px;
  padding: 32px;
  background: var(--ui-surface-bg);
  border: 1px solid var(--ui-surface-border);
  color: var(--ui-text);
  animation: slideUp 0.3s ease;
  position: relative;
}

.contact-type-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}

@media (max-width: 480px) {
  .contact-type-grid {
    grid-template-columns: repeat(2, 1fr); /* æ‰‹æ©Ÿç«¯æ”¹ç‚º 2 æ¬„ä½ï¼Œé»æ“Šå€åŸŸæ›´å¤§ */
    gap: 12px;
  }
  .contact-type-modal {
    padding: 24px 16px;
  }
}

.contact-type-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 16px 8px;
  background: var(--ui-btn-muted-bg);
  border: 1px solid var(--ui-surface-border);
  border-radius: 16px;
  color: var(--ui-text);
  cursor: pointer;
  transition: all 0.2s;
  gap: 10px;
}

.contact-type-btn:hover {
  background: var(--ui-btn-muted-bg-hover);
  border-color: var(--ui-accent);
  transform: translateY(-2px);
}

.contact-type-icon {
  font-size: 24px;
}

.contact-type-icon-img {
  width: 32px;
  height: 32px;
  object-fit: contain;
}

.contact-type-label {
  font-size: 13px;
  font-weight: 600;
  text-align: center;
}

/* å…¬å¸è³‡è¨Šé¡å‹å½ˆçª—å°ˆå±¬æ¨£å¼ */
.company-info-type-overlay {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
  background: var(--ui-overlay);
  backdrop-filter: blur(8px);
  z-index: 3600 !important;
  display: none;
  align-items: center !important;
  justify-content: center !important;
}

.company-info-type-overlay.show {
  display: flex !important;
}

.company-info-type-modal {
  width: 92%;
  max-width: 450px;
  border-radius: 24px;
  padding: 32px;
  background: var(--ui-surface-bg);
  border: 1px solid var(--ui-surface-border);
  color: var(--ui-text);
  animation: slideUp 0.3s ease;
}

.company-info-type-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}

.company-info-type-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  padding: 20px;
  background: var(--ui-btn-muted-bg);
  border: 1px solid var(--ui-surface-border);
  border-radius: 16px;
  color: var(--ui-text);
  cursor: pointer;
  transition: all 0.2s;
}

.company-info-type-btn:hover {
  background: var(--ui-btn-muted-bg-hover);
  border-color: var(--ui-accent);
  transform: translateY(-2px);
}

.company-info-type-icon {
  font-size: 28px;
}

.company-info-type-label {
  font-size: 14px;
  font-weight: 700;
}

/* åœ°å€ç·¨è¼¯å½ˆçª—å°ˆå±¬æ¨£å¼ */
.address-edit-overlay {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
  background: var(--ui-overlay);
  backdrop-filter: blur(8px);
  z-index: 3700 !important;
  display: none;
  align-items: center !important;
  justify-content: center !important;
}

.address-edit-overlay.show {
  display: flex !important;
}

.address-edit-modal {
  width: 92%;
  max-width: 500px;
  border-radius: 24px;
  padding: 32px;
  background: var(--ui-surface-bg);
  border: 1px solid var(--ui-surface-border);
  color: var(--ui-text);
}

.address-edit-textarea {
  width: 100%;
  padding: 12px 16px;
  border-radius: 12px;
  border: 1px solid var(--ui-field-border);
  background: var(--ui-field-bg);
  color: var(--ui-field-text);
  font-size: 15px;
  resize: vertical;
  margin-bottom: 16px;
  box-sizing: border-box;
}

.address-edit-textarea:focus {
  outline: none;
  border-color: var(--ui-accent);
}

.address-edit-label {
  display: block;
  font-size: 13px;
  font-weight: 700;
  margin-bottom: 8px;
  color: var(--ui-muted);
}

.address-edit-btn {
  padding: 12px 24px;
  border-radius: 12px;
  border: none;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
}

.address-edit-submit {
  background: var(--ui-accent);
  color: var(--ui-accent-contrast);
}

.address-edit-cancel {
  background: var(--ui-btn-muted-bg);
  color: var(--ui-btn-muted-text);
}

.address-edit-actions {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-top: 20px;
}

/* ç¯„ä¾‹æµ®æ°´å° */
.example-watermark {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(-15deg);
  font-size: 28px;
  font-weight: 800;
  color: rgba(255, 255, 255, 0.12);
  text-transform: uppercase;
  letter-spacing: 6px;
  pointer-events: none;
  z-index: 10;
  white-space: nowrap;
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* Contenteditable placeholder styling */
[contenteditable="true"]:empty:before {
  content: attr(data-placeholder);
  color: rgba(255, 255, 255, 0.4);
  font-style: italic;
  pointer-events: none;
}

[contenteditable="true"]:focus:empty:before {
  content: '';
}

/* Upload placeholder styling */
.upload-placeholder {
  transition: all 0.2s ease;
}

.upload-placeholder:hover {
  border-color: rgba(255,255,255,0.5) !important;
  background: rgba(255,255,255,0.1) !important;
}

/* å­—é«”æ¨£å¼å·¥å…·åˆ— */
.font-style-toolbar {
  display: none;
  position: fixed;
  top: 100px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(30, 30, 30, 0.98);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 10px;
  padding: 10px 14px;
  gap: 10px;
  align-items: center;
  z-index: 99999;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
  white-space: nowrap;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

.font-style-toolbar.active {
  display: flex;
}

.font-style-group {
  display: flex;
  align-items: center;
  gap: 4px;
}

.font-style-group:not(:last-child) {
  padding-right: 8px;
  border-right: 1px solid rgba(255, 255, 255, 0.2);
}

.font-style-btn {
  width: 28px;
  height: 28px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 4px;
  background: transparent;
  color: #fff;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  transition: all 0.2s;
}

.font-style-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(255, 255, 255, 0.5);
}

.font-style-btn.active {
  background: rgba(34, 197, 94, 0.3);
  border-color: #22c55e;
}

.font-style-btn.size-s { font-size: 10px; }
.font-style-btn.size-m { font-size: 14px; }
.font-style-btn.size-l { font-size: 18px; }

.font-color-btn {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: 2px solid transparent;
  cursor: pointer;
  transition: all 0.2s;
}

.font-color-btn:hover {
  transform: scale(1.1);
}

.font-color-btn.active {
  border-color: #fff;
  box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.5);
}

/* èª¿è‰²ç›¤è¼¸å…¥æ¡† */
.font-color-picker-wrapper {
  position: relative;
  display: flex;
  align-items: center;
  gap: 6px;
}

.font-color-picker {
  width: 32px;
  height: 32px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  cursor: pointer;
  padding: 0;
  background: transparent;
  -webkit-appearance: none;
  appearance: none;
}

.font-color-picker::-webkit-color-swatch-wrapper {
  padding: 0;
}

.font-color-picker::-webkit-color-swatch {
  border: none;
  border-radius: 50%;
}

.font-color-picker::-moz-color-swatch {
  border: none;
  border-radius: 50%;
}

.font-color-picker:hover {
  transform: scale(1.1);
  border-color: rgba(255, 255, 255, 0.6);
}

.font-color-picker:focus {
  outline: none;
  border-color: #22c55e;
  box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.3);
}

/* å¯ç·¨è¼¯æ¬„ä½çš„æ¨£å¼å®¹å™¨ */
.editable-field-wrapper {
  position: relative;
  display: inline-block;
  width: 100%;
}

</style>
</head>

<body class="lang-zh">

<!-- å­—é«”æ¨£å¼å·¥å…·åˆ— -->
<div id="fontStyleToolbar" class="font-style-toolbar" onmousedown="event.preventDefault()">
  <!-- å­—é«”å¤§å° -->
  <div class="font-style-group">
    <button type="button" class="font-style-btn size-s" onclick="setFontSize('small'); event.stopPropagation();" title="å°">A</button>
    <button type="button" class="font-style-btn size-m active" onclick="setFontSize('medium'); event.stopPropagation();" title="ä¸­">A</button>
    <button type="button" class="font-style-btn size-l" onclick="setFontSize('large'); event.stopPropagation();" title="å¤§">A</button>
  </div>
  <!-- ç²—ç´° -->
  <div class="font-style-group">
    <button type="button" class="font-style-btn" onclick="setFontWeight('normal'); event.stopPropagation();" title="æ­£å¸¸" style="font-weight: 400;">N</button>
    <button type="button" class="font-style-btn" onclick="setFontWeight('bold'); event.stopPropagation();" title="ç²—é«”" style="font-weight: 700;">B</button>
  </div>
  <!-- é¡è‰² -->
  <div class="font-style-group">
    <div class="font-color-picker-wrapper">
      <input type="color" id="fontColorPicker" class="font-color-picker" value="#ffffff" title="é¸æ“‡é¡è‰²" onchange="setFontColor(this.value)" oninput="setFontColor(this.value)">
      <span style="color: #aaa; font-size: 11px;">é¡è‰²</span>
    </div>
  </div>
</div>

<!-- èƒŒæ™¯æ³¡æ³¡ -->
<div class="bg-blob blob1"></div>
<div class="bg-blob blob2"></div>

<!-- é ‚éƒ¨ï¼šè¿”å›æŒ‰éˆ• -->
<div class="edit-top-header">
  <a href="directory.html" style="font-size: 20px; color: var(--uvaco-green); text-decoration: none;">â†</a>
</div>

<div class="edit-page-wrapper">
  <div class="edit-page-container">
    <!-- é ‚éƒ¨ï¼šæ¨™é¡Œå’Œä¿å­˜æŒ‰éˆ• -->
    <div class="edit-header-top">
      <h1 class="edit-title lang-zh">ç·¨è¼¯åç‰‡</h1>
      <h1 class="edit-title lang-en">Edit Business Card</h1>
      <div style="display: flex; gap: 12px; align-items: center;">
        <button class="edit-theme-btn" onclick="showThemeSelector()" title="é¸æ“‡ä¸»é¡Œ">
          <span style="font-size: 18px;">ğŸ¨</span>
          <span class="lang-zh">ä¸»é¡Œ</span>
          <span class="lang-en">Theme</span>
        </button>
        <button class="edit-save-btn" onclick="saveCard()">
          <span class="lang-zh">å„²å­˜</span>
          <span class="lang-en">Save</span>
        </button>
      </div>
    </div>
    
    
    <!-- åç‰‡é è¦½ï¼ˆå¯ç›´æ¥ç·¨è¼¯ï¼‰ -->
    <div class="edit-preview-section">
      <div class="hero">
        <div class="hero-frame edit-clickable" onclick="editLogo()" title="é»æ“Šç·¨è¼¯ LOGO" style="position: relative;">
          <img src="" class="hero-logo" alt="Logo" id="previewLogo" loading="lazy" style="display: none;">
          <div class="upload-placeholder" id="logoPlaceholder" style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 80px; border: 2px dashed rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer;">
            <span style="font-size: 24px; margin-bottom: 4px;">ğŸ“·</span>
            <span class="lang-zh" style="font-size: 12px; color: rgba(255,255,255,0.6);">é»æ“Šä¸Šå‚³ Logo</span>
            <span class="lang-en" style="font-size: 12px; color: rgba(255,255,255,0.6);">Click to upload Logo</span>
          </div>
        </div>
      </div>

      <div class="card" id="previewCard" style="position: relative;">
        <!-- ç¯„ä¾‹æµ®æ°´å° -->
        <div class="example-watermark">
          <span class="lang-zh">ç¯„ä¾‹å‘ˆç¾</span>
          <span class="lang-en">Example</span>
        </div>
        <div class="avatar-container edit-clickable" onclick="editAvatar()" title="é»æ“Šç·¨è¼¯é ­åƒ" style="position: relative; width: 120px; height: 120px; margin: 0 auto 16px;">
          <img class="avatar" id="previewAvatar" src="" alt="Avatar" loading="lazy" style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
          <div class="upload-placeholder" id="avatarPlaceholder" style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 120px; height: 120px; border: 2px dashed rgba(255,255,255,0.3); border-radius: 50%; cursor: pointer; background: rgba(255,255,255,0.05);">
            <span style="font-size: 32px; margin-bottom: 4px;">ğŸ‘¤</span>
            <span class="lang-zh" style="font-size: 11px; color: rgba(255,255,255,0.6); text-align: center;">é»æ“Šä¸Šå‚³<br>é ­åƒ</span>
            <span class="lang-en" style="font-size: 11px; color: rgba(255,255,255,0.6); text-align: center;">Upload<br>Photo</span>
          </div>
        </div>
        
        <div class="name lang-zh edit-clickable" id="previewNameZh" contenteditable="true" onblur="updateNameFromPreview()" onclick="focusEdit(this)" data-placeholder="è«‹è¼¸å…¥å§“å" style="min-height: 1.2em;"></div>
        
        <div class="tagline lang-zh edit-clickable" id="previewTitleZh" contenteditable="true" onblur="updateTitleFromPreview()" onclick="focusEdit(this)" data-placeholder="è«‹è¼¸å…¥è·ç¨±" style="min-height: 1.2em;"></div>
        <div class="tagline lang-en edit-clickable" id="previewTitleEn" contenteditable="true" onblur="updateTitleFromPreview()" onclick="focusEdit(this)" data-placeholder="Enter job title" style="min-height: 1.2em;"></div>
        
        <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-start;">
          <div id="previewSlogansZh" class="slogans-container">
            <!-- æ¨™èªå°‡å‹•æ…‹æ–°å¢ -->
          </div>
          <button class="edit-add-btn lang-zh" onclick="addSloganToPreview('zh')">+ æ–°å¢ä¸­æ–‡æ¨™èªï¼ˆé¸å¡«ï¼‰</button>
          <button class="edit-add-btn lang-en" onclick="addSloganToPreview('zh')">+ Add Chinese Slogan (optional)</button>
          
          <div id="previewSlogansEn" class="slogans-container">
            <!-- æ¨™èªå°‡å‹•æ…‹æ–°å¢ -->
          </div>
          <button class="edit-add-btn lang-zh" onclick="addSloganToPreview('en')">+ æ–°å¢è‹±æ–‡æ¨™èªï¼ˆé¸å¡«ï¼‰</button>
          <button class="edit-add-btn lang-en" onclick="addSloganToPreview('en')">+ Add English Slogan (optional)</button>
        </div>

        <div class="divider"></div>

        <!-- å…¬å¸è³‡è¨Šå€å¡Š -->
        <div class="company-info-section" id="companyInfoSection">
          <div class="section-label lang-zh">å…¬å¸è³‡è¨Š COMPANY INFO</div>
          <div class="section-label lang-en">COMPANY INFO</div>
          
          <!-- å…¬å¸åç¨±ï¼ˆå¯é¸ï¼‰ -->
          <div class="info-item info-item-company-name" id="companyNameItem" style="display: none;">
            <span class="info-label lang-zh">å…¬å¸åç¨±ï¼š</span>
            <span class="info-label lang-en">Company Name:</span>
            <span class="info-value lang-zh edit-clickable" id="previewCompanyNameZh" contenteditable="true" onclick="focusEdit(this)" onblur="updateCompanyFromPreview()" data-placeholder="è«‹è¼¸å…¥å…¬å¸åç¨±" style="min-width: 150px; min-height: 1.2em;"></span>
            <span class="info-value lang-en edit-clickable" id="previewCompanyNameEn" contenteditable="true" onclick="focusEdit(this)" onblur="updateCompanyFromPreview()" data-placeholder="Enter company name" style="min-width: 150px; min-height: 1.2em;"></span>
            <button class="info-delete-btn" onclick="deleteCompanyInfo('companyName')" title="åˆªé™¤">Ã—</button>
          </div>
          
          <!-- çµ±ä¸€ç·¨è™Ÿï¼ˆå¯é¸ï¼‰ -->
          <div class="info-item info-item-tax" id="taxIdItem" style="display: none;">
            <span class="info-label lang-zh">çµ±ä¸€ç·¨è™Ÿï¼š</span>
            <span class="info-label lang-en">Tax ID:</span>
            <span class="info-value lang-zh edit-clickable" id="previewTaxIdZh" contenteditable="true" onclick="editTaxId(event)">12345678</span>
            <span class="info-value lang-en edit-clickable" id="previewTaxIdEn" contenteditable="true" onclick="editTaxId(event)">12345678</span>
            <button class="info-delete-btn" onclick="deleteCompanyInfo('taxId')" title="åˆªé™¤">Ã—</button>
          </div>
          
          <!-- æœå‹™æ“šé»ï¼ˆå¯é¸ï¼‰ -->
          <div class="info-item info-item-location" id="serviceLocationItem" style="display: none;">
            <span class="info-label lang-zh">æœå‹™æ“šé»ï¼š</span>
            <span class="info-label lang-en">Service Location:</span>
            <span class="info-value lang-zh edit-clickable" id="previewServiceLocationZh" onclick="editAddress('serviceLocation', event)">
              <span class="address-text">å°åŒ—å¸‚ä¿¡ç¾©å€ä¿¡ç¾©è·¯äº”æ®µ7è™Ÿ</span>
              <span class="address-map-link" onclick="openMap('serviceLocation', event)">ğŸ“ åœ°åœ–</span>
            </span>
            <span class="info-value lang-en edit-clickable" id="previewServiceLocationEn" onclick="editAddress('serviceLocation', event)">
              <span class="address-text">No. 7, Section 5, Xinyi Road, Xinyi District, Taipei</span>
              <span class="address-map-link" onclick="openMap('serviceLocation', event)">ğŸ“ Map</span>
            </span>
            <button class="info-delete-btn" onclick="deleteCompanyInfo('serviceLocation')" title="åˆªé™¤">Ã—</button>
          </div>
          
          <!-- é€šè¨Šä½å€ï¼ˆå¯é¸ï¼‰ -->
          <div class="info-item info-item-location" id="mailingAddressItem" style="display: none;">
            <span class="info-label lang-zh">é€šè¨Šä½å€ï¼š</span>
            <span class="info-label lang-en">Mailing Address:</span>
            <span class="info-value lang-zh edit-clickable" id="previewMailingAddressZh" onclick="editAddress('mailingAddress', event)">
              <span class="address-text">å°åŒ—å¸‚ä¿¡ç¾©å€ä¿¡ç¾©è·¯äº”æ®µ7è™Ÿ</span>
              <span class="address-map-link" onclick="openMap('mailingAddress', event)">ğŸ“ åœ°åœ–</span>
            </span>
            <span class="info-value lang-en edit-clickable" id="previewMailingAddressEn" onclick="editAddress('mailingAddress', event)">
              <span class="address-text">No. 7, Section 5, Xinyi Road, Xinyi District, Taipei</span>
              <span class="address-map-link" onclick="openMap('mailingAddress', event)">ğŸ“ Map</span>
            </span>
            <button class="info-delete-btn" onclick="deleteCompanyInfo('mailingAddress')" title="åˆªé™¤">Ã—</button>
          </div>
          
          <!-- å…¬å¸ä½å€ï¼ˆå¯é¸ï¼‰ -->
          <div class="info-item info-item-location" id="companyAddressItem" style="display: none;">
            <span class="info-label lang-zh">å…¬å¸ä½å€ï¼š</span>
            <span class="info-label lang-en">Company Address:</span>
            <span class="info-value lang-zh edit-clickable" id="previewCompanyAddressZh" onclick="editAddress('companyAddress', event)">
              <span class="address-text">å°åŒ—å¸‚ä¿¡ç¾©å€ä¿¡ç¾©è·¯äº”æ®µ7è™Ÿ</span>
              <span class="address-map-link" onclick="openMap('companyAddress', event)">ğŸ“ åœ°åœ–</span>
            </span>
            <span class="info-value lang-en edit-clickable" id="previewCompanyAddressEn" onclick="editAddress('companyAddress', event)">
              <span class="address-text">No. 7, Section 5, Xinyi Road, Xinyi District, Taipei</span>
              <span class="address-map-link" onclick="openMap('companyAddress', event)">ğŸ“ Map</span>
            </span>
            <button class="info-delete-btn" onclick="deleteCompanyInfo('companyAddress')" title="åˆªé™¤">Ã—</button>
          </div>
          
          <!-- æ–°å¢å…¬å¸è³‡è¨ŠæŒ‰éˆ• -->
          <button class="edit-add-btn lang-zh" onclick="showCompanyInfoTypeModal(event)">+ æ–°å¢å…¬å¸è³‡è¨Š</button>
          <button class="edit-add-btn lang-en" onclick="showCompanyInfoTypeModal(event)">+ Add Company Info</button>
        </div>

        <div class="divider"></div>

        <div class="section-label lang-zh">è¯çµ¡æ–¹å¼ CONTACT</div>
        <div class="section-label lang-en">CONTACT</div>

        <!-- è¯çµ¡æ–¹å¼é¡¯ç¤ºæ¨£å¼ï¼ˆåˆ—è¡¨ / å°å¡ï¼‰ -->
        <div class="contact-layout-toolbar">
          <div class="contact-layout-label">
            <span class="lang-zh">é¡¯ç¤ºæ–¹å¼</span><span class="lang-en">Layout</span>
          </div>
          <div class="contact-layout-toggle" role="group" aria-label="Contact layout">
            <button type="button" class="contact-layout-btn is-active" id="contactLayoutListBtn" onclick="setContactLayout('list')">
              <span class="lang-zh">åˆ—è¡¨</span><span class="lang-en">List</span>
            </button>
            <button type="button" class="contact-layout-btn" id="contactLayoutGridBtn" onclick="setContactLayout('grid')">
              <span class="lang-zh">å°å¡</span><span class="lang-en">Cards</span>
            </button>
          </div>
        </div>

        <div class="btn-group" id="previewContacts">
          <!-- è¯çµ¡æ–¹å¼å°‡ç”±ä½¿ç”¨è€…è‡ªè¡Œæ–°å¢ -->
          <button class="edit-add-btn lang-zh" onclick="addContact(event)">+ æ–°å¢è¯çµ¡æ–¹å¼</button>
          <button class="edit-add-btn lang-en" onclick="addContact(event)">+ Add Contact Method</button>
        </div>

        <div class="hint lang-zh">
          å¦‚éœ€ç”³è«‹å¯¦é«” <strong>NFC åç‰‡</strong>ï¼Œè«‹æ´½ <a href="https://line.me/R/ti/p/@632nedvu" target="_blank" style="color: #06c755; text-decoration: underline;">LINE å®˜æ–¹å¸³è™Ÿ</a>èˆ‡æˆ‘å€‘è¯ç¹«ã€‚
        </div>
        <div class="hint lang-en">
          To apply for a physical <strong>NFC card</strong>, please contact us via <a href="https://line.me/R/ti/p/@632nedvu" target="_blank" style="color: #06c755; text-decoration: underline;">LINE Official Account</a>.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- è¯çµ¡æ–¹å¼é¡å‹é¸æ“‡å½ˆå‡ºè¦–çª— -->
<div class="contact-type-overlay" id="contactTypeOverlay" onclick="closeContactTypeModal(event)">
  <div class="contact-type-modal" onclick="event.stopPropagation()">
    <h2 class="contact-type-title lang-zh">é¸æ“‡è¯çµ¡æ–¹å¼é¡å‹</h2>
    <h2 class="contact-type-title lang-en">Select Contact Method Type</h2>
    
    <div class="contact-type-grid">
      <button class="contact-type-btn" onclick="selectContactType('company-phone', 'å…¬å¸é›»è©±', 'Company Phone')">
        <span class="contact-type-icon"><img src="phone-icon.svg" alt="Phone" class="contact-type-icon-img"></span>
        <span class="contact-type-label lang-zh">å…¬å¸é›»è©±</span>
        <span class="contact-type-label lang-en">Company Phone</span>
      </button>
      
      <button class="contact-type-btn" onclick="selectContactType('personal-phone', 'å€‹äººé›»è©±', 'Personal Phone')">
        <span class="contact-type-icon"><img src="mobile-icon.svg" alt="Mobile" class="contact-type-icon-img"></span>
        <span class="contact-type-label lang-zh">å€‹äººé›»è©±</span>
        <span class="contact-type-label lang-en">Personal Phone</span>
      </button>
      
      <button class="contact-type-btn" onclick="selectContactType('email', 'Email', 'Email')">
        <span class="contact-type-icon"><img src="email-icon.svg" alt="Email" class="contact-type-icon-img"></span>
        <span class="contact-type-label">Email</span>
      </button>
      
      <button class="contact-type-btn" onclick="selectContactType('website', 'ç¶²ç«™', 'Website')">
        <span class="contact-type-icon"><img src="website-icon.svg" alt="Website" class="contact-type-icon-img"></span>
        <span class="contact-type-label lang-zh">ç¶²ç«™</span>
        <span class="contact-type-label lang-en">Website</span>
      </button>
      
      <button class="contact-type-btn" onclick="selectContactType('line', 'LINE', 'LINE')">
        <span class="contact-type-icon"><img src="line-logo.svg" alt="LINE" class="contact-type-icon-img"></span>
        <span class="contact-type-label">LINE</span>
      </button>
      
      <button class="contact-type-btn" onclick="selectContactType('official-line', 'å®˜æ–¹LINE', 'Official LINE')">
        <span class="contact-type-icon"><img src="line-logo.svg" alt="LINE" class="contact-type-icon-img"></span>
        <span class="contact-type-label lang-zh">å®˜æ–¹LINE</span>
        <span class="contact-type-label lang-en">Official LINE</span>
      </button>
      
      <button class="contact-type-btn" onclick="selectContactType('facebook', 'Facebook', 'Facebook')">
        <span class="contact-type-icon"><img src="facebook-logo.svg" alt="Facebook" class="contact-type-icon-img"></span>
        <span class="contact-type-label">Facebook</span>
      </button>
      
      <button class="contact-type-btn" onclick="selectContactType('instagram', 'Instagram', 'Instagram')">
        <span class="contact-type-icon"><img src="instagram-logo.svg" alt="Instagram" class="contact-type-icon-img"></span>
        <span class="contact-type-label">Instagram</span>
      </button>
      
      <button class="contact-type-btn" onclick="selectContactType('linkedin', 'LinkedIn', 'LinkedIn')">
        <span class="contact-type-icon"><img src="linkedin-logo.svg" alt="LinkedIn" class="contact-type-icon-img"></span>
        <span class="contact-type-label">LinkedIn</span>
      </button>
      
      <button class="contact-type-btn" onclick="selectContactType('twitter', 'X (Twitter)', 'X (Twitter)')">
        <span class="contact-type-icon"><img src="twitter-logo.svg" alt="X" class="contact-type-icon-img"></span>
        <span class="contact-type-label lang-zh">X (Twitter)</span>
        <span class="contact-type-label lang-en">X (Twitter)</span>
      </button>
      
      <button class="contact-type-btn" onclick="selectContactType('youtube', 'YouTube', 'YouTube')">
        <span class="contact-type-icon"><img src="youtube-logo.svg" alt="YouTube" class="contact-type-icon-img"></span>
        <span class="contact-type-label">YouTube</span>
      </button>
      
      <button class="contact-type-btn" onclick="selectContactType('wechat', 'å¾®ä¿¡', 'WeChat')">
        <span class="contact-type-icon"><img src="wechat-logo.svg" alt="WeChat" class="contact-type-icon-img"></span>
        <span class="contact-type-label lang-zh">å¾®ä¿¡</span>
        <span class="contact-type-label lang-en">WeChat</span>
      </button>
      
      <button class="contact-type-btn contact-type-btn-whatsapp" onclick="selectContactType('whatsapp', 'WhatsApp', 'WhatsApp')">
        <span class="contact-type-icon"><img src="whatsapp-logo.svg" alt="WhatsApp" class="contact-type-icon-img"></span>
        <span class="contact-type-label">WhatsApp</span>
      </button>
      
      <button class="contact-type-other" onclick="selectContactType('other', 'å…¶ä»–', 'Other')">
        <span class="contact-type-other-icon">+</span>
        <span class="contact-type-other-label lang-zh">å…¶ä»– (è‡ªè¨‚é¡å‹)</span>
        <span class="contact-type-other-label lang-en">Other (Custom Type)</span>
      </button>
    </div>
    
    <div class="contact-type-actions">
      <button class="contact-type-cancel lang-zh" onclick="closeContactTypeModal(event)">å–æ¶ˆ</button>
      <button class="contact-type-cancel lang-en" onclick="closeContactTypeModal(event)">Cancel</button>
    </div>
  </div>
</div>

<!-- é€£çµè¼¸å…¥æ¨¡æ…‹æ¡† -->
<div class="link-input-overlay" id="linkInputOverlay" onclick="closeLinkInputModal(event)">
  <div class="link-input-modal" onclick="event.stopPropagation()">
    <h2 class="link-input-title lang-zh">è¼¸å…¥é€£çµ</h2>
    <h2 class="link-input-title lang-en">Enter Link</h2>
    <input type="text" class="link-input-field" id="linkInputField" placeholder="" autofocus onkeydown="if(event.key === 'Enter') { event.preventDefault(); event.stopPropagation(); submitLinkInput(event); return false; }">
    <div class="link-input-help" id="linkInputHelp" style="margin-top:10px;font-size:13px;line-height:1.45;opacity:.92;">
      <div class="lang-zh">ç¯„ä¾‹ï¼š<code style="opacity:.9;">https://example.com</code></div>
      <div class="lang-en">Example: <code style="opacity:.9;">https://example.com</code></div>
    </div>
    <div class="link-input-actions">
      <button class="link-input-btn link-input-cancel lang-zh" onclick="closeLinkInputModal(event)">å–æ¶ˆ</button>
      <button class="link-input-btn link-input-cancel lang-en" onclick="closeLinkInputModal(event)">Cancel</button>
      <button class="link-input-btn link-input-submit lang-zh" onclick="submitLinkInput(event)">ç¢ºå®š</button>
      <button class="link-input-btn link-input-submit lang-en" onclick="submitLinkInput(event)">Confirm</button>
    </div>
  </div>
</div>

<!-- è‡ªè¨‚ã€Œå…¶ä»–ã€é¡å‹æ¨¡æ…‹æ¡† -->
<div class="custom-type-overlay" id="customTypeOverlay" onclick="closeCustomTypeModal(event)">
  <div class="custom-type-modal" onclick="event.stopPropagation()">
    <h2 class="custom-type-title lang-zh">è‡ªè¨‚é¡å‹</h2>
    <h2 class="custom-type-title lang-en">Custom Type</h2>

    <div class="custom-type-label lang-zh">ä¸­æ–‡åç¨±</div>
    <div class="custom-type-label lang-en">Chinese Name</div>
    <input class="custom-type-field" id="customTypeZh" type="text" placeholder="ä¾‹å¦‚ï¼šTelegramã€Google Meetã€åç‰‡é€£çµâ€¦">

    <div class="custom-type-label lang-zh">è‹±æ–‡åç¨±</div>
    <div class="custom-type-label lang-en">English Name</div>
    <input class="custom-type-field" id="customTypeEn" type="text" placeholder="e.g. Telegram, Google Meet, Card Link...">

    <div class="custom-type-actions">
      <button class="custom-type-btn custom-type-cancel lang-zh" onclick="closeCustomTypeModal(event)">å–æ¶ˆ</button>
      <button class="custom-type-btn custom-type-cancel lang-en" onclick="closeCustomTypeModal(event)">Cancel</button>
      <button class="custom-type-btn custom-type-confirm lang-zh" onclick="submitCustomType(event)">ç¢ºå®š</button>
      <button class="custom-type-btn custom-type-confirm lang-en" onclick="submitCustomType(event)">Confirm</button>
    </div>
  </div>
</div>

<!-- å…¬å¸è³‡è¨Šé¡å‹é¸æ“‡å½ˆå‡ºè¦–çª— -->
<div class="company-info-type-overlay" id="companyInfoTypeOverlay" onclick="closeCompanyInfoTypeModal(event)">
  <div class="company-info-type-modal" onclick="event.stopPropagation()">
    <h2 class="company-info-type-title lang-zh">é¸æ“‡å…¬å¸è³‡è¨Šé¡å‹</h2>
    <h2 class="company-info-type-title lang-en">Select Company Info Type</h2>
    
    <div class="company-info-type-grid">
      <button class="company-info-type-btn" onclick="selectCompanyInfoType('companyName')">
        <span class="company-info-type-icon">ğŸ·ï¸</span>
        <span class="company-info-type-label lang-zh">å…¬å¸åç¨±</span>
        <span class="company-info-type-label lang-en">Company Name</span>
      </button>
      
      <button class="company-info-type-btn" onclick="selectCompanyInfoType('taxId')">
        <span class="company-info-type-icon">ğŸ”¢</span>
        <span class="company-info-type-label lang-zh">çµ±ä¸€ç·¨è™Ÿ</span>
        <span class="company-info-type-label lang-en">Tax ID</span>
      </button>
      
      <button class="company-info-type-btn" onclick="selectCompanyInfoType('serviceLocation')">
        <span class="company-info-type-icon">ğŸ“</span>
        <span class="company-info-type-label lang-zh">æœå‹™æ“šé»</span>
        <span class="company-info-type-label lang-en">Service Location</span>
      </button>
      
      <button class="company-info-type-btn" onclick="selectCompanyInfoType('mailingAddress')">
        <span class="company-info-type-icon">ğŸ“®</span>
        <span class="company-info-type-label lang-zh">é€šè¨Šä½å€</span>
        <span class="company-info-type-label lang-en">Mailing Address</span>
      </button>
      
      <button class="company-info-type-btn" onclick="selectCompanyInfoType('companyAddress')">
        <span class="company-info-type-icon">ğŸ¢</span>
        <span class="company-info-type-label lang-zh">å…¬å¸ä½å€</span>
        <span class="company-info-type-label lang-en">Company Address</span>
      </button>

      <button class="company-info-type-btn" onclick="selectCompanyInfoType('custom')">
        <span class="company-info-type-icon">â•</span>
        <span class="company-info-type-label lang-zh">è‡ªè¨‚æ¬„ä½</span>
        <span class="company-info-type-label lang-en">Custom</span>
      </button>
    </div>
    
    <div class="company-info-type-actions">
      <button class="company-info-type-cancel lang-zh" onclick="closeCompanyInfoTypeModal(event)">å–æ¶ˆ</button>
      <button class="company-info-type-cancel lang-en" onclick="closeCompanyInfoTypeModal(event)">Cancel</button>
    </div>
  </div>
</div>

<!-- åœ°å€ç·¨è¼¯å½ˆå‡ºè¦–çª— -->
<div class="address-edit-overlay" id="addressEditOverlay" onclick="closeAddressEditModal(event)">
  <div class="address-edit-modal" onclick="event.stopPropagation()">
    <h2 class="address-edit-title lang-zh" id="addressEditTitleZh">ç·¨è¼¯åœ°å€</h2>
    <h2 class="address-edit-title lang-en" id="addressEditTitleEn">Edit Address</h2>
    
    <div class="address-edit-form">
      <div class="address-edit-group">
        <label class="address-edit-label lang-zh">ä¸­æ–‡åœ°å€</label>
        <label class="address-edit-label lang-en">Chinese Address</label>
        <textarea class="address-edit-textarea" id="addressEditZh" rows="3" placeholder="è«‹è¼¸å…¥ä¸­æ–‡åœ°å€"></textarea>
      </div>
      
      <div class="address-edit-group">
        <label class="address-edit-label lang-zh">è‹±æ–‡åœ°å€</label>
        <label class="address-edit-label lang-en">English Address</label>
        <textarea class="address-edit-textarea" id="addressEditEn" rows="3" placeholder="Enter English address"></textarea>
      </div>
      
      <div class="address-edit-map-section">
        <button class="address-edit-map-btn lang-zh" onclick="generateMapLink()">
          <span class="map-icon">ğŸ“</span>
          <span>é–‹å•Ÿåœ°åœ–</span>
        </button>
        <button class="address-edit-map-btn lang-en" onclick="generateMapLink()">
          <span class="map-icon">ğŸ“</span>
          <span>Open Map</span>
        </button>
        <a class="address-edit-map-link" id="addressMapLink" href="#" target="_blank" style="display: none;">
          <span class="lang-zh">åœ¨ Google Maps ä¸­æŸ¥çœ‹</span>
          <span class="lang-en">View on Google Maps</span>
        </a>
      </div>
    </div>
    
    <div class="address-edit-actions">
      <button class="address-edit-btn address-edit-cancel lang-zh" onclick="closeAddressEditModal(event)">å–æ¶ˆ</button>
      <button class="address-edit-btn address-edit-cancel lang-en" onclick="closeAddressEditModal(event)">Cancel</button>
      <button class="address-edit-btn address-edit-submit lang-zh" onclick="submitAddressEdit(event)">ç¢ºå®š</button>
      <button class="address-edit-btn address-edit-submit lang-en" onclick="submitAddressEdit(event)">Confirm</button>
    </div>
  </div>
</div>

<!-- ä¸»é¡Œé¸æ“‡å™¨æ¨¡æ…‹æ¡† -->
<div class="theme-selector-overlay" id="themeSelectorOverlay" onclick="closeThemeSelector(event)">
  <div class="theme-selector-modal" onclick="event.stopPropagation()">
    <div class="theme-selector-header">
      <h2 class="theme-selector-title lang-zh">é¸æ“‡åç‰‡ä¸»é¡Œ</h2>
      <h2 class="theme-selector-title lang-en">Select Card Theme</h2>
      <button class="theme-selector-close" onclick="closeThemeSelector(event)" title="é—œé–‰">Ã—</button>
    </div>
    
    <div class="theme-selector-grid">
      <!-- Theme 1: Dark -->
      <div class="theme-card-preview" data-theme="1" onclick="selectCardTheme(1)">
        <div class="theme-preview-wrapper">
          <div class="theme-preview-top-bar"></div>
          <div class="theme-preview-card">
            <div class="theme-preview-text long"></div>
            <div class="theme-preview-text short"></div>
            <div class="theme-preview-text long"></div>
            <div class="theme-preview-button"></div>
          </div>
        </div>
        <div class="theme-card-name lang-zh">æ·±è‰²ä¸»é¡Œ</div>
        <div class="theme-card-name lang-en">Dark Theme</div>
      </div>
      
      <!-- Theme 2: Light -->
      <div class="theme-card-preview" data-theme="2" onclick="selectCardTheme(2)">
        <div class="theme-preview-wrapper">
          <div class="theme-preview-top-bar"></div>
          <div class="theme-preview-card">
            <div class="theme-preview-text long"></div>
            <div class="theme-preview-text short"></div>
            <div class="theme-preview-text long"></div>
            <div class="theme-preview-button"></div>
          </div>
        </div>
        <div class="theme-card-name lang-zh">æ·ºè‰²ä¸»é¡Œ</div>
        <div class="theme-card-name lang-en">Light Theme</div>
      </div>
      
      <!-- Theme 3: Blue -->
      <div class="theme-card-preview" data-theme="3" onclick="selectCardTheme(3)">
        <div class="theme-preview-wrapper">
          <div class="theme-preview-top-bar"></div>
          <div class="theme-preview-card">
            <div class="theme-preview-text long"></div>
            <div class="theme-preview-text short"></div>
            <div class="theme-preview-text long"></div>
            <div class="theme-preview-button"></div>
          </div>
        </div>
        <div class="theme-card-name lang-zh">è—è‰²ä¸»é¡Œ</div>
        <div class="theme-card-name lang-en">Blue Theme</div>
      </div>
      
      <!-- Theme 4: Gold -->
      <div class="theme-card-preview" data-theme="4" onclick="selectCardTheme(4)">
        <div class="theme-preview-wrapper">
          <div class="theme-preview-top-bar"></div>
          <div class="theme-preview-card">
            <div class="theme-preview-text long"></div>
            <div class="theme-preview-text short"></div>
            <div class="theme-preview-text long"></div>
            <div class="theme-preview-button"></div>
          </div>
        </div>
        <div class="theme-card-name lang-zh">é‡‘è‰²ä¸»é¡Œ</div>
        <div class="theme-card-name lang-en">Gold Theme</div>
      </div>
      
      <!-- Theme 5: Purple -->
      <div class="theme-card-preview" data-theme="5" onclick="selectCardTheme(5)">
        <div class="theme-preview-wrapper">
          <div class="theme-preview-top-bar"></div>
          <div class="theme-preview-card">
            <div class="theme-preview-text long"></div>
            <div class="theme-preview-text short"></div>
            <div class="theme-preview-text long"></div>
            <div class="theme-preview-button"></div>
          </div>
        </div>
        <div class="theme-card-name lang-zh">ç´«è‰²ä¸»é¡Œ</div>
        <div class="theme-card-name lang-en">Purple Theme</div>
      </div>

      <!-- Theme 6: Deep Black + Classic Blue -->
      <div class="theme-card-preview" data-theme="6" onclick="selectCardTheme(6)">
        <div class="theme-preview-wrapper">
          <div class="theme-preview-top-bar"></div>
          <div class="theme-preview-card">
            <div class="theme-preview-text long"></div>
            <div class="theme-preview-text short"></div>
            <div class="theme-preview-text long"></div>
            <div class="theme-preview-button"></div>
          </div>
        </div>
        <div class="theme-card-name lang-zh">æ·±é»‘è—ï¼ˆç¶“å…¸è—ï¼‰</div>
        <div class="theme-card-name lang-en">Deep Black + Classic Blue</div>
      </div>

      <!-- Theme 7: White + Classic Blue -->
      <div class="theme-card-preview" data-theme="7" onclick="selectCardTheme(7)">
        <div class="theme-preview-wrapper">
          <div class="theme-preview-top-bar"></div>
          <div class="theme-preview-card">
            <div class="theme-preview-text long"></div>
            <div class="theme-preview-text short"></div>
            <div class="theme-preview-text long"></div>
            <div class="theme-preview-button"></div>
          </div>
        </div>
        <div class="theme-card-name lang-zh">ç™½åº•è—ï¼ˆç¶“å…¸è—ï¼‰</div>
        <div class="theme-card-name lang-en">White + Classic Blue</div>
      </div>

      <!-- Theme 8: Deep Black + Teal -->
      <div class="theme-card-preview" data-theme="8" onclick="selectCardTheme(8)">
        <div class="theme-preview-wrapper">
          <div class="theme-preview-top-bar"></div>
          <div class="theme-preview-card">
            <div class="theme-preview-text long"></div>
            <div class="theme-preview-text short"></div>
            <div class="theme-preview-text long"></div>
            <div class="theme-preview-button"></div>
          </div>
        </div>
        <div class="theme-card-name lang-zh">æ·±é»‘é’ç¶ ï¼ˆé’ç¶ ï¼‰</div>
        <div class="theme-card-name lang-en">Deep Black + Teal</div>
      </div>

      <!-- Theme 9: White + Teal -->
      <div class="theme-card-preview" data-theme="9" onclick="selectCardTheme(9)">
        <div class="theme-preview-wrapper">
          <div class="theme-preview-top-bar"></div>
          <div class="theme-preview-card">
            <div class="theme-preview-text long"></div>
            <div class="theme-preview-text short"></div>
            <div class="theme-preview-text long"></div>
            <div class="theme-preview-button"></div>
          </div>
        </div>
        <div class="theme-card-name lang-zh">ç™½åº•é’ç¶ ï¼ˆé’ç¶ ï¼‰</div>
        <div class="theme-card-name lang-en">White + Teal</div>
      </div>
    </div>
  </div>
</div>

<!-- åº•éƒ¨å°èˆªæ¬„ -->
<nav class="bottom-nav">
  <a href="#" class="nav-item primary" id="navMyCard" onclick="gotoMyCard(event)">
    <span class="nav-icon">ğŸ‘¤</span>
    <span class="nav-label lang-zh">æˆ‘çš„åç‰‡</span>
    <span class="nav-label lang-en">My Card</span>
  </a>
  <a href="directory.html" class="nav-item">
    <span class="nav-icon">ğŸ“‹</span>
    <span class="nav-label lang-zh">é€šè¨ŠéŒ„</span>
    <span class="nav-label lang-en">Directory</span>
  </a>
  <a href="settings.html" class="nav-item">
    <span class="nav-icon">âš™ï¸</span>
    <span class="nav-label lang-zh">è¨­å®š</span>
    <span class="nav-label lang-en">Settings</span>
  </a>
</nav>

<script src="common.js?v=20260205c"></script>
<script>
// å‰å¾€ã€Œæˆ‘çš„åç‰‡ã€é é¢
async function gotoMyCard(event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  try {
    if (!window.UVACO_CLOUD || !UVACO_CLOUD.hasConfig()) {
      window.location.href = 'auth.html?next=edit.html';
      return false;
    }
    const s = await UVACO_CLOUD.getSession();
    const uid = s && s.session && s.session.user ? String(s.session.user.id || '').trim() : '';
    if (!uid) {
      window.location.href = 'auth.html?next=edit.html';
      return false;
    }
    window.location.href = 'card.html?id=' + encodeURIComponent(uid);
    return false;
  } catch (e) {
    window.location.href = 'auth.html?next=edit.html';
    return false;
  }
}
</script>
<script>
// ç·¨è¼¯é é¢ï¼šèƒŒæ™¯é è¼‰å…¥æ‰€æœ‰ä¸»é¡Œä»¥æ”¹å–„åˆ‡æ›é«”é©—
if (typeof preloadAllThemes === 'function') {
  preloadAllThemes();
}

// é›²ç«¯ç‰ˆï¼šéœ€è¦ç™»å…¥æ‰å¯ç·¨è¼¯ï¼ˆæœªè¨­å®š Supabase å‰‡ç•¥éï¼‰
(async function () {
  try {
    if (window.UVACO_CLOUD && UVACO_CLOUD.hasConfig()) {
      // ä»¥ edit.html ä½œç‚ºå…¥å£ï¼šæœªç™»å…¥å‰‡å°å‘ auth.htmlï¼›ç™»å…¥å¾Œå›åˆ°æ­¤é 
      const here = 'edit.html' + (window.location.search || '');
      const r = await UVACO_CLOUD.requireAuth(here);
      if (!r.ok) return;

      // Admin Mode: æ”¯æ´ï¼š
      // - edit.html?adminMode=true&targetUserId=<uuid>
      // - edit.html?uid=<uuid>
      // - edit.html?id=<uuid>ï¼ˆåŒ uidï¼‰
      // è¦å‰‡ï¼š
      // - åªè¦ç¶²å€æœ‰ uid/id/targetUserIdï¼Œå°±ä»¥è©² id ç‚ºã€Œè¦ç·¨è¼¯çš„ç›®æ¨™ã€ã€‚
      // - è‹¥ç›®æ¨™ä¸æ˜¯æœ¬äºº â†’ éœ€è¦ç®¡ç†å“¡æ¬Šé™ã€‚
      const params = new URLSearchParams(window.location.search || '');
      const targetUserId = params.get('targetUserId') || params.get('uid') || params.get('id');
      let adminMode = params.get('adminMode') === 'true';

      // é è¨­ç‚ºç·¨è¼¯è‡ªå·±çš„åç‰‡
      let cardData = null;

      // å–å¾—ç›®å‰ç™»å…¥è€… idï¼Œç”¨æ–¼åˆ¤æ–·æ˜¯å¦ç‚ºã€Œç·¨è¼¯æœ¬äººã€æˆ–ã€Œç·¨è¼¯ä»–äººã€
      let myUserId = '';
      try {
        const s = await UVACO_CLOUD.getSession();
        myUserId = s && s.session && s.session.user ? String(s.session.user.id || '') : '';
      } catch (e) {}

      if (targetUserId && myUserId && String(targetUserId) !== String(myUserId)) {
        // æœ‰æŒ‡å®š targetUserId ä¸”ä¸æ˜¯æœ¬äºº â†’ è‡ªå‹•è½‰ç‚ºç®¡ç†å“¡æ¨¡å¼
        adminMode = true;
      }

      // è‹¥æŒ‡å®šçš„ targetUserId ä¸æ˜¯æœ¬äºº â†’ èµ°ç®¡ç†å“¡æ¨¡å¼ï¼ˆä¸ç®¡æœ‰æ²’æœ‰å¸¶ adminMode=trueï¼‰
      if (targetUserId && myUserId && String(targetUserId) !== String(myUserId)) {
        adminMode = true;
      }

      if (adminMode && targetUserId && myUserId && String(targetUserId) !== String(myUserId)) {
        // ç®¡ç†å“¡æ¨¡å¼ï¼šæª¢æŸ¥æ¬Šé™ä¸¦è®€å–ç›®æ¨™åç‰‡
        const adminStatus = await UVACO_CLOUD.isAdmin();
        if (!adminStatus || !adminStatus.isAdmin) {
          alert('æ¬Šé™ä¸è¶³ï¼šæ‚¨ä¸æ˜¯ç®¡ç†å“¡');
          window.location.href = 'directory.html';
          return;
        }
        
        // é¡¯ç¤ºç®¡ç†å“¡æç¤ºæ¢
        showAdminBanner(targetUserId);

        // è®€å–ç›®æ¨™åç‰‡
        const res = await UVACO_CLOUD.getCardByUserId(targetUserId);
        cardData = res.card;
        
        // å¦‚æœè©²ç”¨æˆ¶é‚„æ²’åç‰‡ï¼ŒcardData ç‚º nullï¼Œè¦–ç‚ºå¹«ä»–æ–°å»º
      } else {
        // ä¸€èˆ¬æ¨¡å¼ï¼š
        // - è‹¥ç¶²å€æœ‰æŒ‡å®š uid/id/targetUserIdï¼ˆä¸”æ˜¯æœ¬äººï¼‰ï¼Œå°±ç”¨ getCardByUserId() æ˜ç¢ºè®€å–ï¼Œé¿å…è¼‰å…¥éŒ¯èª¤æˆ–è½å›ç¤ºä¾‹ã€‚
        // - å¦å‰‡æ‰ç”¨ getMyCard()
        if (targetUserId && myUserId && String(targetUserId) === String(myUserId)) {
          const meRes = await UVACO_CLOUD.getCardByUserId(targetUserId);
          cardData = meRes.card;
        } else {
          const my = await UVACO_CLOUD.getMyCard();
          cardData = my.card;
        }
        
        // è‹¥ä½¿ç”¨è€…å·²ç¶“æœ‰åç‰‡ï¼šè¦–ç‚ºå·² onboardingï¼ˆé¿å…æ¸…æ‰ localStorage å¾Œåˆè¢«ç•¶æ–°æ‰‹ï¼‰
        if (cardData) {
          try { localStorage.setItem('UVACO_ONBOARDED', '1'); } catch (e) {}
        }

        // è‹¥å°šæœªå»ºç«‹åç‰‡ï¼Œä¸”ç¶²å€æœªæŒ‡å®š modeï¼šè‡ªå‹•åˆ‡æ›ç‚º onboarding
        if (!cardData && !params.get('mode')) {
          params.set('mode', 'onboarding');
          if (!params.get('next')) params.set('next', 'directory.html');
          const qs = params.toString();
          const newUrl = 'edit.html' + (qs ? ('?' + qs) : '');
          window.history.replaceState({}, '', newUrl);
        }
      }

      // å¦‚æœæœ‰è®€åˆ°åç‰‡è³‡æ–™ï¼Œè¼‰å…¥åˆ°ä»‹é¢
      if (cardData) {
        loadCardToUI(cardData);
      }

      // æ³¨å…¥å…¬å¸é¸æ“‡å™¨æŒ‰éˆ•ï¼ˆèˆ‡èªç³»åŒæ­¥é¡¯ç¤ºï¼‰
      try {
        setTimeout(() => injectCompanyPickerButtons(), 0);
      } catch (e) {}
    }
  } catch (e) {
    console.error('Init failed', e);
  }
})();

function showAdminBanner(targetUserId) {
  const div = document.createElement('div');
  div.style.cssText = `
    position: fixed; top: 0; left: 0; right: 0; 
    background: #eab308; color: #000; font-weight: bold; 
    text-align: center; padding: 8px; z-index: 9999;
    font-size: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  `;
  div.innerHTML = `âš ï¸ ç®¡ç†å“¡æ¨¡å¼ï¼šæ‚¨æ­£åœ¨ç·¨è¼¯ä½¿ç”¨è€… ${targetUserId} çš„åç‰‡ <button onclick="window.location.href='admin.html'" style="margin-left:10px;padding:2px 8px;border:1px solid #000;background:transparent;cursor:pointer;border-radius:4px;">è¿”å›å¾Œå°</button>`;
  document.body.appendChild(div);
  // æŠŠ top-bar å¾€ä¸‹æ¨ä¸€é»ä»¥å…è¢«æ“‹ä½
  const topBar = document.querySelector('.top-bar');
  if (topBar) topBar.style.marginTop = '36px';
}

function loadCardToUI(card) {
  // å°‡å¾Œç«¯åç‰‡è³‡æ–™ç›´æ¥å¥—åˆ°ã€Œé è¦½å€ã€ï¼ˆæœ¬é æ˜¯ contenteditable ç›´ç·¨æ¨¡å¼ï¼‰
  if (!card) return;

  const safeText = (v) => String(v ?? '').replace(/\s+/g, ' ').trim();

  let pj = card.profile_json;
  if (typeof pj === 'string') {
    try { pj = JSON.parse(pj); } catch (e) { pj = {}; }
  }
  pj = (pj && typeof pj === 'object') ? pj : {};
  // ä¾› saveCard() åƒè€ƒï¼ˆé¿å… pj ä½œç”¨åŸŸå•é¡Œï¼‰
  window.__uvacoLoadedProfileJson = pj;

  const setHtmlLikeName = (id, raw) => {
    const el = document.getElementById(id);
    if (!el) return;
    const s = safeText(raw);
    // å³ä½¿æ˜¯ç©ºå­—ä¸²ä¹Ÿæ‡‰è©²æ›´æ–°ï¼Œé™¤é raw ç‚º null/undefined ä»£è¡¨æ²’è³‡æ–™
    if (raw === null || raw === undefined) return;
    
    const parts = s.split(/\s*ï½œ\s*/);
    if (parts.length >= 2) {
      el.innerHTML = `${parts[0]} ï½œ <span class="en">${parts.slice(1).join(' ï½œ ')}</span>`;
    } else {
      el.textContent = s || (id === 'previewNameZh' ? 'å§“å' : '');
    }
  };

  const setText = (id, raw) => {
    const el = document.getElementById(id);
    if (!el) return;
    if (raw === null || raw === undefined) return;
    const s = safeText(raw);
    el.textContent = s;
  };

  // 1) å¥—ç”¨ä¸»é¡Œ
  try {
    const theme = parseInt(card.theme || pj.theme || 1, 10) || 1;
    setTheme(theme);
    window.currentCardTheme = theme;
    if (typeof updateCardThemeUI === 'function') updateCardThemeUI(theme);
  } catch (e) {}

  // 2) å¥—ç”¨å§“å/è·å‹™ï¼ˆé›™èªï¼‰
  setHtmlLikeName('previewNameZh', pj.nameZh || card.name || '');
  setText('previewTitleZh', pj.titleZh || card.title || '');
  setText('previewTitleEn', pj.titleEn || card.title || '');
  // å§“åå–®è¡Œè‡ªå‹•ç¸®å­—ï¼ˆiPhone SE ç­‰å°è¢å¹•ï¼‰ï¼šæ‰‹æ©Ÿç«¯é™åˆ¶æœ€å¤§å­—ç´šï¼Œé¿å…è“‹åˆ°é ­åƒæ¡†
  try {
    const isSmall = (window.matchMedia && window.matchMedia('(max-width: 420px)').matches);
    fitTextToSingleLine(document.getElementById('previewNameZh'), { minPx: 16, maxPx: isSmall ? 30 : 34 });
  } catch (e) {}
  
  // 2.5) é‚„åŸå­—é«”æ¨£å¼
  try {
    if (pj.fontStyles) {
      const applyFontStyle = (elementId, styleObj) => {
        const el = document.getElementById(elementId);
        if (!el || !styleObj) return;
        
        const sizeMap = {
          'small': elementId === 'previewNameZh' ? '18px' : '12px',
          'medium': elementId === 'previewNameZh' ? '24px' : '16px',
          'large': elementId === 'previewNameZh' ? '32px' : '20px'
        };
        
        if (styleObj.size && sizeMap[styleObj.size]) {
          el.style.fontSize = sizeMap[styleObj.size];
          el.dataset.fontSize = styleObj.size;
        }
        if (styleObj.weight) {
          el.style.fontWeight = styleObj.weight === 'bold' ? '700' : '400';
          el.dataset.fontWeight = styleObj.weight;
        }
        if (styleObj.color) {
          el.style.color = styleObj.color;
          el.dataset.fontColor = styleObj.color;
        }
      };
      
      applyFontStyle('previewNameZh', pj.fontStyles.name);
      applyFontStyle('previewTitleZh', pj.fontStyles.titleZh);
      applyFontStyle('previewTitleEn', pj.fontStyles.titleEn);
    }
  } catch (e) { console.log('Font style restore error:', e); }

  // 3) å…¬å¸ï¼ˆcanonical + é–å®šï¼‰
  try {
    const canonical = safeText(pj.companyCanonical || card.company || '');
    window.__uvacoSelectedCompany = canonical;
    window.__uvacoOriginalCompanyCanonical = canonical;
    window.__uvacoCompanyLocked = (pj.companyLocked === true) && !isAdminModeFromUrl();
    if (canonical) applyCompanyToUI(canonical);
  } catch (e) {}

  // 3.1) è¼‰å…¥å…¬å¸åç¨±åˆ°å…¬å¸è³‡è¨Šå€å¡Š
  try {
    const companyZh = safeText(pj.companyZh || pj.companyCanonical || card.company || '');
    const companyEn = safeText(pj.companyEn || pj.companyCanonical || card.company || '');
    if (companyZh || companyEn) {
      const item = document.getElementById('companyNameItem');
      const zhEl = document.getElementById('previewCompanyNameZh');
      const enEl = document.getElementById('previewCompanyNameEn');
      if (item) item.style.display = 'flex';
      if (zhEl) zhEl.textContent = companyZh;
      if (enEl) enEl.textContent = companyEn;
    }
    window.__uvacoCompanyZh = companyZh;
    window.__uvacoCompanyEn = companyEn;
  } catch (e) {}

  // 4) Logo / Avatarï¼ˆå„ªå…ˆ Storage pathï¼‰
  (async function () {
    try {
      const logo = document.getElementById('previewLogo');
      const avatar = document.getElementById('previewAvatar');
      const logoPlaceholder = document.getElementById('logoPlaceholder');
      const avatarPlaceholder = document.getElementById('avatarPlaceholder');
      
      // é¡¯ç¤º/éš±è— Logo placeholder
      function updateLogoDisplay(hasImage) {
        if (logo && logoPlaceholder) {
          logo.style.display = hasImage ? 'block' : 'none';
          logoPlaceholder.style.display = hasImage ? 'none' : 'flex';
        }
      }
      
      // é¡¯ç¤º/éš±è— Avatar placeholder
      function updateAvatarDisplay(hasImage) {
        if (avatar && avatarPlaceholder) {
          avatar.style.display = hasImage ? 'block' : 'none';
          avatarPlaceholder.style.display = hasImage ? 'none' : 'flex';
        }
      }
      
      // è‹¥è¼‰å…¥å¤±æ•—ï¼Œé¡¯ç¤º placeholder
      if (logo && !logo.__uvacoOnErrorBound) {
        logo.__uvacoOnErrorBound = true;
        logo.addEventListener('error', () => {
          updateLogoDisplay(false);
        });
        logo.addEventListener('load', () => {
          if (logo.src && logo.src !== window.location.href) updateLogoDisplay(true);
        });
      }
      if (avatar && !avatar.__uvacoOnErrorBound) {
        avatar.__uvacoOnErrorBound = true;
        avatar.addEventListener('error', () => {
          updateAvatarDisplay(false);
        });
        avatar.addEventListener('load', () => {
          if (avatar.src && avatar.src !== window.location.href) updateAvatarDisplay(true);
        });
      }
      
      // åˆå§‹ç‹€æ…‹ï¼šé¡¯ç¤º placeholder
      updateLogoDisplay(false);
      updateAvatarDisplay(false);
      
      if (window.UVACO_CLOUD && UVACO_CLOUD.hasConfig()) {
        if (logo) {
          if (pj.logoPath) {
            const u = await UVACO_CLOUD.getSignedAssetUrl(String(pj.logoPath), { bucket: 'card-assets', expiresIn: 3600 });
            if (u && u.url) {
              logo.setAttribute('src', u.url);
              updateLogoDisplay(true);
            }
          } else if (pj.logoSrc) {
            logo.setAttribute('src', String(pj.logoSrc));
            updateLogoDisplay(true);
          }
        }
        if (avatar) {
          if (pj.avatarPath) {
            const u = await UVACO_CLOUD.getSignedAssetUrl(String(pj.avatarPath), { bucket: 'card-assets', expiresIn: 3600 });
            if (u && u.url) {
              avatar.setAttribute('src', u.url);
              updateAvatarDisplay(true);
            }
          } else if (pj.avatarSrc) {
            avatar.setAttribute('src', String(pj.avatarSrc));
            updateAvatarDisplay(true);
          }
        }
      }
    } catch (e) {}
  })();

  // éæ¿¾ç³»çµ±æç¤ºæ–‡å­—ï¼ˆé¿å…é¡¯ç¤ºè¢«èª¤å­˜çš„æç¤ºï¼‰
  function filterSystemTextFromHtml(html) {
    if (!html) return html;
    const systemPatterns = [
      'å…¬å¸å·²é–å®šï¼ˆå¦‚éœ€æ›´æ”¹è«‹è¯çµ¡ç®¡ç†å“¡ï¼‰',
      'å…¬å¸ï¼šå¿…é¸ä¸‹æ‹‰ï¼ˆå¯è¼¸å…¥é—œéµå­—å¿«é€Ÿå¸¶å…¥ï¼‰',
      'ğŸ¢ é¸æ“‡å…¬å¸',
      'ğŸ¢ Select Company',
      'è«‹è¼¸å…¥å…§å®¹',
      'Enter content'
    ];
    let result = html;
    systemPatterns.forEach(pattern => {
      result = result.split(pattern).join('');
    });
    // ç§»é™¤å…¬å¸é¸æ“‡å™¨ç›¸é—œçš„ HTML æ¨™ç±¤
    result = result.replace(/<div[^>]*class="[^"]*uvaco-company-picker[^"]*"[^>]*>[\s\S]*?<\/div>/gi, '');
    result = result.replace(/<button[^>]*id="uvacoCompanyPickBtn[^"]*"[^>]*>[\s\S]*?<\/button>/gi, '');
    return result;
  }

  // 5) å…¬å¸è³‡è¨Šï¼ˆè¼‰å…¥å¾Œç¢ºä¿æ–°å…ƒç´ å­˜åœ¨ï¼‰
  try {
    const section = document.getElementById('companyInfoSection');
    if (section && pj.companyInfoHtml) {
      section.innerHTML = filterSystemTextFromHtml(String(pj.companyInfoHtml));
    }
    // ç¢ºä¿ companyNameItem å…ƒç´ å­˜åœ¨ï¼ˆèˆŠè³‡æ–™å¯èƒ½æ²’æœ‰æ­¤å…ƒç´ ï¼‰
    ensureCompanyNameItemExists();
  } catch (e) {}

  // 6) è¯çµ¡æ–¹å¼ï¼ˆç›´æ¥å›å¡« HTMLï¼Œç¶­æŒæ’åºèˆ‡é¡¯ç¤ºæ–¹å¼ï¼‰
  try {
    const contacts = document.getElementById('previewContacts');
    if (contacts && pj.contactsHtml) {
      contacts.innerHTML = filterSystemTextFromHtml(String(pj.contactsHtml));
    }
    // å¥—ç”¨é¡¯ç¤ºæ–¹å¼ï¼ˆgrid/listï¼‰
    const layout = String(pj.contactLayout || '').toLowerCase() === 'grid' ? 'grid' : 'list';
    window.__uvacoContactLayout = layout;
    if (typeof applyContactLayout === 'function') applyContactLayout(layout);
  } catch (e) {}

  // 7) æ¨™èªï¼ˆç›´æ¥å›å¡« HTMLï¼Œç¶­æŒåŸç‰ˆå‹èˆ‡å¯ç·¨è¼¯äº‹ä»¶ï¼‰
  try {
    const zhSlogans = document.getElementById('previewSlogansZh');
    // å„ªå…ˆä½¿ç”¨è³‡æ–™åº«ä¸­çš„ HTML (pj.slogansZhHtml)
    // ä½†è‹¥ pj.slogansZhHtml ç‚ºç©ºï¼Œä¸”æ˜¯ç¬¬ä¸€æ¬¡ç·¨è¼¯ï¼ˆæ²’æœ‰ savedAtï¼‰ï¼Œå‰‡ä¿ç•™é è¨­çš„ HTMLï¼ˆä¸è¦†è“‹ç‚ºç©ºï¼‰
    // é¿å…æ–°ç”¨æˆ¶ä¸€é€²ä¾†æ¨™èªå°±è¢«æ¸…ç©º
    if (zhSlogans) {
      if (pj.slogansZhHtml) {
        zhSlogans.innerHTML = filterSystemTextFromHtml(String(pj.slogansZhHtml));
      } else if (pj.savedAt) {
        // è‹¥æœ‰å„²å­˜éä½† html ç‚ºç©ºï¼Œä»£è¡¨ç”¨æˆ¶å¯èƒ½çœŸçš„æ¸…ç©ºäº†ï¼Œé€™è£¡æ‡‰è©²è¦æ¸…ç©ºï¼Ÿ
        // ç‚ºäº†å®‰å…¨èµ·è¦‹ï¼Œè‹¥çœŸçš„ç‚ºç©ºï¼Œçµ¦ä¸€å€‹é è¨­çµæ§‹ï¼Œæ–¹ä¾¿ç”¨æˆ¶é»æ“Šç·¨è¼¯
        zhSlogans.innerHTML = `<div class="slogan-item"><div class="tagline lang-zh edit-clickable" contenteditable="true" onblur="updateSlogansPreview()" onclick="focusEdit(this)">å¥åº·ãƒ»äº‹æ¥­ãƒ»æœªä¾†</div><button class="slogan-delete-btn" onclick="deleteSloganFromPreview(this)" title="åˆªé™¤æ¨™èª">âœ•</button></div>`;
      }
    }

    const enSlogans = document.getElementById('previewSlogansEn');
    if (enSlogans) {
      if (pj.slogansEnHtml) {
        enSlogans.innerHTML = filterSystemTextFromHtml(String(pj.slogansEnHtml));
      } else if (pj.savedAt) {
        enSlogans.innerHTML = `<div class="slogan-item"><div class="tagline lang-en edit-clickable" contenteditable="true" onblur="updateSlogansPreview()" onclick="focusEdit(this)">Health â€¢ Business â€¢ Future</div><button class="slogan-delete-btn" onclick="deleteSloganFromPreview(this)" title="Delete slogan">âœ•</button></div>`;
      }
    }
  } catch (e) {}

  // 8) åŒæ­¥æ¨™èªé è¦½ï¼ˆç¢ºä¿äº‹ä»¶ç¹«çµèˆ‡æ•´ç†ï¼‰
  try { if (typeof updateSlogansPreview === 'function') updateSlogansPreview(); } catch (e) {}

  // 8.1) ä½¿ç”¨äº‹ä»¶å§”æ´¾ç¢ºä¿æ¨™èªåˆªé™¤æŒ‰éˆ•èƒ½æ­£å¸¸é‹ä½œ
  ['previewSlogansZh', 'previewSlogansEn'].forEach(id => {
    const container = document.getElementById(id);
    if (container && !container._deleteHandlerBound) {
      container.addEventListener('click', function(e) {
        if (e.target.classList.contains('slogan-delete-btn')) {
          e.stopPropagation();
          deleteSloganFromPreview(e.target);
        }
      });
      container._deleteHandlerBound = true;
    }
  });

  // 9) æ¢å¾©å…¬å¸è³‡è¨Šå€åŸŸçš„ç·¨è¼¯åŠŸèƒ½
  try { restoreCompanyInfoFunctionality(); } catch (e) { console.error('restoreCompanyInfoFunctionality error:', e); }

  // 10) æ¢å¾©è¯çµ¡æ–¹å¼å€åŸŸçš„ç·¨è¼¯åŠŸèƒ½
  try { restoreContactsFunctionality(); } catch (e) { console.error('restoreContactsFunctionality error:', e); }

  // 11) é‡æ–°å¥—ç”¨èªè¨€è¨­å®šï¼Œç¢ºä¿è¼‰å…¥çš„å…§å®¹é¡¯ç¤ºæ­£ç¢ºèªè¨€
  try {
    const savedLang = localStorage.getItem('lang') || 'zh';
    if (typeof setLang === 'function') setLang(savedLang);
  } catch (e) {}
}

// ç¢ºä¿ companyNameItem å…ƒç´ å­˜åœ¨ï¼ˆèˆŠè³‡æ–™å¯èƒ½æ²’æœ‰æ­¤å…ƒç´ ï¼‰
function ensureCompanyNameItemExists() {
  const section = document.getElementById('companyInfoSection');
  if (!section) return;
  
  // å¦‚æœ companyNameItem ä¸å­˜åœ¨ï¼Œé‡æ–°å»ºç«‹
  if (!document.getElementById('companyNameItem')) {
    const sectionLabel = section.querySelector('.section-label');
    const companyNameHtml = `
      <div class="info-item info-item-company-name" id="companyNameItem" style="display: none;">
        <span class="info-label lang-zh">å…¬å¸åç¨±ï¼š</span>
        <span class="info-label lang-en">Company Name:</span>
        <span class="info-value lang-zh edit-clickable" id="previewCompanyNameZh" contenteditable="true" onclick="focusEdit(this)" onblur="updateCompanyFromPreview()" data-placeholder="è«‹è¼¸å…¥å…¬å¸åç¨±" style="min-width: 150px; min-height: 1.2em;"></span>
        <span class="info-value lang-en edit-clickable" id="previewCompanyNameEn" contenteditable="true" onclick="focusEdit(this)" onblur="updateCompanyFromPreview()" data-placeholder="Enter company name" style="min-width: 150px; min-height: 1.2em;"></span>
        <button class="info-delete-btn" onclick="deleteCompanyInfo('companyName')" title="åˆªé™¤">Ã—</button>
      </div>
    `;
    // æ’å…¥åˆ° section-label ä¹‹å¾Œ
    if (sectionLabel) {
      sectionLabel.insertAdjacentHTML('afterend', companyNameHtml);
    } else {
      section.insertAdjacentHTML('afterbegin', companyNameHtml);
    }
  }
}

// æ¢å¾©å…¬å¸è³‡è¨Šå€åŸŸçš„ç·¨è¼¯åŠŸèƒ½ï¼ˆè¼‰å…¥å·²ä¿å­˜æ•¸æ“šå¾Œé‡æ–°ç¶å®šäº‹ä»¶ï¼‰
function restoreCompanyInfoFunctionality() {
  const section = document.getElementById('companyInfoSection');
  if (!section) return;

  // åœ°å€é¡å‹åˆ—è¡¨
  const addressTypes = ['serviceLocation', 'mailingAddress', 'companyAddress'];

  addressTypes.forEach(type => {
    const itemId = type + 'Item';
    const item = document.getElementById(itemId);
    if (!item) return;

    const typeCapitalized = type.charAt(0).toUpperCase() + type.slice(1);
    const zhEl = document.getElementById(`preview${typeCapitalized}Zh`);
    const enEl = document.getElementById(`preview${typeCapitalized}En`);

    // æ¢å¾©ä¸­æ–‡åœ°å€çš„ç·¨è¼¯åŠŸèƒ½
    if (zhEl) {
      zhEl.classList.add('edit-clickable');
      zhEl.onclick = function(event) { editAddress(type, event); };
      
      // æ¢å¾©åœ°åœ–é€£çµ
      const mapLinkZh = zhEl.querySelector('.address-map-link');
      if (mapLinkZh) {
        mapLinkZh.onclick = function(event) { openMap(type, event); };
      }
    }

    // æ¢å¾©è‹±æ–‡åœ°å€çš„ç·¨è¼¯åŠŸèƒ½
    if (enEl) {
      enEl.classList.add('edit-clickable');
      enEl.onclick = function(event) { editAddress(type, event); };
      
      // æ¢å¾©åœ°åœ–é€£çµ
      const mapLinkEn = enEl.querySelector('.address-map-link');
      if (mapLinkEn) {
        mapLinkEn.onclick = function(event) { openMap(type, event); };
      }
    }

    // æª¢æŸ¥ä¸¦æ·»åŠ åˆªé™¤æŒ‰éˆ•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if (!item.querySelector('.info-delete-btn')) {
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'info-delete-btn';
      deleteBtn.title = 'åˆªé™¤';
      deleteBtn.textContent = 'Ã—';
      deleteBtn.onclick = function() { deleteCompanyInfo(type); };
      item.appendChild(deleteBtn);
    }
  });

  // æ¢å¾©å…¬å¸åç¨±çš„ç·¨è¼¯åŠŸèƒ½
  const companyNameItem = document.getElementById('companyNameItem');
  if (companyNameItem) {
    const companyNameZh = document.getElementById('previewCompanyNameZh');
    const companyNameEn = document.getElementById('previewCompanyNameEn');

    if (companyNameZh) {
      companyNameZh.classList.add('edit-clickable');
      companyNameZh.setAttribute('contenteditable', 'true');
      companyNameZh.onclick = function() { focusEdit(this); };
      companyNameZh.onblur = function() { updateCompanyFromPreview(); };
    }
    if (companyNameEn) {
      companyNameEn.classList.add('edit-clickable');
      companyNameEn.setAttribute('contenteditable', 'true');
      companyNameEn.onclick = function() { focusEdit(this); };
      companyNameEn.onblur = function() { updateCompanyFromPreview(); };
    }

    // æª¢æŸ¥ä¸¦æ·»åŠ åˆªé™¤æŒ‰éˆ•
    if (!companyNameItem.querySelector('.info-delete-btn')) {
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'info-delete-btn';
      deleteBtn.title = 'åˆªé™¤';
      deleteBtn.textContent = 'Ã—';
      deleteBtn.onclick = function() { deleteCompanyInfo('companyName'); };
      companyNameItem.appendChild(deleteBtn);
    }
  }

  // æ¢å¾©çµ±ä¸€ç·¨è™Ÿçš„ç·¨è¼¯åŠŸèƒ½
  const taxIdItem = document.getElementById('taxIdItem');
  if (taxIdItem) {
    const taxIdZh = document.getElementById('previewTaxIdZh');
    const taxIdEn = document.getElementById('previewTaxIdEn');

    if (taxIdZh) {
      taxIdZh.classList.add('edit-clickable');
      taxIdZh.setAttribute('contenteditable', 'true');
      taxIdZh.onclick = function(event) { editTaxId(event); };
    }
    if (taxIdEn) {
      taxIdEn.classList.add('edit-clickable');
      taxIdEn.setAttribute('contenteditable', 'true');
      taxIdEn.onclick = function(event) { editTaxId(event); };
    }

    // æª¢æŸ¥ä¸¦æ·»åŠ åˆªé™¤æŒ‰éˆ•
    if (!taxIdItem.querySelector('.info-delete-btn')) {
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'info-delete-btn';
      deleteBtn.title = 'åˆªé™¤';
      deleteBtn.textContent = 'Ã—';
      deleteBtn.onclick = function() { deleteCompanyInfo('taxId'); };
      taxIdItem.appendChild(deleteBtn);
    }
  }

  // æ¢å¾©è‡ªè¨‚å…¬å¸è³‡è¨Šé …ç›®çš„ç·¨è¼¯åŠŸèƒ½
  const customItems = section.querySelectorAll('.info-item-custom');
  customItems.forEach(item => {
    const labelEl = item.querySelector('.info-label');
    const valueZhEl = item.querySelector('.info-value.lang-zh');
    const valueEnEl = item.querySelector('.info-value.lang-en');

    if (labelEl) {
      labelEl.classList.add('edit-clickable');
      labelEl.setAttribute('contenteditable', 'true');
    }
    if (valueZhEl) {
      valueZhEl.classList.add('edit-clickable');
      valueZhEl.setAttribute('contenteditable', 'true');
    }
    if (valueEnEl) {
      valueEnEl.classList.add('edit-clickable');
      valueEnEl.setAttribute('contenteditable', 'true');
    }

    // æª¢æŸ¥ä¸¦æ·»åŠ åˆªé™¤æŒ‰éˆ•
    if (!item.querySelector('.info-delete-btn')) {
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'info-delete-btn';
      deleteBtn.title = 'åˆªé™¤';
      deleteBtn.textContent = 'Ã—';
      deleteBtn.onclick = function() { item.remove(); };
      item.appendChild(deleteBtn);
    }
  });

  // æª¢æŸ¥ä¸¦æ·»åŠ ã€Œæ–°å¢å…¬å¸è³‡è¨Šã€æŒ‰éˆ•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  if (!section.querySelector('.edit-add-btn')) {
    const addBtnZh = document.createElement('button');
    addBtnZh.className = 'edit-add-btn lang-zh';
    addBtnZh.textContent = '+ æ–°å¢å…¬å¸è³‡è¨Š';
    addBtnZh.onclick = function(event) { showCompanyInfoTypeModal(event); };
    section.appendChild(addBtnZh);

    const addBtnEn = document.createElement('button');
    addBtnEn.className = 'edit-add-btn lang-en';
    addBtnEn.textContent = '+ Add Company Info';
    addBtnEn.onclick = function(event) { showCompanyInfoTypeModal(event); };
    section.appendChild(addBtnEn);
  }
}

// æ¢å¾©è¯çµ¡æ–¹å¼å€åŸŸçš„ç·¨è¼¯åŠŸèƒ½ï¼ˆè¼‰å…¥å·²ä¿å­˜æ•¸æ“šå¾Œé‡æ–°ç¶å®šäº‹ä»¶ï¼‰
function restoreContactsFunctionality() {
  const contacts = document.getElementById('previewContacts');
  if (!contacts) return;

  // æ¢å¾©æ‰€æœ‰è¯çµ¡æ–¹å¼æŒ‰éˆ•çš„ç·¨è¼¯åŠŸèƒ½
  const contactBtns = contacts.querySelectorAll('a.btn');
  contactBtns.forEach(btn => {
    btn.classList.add('edit-clickable');
    
    // æ ¹æ“šæŒ‰éˆ•é¡å‹å’Œ href åˆ¤æ–·è¯çµ¡æ–¹å¼é¡å‹
    const href = btn.getAttribute('href') || '';
    let type = 'website';
    
    if (href.startsWith('tel:')) {
      type = 'call';
    } else if (href.startsWith('mailto:')) {
      type = 'email';
    } else if (href.includes('line.me') || href.includes('line://')) {
      type = 'line';
    } else if (href.endsWith('.vcf')) {
      type = 'vcf';
    } else if (href.includes('wa.me') || href.includes('whatsapp')) {
      type = 'whatsapp';
    } else if (href.includes('facebook.com') || href.includes('fb.com')) {
      type = 'facebook';
    } else if (href.includes('instagram.com')) {
      type = 'instagram';
    } else if (href.includes('linkedin.com')) {
      type = 'linkedin';
    } else if (href.includes('twitter.com') || href.includes('x.com')) {
      type = 'twitter';
    } else if (href.includes('youtube.com')) {
      type = 'youtube';
    } else if (href.includes('wechat') || href.includes('weixin')) {
      type = 'wechat';
    }

    const currentLink = href;
    btn.onclick = function(event) { editContact(event, type, currentLink); };
  });

  // æ¢å¾©åˆªé™¤æŒ‰éˆ•
  const wrappers = contacts.querySelectorAll('.contact-btn-wrapper');
  wrappers.forEach(wrapper => {
    if (!wrapper.querySelector('.contact-delete-btn')) {
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'contact-delete-btn';
      deleteBtn.title = 'åˆªé™¤';
      deleteBtn.textContent = 'âœ•';
      deleteBtn.onclick = function(event) {
        event.stopPropagation();
        deleteContactButton(wrapper.querySelector('a'));
      };
      wrapper.appendChild(deleteBtn);
    }
  });

  // æª¢æŸ¥ä¸¦æ·»åŠ ã€Œæ–°å¢è¯çµ¡æ–¹å¼ã€æŒ‰éˆ•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  if (!contacts.querySelector('.edit-add-btn')) {
    const addBtnZh = document.createElement('button');
    addBtnZh.className = 'edit-add-btn lang-zh';
    addBtnZh.textContent = '+ æ–°å¢è¯çµ¡æ–¹å¼';
    addBtnZh.onclick = function(event) { addContact(event); };
    contacts.appendChild(addBtnZh);

    const addBtnEn = document.createElement('button');
    addBtnEn.className = 'edit-add-btn lang-en';
    addBtnEn.textContent = '+ Add Contact Method';
    addBtnEn.onclick = function(event) { addContact(event); };
    contacts.appendChild(addBtnEn);
  }
}

// èšç„¦ç·¨è¼¯
function focusEdit(element) {
  // ä¿®æ­£ï¼šé¿å…æ¯æ¬¡é»æ“Šéƒ½ã€Œå…¨é¸ã€å°è‡´è²¼ä¸Š/è¼¸å…¥æ™‚æ¸¸æ¨™è·³å‹•ã€æ–‡å­—è¢«æ•´æ®µè¦†è“‹ã€‚
  // è¡Œç‚ºæ”¹ç‚ºï¼šè‹¥å°šæœªèšç„¦ï¼Œèšç„¦ä¸¦æŠŠæ¸¸æ¨™æ”¾åˆ°çµå°¾ï¼ˆä¸å…¨é¸ï¼‰ã€‚
  try {
    const alreadyFocused = (document.activeElement === element);
    element.focus();
    
    // é¡¯ç¤ºå­—é«”æ¨£å¼å·¥å…·åˆ—ï¼ˆç„¡è«–æ˜¯å¦å·²èšç„¦ï¼‰
    showFontStyleToolbar(element);
    
    if (alreadyFocused) return;

    const selection = window.getSelection();
    if (!selection) return;
    selection.removeAllRanges();

    const range = document.createRange();
    range.selectNodeContents(element);
    range.collapse(false); // æ¸¸æ¨™æ”¾åˆ°çµå°¾
    selection.addRange(range);
  } catch (e) {
    // å³ä½¿ç™¼ç”ŸéŒ¯èª¤ï¼Œä»å˜—è©¦é¡¯ç¤ºå·¥å…·åˆ—
    try { showFontStyleToolbar(element); } catch (e2) {}
  }
}

// ===== å­—é«”æ¨£å¼å·¥å…·åˆ—åŠŸèƒ½ =====
let currentStyledElement = null;

function showFontStyleToolbar(element) {
  const toolbar = document.getElementById('fontStyleToolbar');
  if (!toolbar) return;
  
  // åªå°å§“åã€è·ç¨±ã€æ¨™èªæ¬„ä½é¡¯ç¤ºå·¥å…·åˆ—
  const isStyleable = element.id === 'previewNameZh' || 
                      element.id === 'previewTitleZh' || 
                      element.id === 'previewTitleEn' ||
                      element.closest('.slogan-item');
  
  if (!isStyleable) {
    hideFontStyleToolbar();
    return;
  }
  
  currentStyledElement = element;
  
  // è¨ˆç®—ä½ç½®
  const rect = element.getBoundingClientRect();
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
  
  toolbar.style.position = 'fixed';
  toolbar.style.top = (rect.top - 50) + 'px';
  toolbar.style.left = (rect.left + rect.width / 2) + 'px';
  toolbar.style.transform = 'translateX(-50%)';
  toolbar.classList.add('active');
  
  // æ›´æ–°å·¥å…·åˆ—æŒ‰éˆ•ç‹€æ…‹
  updateToolbarState(element);
}

function hideFontStyleToolbar() {
  const toolbar = document.getElementById('fontStyleToolbar');
  if (toolbar) {
    toolbar.classList.remove('active');
  }
  currentStyledElement = null;
}

function updateToolbarState(element) {
  const style = window.getComputedStyle(element);
  const toolbar = document.getElementById('fontStyleToolbar');
  if (!toolbar) return;
  
  // æ›´æ–°å­—é«”å¤§å°æŒ‰éˆ•ç‹€æ…‹
  const fontSize = parseInt(style.fontSize);
  toolbar.querySelectorAll('.size-s, .size-m, .size-l').forEach(btn => btn.classList.remove('active'));
  if (fontSize <= 14) {
    toolbar.querySelector('.size-s')?.classList.add('active');
  } else if (fontSize >= 24) {
    toolbar.querySelector('.size-l')?.classList.add('active');
  } else {
    toolbar.querySelector('.size-m')?.classList.add('active');
  }
  
  // æ›´æ–°ç²—ç´°æŒ‰éˆ•ç‹€æ…‹
  const fontWeight = style.fontWeight;
  toolbar.querySelectorAll('.font-style-btn[onclick^="setFontWeight"]').forEach(btn => btn.classList.remove('active'));
  if (fontWeight === 'bold' || parseInt(fontWeight) >= 600) {
    toolbar.querySelector('.font-style-btn[onclick="setFontWeight(\'bold\')"]')?.classList.add('active');
  } else {
    toolbar.querySelector('.font-style-btn[onclick="setFontWeight(\'normal\')"]')?.classList.add('active');
  }
  
  // æ›´æ–°èª¿è‰²ç›¤ç‹€æ…‹
  const color = rgbToHex(style.color);
  const picker = document.getElementById('fontColorPicker');
  if (picker) {
    picker.value = color;
  }
}

function rgbToHex(rgb) {
  if (rgb.startsWith('#')) return rgb;
  const match = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
  if (!match) return rgb;
  return '#' + [match[1], match[2], match[3]].map(x => {
    const hex = parseInt(x).toString(16);
    return hex.length === 1 ? '0' + hex : hex;
  }).join('');
}

function setFontSize(size) {
  if (!currentStyledElement) return;
  
  const sizeMap = {
    'small': '14px',
    'medium': '18px',
    'large': '26px'
  };
  
  // æ ¹æ“šå…ƒç´ é¡å‹èª¿æ•´åŸºæº–å¤§å°
  if (currentStyledElement.classList.contains('name')) {
    sizeMap.small = '18px';
    sizeMap.medium = '24px';
    sizeMap.large = '32px';
  } else if (currentStyledElement.classList.contains('tagline')) {
    sizeMap.small = '12px';
    sizeMap.medium = '16px';
    sizeMap.large = '20px';
  }
  
  currentStyledElement.style.fontSize = sizeMap[size] || sizeMap.medium;
  
  // å„²å­˜æ¨£å¼åˆ° data å±¬æ€§
  currentStyledElement.dataset.fontSize = size;
  
  updateToolbarState(currentStyledElement);
}

function setFontWeight(weight) {
  if (!currentStyledElement) return;
  
  currentStyledElement.style.fontWeight = weight === 'bold' ? '700' : '400';
  currentStyledElement.dataset.fontWeight = weight;
  
  updateToolbarState(currentStyledElement);
}

function setFontColor(color) {
  if (!currentStyledElement) {
    return;
  }
  
  currentStyledElement.style.color = color;
  currentStyledElement.dataset.fontColor = color;
  
  // æ›´æ–°èª¿è‰²ç›¤é¡¯ç¤º
  const picker = document.getElementById('fontColorPicker');
  if (picker && picker.value !== color) {
    picker.value = color;
  }
  
  // ç¢ºä¿ç„¦é»ä¿æŒåœ¨å…ƒç´ ä¸Š
  currentStyledElement.focus();
}

// é»æ“Šå…¶ä»–åœ°æ–¹æ™‚éš±è—å·¥å…·åˆ—
document.addEventListener('click', function(e) {
  const toolbar = document.getElementById('fontStyleToolbar');
  if (!toolbar) return;
  
  // å¦‚æœé»æ“Šçš„æ˜¯å·¥å…·åˆ—æˆ–å·¥å…·åˆ—å…§çš„æŒ‰éˆ•ï¼Œä¸éš±è—
  if (toolbar.contains(e.target)) return;
  
  // å¦‚æœé»æ“Šçš„æ˜¯å¯ç·¨è¼¯æ¬„ä½ï¼ŒshowFontStyleToolbar æœƒè™•ç†
  const editableTarget = e.target.closest('[contenteditable="true"]');
  if (editableTarget && editableTarget.classList.contains('edit-clickable')) return;
  
  // å¦å‰‡éš±è—å·¥å…·åˆ—
  hideFontStyleToolbar();
});

// æ»¾å‹•æ™‚æ›´æ–°å·¥å…·åˆ—ä½ç½®
document.addEventListener('scroll', function() {
  if (currentStyledElement) {
    const toolbar = document.getElementById('fontStyleToolbar');
    if (toolbar && toolbar.classList.contains('active')) {
      const rect = currentStyledElement.getBoundingClientRect();
      toolbar.style.top = (rect.top - 50) + 'px';
      toolbar.style.left = (rect.left + rect.width / 2) + 'px';
    }
  }
}, true);

// ä¿®æ­£ï¼šcontenteditable è²¼ä¸Šæ™‚ä¸€å¾‹ä»¥ã€Œç´”æ–‡å­—ã€æ’å…¥ï¼Œé¿å…æ’å…¥ HTML é€ æˆçµæ§‹è®Šå‹•èˆ‡æ¸¸æ¨™è·‘ä½
// ä¸¦åœ¨è²¼ä¸Šå¾Œå¼·åˆ¶è§¸ç™¼ input/blur äº‹ä»¶ä»¥åŒæ­¥è³‡æ–™
document.addEventListener('paste', function (e) {
  try {
    const t = e.target;
    if (!t || !t.closest) return;
    const el = t.closest('[contenteditable="true"]');
    if (!el) return;
    // åªè™•ç†å¯ç·¨è¼¯æ¬„ä½ï¼ˆé¿å…å½±éŸ¿å…¶ä»–è¼¸å…¥ï¼‰
    if (!el.classList || !el.classList.contains('edit-clickable')) return;

    const text = (e.clipboardData || window.clipboardData)?.getData('text/plain');
    if (typeof text !== 'string') return;
    e.preventDefault();

    // å„ªå…ˆç”¨ execCommandï¼ˆç›¸å®¹æ€§å¥½ï¼‰ï¼Œä¸è¡Œå†ç”¨ Range
    if (document.queryCommandSupported && document.queryCommandSupported('insertText')) {
      document.execCommand('insertText', false, text);
    } else {
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) return;
      sel.deleteFromDocument();
      const range = sel.getRangeAt(0);
      range.insertNode(document.createTextNode(text));
      range.collapse(false);
      sel.removeAllRanges();
      sel.addRange(range);
    }
    
    // å¼·åˆ¶è§¸ç™¼åŒæ­¥
    if (el.onblur) el.onblur();
  } catch (_e) {}
});

// ===== å…¬å¸é¸æ“‡å™¨ï¼ˆå¿…é¸ä¸‹æ‹‰ + é—œéµå­—åŒ¹é…ï¼‰=====
// è¦æ ¼ï¼š
// - å…¬å¸æ¸…å–®ä¾†æºï¼šå¾ cards.company è‡ªå‹•å½™æ•´ï¼ˆå»é‡ï¼‰
// - ä¸€èˆ¬ä½¿ç”¨è€…ï¼šç¬¬ä¸€æ¬¡å„²å­˜å¾Œé–å®šå…¬å¸ï¼ˆé¿å…æ”¹æ‰å°è‡´ä¼æ¥­ç®¡ç†å“¡çœ‹ä¸åˆ°ï¼‰
// - ç®¡ç†å“¡æ¨¡å¼ï¼šå¯æ”¹ä»–äººå…¬å¸ï¼ˆä¸å—é–å®šé™åˆ¶ï¼‰
window.__uvacoCompanyOptions = window.__uvacoCompanyOptions || null; // Array<string>
window.__uvacoSelectedCompany = window.__uvacoSelectedCompany || ''; // canonical company (cards.company)
window.__uvacoOriginalCompanyCanonical = window.__uvacoOriginalCompanyCanonical || '';
window.__uvacoCompanyLocked = window.__uvacoCompanyLocked || false;

function getEditUrlTargetUserId() {
  try {
    const p = new URLSearchParams(window.location.search || '');
    return p.get('targetUserId') || p.get('uid') || p.get('id') || '';
  } catch (e) { return ''; }
}

function isAdminModeFromUrl() {
  try {
    const p = new URLSearchParams(window.location.search || '');
    return p.get('adminMode') === 'true';
  } catch (e) { return false; }
}

async function loadCompanyOptionsFromCards() {
  if (Array.isArray(window.__uvacoCompanyOptions)) return window.__uvacoCompanyOptions;
  window.__uvacoCompanyOptions = [];
  try {
    if (!window.UVACO_CLOUD || !UVACO_CLOUD.hasConfig()) return window.__uvacoCompanyOptions;
    // éœ€è¦ç™»å…¥ï¼ˆèµ° RLSï¼‰
    const here = 'edit.html' + (window.location.search || '');
    const auth = await UVACO_CLOUD.requireAuth(here);
    if (!auth.ok) return window.__uvacoCompanyOptions;

    const client = UVACO_CLOUD.getClient();
    if (!client) return window.__uvacoCompanyOptions;

    // å–å‰ 1000 ç­† company ä½œå»é‡ï¼ˆè¶³å¤ ç”¨æ–¼ä¸‹æ‹‰ï¼›è‹¥æœªä¾†å¾ˆå¤§å¯æ”¹æˆ RPC/ç´¢å¼•ï¼‰
    const { data, error } = await client
      .from('cards')
      .select('company')
      .not('company', 'is', null)
      .limit(1000);
    if (error) return window.__uvacoCompanyOptions;

    const set = new Set();
    (data || []).forEach(r => {
      const c = String(r?.company || '').trim();
      if (c) set.add(c);
    });
    window.__uvacoCompanyOptions = Array.from(set).sort((a, b) => a.localeCompare(b, 'zh-Hant'));
  } catch (e) {}
  return window.__uvacoCompanyOptions;
}

function getSloganStrong(lang) {
  try {
    const containerId = (lang === 'zh') ? 'previewSlogansZh' : 'previewSlogansEn';
    const container = document.getElementById(containerId);
    if (!container) return null;
    const strong = container.querySelector('strong');
    return strong || null;
  } catch (e) { return null; }
}

function getCanonicalCompanyFromStrongText(text) {
  const s = String(text || '').replace(/\s+/g, ' ').trim();
  if (!s) return '';
  // åªå–å·¦åŠé‚Šï¼ˆå…¬å¸åï¼‰ä½œç‚º canonical
  return s.split(/\s*[ï½œ|]\s*/)[0].trim();
}

function applyCompanyToUI(canonical) {
  const c = String(canonical || '').trim();
  if (!c) return false;

  // ä¸­æ–‡ strongï¼šä¿ç•™å³åŠé‚Šï¼ˆè‹¥å­˜åœ¨ï¼‰ï¼Œè‹¥ç„¡å‰‡å»ºç«‹
  const zhStrong = getSloganStrong('zh');
  if (zhStrong) {
    const old = String(zhStrong.textContent || '').trim();
    const parts = old.split(/\s*ï½œ\s*/);
    const suffix = (parts.length >= 2) ? parts.slice(1).join('ï½œ').trim() : 'å°ˆæ¥­é™ªä¼´';
    zhStrong.textContent = c + 'ï½œ' + (suffix || 'å°ˆæ¥­é™ªä¼´');
  } else {
    // å»ºç«‹ä¸€å€‹å¸¶ strong çš„ slogan
    const container = document.getElementById('previewSlogansZh');
    if (container) {
      const div = document.createElement('div');
      div.className = 'slogan-item';
      div.innerHTML = `
        <div class="tagline lang-zh edit-clickable" contenteditable="true"><strong>${c}ï½œå°ˆæ¥­é™ªä¼´</strong></div>
        <button class="slogan-delete-btn" onclick="deleteSloganFromPreview(this)" title="åˆªé™¤">âœ•</button>
      `;
      container.insertBefore(div, container.firstChild);
    }
  }

  // è‹±æ–‡ strongï¼šä¿ç•™å³åŠé‚Šï¼ˆè‹¥å­˜åœ¨ï¼‰ï¼Œè‹¥ç„¡å‰‡å»ºç«‹
  const enStrong = getSloganStrong('en');
  if (enStrong) {
    const old = String(enStrong.textContent || '').trim();
    const parts = old.split(/\s*\|\s*/);
    const suffix = (parts.length >= 2) ? parts.slice(1).join('|').trim() : 'Professional Support';
    enStrong.textContent = c + ' | ' + (suffix || 'Professional Support');
  } else {
    const container = document.getElementById('previewSlogansEn');
    if (container) {
      const div = document.createElement('div');
      div.className = 'slogan-item';
      div.innerHTML = `
        <div class="tagline lang-en edit-clickable" contenteditable="true"><strong>${c} | Professional Support</strong></div>
        <button class="slogan-delete-btn" onclick="deleteSloganFromPreview(this)" title="Delete">âœ•</button>
      `;
      container.insertBefore(div, container.firstChild);
    }
  }

  window.__uvacoSelectedCompany = c;
  // åŒæ­¥æ•´ç†ï¼Œé¿å…äº‹ä»¶ç¼ºå¤±
  if (typeof updateSlogansPreview === 'function') updateSlogansPreview();
  // æ›´æ–°é–å®šæç¤º
  try {
    const badge = document.getElementById('uvacoCompanyLockBadge');
    if (badge) {
      badge.textContent = 'å…¬å¸ï¼šå¿…é¸ä¸‹æ‹‰ï¼ˆå¯è¼¸å…¥é—œéµå­—å¿«é€Ÿå¸¶å…¥ï¼‰';
      /*
      badge.textContent = window.__uvacoCompanyLocked && !isAdminModeFromUrl()
        ? 'å…¬å¸å·²é–å®šï¼ˆå¦‚éœ€æ›´æ”¹è«‹è¯çµ¡ç®¡ç†å“¡ï¼‰'
        : 'å…¬å¸ï¼šå¿…é¸ä¸‹æ‹‰ï¼ˆå¯è¼¸å…¥é—œéµå­—å¿«é€Ÿå¸¶å…¥ï¼‰';
      */
    }
  } catch (e) {}
  return true;
}

function ensureCompanySelectorModal() {
  if (document.getElementById('uvacoCompanyModal')) return;
  const overlay = document.createElement('div');
  overlay.id = 'uvacoCompanyModal';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:3000;padding:18px;';
  overlay.innerHTML = `
    <div style="width:100%;max-width:520px;border-radius:16px;padding:16px 14px;background:#111;border:1px solid rgba(255,255,255,.10);color:#fff;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;">
        <div style="font-weight:800;color:var(--uvaco-green);">é¸æ“‡å…¬å¸</div>
        <button type="button" id="uvacoCompanyCloseBtn" style="border:none;background:transparent;color:#9ca3af;font-size:20px;cursor:pointer;">âœ•</button>
      </div>
      <div style="font-size:13px;color:#9ca3af;line-height:1.6;margin-bottom:10px;">
        è«‹è¼¸å…¥é—œéµå­—æœå°‹å…¬å¸åç¨±ï¼Œä¸¦å¾æ¸…å–®é»é¸å¸¶å…¥ã€‚<br>
        ï¼ˆå…¬å¸ç‚ºå¿…é¸ï¼›ç¬¬ä¸€æ¬¡å„²å­˜å¾Œæœƒé–å®šï¼Œé¿å…æ”¹æ‰å°è‡´ç®¡ç†æ¬Šé™å¤±æ•ˆï¼‰
      </div>
      <input id="uvacoCompanySearch" type="text" placeholder="è¼¸å…¥é—œéµå­—ï¼ˆä¾‹å¦‚ï¼šUVACO / è‘¡çœ¾ï¼‰" style="width:100%;box-sizing:border-box;padding:12px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:#1a1a1a;color:#fff;font-size:14px;outline:none;" />
      <div id="uvacoCompanyList" style="margin-top:10px;max-height:280px;overflow:auto;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:#151515;"></div>
      <div style="display:flex;gap:10px;margin-top:12px;">
        <button type="button" id="uvacoCompanyCancel" style="flex:1;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.06);color:#fff;cursor:pointer;">å–æ¶ˆ</button>
        <button type="button" id="uvacoCompanyConfirm" style="flex:1;padding:12px;border-radius:12px;border:none;background:var(--uvaco-green);color:#fff;font-weight:800;cursor:pointer;">ç¢ºèªå¸¶å…¥</button>
      </div>
      <div id="uvacoCompanyErr" style="display:none;margin-top:10px;color:#ef4444;font-size:13px;white-space:pre-wrap;"></div>
    </div>
  `;
  document.body.appendChild(overlay);

  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) closeCompanySelector();
  });
  document.getElementById('uvacoCompanyCloseBtn')?.addEventListener('click', closeCompanySelector);
  document.getElementById('uvacoCompanyCancel')?.addEventListener('click', closeCompanySelector);

  // æœå°‹äº’å‹•
  const input = document.getElementById('uvacoCompanySearch');
  if (input) {
    input.addEventListener('input', () => renderCompanyList());
    input.addEventListener('keydown', (ev) => {
      if (ev.key === 'Escape') { closeCompanySelector(); return; }
      if (ev.key === 'Enter') {
        ev.preventDefault();
        // Enterï¼šå„ªå…ˆå¸¶å…¥ç¬¬ä¸€å€‹å¯è¦‹é¸é …ï¼›è‹¥æ²’æœ‰ï¼Œå‰‡ç”¨è¼¸å…¥æ¡†æ–‡å­—å»ºç«‹ä¸¦å¸¶å…¥
        const first = document.querySelector('#uvacoCompanyList button[data-company]');
        if (first) {
          first.click();
        } else {
          document.getElementById('uvacoCompanyConfirm')?.click();
        }
      }
    });
  }

  document.getElementById('uvacoCompanyConfirm')?.addEventListener('click', () => {
    const inputVal = String(document.getElementById('uvacoCompanySearch')?.value || '').trim();
    const chosen = String(overlay.getAttribute('data-chosen') || '').trim();
    const value = chosen || inputVal;
    if (!value) {
      showCompanyErr('è«‹è¼¸å…¥æˆ–é¸æ“‡å…¬å¸åç¨±ã€‚');
      return;
    }
    // å»ºç«‹æ–°å…¬å¸ï¼šæŠŠæ–°å€¼åŠ å…¥ optionsï¼ˆé¿å…ä¸‹æ¬¡æœå°‹æ‰¾ä¸åˆ°ï¼‰
    try {
      window.__uvacoCompanyOptions = Array.isArray(window.__uvacoCompanyOptions) ? window.__uvacoCompanyOptions : [];
      if (!window.__uvacoCompanyOptions.includes(value)) {
        window.__uvacoCompanyOptions.push(value);
        window.__uvacoCompanyOptions.sort((a, b) => String(a).localeCompare(String(b), 'zh-Hant'));
      }
    } catch (e) {}
    applyCompanyToUI(value);
    closeCompanySelector();
  });
}

function showCompanyErr(msg) {
  const el = document.getElementById('uvacoCompanyErr');
  if (!el) return;
  el.style.display = 'block';
  el.textContent = String(msg || '');
}

function clearCompanyErr() {
  const el = document.getElementById('uvacoCompanyErr');
  if (!el) return;
  el.style.display = 'none';
  el.textContent = '';
}

function openCompanySelector() {
  // é–å®šï¼šä¸€èˆ¬ä½¿ç”¨è€…ä¸å¯æ”¹ï¼›ç®¡ç†å“¡æ¨¡å¼å¯æ”¹
  // è®“å®¢æˆ¶å¯ä»¥ç·¨è¼¯å…¬å¸ï¼šç§»é™¤é–å®šæª¢æŸ¥
  /*
  if (window.__uvacoCompanyLocked && !isAdminModeFromUrl()) {
    alert('å…¬å¸å·²é–å®šï¼Œå¦‚éœ€æ›´æ”¹è«‹è¯çµ¡ç®¡ç†å“¡ã€‚');
    return;
  }
  */
  ensureCompanySelectorModal();
  clearCompanyErr();
  const overlay = document.getElementById('uvacoCompanyModal');
  if (!overlay) return;
  overlay.style.display = 'flex';
  overlay.setAttribute('data-chosen', '');
  const input = document.getElementById('uvacoCompanySearch');
  if (input) {
    input.value = '';
    setTimeout(() => input.focus(), 0);
  }
  // å…ˆè¼‰å…¥å…¬å¸æ¸…å–®å†æ¸²æŸ“
  Promise.resolve(loadCompanyOptionsFromCards()).then(() => renderCompanyList());
}

function closeCompanySelector() {
  const overlay = document.getElementById('uvacoCompanyModal');
  if (!overlay) return;
  overlay.style.display = 'none';
}

function renderCompanyList() {
  const list = document.getElementById('uvacoCompanyList');
  const overlay = document.getElementById('uvacoCompanyModal');
  if (!list || !overlay) return;
  const q = String(document.getElementById('uvacoCompanySearch')?.value || '').trim().toLowerCase();
  const options = Array.isArray(window.__uvacoCompanyOptions) ? window.__uvacoCompanyOptions : [];
  const filtered = q
    ? options.filter(c => String(c).toLowerCase().includes(q)).slice(0, 50)
    : options.slice(0, 50);

  if (!options.length) {
    list.innerHTML = `<div style="padding:12px;color:#9ca3af;font-size:13px;line-height:1.6;">ç›®å‰å°šç„¡å…¬å¸æ¸…å–®ï¼ˆcards.company ç‚ºç©ºï¼‰ã€‚\nè«‹å…ˆç”±ç®¡ç†å“¡å»ºç«‹ç¬¬ä¸€å¼µåç‰‡ä»¥ç”¢ç”Ÿå…¬å¸é¸é …ã€‚</div>`;
    return;
  }

  if (!filtered.length) {
    const displayQ = String(document.getElementById('uvacoCompanySearch')?.value || '').trim();
    list.innerHTML = `
      <div style="padding:12px;color:#9ca3af;font-size:13px;line-height:1.6;">
        æ‰¾ä¸åˆ°ç¬¦åˆçš„å…¬å¸åç¨±ã€‚
      </div>
      ${displayQ ? `
        <button type="button" id="uvacoCompanyCreateBtn"
          style="width:100%;text-align:left;padding:12px;border:none;border-top:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.06);color:#fff;cursor:pointer;font-size:14px;font-weight:800;">
          â• å»ºç«‹ä¸¦å¸¶å…¥ã€Œ${displayQ}ã€
        </button>
      ` : ''}
    `;
    const btn = document.getElementById('uvacoCompanyCreateBtn');
    if (btn && displayQ) {
      btn.addEventListener('click', () => {
        overlay.setAttribute('data-chosen', displayQ);
        clearCompanyErr();
        applyCompanyToUI(displayQ);
      });
    }
    return;
  }

  list.innerHTML = '';
  filtered.forEach(company => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.setAttribute('data-company', company);
    btn.style.cssText = 'width:100%;text-align:left;padding:12px;border:none;border-bottom:1px solid rgba(255,255,255,.06);background:transparent;color:#fff;cursor:pointer;font-size:14px;';
    btn.textContent = company;
    btn.addEventListener('click', () => {
      overlay.setAttribute('data-chosen', company);
      clearCompanyErr();
      // ç«‹å³é è¦½å¸¶å…¥ï¼ˆä½†ä¸é—œé–‰ï¼Œè®“ä½¿ç”¨è€…å¯å†é¸ï¼‰
      applyCompanyToUI(company);
    });
    list.appendChild(btn);
  });
}

function injectCompanyPickerButtons() {
  // å·²æ³¨å…¥å°±ä¸é‡è¤‡
  if (document.getElementById('uvacoCompanyPickBtnZh')) return;

  const anchorZh = getSloganStrong('zh')?.parentElement;
  const anchorEn = getSloganStrong('en')?.parentElement;
  if (!anchorZh && !anchorEn) return;

  // å°è¢å¹•å †ç–Šï¼šç”¨ wrapper åŒ…ä½æŒ‰éˆ• + badgeï¼Œé¿å… iPhone SE æ“ å£“
  const makeWrap = (lang) => {
    const wrap = document.createElement('div');
    wrap.className = `uvaco-company-picker-wrap lang-${lang}`;
    return wrap;
  };

  const makeBadge = () => {
    const badge = document.createElement('div');
    badge.id = 'uvacoCompanyLockBadge';
    badge.className = 'uvaco-company-picker-badge';
    badge.textContent = 'å…¬å¸ï¼šå¿…é¸ä¸‹æ‹‰ï¼ˆå¯è¼¸å…¥é—œéµå­—å¿«é€Ÿå¸¶å…¥ï¼‰';
    /*
    badge.textContent = window.__uvacoCompanyLocked && !isAdminModeFromUrl()
      ? 'å…¬å¸å·²é–å®šï¼ˆå¦‚éœ€æ›´æ”¹è«‹è¯çµ¡ç®¡ç†å“¡ï¼‰'
      : 'å…¬å¸ï¼šå¿…é¸ä¸‹æ‹‰ï¼ˆå¯è¼¸å…¥é—œéµå­—å¿«é€Ÿå¸¶å…¥ï¼‰';
    */
    return badge;
  };

  // ä¸­æ–‡æŒ‰éˆ• + badge
  if (anchorZh) {
    const wrapZh = makeWrap('zh');
    const btnZh = document.createElement('button');
    btnZh.type = 'button';
    btnZh.id = 'uvacoCompanyPickBtnZh';
    btnZh.className = 'edit-add-btn lang-zh';
    btnZh.textContent = 'ğŸ¢ é¸æ“‡å…¬å¸';
    btnZh.onclick = openCompanySelector;
    wrapZh.appendChild(btnZh);
    wrapZh.appendChild(makeBadge());
    anchorZh.insertAdjacentElement('afterend', wrapZh);
  }

  // è‹±æ–‡æŒ‰éˆ• + badgeï¼ˆè‹¥ä¸­æ–‡ä¸å­˜åœ¨æ‰æ’å…¥ badgeï¼Œé¿å…é‡è¤‡ idï¼‰
  if (anchorEn) {
    const wrapEn = makeWrap('en');
    const btnEn = document.createElement('button');
    btnEn.type = 'button';
    btnEn.id = 'uvacoCompanyPickBtnEn';
    btnEn.className = 'edit-add-btn lang-en';
    btnEn.textContent = 'ğŸ¢ Select Company';
    btnEn.onclick = openCompanySelector;
    wrapEn.appendChild(btnEn);
    // è‹¥ä¸­æ–‡å·²æ’å…¥ badgeï¼ˆå·²å­˜åœ¨ idï¼‰ï¼Œè‹±æ–‡å°±ä¸å†æ’å…¥ badge
    if (!document.getElementById('uvacoCompanyLockBadge')) {
      wrapEn.appendChild(makeBadge());
    }
    anchorEn.insertAdjacentElement('afterend', wrapEn);
  }
}

// å¾é è¦½æ›´æ–°å§“å
function updateNameFromPreview() {
  const nameZhEl = document.getElementById('previewNameZh');
  if (!nameZhEl) return;
  const nameZhText = String(nameZhEl.textContent || '').replace(/\s+/g, ' ').trim();
  if (!nameZhText) return;
  
  // åŒæ­¥åˆ°éš±è—çš„ input æ¬„ä½ï¼ˆè‹¥æœªä¾†è¡¨å–®éœ€è¦ï¼‰
  const nameInp = document.getElementById('nameZh');
  if (nameInp) nameInp.value = nameZhText;

  // è§£æå§“åï¼ˆæ ¼å¼ï¼šä¸­æ–‡å ï½œ è‹±æ–‡åï¼‰
  const zhMatch = nameZhText.match(/^(.+?)\s*ï½œ\s*(.+)$/);

  // ç›¸å®¹ï¼šä½¿ç”¨è€…å¯èƒ½è¼¸å…¥ã€Œä¸­æ–‡ï¼ˆENï¼‰ã€æˆ–ã€Œä¸­æ–‡(EN)ã€
  const zhParen = nameZhText.match(/^(.+?)\s*[ï¼ˆ(]\s*([^)ï¼‰]+)\s*[)ï¼‰]\s*$/);
  
  if (zhMatch) {
    nameZhEl.innerHTML = zhMatch[1].trim() + ' ï½œ <span class="en">' + zhMatch[2].trim() + '</span>';
  } else if (zhParen) {
    nameZhEl.innerHTML = zhParen[1].trim() + ' ï½œ <span class="en">' + zhParen[2].trim() + '</span>';
  } else {
    nameZhEl.textContent = nameZhText;
  }

  // å¥—ç”¨è‡ªå‹•ç¸®å­—ï¼Œç¢ºä¿å–®è¡Œæ°´å¹³é¡¯ç¤º
  try {
    const isSmall = (window.matchMedia && window.matchMedia('(max-width: 420px)').matches);
    fitTextToSingleLine(nameZhEl, { minPx: 16, maxPx: isSmall ? 30 : 34 });
  } catch (e) {}
}

// å¾é è¦½æ›´æ–°è·å‹™
function updateTitleFromPreview() {
  const titleZhEl = document.getElementById('previewTitleZh');
  const titleEnEl = document.getElementById('previewTitleEn');
  
  // å–å¾—ç´”æ–‡å­—ä¸¦æ¸…ç†å¤šé¤˜ç©ºç™½
  const zhText = String(titleZhEl?.textContent || '').replace(/\s+/g, ' ').trim();
  const enText = String(titleEnEl?.textContent || '').replace(/\s+/g, ' ').trim();

  // æ›´æ–°å› DOM ç¢ºä¿ä¸€è‡´æ€§
  if (titleZhEl) titleZhEl.textContent = zhText;
  if (titleEnEl) titleEnEl.textContent = enText;

  // åŒæ­¥åˆ°éš±è—çš„ input æ¬„ä½ï¼ˆè‹¥æœªä¾†è¡¨å–®éœ€è¦ï¼‰
  const zhInp = document.getElementById('titleZh');
  const enInp = document.getElementById('titleEn');
  if (zhInp) zhInp.value = zhText;
  if (enInp) enInp.value = enText;
}

// å¾é è¦½æ›´æ–°å…¬å¸åç¨±
function updateCompanyFromPreview() {
  const zhEl = document.getElementById('previewCompanyNameZh');
  const enEl = document.getElementById('previewCompanyNameEn');
  
  // å–å¾—ç´”æ–‡å­—ä¸¦æ¸…ç†å¤šé¤˜ç©ºç™½
  const companyZh = String(zhEl?.textContent || '').replace(/\s+/g, ' ').trim();
  const companyEn = String(enEl?.textContent || '').replace(/\s+/g, ' ').trim();
  
  // æ›´æ–°å› DOM ç¢ºä¿ä¸€è‡´æ€§
  if (zhEl) zhEl.textContent = companyZh;
  if (enEl) enEl.textContent = companyEn;
  
  // å„²å­˜åˆ°å…¨åŸŸè®Šæ•¸ä¾› saveCard ä½¿ç”¨
  window.__uvacoCompanyZh = companyZh;
  window.__uvacoCompanyEn = companyEn;
  window.__uvacoSelectedCompany = companyZh || companyEn;
}

// ===== è‡ªå‹•ç¸®å­—ï¼šè®“å…ƒç´ æ–‡å­—ä¿æŒå–®è¡Œæ°´å¹³å‘ˆç¾ï¼ˆè¶…å‡ºå°±ç¸®å°åˆ° minPxï¼‰=====
function fitTextToSingleLine(el, opts) {
  if (!el) return;
  const minPx = (opts && typeof opts.minPx === 'number') ? opts.minPx : 16;
  const maxPx = (opts && typeof opts.maxPx === 'number') ? opts.maxPx : 34;

  // åªåœ¨å¯è¦‹æ™‚è™•ç†
  const rect = el.getBoundingClientRect();
  if (!rect.width || rect.width <= 0) return;

  el.style.whiteSpace = 'nowrap';
  el.style.fontSize = maxPx + 'px';

  // è‹¥ä»è¶…å‡ºï¼Œé€æ­¥ç¸®å°
  let size = maxPx;
  // è¿´åœˆä¸Šé™é¿å…å¡ä½
  for (let i = 0; i < 40; i++) {
    if (el.scrollWidth <= el.clientWidth + 1) break;
    size -= 1;
    if (size <= minPx) { size = minPx; break; }
    el.style.fontSize = size + 'px';
  }
}

// åˆæ¬¡è¼‰å…¥/è¦–çª—æ”¹è®Šæ™‚ä¹Ÿé‡ç®—ï¼ˆé¿å… iPhone SE æ—‹è½‰æˆ–ç¸®æ”¾å¾Œè·‘ç‰ˆï¼‰
window.addEventListener('resize', function () {
  try {
    const isSmall = (window.matchMedia && window.matchMedia('(max-width: 420px)').matches);
    fitTextToSingleLine(document.getElementById('previewNameZh'), { minPx: 16, maxPx: isSmall ? 30 : 34 });
  } catch (e) {}
});

// æ›´æ–°æ¨™èªé è¦½
function updateSlogansPreview() {
  // ä¿®æ­£ï¼šæ¨™èªç›®å‰æ˜¯ç›´æ¥åœ¨é è¦½å€ï¼ˆcontenteditableï¼‰ç·¨è¼¯ï¼Œ
  // è‹¥é€™è£¡ç”¨ #slogansZhList/#slogansEnList çš„ input ä¾†æºé‡å»º DOMï¼Œ
  // æœƒå°è‡´ç·¨è¼¯å¾Œå…§å®¹è¢«è¦†è“‹æˆç©ºï¼Œå‡ºç¾ã€Œç·¨è¼¯å¾Œæ¶ˆå¤±ã€ç„¡æ³•å„²å­˜ã€çš„å•é¡Œã€‚

  const zhContainer = document.getElementById('previewSlogansZh');
  const enContainer = document.getElementById('previewSlogansEn');
  if (!zhContainer || !enContainer) return;

  // è¨˜éŒ„ç›®å‰çš„ç„¦é»ä½ç½®ï¼Œé¿å… normalizeContainer é‡å»ºå…§å®¹æ™‚æ¸¸æ¨™è·³æ‰
  const selection = window.getSelection();
  let focusedEl = null;
  let offset = 0;
  if (selection && selection.rangeCount > 0) {
    focusedEl = selection.focusNode;
    offset = selection.focusOffset;
  }

  // åªåšæœ€å°åŒ–æ•´ç†ï¼šæ¸…ç†ç©ºç™½ã€ç¢ºä¿ class/äº‹ä»¶å­˜åœ¨ï¼Œä¸¦ä¿®å¾©çµæ§‹
  const normalizeContainer = (container, lang) => {
    // 1. å…ˆä¿®å¾©çµæ§‹ï¼šæ‰¾å‡ºæ‰€æœ‰æ²’æœ‰è¢« .slogan-item åŒ…è£¹çš„ .taglineï¼Œå°‡å…¶åŒ…è£¹ä¸¦åŠ ä¸Šåˆªé™¤æŒ‰éˆ•
    const orphanedTaglines = Array.from(container.children).filter(el => 
      el.classList.contains('tagline') && !el.closest('.slogan-item')
    );
    
    orphanedTaglines.forEach(tagline => {
      const wrapper = document.createElement('div');
      wrapper.className = 'slogan-item';
      
      // æ’å…¥ wrapper åˆ° tagline åŸæœ¬çš„ä½ç½®
      container.insertBefore(wrapper, tagline);
      
      // ç§»å‹• tagline åˆ° wrapper å…§
      wrapper.appendChild(tagline);
      
      // åŠ å…¥åˆªé™¤æŒ‰éˆ•
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'slogan-delete-btn';
      deleteBtn.textContent = 'âœ•';
      deleteBtn.title = lang === 'zh' ? 'åˆªé™¤æ¨™èª' : 'Delete slogan';
      deleteBtn.onclick = function(e) {
         e.stopPropagation();
         deleteSloganFromPreview(this);
      };
      wrapper.appendChild(deleteBtn);
    });

    // 2. é‡å°æ‰€æœ‰ .slogan-item é€²è¡Œæ­£è¦åŒ–
    const items = Array.from(container.querySelectorAll('.slogan-item'));
    items.forEach(item => {
      let tagline = item.querySelector('.tagline');
      
      // å¦‚æœ .slogan-item è£¡é¢æ²’æœ‰ .taglineï¼ˆç½•è¦‹ï¼‰ï¼Œè£œä¸€å€‹
      if (!tagline) {
         tagline = document.createElement('div');
         tagline.className = 'tagline';
         item.insertBefore(tagline, item.firstChild);
      }

      // ç¢ºä¿èªç³» class æ­£ç¢º
      tagline.classList.add('tagline');
      tagline.classList.toggle('lang-zh', lang === 'zh');
      tagline.classList.toggle('lang-en', lang !== 'zh');
      tagline.classList.add('edit-clickable');

      // ç¢ºä¿å¯ç·¨è¼¯èˆ‡äº‹ä»¶å­˜åœ¨
      tagline.contentEditable = 'true';
      
      // ä½¿ç”¨é–‰åŒ…ç¶å®šäº‹ä»¶ï¼Œé¿å…å…¨åŸŸæ±¡æŸ“
      // é˜²æ­¢é‡è¤‡ç¶å®š
      tagline.onblur = function() {
        // é‡è¦ï¼šé€™è£¡ä¸å‘¼å« normalizeContainerï¼Œä¹Ÿä¸éè¿´å‘¼å« updateSlogansPreview
        // åªåšè³‡æ–™åŒæ­¥
        updateCompanyFromSlogans();
      };
      
      tagline.onclick = function() { focusEdit(this); };

      // ç¢ºä¿æœ‰åˆªé™¤æŒ‰éˆ•
      if (!item.querySelector('.slogan-delete-btn')) {
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'slogan-delete-btn';
        deleteBtn.textContent = 'âœ•';
        deleteBtn.title = lang === 'zh' ? 'åˆªé™¤æ¨™èª' : 'Delete slogan';
        deleteBtn.onclick = function(e) {
            e.stopPropagation();
            deleteSloganFromPreview(this);
        };
        item.appendChild(deleteBtn);
      }

      // è‹¥ä½¿ç”¨è€…æŠŠå…§å®¹æ¸…ç©ºï¼Œçµ¦ä¸€å€‹æœ€å°æç¤ºå­—é¿å…æ•´å€‹æ¶ˆå¤±
      const html = String(tagline.innerHTML || '').trim();
      const text = String(tagline.textContent || '').trim();
      // åªæœ‰ç•¶çœŸçš„ä»€éº¼éƒ½æ²’æœ‰æ™‚æ‰çµ¦é è¨­å€¼ï¼Œä¸”ä¸è¦åœ¨ç”¨æˆ¶æ­£åœ¨ç·¨è¼¯æ™‚å¹²æ“¾
      if (!html && !text && document.activeElement !== tagline) {
        tagline.textContent = (lang === 'zh') ? 'æ–°æ¨™èª' : 'New Slogan';
      }
    });
  };

  // åªæœ‰åœ¨éç·¨è¼¯ç‹€æ…‹ä¸‹æ‰åŸ·è¡Œ normalizeï¼Œé¿å…å¹²æ“¾è¼¸å…¥æ³•
  // ä½†ç‚ºäº†ç¢ºä¿æŒ‰éˆ•äº‹ä»¶ç¶å®šï¼Œé€™è£¡é‚„æ˜¯å¾—åŸ·è¡Œï¼Œåªæ˜¯è¦å°å¿ƒä¸è¦å‹•åˆ° activeElement
  normalizeContainer(zhContainer, 'zh');
  normalizeContainer(enContainer, 'en');

  // ç«‹å³æ›´æ–°å…¬å¸åç¨±
  updateCompanyFromSlogans();
}

function updateCompanyFromSlogans() {
  const zhStrong = getSloganStrong('zh');
  const enStrong = getSloganStrong('en');
  const currentCompany = getCanonicalCompanyFromStrongText(zhStrong ? zhStrong.textContent : (enStrong ? enStrong.textContent : ''));
  if (currentCompany) {
    window.__uvacoSelectedCompany = currentCompany;
  }
}

// ===== åœ–ç‰‡è™•ç†ï¼ˆå£“ç¸®/è£åˆ‡/ä¸Šå‚³ Storageï¼‰=====
// - avatarï¼šæœ€å¤§ 512pxï¼Œç›®æ¨™ <= 1MB
// - logoï¼šæœ€å¤§ 1024pxï¼Œç›®æ¨™ <= 1MB
window.__uvacoPendingAssets = window.__uvacoPendingAssets || {
  avatar: null, // { blob, contentType, ext }
  logo: null
};

function revokeObjectUrlSafe(url) {
  try { if (url && url.startsWith('blob:')) URL.revokeObjectURL(url); } catch (e) {}
}

async function compressImageFile(file, opts) {
  const maxDim = Math.max(64, parseInt(opts?.maxDim || 512, 10) || 512);
  const maxBytes = Math.max(50 * 1024, parseInt(opts?.maxBytes || 1024 * 1024, 10) || 1024 * 1024);
  const mime = String(opts?.mime || 'image/webp');

  if (!file || !file.type || !file.type.startsWith('image/')) {
    throw new Error('NOT_IMAGE');
  }

  const imgUrl = URL.createObjectURL(file);
  try {
    const img = new Image();
    img.decoding = 'async';
    img.src = imgUrl;
    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
    });

    const w0 = img.naturalWidth || img.width || 1;
    const h0 = img.naturalHeight || img.height || 1;

    // è‡ªå‹•é™å“è³ª/ç¸®å°ºå¯¸ç›´åˆ° <= maxBytesï¼ˆé¿å…ä½ ç¾åœ¨é‡åˆ°çš„ã€Œè™•ç†å¤±æ•—ã€ï¼‰
    let targetMaxDim = maxDim;
    let outMime = mime;
    let blob = null;
    let tw = 0;
    let th = 0;

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d', { alpha: true });

    async function encodeAt(quality) {
      if (outMime === 'image/jpeg') {
        return await new Promise((resolve) => canvas.toBlob(resolve, outMime, quality));
      }
      return await new Promise((resolve) => canvas.toBlob(resolve, outMime, quality));
    }

    for (let attempt = 0; attempt < 6; attempt++) {
      const scale = Math.min(1, targetMaxDim / Math.max(w0, h0));
      tw = Math.max(1, Math.round(w0 * scale));
      th = Math.max(1, Math.round(h0 * scale));
      canvas.width = tw;
      canvas.height = th;
      ctx.clearRect(0, 0, tw, th);
      ctx.drawImage(img, 0, 0, tw, th);

      // å…ˆè©¦ webpï¼ˆè‹¥ç€è¦½å™¨ä¸æ”¯æ´æœƒå¾—åˆ° nullï¼‰ï¼Œä¸æ”¯æ´å°±æ”¹ jpeg
      outMime = mime;
      let q = 0.9;
      blob = await encodeAt(q);
      if (!blob) {
        outMime = 'image/jpeg';
        q = 0.9;
        blob = await encodeAt(q);
      }
      if (!blob) throw new Error('TOBLOB_FAIL');

      // é€æ­¥é™å“è³ª
      while (blob.size > maxBytes && q > 0.3) {
        q = Math.max(0.3, q - 0.1);
        const b2 = await encodeAt(q);
        if (!b2) break;
        blob = b2;
      }

      if (blob && blob.size <= maxBytes) break;
      // ä»å¤ªå¤§ï¼šå†ç¸®å°ä¸€æ¬¡å°ºå¯¸é‡è©¦
      targetMaxDim = Math.max(128, Math.floor(targetMaxDim * 0.8));
    }

    if (!blob) throw new Error('TOBLOB_FAIL');
    if (blob.size > maxBytes) throw new Error('TOO_LARGE');

    const ext = outMime === 'image/jpeg' ? 'jpg' : (outMime === 'image/png' ? 'png' : 'webp');
    return { blob, contentType: outMime, ext, width: tw, height: th, bytes: blob.size };
  } finally {
    revokeObjectUrlSafe(imgUrl);
  }
}

async function handleImagePickAndPreview(file, kind) {
  const zhElements = document.querySelectorAll('.lang-zh');
  const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';

  // é™åˆ¶ï¼šåŸå§‹æª”æ¡ˆå¤§å°å¿…é ˆ <= 1MBï¼ˆä½ è¦æ±‚ï¼‰
  const maxInputBytes = 1024 * 1024;
  if (file && typeof file.size === 'number' && file.size > maxInputBytes) {
    const msg = (currentLang === 'zh')
      ? 'åœ–ç‰‡æª”æ¡ˆéå¤§ï¼šè«‹ä¸Šå‚³ 1MB ä»¥å…§çš„åœ–ç‰‡ã€‚'
      : 'Image file is too large. Please upload an image within 1MB.';
    alert(msg);
    return;
  }

  const rules = (kind === 'avatar')
    ? { maxDim: 512, maxBytes: 1024 * 1024, mime: 'image/webp' }
    : { maxDim: 1024, maxBytes: 1024 * 1024, mime: 'image/webp' };

  try {
    const out = await compressImageFile(file, rules);
    window.__uvacoPendingAssets[kind] = { blob: out.blob, contentType: out.contentType, ext: out.ext };
    const url = URL.createObjectURL(out.blob);
    if (kind === 'avatar') {
      const el = document.getElementById('previewAvatar');
      const placeholder = document.getElementById('avatarPlaceholder');
      if (el) {
        el.src = url;
        el.style.display = 'block';
      }
      if (placeholder) placeholder.style.display = 'none';
    } else {
      const el = document.getElementById('previewLogo');
      const placeholder = document.getElementById('logoPlaceholder');
      if (el) {
        el.src = url;
        el.style.display = 'block';
      }
      if (placeholder) placeholder.style.display = 'none';
    }
  } catch (e) {
    const code = String(e && e.message ? e.message : '');
    const msg = (currentLang === 'zh')
      ? (code === 'TOO_LARGE'
          ? 'åœ–ç‰‡å£“ç¸®å¾Œä»è¶…é 1MBï¼šè«‹æ›æ›´å°çš„åœ–ç‰‡æˆ–å…ˆè£åˆ‡å¾Œå†ä¸Šå‚³ã€‚'
          : code === 'NOT_IMAGE'
            ? 'é€™ä¸æ˜¯åœ–ç‰‡æª”ï¼Œè«‹æ”¹é¸æ“‡ JPG/PNG/WebPã€‚'
            : 'åœ–ç‰‡è™•ç†å¤±æ•—ï¼šè«‹æ”¹ç”¨è¼ƒå°çš„åœ–ç‰‡ï¼ˆ1MB ä»¥å…§ï¼‰ï¼Œæˆ–å…ˆè£åˆ‡/é™ä½è§£æåº¦å†ä¸Šå‚³ã€‚')
      : (code === 'TOO_LARGE'
          ? 'The compressed image is still over 1MB. Please crop or use a smaller image.'
          : code === 'NOT_IMAGE'
            ? 'Not an image file. Please choose JPG/PNG/WebP.'
            : 'Image processing failed. Please use a smaller image (within 1MB) or crop it first.');
    alert(msg);
  }
}

// ç·¨è¼¯ LOGO
function editLogo() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.onchange = function(event) {
    const file = event.target.files[0];
    if (file) {
      handleImagePickAndPreview(file, 'logo');
    }
  };
  input.click();
}

// ç·¨è¼¯é ­åƒ
function editAvatar() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.onchange = function(event) {
    const file = event.target.files[0];
    if (file) {
      handleImagePickAndPreview(file, 'avatar');
    }
  };
  input.click();
}

// ç·¨è¼¯è¯çµ¡æ–¹å¼
function editContact(event, type, currentLink) {
  event.preventDefault();
  event.stopPropagation();
  
  const zhElements = document.querySelectorAll('.lang-zh');
  const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';
  
  // è¨­ç½®ç·¨è¼¯æ¨¡å¼
  window.isEditingContact = true;
  window.editingContactInfo = {
    type: type,
    currentLink: currentLink
  };
  
  // é¡¯ç¤ºé€£çµè¼¸å…¥æ¨¡æ…‹æ¡†ï¼Œé å¡«ç•¶å‰é€£çµ
  showLinkInputModal(currentLink, currentLang);
}

// åˆªé™¤è¯çµ¡æ–¹å¼æŒ‰éˆ•
function deleteContactButton(btn) {
  const zhElements = document.querySelectorAll('.lang-zh');
  const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';
  const confirmMsg = currentLang === 'zh' ? 'ç¢ºå®šè¦åˆªé™¤æ­¤è¯çµ¡æ–¹å¼å—ï¼Ÿ' : 'Are you sure you want to delete this contact method?';
  
  if (confirm(confirmMsg)) {
    const anchor = (btn && btn.nodeName === 'A') ? btn : (btn && btn.closest ? btn.closest('a') : null);
    // ä»¥ wrapper ç‚ºå–®ä½åˆªé™¤ï¼ˆé¿å…ç•™ä¸‹ç©ºç™½å®¹å™¨ï¼‰
    const wrapper = anchor ? anchor.closest('.contact-btn-wrapper') : null;
    if (wrapper) {
      wrapper.remove();
      return;
    }
    // fallbackï¼šåˆªé™¤ç›¸åŒé€£çµçš„æ‰€æœ‰ wrapper
    const currentLink = anchor ? anchor.getAttribute('href') : '';
    if (currentLink) {
      document.querySelectorAll(`#previewContacts a[href="${CSS.escape(currentLink)}"]`)
        .forEach(a => a.closest('.contact-btn-wrapper')?.remove());
    }
  }
}

// ===== è¯çµ¡æ–¹å¼é¡¯ç¤ºæ¨£å¼ï¼ˆåˆ—è¡¨ / å°å¡ï¼‰=====
window.__uvacoContactLayout = window.__uvacoContactLayout || (function () {
  try {
    const v = String(localStorage.getItem('UVACO_CONTACT_LAYOUT') || '').toLowerCase();
    return (v === 'grid') ? 'grid' : 'list';
  } catch (e) {
    return 'list';
  }
})();

function applyContactLayout(layout) {
  const group = document.getElementById('previewContacts');
  const listBtn = document.getElementById('contactLayoutListBtn');
  const gridBtn = document.getElementById('contactLayoutGridBtn');
  const mode = (layout === 'grid') ? 'grid' : 'list';

  if (group) {
    group.classList.toggle('contact-layout-grid', mode === 'grid');
  }
  if (listBtn) listBtn.classList.toggle('is-active', mode === 'list');
  if (gridBtn) gridBtn.classList.toggle('is-active', mode === 'grid');
}

function setContactLayout(layout) {
  window.__uvacoContactLayout = (layout === 'grid') ? 'grid' : 'list';
  try { localStorage.setItem('UVACO_CONTACT_LAYOUT', window.__uvacoContactLayout); } catch (e) {}
  applyContactLayout(window.__uvacoContactLayout);
}

// åˆå§‹å¥—ç”¨ä¸€æ¬¡
setTimeout(() => applyContactLayout(window.__uvacoContactLayout), 0);

// æ–°å¢æ¨™èªåˆ°é è¦½
function addSloganToPreview(lang) {
  // è‹¥ç›®å‰èªç³»èˆ‡è¦æ–°å¢çš„èªç³»ä¸åŒï¼Œæ–°å¢å¾Œæœƒè¢« setLang() éš±è—ï¼ˆé€ æˆã€Œé»äº†æ²’å‡ºç¾ã€çš„éŒ¯è¦ºï¼‰ã€‚
  // å› æ­¤é€™è£¡è‡ªå‹•åˆ‡æ›åˆ°å°æ‡‰èªç³»ï¼Œä¸¦æŠŠæ¸¸æ¨™èšç„¦åˆ°æ–°æ¨™èªã€‚
  const getCurrentLang = () => {
    const zhElements = document.querySelectorAll('.lang-zh');
    return (zhElements.length > 0 && zhElements[0].style.display !== 'none') ? 'zh' : 'en';
  };

  const containerId = lang === 'zh' ? 'previewSlogansZh' : 'previewSlogansEn';
  const container = document.getElementById(containerId);
  if (!container) return;

  const sloganItem = document.createElement('div');
  sloganItem.className = 'slogan-item';
  
  const tagline = document.createElement('div');
  tagline.className = `tagline lang-${lang} edit-clickable`;
  tagline.contentEditable = 'true';
  tagline.textContent = lang === 'zh' ? 'æ–°æ¨™èª' : 'New Slogan';
  tagline.onblur = function() { updateSlogansPreview(); };
  tagline.onclick = function() { focusEdit(this); };
  
  const deleteBtn = document.createElement('button');
  deleteBtn.className = 'slogan-delete-btn';
  deleteBtn.textContent = 'âœ•';
  deleteBtn.title = lang === 'zh' ? 'åˆªé™¤æ¨™èª' : 'Delete slogan';
  deleteBtn.onclick = function(event) {
    event.stopPropagation();
    deleteSloganFromPreview(this);
  };
  
  // çµ„è£ä¸¦åŠ å…¥
  sloganItem.appendChild(tagline);
  sloganItem.appendChild(deleteBtn);
  container.appendChild(sloganItem);

  // åŒæ­¥æ•´ç†ï¼ˆé¿å…ç©ºç™½è¢«æ¸…æ‰ã€ç¢ºä¿äº‹ä»¶å­˜åœ¨ï¼‰
  updateSlogansPreview();

  // ä¸è‡ªå‹•åˆ‡æ›èªç³»ï¼ˆä¿æŒä»‹é¢èªè¨€ä¸è®Šï¼‰ï¼Œåƒ…èšç„¦åˆ°æ–°æ¨™èª
  setTimeout(() => {
    try { sloganItem.scrollIntoView({ block: 'center', behavior: 'smooth' }); } catch (e) {}
    try { focusEdit(tagline); } catch (e) { try { tagline.focus(); } catch (_e) {} }
  }, 0);

  return;

  // ä¸‹é¢åŸæœ¬çš„ append è‹¥å­˜åœ¨ï¼Œä¿ç•™ä½†ä¸æœƒèµ°åˆ°ï¼ˆé¿å…é‡è¤‡ appendï¼‰
  sloganItem.appendChild(tagline);
  sloganItem.appendChild(deleteBtn);
  container.appendChild(sloganItem);
  
  tagline.focus();
  focusEdit(tagline);
}

// å¾é è¦½åˆªé™¤æ¨™èª
function deleteSloganFromPreview(btn) {
  if (!btn) return;
  const zhElements = document.querySelectorAll('.lang-zh');
  const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';
  const confirmMsg = currentLang === 'zh' ? 'ç¢ºå®šè¦åˆªé™¤æ­¤æ¨™èªå—ï¼Ÿ' : 'Are you sure you want to delete this slogan?';
  
  if (confirm(confirmMsg)) {
    const item = btn.closest('.slogan-item');
    if (item) {
      item.remove();
      // è§¸ç™¼æ›´æ–°ä»¥ç¢ºä¿è³‡æ–™åŒæ­¥
      if (typeof updateCompanyFromSlogans === 'function') {
        updateCompanyFromSlogans();
      }
    }
  }
}

// é¡¯ç¤ºè¯çµ¡æ–¹å¼é¡å‹é¸æ“‡å½ˆå‡ºè¦–çª—
function addContact(event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  const overlay = document.getElementById('contactTypeOverlay');
  if (overlay) {
    overlay.classList.add('show');
    overlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    console.log('Contact type overlay shown');
  } else {
    console.error('contactTypeOverlay element not found');
  }
}

// é—œé–‰è¯çµ¡æ–¹å¼é¡å‹é¸æ“‡å½ˆå‡ºè¦–çª—
function closeContactTypeModal(event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  
  const overlay = document.getElementById('contactTypeOverlay');
  if (!overlay) return;
  
  // å¦‚æœé»æ“Šçš„æ˜¯å–æ¶ˆæŒ‰éˆ•ï¼Œç›´æ¥é—œé–‰
  if (event && event.target && event.target.classList.contains('contact-type-cancel')) {
    overlay.classList.remove('show');
    overlay.style.display = 'none';
    document.body.style.overflow = '';
    return;
  }
  
  // å¦‚æœé»æ“Šçš„æ˜¯ overlay èƒŒæ™¯ï¼ˆä¸æ˜¯ modal å…§éƒ¨ï¼‰ï¼Œå‰‡é—œé–‰
  if (event && event.target && event.target.id === 'contactTypeOverlay') {
    overlay.classList.remove('show');
    overlay.style.display = 'none';
    document.body.style.overflow = '';
  }
}

// ç²å–è¯çµ¡æ–¹å¼åœ–ç¤º
function getContactIcon(type) {
  const icons = {
    'company-phone': '<img src="phone-icon.svg" alt="Phone" class="btn-icon-phone">',
    'personal-phone': '<img src="mobile-icon.svg" alt="Mobile" class="btn-icon-mobile">',
    'email': '<img src="email-icon.svg" alt="Email" class="btn-icon-email">',
    'website': '<img src="website-icon.svg" alt="Website" class="btn-icon-website">',
    'line': '<img src="line-logo.svg" alt="LINE" class="btn-icon-line">',
    'official-line': '<img src="line-logo.svg" alt="LINE" class="btn-icon-line">',
    'facebook': '<img src="facebook-logo.svg" alt="Facebook" class="btn-icon-facebook">',
    'instagram': '<img src="instagram-logo.svg" alt="Instagram" class="btn-icon-instagram">',
    'linkedin': '<img src="linkedin-logo.svg" alt="LinkedIn" class="btn-icon-linkedin">',
    'twitter': '<img src="twitter-logo.svg" alt="X" class="btn-icon-twitter">',
    'youtube': '<img src="youtube-logo.svg" alt="YouTube" class="btn-icon-youtube">',
    'wechat': '<img src="wechat-logo.svg" alt="WeChat" class="btn-icon-wechat">',
    'whatsapp': '<img src="whatsapp-logo.svg" alt="WhatsApp" class="btn-icon-whatsapp">',
    'call': '<img src="phone-icon.svg" alt="Phone" class="btn-icon-phone">',
    'vcf': '<img src="file-icon.svg" alt="VCF" class="btn-icon-file">',
    'other': 'â•'
  };
  return icons[type] || 'ğŸ“‹';
}

// é¸æ“‡è¯çµ¡æ–¹å¼é¡å‹
function selectContactType(type, labelZh, labelEn) {
  // é—œé–‰é¡å‹é¸æ“‡å½ˆå‡ºè¦–çª—
  const typeOverlay = document.getElementById('contactTypeOverlay');
  if (typeOverlay) {
    typeOverlay.classList.remove('show');
    typeOverlay.style.display = 'none';
  }
  
  const zhElements = document.querySelectorAll('.lang-zh');
  const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';
  
  // å…¶ä»–ï¼šå…è¨±è‡ªè¨‚ã€Œç¨®é¡åç¨±ã€
  if (type === 'other') {
    window.pendingCustomType = {
      type: 'other',
      labelZh: labelZh || 'å…¶ä»–',
      labelEn: labelEn || 'Other'
    };
    showCustomTypeModal();
    return;
  }

  // æ ¹æ“šé¡å‹è¨­å®šé è¨­é€£çµæ ¼å¼å’Œæ¨™ç±¤
  let defaultLink = '';
  let buttonTextZh = '';
  let buttonTextEn = '';
  let placeholderText = '';
  
  switch(type) {
    case 'company-phone':
      defaultLink = '';
      placeholderText = 'ä¾‹ï¼š02-12345678';
      buttonTextZh = '<img src="phone-icon.svg" alt="Phone" class="btn-icon-phone"> å…¬å¸é›»è©±';
      buttonTextEn = '<img src="phone-icon.svg" alt="Phone" class="btn-icon-phone"> Company Phone';
      break;
    case 'personal-phone':
      defaultLink = '';
      placeholderText = 'ä¾‹ï¼š0912345678';
      buttonTextZh = '<img src="mobile-icon.svg" alt="Mobile" class="btn-icon-mobile"> å€‹äººé›»è©±';
      buttonTextEn = '<img src="mobile-icon.svg" alt="Mobile" class="btn-icon-mobile"> Personal Phone';
      break;
    case 'call':
      defaultLink = '';
      placeholderText = 'ä¾‹ï¼š0912345678';
      buttonTextZh = '<img src="phone-icon.svg" alt="Phone" class="btn-icon-phone"> ç«‹å³ä¾†é›»';
      buttonTextEn = '<img src="phone-icon.svg" alt="Phone" class="btn-icon-phone"> Call Now';
      break;
    case 'email':
      defaultLink = '';
      placeholderText = 'ä¾‹ï¼šyourname@example.com';
      buttonTextZh = '<img src="email-icon.svg" alt="Email" class="btn-icon-email"> å¯„é€ Email';
      buttonTextEn = '<img src="email-icon.svg" alt="Email" class="btn-icon-email"> Send Email';
      break;
    case 'website':
      defaultLink = '';
      placeholderText = 'ä¾‹ï¼šwww.example.com';
      buttonTextZh = '<img src="website-icon.svg" alt="Website" class="btn-icon-website"> ç¶²ç«™';
      buttonTextEn = '<img src="website-icon.svg" alt="Website" class="btn-icon-website"> Website';
      break;
    case 'line':
    case 'official-line':
      defaultLink = '';
      placeholderText = 'ä¾‹ï¼šhttps://line.me/R/ti/p/xxxxx';
      buttonTextZh = '<img src="line-logo.svg" alt="LINE" class="btn-icon-line"> LINE';
      buttonTextEn = '<img src="line-logo.svg" alt="LINE" class="btn-icon-line"> LINE';
      break;
    case 'facebook':
      defaultLink = '';
      placeholderText = 'ä¾‹ï¼šfacebook.com/yourpage';
      buttonTextZh = '<img src="facebook-logo.svg" alt="Facebook" class="btn-icon-facebook"> Facebook';
      buttonTextEn = '<img src="facebook-logo.svg" alt="Facebook" class="btn-icon-facebook"> Facebook';
      break;
    case 'instagram':
      defaultLink = '';
      placeholderText = 'ä¾‹ï¼š@yourusername æˆ– instagram.com/yourusername';
      buttonTextZh = '<img src="instagram-logo.svg" alt="Instagram" class="btn-icon-instagram"> Instagram';
      buttonTextEn = '<img src="instagram-logo.svg" alt="Instagram" class="btn-icon-instagram"> Instagram';
      break;
    case 'linkedin':
      defaultLink = '';
      placeholderText = 'ä¾‹ï¼šlinkedin.com/in/yourprofile';
      buttonTextZh = '<img src="linkedin-logo.svg" alt="LinkedIn" class="btn-icon-linkedin"> LinkedIn';
      buttonTextEn = '<img src="linkedin-logo.svg" alt="LinkedIn" class="btn-icon-linkedin"> LinkedIn';
      break;
    case 'twitter':
      defaultLink = '';
      placeholderText = 'ä¾‹ï¼š@yourusername æˆ– x.com/yourusername';
      buttonTextZh = '<img src="twitter-logo.svg" alt="X" class="btn-icon-twitter"> X (Twitter)';
      buttonTextEn = '<img src="twitter-logo.svg" alt="X" class="btn-icon-twitter"> X (Twitter)';
      break;
    case 'youtube':
      defaultLink = '';
      placeholderText = 'ä¾‹ï¼šyoutube.com/@yourchannel';
      buttonTextZh = '<img src="youtube-logo.svg" alt="YouTube" class="btn-icon-youtube"> YouTube';
      buttonTextEn = '<img src="youtube-logo.svg" alt="YouTube" class="btn-icon-youtube"> YouTube';
      break;
    case 'wechat':
      defaultLink = '';
      placeholderText = 'ä¾‹ï¼šyour_wechat_id';
      buttonTextZh = '<img src="wechat-logo.svg" alt="WeChat" class="btn-icon-wechat"> å¾®ä¿¡';
      buttonTextEn = '<img src="wechat-logo.svg" alt="WeChat" class="btn-icon-wechat"> WeChat';
      break;
    case 'whatsapp':
      defaultLink = '';
      placeholderText = 'ä¾‹ï¼š+886912345678';
      buttonTextZh = '<img src="whatsapp-logo.svg" alt="WhatsApp" class="btn-icon-whatsapp"> WhatsApp';
      buttonTextEn = '<img src="whatsapp-logo.svg" alt="WhatsApp" class="btn-icon-whatsapp"> WhatsApp';
      break;
    case 'vcf':
      defaultLink = '';
      placeholderText = 'ä¾‹ï¼šcontact.vcf';
      buttonTextZh = '<img src="file-icon.svg" alt="VCF" class="btn-icon-file"> å„²å­˜åˆ°é€šè¨ŠéŒ„ï¼ˆVCFï¼‰';
      buttonTextEn = '<img src="file-icon.svg" alt="VCF" class="btn-icon-file"> Save Contact (VCF)';
      break;
    default:
      defaultLink = '';
      placeholderText = '';
      buttonTextZh = 'ğŸ”— ' + labelZh;
      buttonTextEn = 'ğŸ”— ' + labelEn;
  }
  
  // ä¿å­˜ç•¶å‰é¸æ“‡çš„é¡å‹ä¿¡æ¯ï¼Œç”¨æ–¼å¾ŒçºŒè™•ç†
  window.currentContactType = {
    type: type,
    labelZh: labelZh,
    labelEn: labelEn,
    defaultLink: defaultLink,
    buttonTextZh: buttonTextZh,
    buttonTextEn: buttonTextEn,
    placeholder: placeholderText
  };
  
  // ç«‹å³é¡¯ç¤ºé€£çµè¼¸å…¥æ¨¡æ…‹æ¡†ï¼ˆä¸é—œé–‰ body overflowï¼Œå› ç‚ºæ¨¡æ…‹æ¡†æœƒä¿æŒï¼‰
  setTimeout(() => {
    showLinkInputModal(defaultLink, currentLang);
  }, 100);
}

// ===== è‡ªè¨‚ã€Œå…¶ä»–ã€é¡å‹ =====
function showCustomTypeModal() {
  const overlay = document.getElementById('customTypeOverlay');
  if (!overlay) return;

  // æ¸…ç©º / é å¡«
  const zh = document.getElementById('customTypeZh');
  const en = document.getElementById('customTypeEn');
  if (zh) zh.value = '';
  if (en) en.value = '';

  overlay.classList.add('show');
  document.body.style.overflow = 'hidden';
  setTimeout(() => {
    if (zh) zh.focus();
  }, 50);
}

function closeCustomTypeModal(event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  const overlay = document.getElementById('customTypeOverlay');
  if (overlay) {
    overlay.classList.remove('show');
  }
  document.body.style.overflow = '';
  window.pendingCustomType = null;
}

function submitCustomType(event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  const zhEl = document.getElementById('customTypeZh');
  const enEl = document.getElementById('customTypeEn');
  const zhName = (zhEl?.value || '').trim();
  const enName = (enEl?.value || '').trim();

  const zhElements = document.querySelectorAll('.lang-zh');
  const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';

  if (!zhName && !enName) {
    alert(currentLang === 'zh' ? 'è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹åç¨±' : 'Please enter at least one name');
    return;
  }

  // è‹¥åªå¡«ä¸€ç¨®èªè¨€ï¼Œå¦ä¸€ç¨®è‡ªå‹•ç”¨åŒä¸€å€‹åç¨±
  const finalZh = zhName || enName;
  const finalEn = enName || zhName;

  // ç”¨ä¸»é¡Œ accent çš„ icon + è‡ªè¨‚æ–‡å­—
  const icon = getContactIcon('other');
  const buttonTextZh = `${icon} ${finalZh}`;
  const buttonTextEn = `${icon} ${finalEn}`;

  // è¨­å®šç‚ºæ–°å¢æ¨¡å¼ï¼Œä¸‹ä¸€æ­¥è¼¸å…¥é€£çµ
  window.currentContactType = {
    type: 'other',
    labelZh: finalZh,
    labelEn: finalEn,
    defaultLink: '',
    buttonTextZh,
    buttonTextEn
  };

  closeCustomTypeModal();

  // é€²å…¥é€£çµè¼¸å…¥æµç¨‹
  showLinkInputModal('', currentLang);
}

// é¡¯ç¤ºé€£çµè¼¸å…¥æ¨¡æ…‹æ¡†
function showLinkInputModal(defaultLink, currentLang) {
  const overlay = document.getElementById('linkInputOverlay');
  const inputField = document.getElementById('linkInputField');
  const help = document.getElementById('linkInputHelp');
  
  if (overlay && inputField) {
    inputField.value = defaultLink || '';
    // ä½¿ç”¨ currentContactType ä¸­çš„ placeholderï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨é è¨­å€¼
    const customPlaceholder = window.currentContactType && window.currentContactType.placeholder;
    inputField.placeholder = customPlaceholder || (currentLang === 'zh' ? 'è«‹è¼¸å…¥é€£çµ' : 'Please enter link');
    // é‡ç½®æäº¤æ¨™è¨˜ï¼ˆåŒ…æ‹¬å…¨å±€æ¨™è¨˜ï¼‰
    inputField.dataset.submitted = 'false';
    window.isSubmittingLink = false;
    overlay.classList.add('show');
    overlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    // ç¯„ä¾‹/èªªæ˜ï¼ˆAï¼‰
    if (help) {
      const t = window.isEditingContact && window.editingContactInfo ? window.editingContactInfo.type : (window.currentContactType ? window.currentContactType.type : '');
      let zh = 'è«‹è¼¸å…¥å®Œæ•´é€£çµï¼ˆåŒ…å« https://ï¼‰ã€‚';
      let en = 'Please enter a full link (including https://).';
      if (t === 'line') {
        zh = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸ“± å¦‚ä½•å–å¾— LINE å€‹äººé€£çµï¼š</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> é–‹å•Ÿ LINE App â†’ é»æ“Šã€Œä¸»é ã€</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> é»æ“Šå³ä¸Šè§’ã€Œè¨­å®šã€âš™ï¸</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">3</span> é»æ“Šã€Œå€‹äººæª”æ¡ˆã€</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">4</span> é»æ“Šã€Œé¡¯ç¤ºè¡Œå‹•æ¢ç¢¼ã€</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">5</span> é»æ“Šã€Œåˆ†äº«ã€â†’ã€Œè¤‡è£½é€£çµã€</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">é€£çµæ ¼å¼ç¯„ä¾‹ï¼š</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">https://line.me/ti/p/7QENOpjTy5</code>
          </div>
        </div>`;
        en = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸ“± How to get your LINE link:</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> Open LINE App â†’ Tap "Home"</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> Tap "Settings" âš™ï¸ (top right)</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">3</span> Tap "Profile"</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">4</span> Tap "Show QR Code"</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">5</span> Tap "Share" â†’ "Copy Link"</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">Link format example:</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">https://line.me/ti/p/7QENOpjTy5</code>
          </div>
        </div>`;
      } else if (t === 'official-line') {
        zh = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸ“± å¦‚ä½•å–å¾— LINE å®˜æ–¹å¸³è™Ÿé€£çµï¼š</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> ç™»å…¥ LINE Official Account Manager</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> é¸æ“‡æ‚¨çš„å®˜æ–¹å¸³è™Ÿ</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">3</span> é»æ“Šã€ŒåŠ å…¥å¥½å‹ã€â†’ã€Œåˆ†äº«é€£çµã€</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">4</span> è¤‡è£½ URL é€£çµ</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">é€£çµæ ¼å¼ç¯„ä¾‹ï¼š</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">https://line.me/R/ti/p/@yourid</code>
          </div>
        </div>`;
        en = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸ“± How to get LINE Official Account link:</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> Login to LINE Official Account Manager</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> Select your official account</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">3</span> Click "Add Friends" â†’ "Share Link"</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">4</span> Copy the URL link</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">Link format example:</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">https://line.me/R/ti/p/@yourid</code>
          </div>
        </div>`;
      } else if (t === 'email') {
        zh = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">âœ‰ï¸ å¦‚ä½•è¼¸å…¥ Emailï¼š</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> ç›´æ¥è¼¸å…¥æ‚¨çš„ Email åœ°å€</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> ç³»çµ±æœƒè‡ªå‹•åŠ ä¸Š mailto: å‰ç¶´</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">è¼¸å…¥æ ¼å¼ç¯„ä¾‹ï¼š</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">yourname@example.com</code>
          </div>
        </div>`;
        en = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">âœ‰ï¸ How to enter Email:</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> Enter your email address directly</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> System will auto-add mailto: prefix</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">Input format example:</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">yourname@example.com</code>
          </div>
        </div>`;
      } else if (t === 'company-phone' || t === 'personal-phone' || t === 'call') {
        zh = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸ“ å¦‚ä½•è¼¸å…¥é›»è©±è™Ÿç¢¼ï¼š</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> ç›´æ¥è¼¸å…¥é›»è©±è™Ÿç¢¼ï¼ˆå¯åŒ…å« - åˆ†éš”ï¼‰</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> ç³»çµ±æœƒè‡ªå‹•åŠ ä¸Š tel: å‰ç¶´</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">è¼¸å…¥æ ¼å¼ç¯„ä¾‹ï¼š</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">0912-345-678 æˆ– 02-1234-5678</code>
          </div>
        </div>`;
        en = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸ“ How to enter phone number:</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> Enter phone number directly (can include - separator)</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> System will auto-add tel: prefix</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">Input format example:</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">0912-345-678 or +886-2-1234-5678</code>
          </div>
        </div>`;
      } else if (t === 'website') {
        zh = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸŒ å¦‚ä½•è¼¸å…¥ç¶²ç«™é€£çµï¼š</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> è¼¸å…¥å®Œæ•´ç¶²å€ï¼ˆéœ€åŒ…å« https://ï¼‰</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> å¯å¾ç€è¦½å™¨ç¶²å€åˆ—è¤‡è£½</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">é€£çµæ ¼å¼ç¯„ä¾‹ï¼š</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">https://www.example.com</code>
          </div>
        </div>`;
        en = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸŒ How to enter website link:</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> Enter full URL (must include https://)</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> You can copy from browser address bar</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">Link format example:</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">https://www.example.com</code>
          </div>
        </div>`;
      } else if (t === 'facebook') {
        zh = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸ“˜ å¦‚ä½•å–å¾— Facebook å€‹äººé€£çµï¼š</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> é–‹å•Ÿ Facebook App æˆ–ç¶²é ç‰ˆ</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> é»æ“Šæ‚¨çš„å€‹äººæª”æ¡ˆé ­åƒ</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">3</span> é»æ“Šã€Œ...ã€â†’ã€Œè¤‡è£½é€£çµã€</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">é€£çµæ ¼å¼ç¯„ä¾‹ï¼š</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">https://www.facebook.com/yourname</code>
          </div>
        </div>`;
        en = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸ“˜ How to get your Facebook link:</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> Open Facebook App or website</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> Tap your profile picture</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">3</span> Tap "..." â†’ "Copy Link"</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">Link format example:</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">https://www.facebook.com/yourname</code>
          </div>
        </div>`;
      } else if (t === 'instagram') {
        zh = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸ“¸ å¦‚ä½•å–å¾— Instagram å€‹äººé€£çµï¼š</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> é–‹å•Ÿ Instagram App</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> é»æ“Šå³ä¸‹è§’ã€Œå€‹äººæª”æ¡ˆã€</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">3</span> é»æ“Šå³ä¸Šè§’ã€Œâ‰¡ã€â†’ã€ŒQR åœ–ç¢¼ã€</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">4</span> é»æ“Šã€Œåˆ†äº«ã€â†’ã€Œè¤‡è£½é€£çµã€</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">é€£çµæ ¼å¼ç¯„ä¾‹ï¼š</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">https://www.instagram.com/yourname</code>
          </div>
        </div>`;
        en = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸ“¸ How to get your Instagram link:</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> Open Instagram App</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> Tap "Profile" (bottom right)</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">3</span> Tap "â‰¡" â†’ "QR Code" (top right)</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">4</span> Tap "Share" â†’ "Copy Link"</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">Link format example:</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">https://www.instagram.com/yourname</code>
          </div>
        </div>`;
      } else if (t === 'linkedin') {
        zh = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸ’¼ å¦‚ä½•å–å¾— LinkedIn å€‹äººé€£çµï¼š</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> é–‹å•Ÿ LinkedIn App æˆ–ç¶²é ç‰ˆ</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> é»æ“Šã€Œæˆ‘ã€â†’ã€ŒæŸ¥çœ‹å€‹äººæª”æ¡ˆã€</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">3</span> é»æ“Šã€Œ...ã€â†’ã€Œåˆ†äº«å€‹äººæª”æ¡ˆã€â†’ã€Œè¤‡è£½ã€</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">é€£çµæ ¼å¼ç¯„ä¾‹ï¼š</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">https://www.linkedin.com/in/yourname</code>
          </div>
        </div>`;
        en = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸ’¼ How to get your LinkedIn link:</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> Open LinkedIn App or website</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> Tap "Me" â†’ "View Profile"</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">3</span> Tap "..." â†’ "Share Profile" â†’ "Copy"</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">Link format example:</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">https://www.linkedin.com/in/yourname</code>
          </div>
        </div>`;
      } else if (t === 'twitter') {
        zh = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸ¦ å¦‚ä½•å–å¾— X (Twitter) å€‹äººé€£çµï¼š</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> é–‹å•Ÿ X (Twitter) App</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> é»æ“Šå·¦ä¸Šè§’é ­åƒ â†’ ã€Œå€‹äººæª”æ¡ˆã€</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">3</span> é»æ“Šã€Œåˆ†äº«ã€â†’ã€Œè¤‡è£½é€£çµã€</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">é€£çµæ ¼å¼ç¯„ä¾‹ï¼š</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">https://twitter.com/yourname</code>
          </div>
        </div>`;
        en = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸ¦ How to get your X (Twitter) link:</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> Open X (Twitter) App</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> Tap profile icon (top left) â†’ "Profile"</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">3</span> Tap "Share" â†’ "Copy Link"</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">Link format example:</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">https://twitter.com/yourname</code>
          </div>
        </div>`;
      } else if (t === 'youtube') {
        zh = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸ¬ å¦‚ä½•å–å¾— YouTube é »é“é€£çµï¼š</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> é–‹å•Ÿ YouTube App æˆ–ç¶²é ç‰ˆ</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> é»æ“Šå³ä¸‹è§’ã€Œæ‚¨ã€â†’ã€ŒæŸ¥çœ‹é »é“ã€</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">3</span> é»æ“Šã€Œ...ã€â†’ã€Œåˆ†äº«ã€â†’ã€Œè¤‡è£½é€£çµã€</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">é€£çµæ ¼å¼ç¯„ä¾‹ï¼š</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">https://www.youtube.com/@yourchannel</code>
          </div>
        </div>`;
        en = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸ¬ How to get your YouTube channel link:</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> Open YouTube App or website</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> Tap "You" (bottom right) â†’ "View Channel"</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">3</span> Tap "..." â†’ "Share" â†’ "Copy Link"</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">Link format example:</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">https://www.youtube.com/@yourchannel</code>
          </div>
        </div>`;
      } else if (t === 'wechat') {
        zh = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸ’¬ å¦‚ä½•è¼¸å…¥å¾®ä¿¡ IDï¼š</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> é–‹å•Ÿå¾®ä¿¡ App</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> é»æ“Šã€Œæˆ‘ã€â†’ æŸ¥çœ‹å¾®ä¿¡è™Ÿ</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">3</span> ç›´æ¥è¼¸å…¥æ‚¨çš„å¾®ä¿¡è™Ÿ</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">è¼¸å…¥æ ¼å¼ç¯„ä¾‹ï¼š</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">your_wechat_id</code>
          </div>
        </div>`;
        en = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸ’¬ How to enter WeChat ID:</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> Open WeChat App</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> Tap "Me" â†’ View WeChat ID</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">3</span> Enter your WeChat ID directly</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">Input format example:</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">your_wechat_id</code>
          </div>
        </div>`;
      } else if (t === 'whatsapp') {
        zh = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸ“± å¦‚ä½•è¼¸å…¥ WhatsApp è™Ÿç¢¼ï¼š</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> è¼¸å…¥åœ‹éš›æ ¼å¼é›»è©±è™Ÿç¢¼</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> å°ç£è™Ÿç¢¼ï¼š+886 é–‹é ­ï¼Œå»æ‰ç¬¬ä¸€å€‹ 0</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">3</span> ä¾‹ï¼š0912345678 â†’ +886912345678</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">é€£çµæ ¼å¼ç¯„ä¾‹ï¼š</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">https://wa.me/886912345678</code>
          </div>
        </div>`;
        en = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸ“± How to enter WhatsApp number:</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> Enter phone number in international format</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> Include country code (e.g., +1 for US)</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">3</span> No spaces or dashes needed</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">Link format example:</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">https://wa.me/886912345678</code>
          </div>
        </div>`;
      } else if (t === 'other') {
        zh = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸ”— å¦‚ä½•è¼¸å…¥è‡ªè¨‚é€£çµï¼š</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> è¼¸å…¥å®Œæ•´ç¶²å€ï¼ˆéœ€åŒ…å« https://ï¼‰</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> å¯ä»¥æ˜¯ä»»ä½•ç¶²ç«™æˆ–æœå‹™çš„é€£çµ</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">é€£çµæ ¼å¼ç¯„ä¾‹ï¼š</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">https://example.com/yourpage</code>
          </div>
        </div>`;
        en = `<div style="text-align:left;">
          <div style="font-weight:600;color:var(--uvaco-green);margin-bottom:10px;">ğŸ”— How to enter custom link:</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">1</span> Enter full URL (must include https://)</div>
            <div style="display:flex;align-items:center;gap:8px;"><span style="width:20px;height:20px;min-width:20px;border-radius:50%;background:var(--uvaco-green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">2</span> Can be any website or service link</div>
          </div>
          <div style="padding:10px;background:rgba(0,200,83,0.1);border-radius:8px;">
            <div style="font-size:11px;opacity:0.8;margin-bottom:4px;">Link format example:</div>
            <code style="color:var(--uvaco-green);word-break:break-all;">https://example.com/yourpage</code>
          </div>
        </div>`;
      }
      help.querySelector('.lang-zh').innerHTML = zh;
      help.querySelector('.lang-en').innerHTML = en;
    }

    // èšç„¦è¼¸å…¥æ¡†
    setTimeout(() => {
      inputField.focus();
      inputField.select();
    }, 100);
  }
}

// é—œé–‰é€£çµè¼¸å…¥æ¨¡æ…‹æ¡†
function closeLinkInputModal(event) {
  if (event && event.target && event.target.closest('.link-input-modal') && !event.target.classList.contains('link-input-cancel')) {
    return;
  }
  
  const overlay = document.getElementById('linkInputOverlay');
  if (overlay) {
    overlay.classList.remove('show');
    overlay.style.display = 'none';
    document.body.style.overflow = '';
  }
  
  // æ¸…é™¤ä¿å­˜çš„é¡å‹ä¿¡æ¯å’Œæäº¤æ¨™è¨˜
  window.currentContactType = null;
  window.isSubmittingLink = false;
  window.isEditingContact = false;
  window.editingContactInfo = null;
  const inputField = document.getElementById('linkInputField');
  if (inputField) {
    inputField.dataset.submitted = 'false';
  }
}

// æäº¤é€£çµè¼¸å…¥
function submitLinkInput(event) {
  // é˜²æ­¢é‡è¤‡æäº¤ - ç«‹å³æª¢æŸ¥å…¨å±€æ¨™è¨˜
  if (window.isSubmittingLink) {
    console.log('Already submitting, ignoring duplicate call');
    return;
  }
  
  // é˜²æ­¢é‡è¤‡æäº¤
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  
  const inputField = document.getElementById('linkInputField');
  
  // æª¢æŸ¥æ˜¯å¦å·²ç¶“æäº¤éï¼ˆé˜²æ­¢é‡è¤‡æäº¤ï¼‰
  if (inputField.dataset.submitted === 'true') {
    console.log('Already submitted, ignoring duplicate call');
    return;
  }
  
  // ç«‹å³è¨­ç½®å…¨å±€æ¨™è¨˜å’Œæœ¬åœ°æ¨™è¨˜ï¼Œé˜²æ­¢é‡è¤‡æäº¤
  window.isSubmittingLink = true;
  inputField.dataset.submitted = 'true';
  
  let newLink = inputField.value.trim();

  // é˜²å‘†/é©—è­‰ï¼ˆBï¼‰ï¼šä¾é¡å‹æª¢æŸ¥åŸºæœ¬æ ¼å¼ï¼Œé¿å…å®¢äººå¡«éŒ¯
  const t = window.isEditingContact && window.editingContactInfo ? window.editingContactInfo.type : (window.currentContactType ? window.currentContactType.type : '');
  const zhElements = document.querySelectorAll('.lang-zh');
  const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';

  function fail(msgZh, msgEn) {
    alert(currentLang === 'zh' ? msgZh : msgEn);
    window.isSubmittingLink = false;
    inputField.dataset.submitted = 'false';
    return true;
  }

  // ===== è‡ªå‹•æ·»åŠ å‰ç¶´ =====
  
  // Emailï¼šè‡ªå‹•æ·»åŠ  mailto:
  if (t === 'email') {
    if (!/^mailto:/i.test(newLink)) {
      // é©—è­‰æ˜¯å¦ç‚ºæœ‰æ•ˆçš„ email æ ¼å¼
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(newLink)) {
        if (fail('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email åœ°å€ï¼Œä¾‹å¦‚ï¼šyourname@example.com', 'Please enter a valid email address, e.g. yourname@example.com')) return;
      }
      newLink = 'mailto:' + newLink;
    }
  }

  // é›»è©±ï¼šè‡ªå‹•æ·»åŠ  tel:
  if (t === 'company-phone' || t === 'personal-phone' || t === 'call') {
    if (!/^tel:/i.test(newLink)) {
      // ç§»é™¤å¸¸è¦‹çš„æ ¼å¼å­—ç¬¦ï¼Œä¿ç•™æ•¸å­—å’Œ + è™Ÿ
      const cleanedPhone = newLink.replace(/[\s\-\(\)]/g, '');
      if (!/^[\+]?[0-9]{6,15}$/.test(cleanedPhone)) {
        if (fail('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»è©±è™Ÿç¢¼ï¼Œä¾‹å¦‚ï¼š0912345678 æˆ– +886912345678', 'Please enter a valid phone number, e.g. 0912345678 or +886912345678')) return;
      }
      newLink = 'tel:' + cleanedPhone;
    }
  }

  // ç¶²ç«™ï¼šè‡ªå‹•æ·»åŠ  https://
  if (t === 'website') {
    if (!/^https?:\/\//i.test(newLink)) {
      // å¦‚æœæ²’æœ‰å”è­°ï¼Œè‡ªå‹•åŠ ä¸Š https://
      newLink = 'https://' + newLink;
    }
  }

  // LINEï¼šé©—è­‰å¿…é ˆæ˜¯å®Œæ•´é€£çµ
  if (t === 'line' || t === 'official-line') {
    const v = newLink.trim();
    if (!/^https?:\/\//i.test(v) || !/line\.me\//i.test(v)) {
      if (fail(
        'LINE è«‹è²¼ã€Œåˆ†äº«é€£çµã€ï¼Œä¾‹å¦‚ï¼šhttps://line.me/R/ti/p/2sSjJ_o6OT\nï¼ˆè«‹åˆ° LINE å€‹äººæª”æ¡ˆ â†’ åˆ†äº« â†’ è¤‡è£½é€£çµï¼‰',
        'Please paste a LINE share link, e.g. https://line.me/R/ti/p/2sSjJ_o6OT'
      )) return;
    }
  }
  
  // Facebookï¼šè‡ªå‹•æ·»åŠ  https://
  if (t === 'facebook') {
    if (!/^https?:\/\//i.test(newLink)) {
      newLink = 'https://' + newLink;
    }
  }
  
  // Instagramï¼šè‡ªå‹•æ·»åŠ  https://
  if (t === 'instagram') {
    if (!/^https?:\/\//i.test(newLink)) {
      // å¦‚æœåªè¼¸å…¥ç”¨æˆ¶åï¼Œè‡ªå‹•çµ„åˆå®Œæ•´é€£çµ
      if (!newLink.includes('instagram.com')) {
        newLink = 'https://www.instagram.com/' + newLink.replace(/^@/, '');
      } else {
        newLink = 'https://' + newLink;
      }
    }
  }
  
  // LinkedInï¼šè‡ªå‹•æ·»åŠ  https://
  if (t === 'linkedin') {
    if (!/^https?:\/\//i.test(newLink)) {
      newLink = 'https://' + newLink;
    }
  }
  
  // Twitter/Xï¼šè‡ªå‹•æ·»åŠ  https://
  if (t === 'twitter') {
    if (!/^https?:\/\//i.test(newLink)) {
      // å¦‚æœåªè¼¸å…¥ç”¨æˆ¶åï¼Œè‡ªå‹•çµ„åˆå®Œæ•´é€£çµ
      if (!newLink.includes('twitter.com') && !newLink.includes('x.com')) {
        newLink = 'https://x.com/' + newLink.replace(/^@/, '');
      } else {
        newLink = 'https://' + newLink;
      }
    }
  }
  
  // YouTubeï¼šè‡ªå‹•æ·»åŠ  https://
  if (t === 'youtube') {
    if (!/^https?:\/\//i.test(newLink)) {
      newLink = 'https://' + newLink;
    }
  }
  
  // WeChatï¼šä¿æŒåŸæ¨£ï¼ˆå¾®ä¿¡ IDï¼‰
  // WhatsAppï¼šè‡ªå‹•æ·»åŠ  https://wa.me/
  if (t === 'whatsapp') {
    if (!/^https?:\/\//i.test(newLink)) {
      // ç§»é™¤å¸¸è¦‹çš„æ ¼å¼å­—ç¬¦ï¼Œä¿ç•™æ•¸å­—å’Œ + è™Ÿ
      const cleanedPhone = newLink.replace(/[\s\-\(\)]/g, '');
      newLink = 'https://wa.me/' + cleanedPhone.replace(/^\+/, '');
    }
  }
  
  // å¦‚æœè¼¸å…¥ç‚ºç©ºï¼Œæç¤ºç”¨æˆ¶ä¸¦é‡ç½®æ¨™è¨˜
  if (newLink === '') {
    alert(currentLang === 'zh' ? 'é€£çµä¸èƒ½ç‚ºç©º' : 'Link cannot be empty');
    // é‡ç½®æ¨™è¨˜ï¼Œå…è¨±ç”¨æˆ¶é‡æ–°è¼¸å…¥
    window.isSubmittingLink = false;
    inputField.dataset.submitted = 'false';
    return;
  }
  
  // åˆ¤æ–·æ˜¯ç·¨è¼¯æ¨¡å¼é‚„æ˜¯æ–°å¢æ¨¡å¼
  if (window.isEditingContact && window.editingContactInfo) {
    // ç·¨è¼¯æ¨¡å¼ï¼šæ›´æ–°ç¾æœ‰æŒ‰éˆ•
    updateContactButtons(window.editingContactInfo.type, window.editingContactInfo.currentLink, newLink);
  } else if (window.currentContactType) {
    // æ–°å¢æ¨¡å¼ï¼šæ·»åŠ æ–°æŒ‰éˆ•
    const contactType = window.currentContactType;
    addContactButtonToPreview(contactType.type, newLink, contactType.buttonTextZh, contactType.buttonTextEn);
  } else {
    console.error('Contact type or editing info not found');
    window.isSubmittingLink = false;
    inputField.dataset.submitted = 'false';
    return;
  }
  
  // é—œé–‰è¼¸å…¥æ¨¡æ…‹æ¡†
  closeLinkInputModal();
  
  // é‡ç½®å…¨å±€æ¨™è¨˜
  window.isSubmittingLink = false;
}

// æ›´æ–°ç¾æœ‰çš„è¯çµ¡æ–¹å¼æŒ‰éˆ•
function updateContactButtons(type, currentLink, newLink) {
  // æ›´æ–°æ‰€æœ‰ç›¸é—œçš„æŒ‰éˆ•é€£çµï¼ˆä¸­æ–‡å’Œè‹±æ–‡ï¼‰
  const buttons = document.querySelectorAll(`#previewContacts a[href="${currentLink}"]`);
  buttons.forEach(btn => {
    btn.href = newLink;
    // æ›´æ–° onclick äº‹ä»¶ä¸­çš„é€£çµåƒæ•¸
    btn.onclick = function(e) {
      editContact(e, type, newLink);
    };
  });
  console.log('Contact buttons updated');
}

// ===== å…¬å¸è³‡è¨Šç›¸é—œåŠŸèƒ½ =====

// é¡¯ç¤ºå…¬å¸è³‡è¨Šé¡å‹é¸æ“‡å½ˆçª—
function showCompanyInfoTypeModal(event) {
  event.preventDefault();
  event.stopPropagation();
  
  const overlay = document.getElementById('companyInfoTypeOverlay');
  if (overlay) {
    overlay.classList.add('show');
    overlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
}

// é—œé–‰å…¬å¸è³‡è¨Šé¡å‹é¸æ“‡å½ˆçª—
function closeCompanyInfoTypeModal(event) {
  if (event && event.target && event.target.closest('.company-info-type-modal') && !event.target.classList.contains('company-info-type-cancel')) {
    return;
  }
  
  const overlay = document.getElementById('companyInfoTypeOverlay');
  if (overlay) {
    overlay.classList.remove('show');
    overlay.style.display = 'none';
    document.body.style.overflow = '';
  }
}

// é¸æ“‡å…¬å¸è³‡è¨Šé¡å‹
function selectCompanyInfoType(type) {
  closeCompanyInfoTypeModal();
  
  if (type === 'custom') {
    // è‡ªè¨‚é¡å‹ï¼šå»ºç«‹ä¸€å€‹æ–°çš„ info-itemï¼Œæ¨™é¡Œå¯ç·¨è¼¯
    addCustomCompanyInfoItem();
  } else if (type === 'taxId') {
    // çµ±ä¸€ç·¨è™Ÿï¼šç›´æ¥é¡¯ç¤ºè¼¸å…¥æ¡†
    showTaxIdInput();
  } else if (type === 'companyName') {
    // å…¬å¸åç¨±ï¼šé¡¯ç¤ºå…¬å¸åç¨±è¼¸å…¥
    showCompanyNameInput();
  } else {
    // åœ°å€é¡å‹ï¼šé¡¯ç¤ºåœ°å€ç·¨è¼¯å½ˆçª—
    showAddressEditModal(type);
  }
}

// é¡¯ç¤ºå…¬å¸åç¨±è¼¸å…¥
function showCompanyNameInput() {
  const item = document.getElementById('companyNameItem');
  if (item) {
    // å¼·åˆ¶é¡¯ç¤º
    item.style.display = 'flex';
    item.style.visibility = 'visible';
    item.style.opacity = '1';
    
    const zhEl = document.getElementById('previewCompanyNameZh');
    const enEl = document.getElementById('previewCompanyNameEn');
    
    // ä¿æŒæ¬„ä½ç‚ºç©ºï¼Œè®“ CSS data-placeholder é¡¯ç¤ºæç¤ºæ–‡å­—
    // ä¸è¦è¨­å®š textContentï¼Œé€™æ¨£ç”¨æˆ¶å¯ä»¥ç›´æ¥è¼¸å…¥
    
    // æ»¾å‹•åˆ°å¯è¦‹å€åŸŸ
    setTimeout(() => {
      item.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 50);
    
    if (zhEl) {
      setTimeout(() => {
        zhEl.focus();
        if (typeof focusEdit === 'function') focusEdit(zhEl);
      }, 150);
    }
  }
}

// æ–°å¢è‡ªè¨‚å…¬å¸è³‡è¨Šé …ç›®
function addCustomCompanyInfoItem() {
  const container = document.getElementById('companyInfoSection');
  const addBtn = container.querySelector('.edit-add-btn'); // æ’å…¥åœ¨æŒ‰éˆ•ä¹‹å‰
  
  const div = document.createElement('div');
  div.className = 'info-item info-item-custom';
  
  // éš¨æ©Ÿ ID é¿å…è¡çª
  const id = 'customInfo_' + Date.now();
  div.id = id;
  
  div.innerHTML = `
    <span class="info-label lang-zh" contenteditable="true" onclick="focusEdit(this)">è‡ªè¨‚æ¨™é¡Œï¼š</span>
    <span class="info-label lang-en" contenteditable="true" onclick="focusEdit(this)">Custom Title:</span>
    <span class="info-value lang-zh edit-clickable" contenteditable="true" onclick="focusEdit(this)">è«‹è¼¸å…¥å…§å®¹</span>
    <span class="info-value lang-en edit-clickable" contenteditable="true" onclick="focusEdit(this)">Enter content</span>
    <button class="info-delete-btn" onclick="this.closest('.info-item').remove()" title="åˆªé™¤">Ã—</button>
  `;
  
  if (addBtn) {
    container.insertBefore(div, addBtn);
  } else {
    container.appendChild(div);
  }
  
  // è‡ªå‹•èšç„¦åˆ°ç¬¬ä¸€å€‹å¯ç·¨è¼¯çš„æ¨™é¡Œ
  const firstEdit = div.querySelector('.info-label.lang-zh');
  if (firstEdit) {
    setTimeout(() => {
      firstEdit.focus();
      focusEdit(firstEdit); // è¼”åŠ©é¸å–æ–‡å­—
    }, 100);
  }
}

// é¡¯ç¤ºçµ±ä¸€ç·¨è™Ÿè¼¸å…¥
function showTaxIdInput() {
  const item = document.getElementById('taxIdItem');
  if (item) {
    item.style.display = 'flex';
    const zhInput = document.getElementById('previewTaxIdZh');
    const enInput = document.getElementById('previewTaxIdEn');
    if (zhInput) {
      setTimeout(() => {
        zhInput.focus();
        const range = document.createRange();
        range.selectNodeContents(zhInput);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
      }, 100);
    }
  }
}

// é¡¯ç¤ºåœ°å€ç·¨è¼¯å½ˆçª—
function showAddressEditModal(addressType) {
  window.currentAddressType = addressType;
  
  // ç‚ºå°æ‡‰é …ç›®åŠ ä¸Š editing class é¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
  const itemId = addressType + 'Item';
  const item = document.getElementById(itemId);
  if (item) {
    item.classList.add('editing');
  }
  
  // è¨­å®šæ¨™é¡Œ
  const titleMap = {
    'serviceLocation': { zh: 'ç·¨è¼¯æœå‹™æ“šé»', en: 'Edit Service Location' },
    'mailingAddress': { zh: 'ç·¨è¼¯é€šè¨Šä½å€', en: 'Edit Mailing Address' },
    'companyAddress': { zh: 'ç·¨è¼¯å…¬å¸ä½å€', en: 'Edit Company Address' }
  };
  
  const titles = titleMap[addressType];
  document.getElementById('addressEditTitleZh').textContent = titles.zh;
  document.getElementById('addressEditTitleEn').textContent = titles.en;
  
  // è¼‰å…¥ç¾æœ‰åœ°å€ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
  const zhEl = document.getElementById(`preview${addressType.charAt(0).toUpperCase() + addressType.slice(1)}Zh`);
  const enEl = document.getElementById(`preview${addressType.charAt(0).toUpperCase() + addressType.slice(1)}En`);
  
  const zhText = zhEl ? (zhEl.querySelector('.address-text')?.textContent || '').trim() : '';
  const enText = enEl ? (enEl.querySelector('.address-text')?.textContent || '').trim() : '';
  
  document.getElementById('addressEditZh').value = zhText;
  document.getElementById('addressEditEn').value = enText;
  
  // éš±è—åœ°åœ–é€£çµ
  const mapLink = document.getElementById('addressMapLink');
  if (mapLink) {
    mapLink.style.display = 'none';
  }
  
  // é¡¯ç¤ºå½ˆçª—
  const overlay = document.getElementById('addressEditOverlay');
  if (overlay) {
    overlay.classList.add('show');
    overlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    setTimeout(() => {
      document.getElementById('addressEditZh').focus();
    }, 100);
  }
}

// é—œé–‰åœ°å€ç·¨è¼¯å½ˆçª—
function closeAddressEditModal(event) {
  if (event && event.target && event.target.closest('.address-edit-modal') && !event.target.classList.contains('address-edit-cancel') && !event.target.classList.contains('address-edit-submit')) {
    return;
  }
  
  const overlay = document.getElementById('addressEditOverlay');
  if (overlay) {
    overlay.classList.remove('show');
    overlay.style.display = 'none';
    document.body.style.overflow = '';
  }
  
  // ç§»é™¤ editing class éš±è—åˆªé™¤æŒ‰éˆ•
  if (window.currentAddressType) {
    const itemId = window.currentAddressType + 'Item';
    const item = document.getElementById(itemId);
    if (item) {
      item.classList.remove('editing');
    }
  }
  
  window.currentAddressType = null;
}

// æäº¤åœ°å€ç·¨è¼¯
function submitAddressEdit(event) {
  event.preventDefault();
  event.stopPropagation();
  
  const addressType = window.currentAddressType;
  if (!addressType) return;
  
  const zhAddress = document.getElementById('addressEditZh').value.trim();
  const enAddress = document.getElementById('addressEditEn').value.trim();
  
  if (!zhAddress && !enAddress) {
    const zhElements = document.querySelectorAll('.lang-zh');
    const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';
    alert(currentLang === 'zh' ? 'è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹åœ°å€' : 'Please enter at least one address');
    return;
  }
  
  // æ›´æ–°é è¦½å€åŸŸ
  updateAddressPreview(addressType, zhAddress, enAddress);
  
  // é¡¯ç¤ºå°æ‡‰çš„é …ç›®
  const itemId = addressType + 'Item';
  const item = document.getElementById(itemId);
  if (item) {
    item.style.display = 'flex';
  }
  
  closeAddressEditModal();
}

// ===== å¡ç‰‡ä¸»é¡Œé¸æ“‡åŠŸèƒ½ =====

// é¡¯ç¤ºä¸»é¡Œé¸æ“‡å™¨æ¨¡æ…‹æ¡†
function showThemeSelector() {
  const overlay = document.getElementById('themeSelectorOverlay');
  if (overlay) {
    overlay.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // é«˜äº®ç•¶å‰é¸ä¸­çš„ä¸»é¡Œ
    const savedTheme = localStorage.getItem('cardTheme');
    if (savedTheme) {
      updateThemePreviewActive(parseInt(savedTheme));
    }
  }
}

// é—œé–‰ä¸»é¡Œé¸æ“‡å™¨æ¨¡æ…‹æ¡†
function closeThemeSelector(event) {
  if (event && event.target && !event.target.classList.contains('theme-selector-overlay') && !event.target.classList.contains('theme-selector-close')) {
    return;
  }
  
  const overlay = document.getElementById('themeSelectorOverlay');
  if (overlay) {
    overlay.classList.remove('show');
    document.body.style.overflow = '';
  }
}

// æ›´æ–°ä¸»é¡Œé è¦½çš„ active ç‹€æ…‹
function updateThemePreviewActive(themeNumber) {
  const previews = document.querySelectorAll('.theme-card-preview');
  previews.forEach(preview => {
    preview.classList.remove('active');
  });
  const selectedPreview = document.querySelector('.theme-card-preview[data-theme="' + themeNumber + '"]');
  if (selectedPreview) {
    selectedPreview.classList.add('active');
  }
}

// é¸æ“‡å¡ç‰‡ä¸»é¡Œï¼ˆç·¨è¼¯é é¢ - åªæ›´æ–°å¡ç‰‡ï¼Œä¸æ›´æ–° bodyï¼‰
function selectCardTheme(themeNumber) {
  console.log('Selecting card theme:', themeNumber);
  
  // åœ¨ç·¨è¼¯é ï¼šå¡ç‰‡ä¸»é¡Œéœ€è¦ã€Œå®Œæ•´é è¦½ã€æ•´é«”ç‰ˆé¢
  // - ä½¿ç”¨ styles.css å…§å»ºçš„ body.card-theme-*ï¼ˆæ•´é èƒŒæ™¯/é ‚éƒ¨æ¬„/åº•éƒ¨æ¬„ï¼‰
  // - åŒæ™‚ä¿ç•™ theme-dark/theme-lightï¼ˆè®“ edit.html æ—¢æœ‰çš„æ¨¡æ…‹æ¡†/æŒ‰éˆ•æ¨£å¼è¦å‰‡ç”Ÿæ•ˆï¼‰
  // - ç§»é™¤ common.js çš„ body.theme-1~5ï¼ˆé¿å…å…©å¥—ä¸»é¡Œäº’ç›¸è¦†è“‹é€ æˆã€Œåˆ‡ä¸å®Œæ•´ã€ï¼‰
  function applyCardThemeToBody(n) {
    // æ¸…æ‰ common.js å…¨åŸŸä¸»é¡Œé¡åˆ¥ï¼ˆtheme-1~7ï¼‰ï¼Œé¿å…è·Ÿ card-theme-* æ‰“æ¶
    document.body.classList.remove('theme-1', 'theme-2', 'theme-3', 'theme-4', 'theme-5', 'theme-6', 'theme-7', 'theme-8', 'theme-9');

    // æ¸…æ‰èˆŠçš„å¡ç‰‡ä¸»é¡Œï¼ˆæ•´é ï¼‰
    document.body.classList.remove('card-theme-1', 'card-theme-2', 'card-theme-3', 'card-theme-4', 'card-theme-5', 'card-theme-6', 'card-theme-7', 'card-theme-8', 'card-theme-9');

    // å¥—ç”¨æ–°çš„å¡ç‰‡ä¸»é¡Œï¼ˆæ•´é ï¼‰
    if (n >= 1 && n <= 9) {
      document.body.classList.add('card-theme-' + n);
    }

    // å°æ‡‰ light/darkï¼ˆedit.html å…§å¤§é‡ä¾è³´ theme-dark/theme-lightï¼‰
    document.body.classList.remove('theme-dark', 'theme-light');
    if (n === 2 || n === 7 || n === 9) {
      document.body.classList.add('theme-light');
    } else {
      document.body.classList.add('theme-dark');
    }
  }

  // ç›´æ¥æ“ä½œ DOM æ›´æ–°å¡ç‰‡ä¸»é¡Œ
  const card = document.getElementById('previewCard');
  if (card) {
    // ç§»é™¤æ‰€æœ‰èˆŠçš„ä¸»é¡Œé¡åˆ¥
    card.classList.remove('card-theme-1', 'card-theme-2', 'card-theme-3', 'card-theme-4', 'card-theme-5', 'card-theme-6', 'card-theme-7', 'card-theme-8', 'card-theme-9');
    
    // æ·»åŠ æ–°çš„ä¸»é¡Œé¡åˆ¥
    if (themeNumber >= 1 && themeNumber <= 9) {
      card.classList.add('card-theme-' + themeNumber);
      console.log('Applied theme class: card-theme-' + themeNumber);
      console.log('Card classes:', card.className);
    }
  } else {
    console.error('Card element not found!');
  }
  
  // åŒæ­¥æ•´é é è¦½ä¸»é¡Œï¼ˆèƒŒæ™¯/é ‚éƒ¨æ¬„/åº•éƒ¨æ¬„/æ³¡æ³¡/æ¨¡æ…‹æ¡†æ˜æš—ï¼‰
  applyCardThemeToBody(themeNumber);

  // å„²å­˜åˆ° localStorage
  localStorage.setItem('cardTheme', themeNumber);
  // åŒæ­¥å…¨åŸŸä¸»é¡Œï¼ˆyuyuko.html / å…¶ä»–é é¢ç”± common.js è®€å– localStorage.themeï¼‰
  // é€™æ¨£å¾ edit.html è·³å›åç‰‡é æ™‚ï¼Œæ•´é«”ä¸»é¡Œæœƒä¸€è‡´æ›´æ–°
  localStorage.setItem('theme', String(themeNumber));
  
  // æ›´æ–°é è¦½çš„ active ç‹€æ…‹
  updateThemePreviewActive(themeNumber);
  
  // å»¶é²é—œé–‰æ¨¡æ…‹æ¡†ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°é¸ä¸­çš„æ•ˆæœ
  setTimeout(function() {
    closeThemeSelector({ target: document.getElementById('themeSelectorOverlay') });
  }, 500);
}

// åˆå§‹åŒ–å¡ç‰‡ä¸»é¡Œï¼ˆåœ¨ç·¨è¼¯é é¢åªè®€å–ï¼Œä¸è‡ªå‹•æ‡‰ç”¨ï¼‰
function initCardTheme() {
  console.log('Initializing card theme...');
  
  // å¾ localStorage è®€å–
  const savedTheme = localStorage.getItem('cardTheme');
  if (savedTheme) {
    const themeNumber = parseInt(savedTheme);
    console.log('Saved theme:', themeNumber);
    
    if (themeNumber >= 1 && themeNumber <= 9) {
      // åŒæ­¥å…¨åŸŸä¸»é¡Œï¼Œç¢ºä¿è¿”å› yuyuko.html ç­‰é é¢èƒ½ç«‹åˆ»å¥—ç”¨
      localStorage.setItem('theme', String(themeNumber));

      const card = document.getElementById('previewCard');
      if (card) {
        // ç§»é™¤æ‰€æœ‰èˆŠçš„ä¸»é¡Œé¡åˆ¥
        card.classList.remove('card-theme-1', 'card-theme-2', 'card-theme-3', 'card-theme-4', 'card-theme-5', 'card-theme-6', 'card-theme-7', 'card-theme-8', 'card-theme-9');
        // æ·»åŠ ä¿å­˜çš„ä¸»é¡Œ
        card.classList.add('card-theme-' + themeNumber);
        console.log('Applied saved theme: card-theme-' + themeNumber);
        console.log('Card classes:', card.className);
      } else {
        console.error('Card element not found during init!');
      }

      // åˆå§‹åŒ–æ™‚ä¹Ÿè¦åŒæ­¥æ•´é é è¦½ä¸»é¡Œ
      //ï¼ˆæ³¨æ„ï¼šcommon.js æœƒå…ˆå¥—ç”¨ body.theme-1~5ï¼›é€™è£¡ä»¥ cardTheme ç‚ºæº–è¦†è“‹æˆ body.card-theme-*ï¼‰
      document.body.classList.remove('theme-1', 'theme-2', 'theme-3', 'theme-4', 'theme-5', 'theme-6', 'theme-7', 'theme-8', 'theme-9');
      document.body.classList.remove('card-theme-1', 'card-theme-2', 'card-theme-3', 'card-theme-4', 'card-theme-5', 'card-theme-6', 'card-theme-7', 'card-theme-8', 'card-theme-9');
      document.body.classList.add('card-theme-' + themeNumber);
      document.body.classList.remove('theme-dark', 'theme-light');
      document.body.classList.add((themeNumber === 2 || themeNumber === 7 || themeNumber === 9) ? 'theme-light' : 'theme-dark');
      
      // å»¶é²æ›´æ–° active ç‹€æ…‹ï¼Œç¢ºä¿ modal DOM å·²è¼‰å…¥
      setTimeout(function() {
        updateThemePreviewActive(themeNumber);
      }, 200);
    }
  } else {
    console.log('No saved theme found, using default');

    // æ²’æœ‰ä¿å­˜ä¸»é¡Œæ™‚ï¼Œä»ç¢ºä¿æœ‰ä¸€å€‹å¯é æœŸçš„æ˜æš— classï¼ˆé¿å…æ¨¡æ…‹æ¡†é¡è‰²éŒ¯äº‚ï¼‰
    if (!document.body.classList.contains('theme-dark') && !document.body.classList.contains('theme-light')) {
      document.body.classList.add('theme-dark');
    }
  }
}

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initCardTheme, 100);
  });
} else {
  setTimeout(initCardTheme, 100);
}

// æ›´æ–°åœ°å€é è¦½
function updateAddressPreview(addressType, zhAddress, enAddress) {
  const typeCapitalized = addressType.charAt(0).toUpperCase() + addressType.slice(1);
  const zhEl = document.getElementById(`preview${typeCapitalized}Zh`);
  const enEl = document.getElementById(`preview${typeCapitalized}En`);
  
  if (zhEl) {
    const textEl = zhEl.querySelector('.address-text');
    if (textEl) {
      textEl.textContent = zhAddress || 'ï¼ˆæœªè¨­å®šï¼‰';
    }
  }
  
  if (enEl) {
    const textEl = enEl.querySelector('.address-text');
    if (textEl) {
      textEl.textContent = enAddress || 'ï¼ˆNot Setï¼‰';
    }
  }
  
  // æ›´æ–°åœ°åœ–é€£çµ
  updateMapLink(addressType, zhAddress || enAddress);
}

// ç”Ÿæˆåœ°åœ–é€£çµ
function generateMapLink() {
  const addressType = window.currentAddressType;
  const zhAddress = document.getElementById('addressEditZh').value.trim();
  const enAddress = document.getElementById('addressEditEn').value.trim();
  
  const address = zhAddress || enAddress;
  if (!address) {
    const zhElements = document.querySelectorAll('.lang-zh');
    const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';
    alert(currentLang === 'zh' ? 'è«‹å…ˆè¼¸å…¥åœ°å€' : 'Please enter address first');
    return;
  }
  
  // ç”Ÿæˆ Google Maps é€£çµ
  const encodedAddress = encodeURIComponent(address);
  const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
  
  const mapLink = document.getElementById('addressMapLink');
  if (mapLink) {
    mapLink.href = mapUrl;
    mapLink.style.display = 'inline-block';
  }
  
  // åœ¨æ–°è¦–çª—é–‹å•Ÿåœ°åœ–
  window.open(mapUrl, '_blank');
}

// æ›´æ–°åœ°åœ–é€£çµ
function updateMapLink(addressType, address) {
  if (!address || address === 'ï¼ˆæœªè¨­å®šï¼‰' || address === 'ï¼ˆNot Setï¼‰') return;
  
  const encodedAddress = encodeURIComponent(address);
  const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
  
  const typeCapitalized = addressType.charAt(0).toUpperCase() + addressType.slice(1);
  const zhEl = document.getElementById(`preview${typeCapitalized}Zh`);
  const enEl = document.getElementById(`preview${typeCapitalized}En`);
  
  [zhEl, enEl].forEach(el => {
    if (el) {
      const mapLink = el.querySelector('.address-map-link');
      if (mapLink) {
        mapLink.onclick = function(e) {
          e.stopPropagation();
          window.open(mapUrl, '_blank');
        };
      }
    }
  });
}

// é–‹å•Ÿåœ°åœ–
function openMap(addressType, event) {
  event.stopPropagation();
  event.preventDefault();
  
  const typeCapitalized = addressType.charAt(0).toUpperCase() + addressType.slice(1);
  const zhEl = document.getElementById(`preview${typeCapitalized}Zh`);
  const enEl = document.getElementById(`preview${typeCapitalized}En`);
  
  const address = zhEl?.querySelector('.address-text')?.textContent || enEl?.querySelector('.address-text')?.textContent || '';
  
  if (address && address !== 'ï¼ˆæœªè¨­å®šï¼‰' && address !== 'ï¼ˆNot Setï¼‰') {
    const encodedAddress = encodeURIComponent(address);
    const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
    window.open(mapUrl, '_blank');
  }
}

// ç·¨è¼¯åœ°å€ï¼ˆé»æ“Šåœ°å€é …ç›®æ™‚ï¼‰
function editAddress(addressType, event) {
  event.preventDefault();
  event.stopPropagation();
  showAddressEditModal(addressType);
}

// ç·¨è¼¯çµ±ä¸€ç·¨è™Ÿ
function editTaxId(event) {
  event.preventDefault();
  event.stopPropagation();
  
  // ç‚ºå°æ‡‰é …ç›®åŠ ä¸Š editing class é¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
  const taxIdItem = document.getElementById('taxIdItem');
  if (taxIdItem) {
    taxIdItem.classList.add('editing');
  }
  
  const zhInput = document.getElementById('previewTaxIdZh');
  if (zhInput) {
    setTimeout(() => {
      zhInput.focus();
      const range = document.createRange();
      range.selectNodeContents(zhInput);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
    }, 100);
    
    // ç›£è½ blur äº‹ä»¶ä»¥ç§»é™¤ editing class
    const handleBlur = () => {
      // å»¶é²åŸ·è¡Œï¼Œé¿å…é»æ“Šåˆªé™¤æŒ‰éˆ•æ™‚æå‰ç§»é™¤ class
      setTimeout(() => {
        if (taxIdItem && !taxIdItem.contains(document.activeElement)) {
          taxIdItem.classList.remove('editing');
        }
      }, 200);
      zhInput.removeEventListener('blur', handleBlur);
    };
    zhInput.addEventListener('blur', handleBlur);
  }
}

// åˆªé™¤å…¬å¸è³‡è¨Šé …ç›®
function deleteCompanyInfo(type) {
  const zhElements = document.querySelectorAll('.lang-zh');
  const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';
  
  const confirmMsg = currentLang === 'zh' ? 'ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ' : 'Are you sure you want to delete this item?';
  if (!confirm(confirmMsg)) return;
  
  const itemId = type + 'Item';
  const item = document.getElementById(itemId);
  if (item) {
    item.style.display = 'none';
    
    // æ¸…é™¤å…§å®¹
    if (type === 'taxId') {
      document.getElementById('previewTaxIdZh').textContent = '';
      document.getElementById('previewTaxIdEn').textContent = '';
    } else if (type === 'companyName') {
      // å…¬å¸åç¨±ï¼šæ¸…é™¤å…§å®¹
      const zhEl = document.getElementById('previewCompanyNameZh');
      const enEl = document.getElementById('previewCompanyNameEn');
      if (zhEl) zhEl.textContent = '';
      if (enEl) enEl.textContent = '';
      // åŒæ™‚æ¸…é™¤å…¨åŸŸè®Šæ•¸
      window.__uvacoCompanyZh = '';
      window.__uvacoCompanyEn = '';
      window.__uvacoSelectedCompany = '';
    } else {
      // åœ°å€é¡å‹
      const typeCapitalized = type.charAt(0).toUpperCase() + type.slice(1);
      const zhEl = document.getElementById(`preview${typeCapitalized}Zh`);
      const enEl = document.getElementById(`preview${typeCapitalized}En`);
      if (zhEl) {
        const textEl = zhEl.querySelector('.address-text');
        if (textEl) textEl.textContent = '';
      }
      if (enEl) {
        const textEl = enEl.querySelector('.address-text');
        if (textEl) textEl.textContent = '';
      }
    }
  }
}

// æ·»åŠ è¯çµ¡æ–¹å¼æŒ‰éˆ•åˆ°é è¦½å€åŸŸ
function addContactButtonToPreview(type, newLink, buttonTextZh, buttonTextEn) {
  // é˜²æ­¢é‡è¤‡æ·»åŠ  - æª¢æŸ¥æ˜¯å¦å·²ç¶“å­˜åœ¨ç›¸åŒçš„é€£çµ
  const contactsGroup = document.getElementById('previewContacts');
  if (contactsGroup) {
    const existingButtons = contactsGroup.querySelectorAll(`a[href="${newLink}"]`);
    if (existingButtons.length > 0) {
      console.log('Contact with this link already exists, skipping duplicate');
      return;
    }
  }
  
  const zhElements = document.querySelectorAll('.lang-zh');
  const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';
  
  if (!contactsGroup) {
    console.error('previewContacts element not found');
    alert(currentLang === 'zh' ? 'æ‰¾ä¸åˆ°è¯çµ¡æ–¹å¼å®¹å™¨' : 'Contact container not found');
    return;
  }
  
  // å‰µå»ºä¸­æ–‡æŒ‰éˆ•
  const btnZh = document.createElement('a');
  btnZh.className = 'btn btn-secondary lang-zh edit-clickable';
  btnZh.href = newLink;
  if (type === 'website' || type === 'line' || type === 'official-line' || type === 'facebook' || type === 'instagram' || type === 'linkedin' || type === 'twitter' || type === 'youtube' || type === 'whatsapp') {
    btnZh.target = '_blank';
  }
  if (type === 'vcf') {
    btnZh.download = 'Contact.vcf';
  }
  btnZh.innerHTML = buttonTextZh;
  btnZh.onclick = function(event) {
    editContact(event, type, newLink);
  };
  
  // å‰µå»ºè‹±æ–‡æŒ‰éˆ•
  const btnEn = document.createElement('a');
  btnEn.className = 'btn btn-secondary lang-en edit-clickable';
  btnEn.href = newLink;
  if (type === 'website' || type === 'line' || type === 'official-line' || type === 'facebook' || type === 'instagram' || type === 'linkedin' || type === 'twitter' || type === 'youtube' || type === 'whatsapp') {
    btnEn.target = '_blank';
  }
  if (type === 'vcf') {
    btnEn.download = 'Contact.vcf';
  }
  btnEn.innerHTML = buttonTextEn;
  btnEn.onclick = function(event) {
    editContact(event, type, newLink);
  };
  
  // å‰µå»ºåŒ…è£å™¨
  const wrapper = document.createElement('div');
  wrapper.className = 'contact-btn-wrapper';
  
  wrapper.appendChild(btnZh);
  wrapper.appendChild(btnEn);
  
  // å‰µå»ºåˆªé™¤æŒ‰éˆ•
  const deleteBtn = document.createElement('button');
  deleteBtn.className = 'contact-delete-btn';
  deleteBtn.textContent = 'âœ•';
  deleteBtn.title = currentLang === 'zh' ? 'åˆªé™¤' : 'Delete';
  deleteBtn.onclick = function(event) {
    event.stopPropagation();
    deleteContactButton(btnZh);
  };
  wrapper.appendChild(deleteBtn);
  
  // æ·»åŠ åˆ°è¯çµ¡æ–¹å¼å®¹å™¨
  contactsGroup.appendChild(wrapper);
  console.log('Contact button added to previewContacts');
}

// åˆ‡æ›è¯çµ¡æ–¹å¼é …ç›®å±•é–‹/æ”¶åˆ
function toggleContactItem(btn) {
  const item = btn.closest('.edit-contact-item');
  const content = item.querySelector('.edit-contact-content');
  const arrow = btn.querySelector('.edit-contact-toggle-arrow');
  
  content.classList.toggle('show');
  arrow.classList.toggle('expanded');
}

// åˆ‡æ›å¯è¦‹æ€§è¨­å®šå±•é–‹/æ”¶åˆ
function toggleVisibility(btn) {
  const content = btn.nextElementSibling;
  const arrow = btn.querySelector('.edit-contact-visibility-arrow');
  
  content.classList.toggle('show');
  arrow.classList.toggle('expanded');
}


// ç§»å‹•è¯çµ¡æ–¹å¼
function moveContact(item, direction) {
  if (typeof item === 'object' && item.nodeName) {
    // å¦‚æœå‚³å…¥çš„æ˜¯ DOM å…ƒç´ 
  } else {
    // å¦‚æœå‚³å…¥çš„æ˜¯æŒ‰éˆ•
    item = item.closest('.edit-contact-item');
  }
  const list = item.parentElement;
  if (direction === 'up' && item.previousElementSibling) {
    list.insertBefore(item, item.previousElementSibling);
  } else if (direction === 'down' && item.nextElementSibling) {
    list.insertBefore(item.nextElementSibling, item);
  }
}

// åˆªé™¤è¯çµ¡æ–¹å¼æŒ‰éˆ•ï¼ˆå¾é è¦½å€åŸŸï¼‰
function deleteContactButton(contactBtn) {
  if (event) event.stopPropagation();
  const zhElements = document.querySelectorAll('.lang-zh');
  const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';
  const confirmMsg = currentLang === 'zh' ? 'ç¢ºå®šè¦åˆªé™¤æ­¤è¯çµ¡æ–¹å¼å—ï¼Ÿ' : 'Are you sure you want to delete this contact method?';
  
  if (confirm(confirmMsg)) {
    // æ‰¾åˆ°å°æ‡‰çš„åŒ…è£å™¨ä¸¦åˆªé™¤ï¼ˆåŒ…å«ä¸­æ–‡å’Œè‹±æ–‡æŒ‰éˆ•ï¼‰
    const wrapper = contactBtn.closest('.contact-btn-wrapper');
    if (wrapper) {
      wrapper.remove();
    }
  }
}

// å„²å­˜åç‰‡ï¼ˆé›²ç«¯ï¼šSupabaseï¼‰

// æ¸…ç† HTML ç‰‡æ®µï¼ˆç§»é™¤ç·¨è¼¯å…ƒç´ å’Œç³»çµ±æç¤ºæ–‡å­—ï¼‰
function getCleanHtmlFragment(element) {
  if (!element) return '';
  
  const clone = element.cloneNode(true);
  
  // ç§»é™¤ç·¨è¼¯ç›¸é—œå…ƒç´ 
  const editElements = clone.querySelectorAll('button, .edit-add-btn, .contact-delete-btn, .slogan-delete-btn, .uvaco-company-picker-wrap, .uvaco-company-picker-badge');
  editElements.forEach(el => el.remove());
  
  // ç§»é™¤ç·¨è¼¯å±¬æ€§
  const editables = clone.querySelectorAll('[contenteditable]');
  editables.forEach(el => el.removeAttribute('contenteditable'));
  
  const clickables = clone.querySelectorAll('.edit-clickable');
  clickables.forEach(el => {
    el.classList.remove('edit-clickable');
    el.removeAttribute('onclick');
    el.removeAttribute('onblur');
  });
  
  // ç§»é™¤æ‰€æœ‰ on é–‹é ­çš„å±¬æ€§
  const all = clone.querySelectorAll('*');
  all.forEach(el => {
    Array.from(el.attributes).forEach(attr => {
      if (attr.name.startsWith('on')) {
        el.removeAttribute(attr.name);
      }
    });
  });
  
  // éæ¿¾ç³»çµ±æç¤ºæ–‡å­—
  let html = clone.innerHTML;
  const systemPatterns = [
    'å…¬å¸å·²é–å®šï¼ˆå¦‚éœ€æ›´æ”¹è«‹è¯çµ¡ç®¡ç†å“¡ï¼‰',
    'å…¬å¸ï¼šå¿…é¸ä¸‹æ‹‰ï¼ˆå¯è¼¸å…¥é—œéµå­—å¿«é€Ÿå¸¶å…¥ï¼‰',
    'ğŸ¢ é¸æ“‡å…¬å¸',
    'ğŸ¢ Select Company',
    'è«‹è¼¸å…¥å…§å®¹',
    'Enter content'
  ];
  systemPatterns.forEach(pattern => {
    html = html.split(pattern).join('');
  });
  
  return html;
}

function getCleanSloganHtml(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return '';
  
  // è¤‡è£½ä¸€ä»½ï¼Œé¿å…æ”¹åˆ°ç•«é¢
  const clone = container.cloneNode(true);
  
  // ç§»é™¤å…¬å¸é¸æ“‡å™¨ç›¸é—œå…ƒç´ ï¼ˆé¿å…æç¤ºæ–‡å­—è¢«å­˜å…¥è³‡æ–™åº«ï¼‰
  const companyPickerElements = clone.querySelectorAll('.uvaco-company-picker-wrap, .uvaco-company-picker-badge, #uvacoCompanyPickBtnZh, #uvacoCompanyPickBtnEn, #uvacoCompanyLockBadge');
  companyPickerElements.forEach(el => el.remove());
  
  // ç§»é™¤æ‰€æœ‰ç·¨è¼¯å±¬æ€§èˆ‡äº‹ä»¶
  const editables = clone.querySelectorAll('[contenteditable]');
  editables.forEach(el => el.removeAttribute('contenteditable'));
  
  const clickables = clone.querySelectorAll('.edit-clickable');
  clickables.forEach(el => {
    el.classList.remove('edit-clickable');
    el.removeAttribute('onclick');
    el.removeAttribute('onblur');
  });
  
  const buttons = clone.querySelectorAll('button, .slogan-delete-btn, .edit-add-btn');
  buttons.forEach(el => el.remove());
  
  // ç§»é™¤æ‰€æœ‰ script/onclick/onblur å±¬æ€§ï¼ˆå†æ¬¡æª¢æŸ¥ï¼‰
  const all = clone.querySelectorAll('*');
  all.forEach(el => {
    // ç§»é™¤æ‰€æœ‰ on é–‹é ­çš„å±¬æ€§
    Array.from(el.attributes).forEach(attr => {
      if (attr.name.startsWith('on')) {
        el.removeAttribute(attr.name);
      }
    });
  });
  
  // éæ¿¾ç³»çµ±æç¤ºæ–‡å­—
  let html = clone.innerHTML;
  const systemPatterns = [
    'å…¬å¸å·²é–å®šï¼ˆå¦‚éœ€æ›´æ”¹è«‹è¯çµ¡ç®¡ç†å“¡ï¼‰',
    'å…¬å¸ï¼šå¿…é¸ä¸‹æ‹‰ï¼ˆå¯è¼¸å…¥é—œéµå­—å¿«é€Ÿå¸¶å…¥ï¼‰',
    'ğŸ¢ é¸æ“‡å…¬å¸',
    'ğŸ¢ Select Company'
  ];
  systemPatterns.forEach(pattern => {
    html = html.split(pattern).join('');
  });

  return html;
}

// Helper functions for name parsing
function primaryPart(raw) {
  if (!raw) return '';
  const parts = raw.split(/\s*[ï½œ|]\s*/);
  return parts[0].trim();
}

function englishPartFromNameZh(raw) {
  if (!raw) return '';
  const parts = raw.split(/\s*[ï½œ|]\s*/);
  if (parts.length > 1) {
    return parts[1].trim();
  }
  // Fallback: check for parentheses
  const match = raw.match(/[ï¼ˆ(](.+?)[)ï¼‰]/);
  if (match) return match[1].trim();
  return '';
}

async function saveCard() {
  console.log('saveCard started...');
  const zhElements = document.querySelectorAll('.lang-zh');
  const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';

  // 1. å¼·åˆ¶è®“ç›®å‰èšç„¦çš„å…ƒç´ å¤±å»ç„¦é»ï¼Œè§¸ç™¼ onblur ä»¥åŒæ­¥æœ€æ–°ç·¨è¼¯å…§å®¹
  if (document.activeElement && typeof document.activeElement.blur === 'function') {
    try { document.activeElement.blur(); } catch(e) {}
  }

  // 2. é¡å¤–å¼·åˆ¶åŒæ­¥ï¼šæ‰‹å‹•è§¸ç™¼æ‰€æœ‰ contenteditable çš„æ›´æ–°å‡½å¼
  try { if (typeof updateNameFromPreview === 'function') updateNameFromPreview(); } catch (e) {}
  try { if (typeof updateTitleFromPreview === 'function') updateTitleFromPreview(); } catch (e) {}
  try { if (typeof updateSlogansPreview === 'function') updateSlogansPreview(); } catch (e) {}
  try { if (typeof updateCompanyFromSlogans === 'function') updateCompanyFromSlogans(); } catch (e) {}

  function textOf(id) {
    const el = document.getElementById(id);
    return String(el?.textContent || '').replace(/\s+/g, ' ').trim();
  }
  
  function srcOf(id) {
    const el = document.getElementById(id);
    const src = el?.getAttribute('src') || '';
    if (src.startsWith('blob:') || src.startsWith('data:')) return src;
    if (src.includes('default-avatar.svg')) return '';
    if (src.includes('uvaco-logo.svg')) return '';
    return src;
  }

  // 3. æ“·å–è³‡æ–™
  const nameZhRaw = textOf('previewNameZh');
  const nameEnRaw = englishPartFromNameZh(nameZhRaw);
  const titleZhRaw = textOf('previewTitleZh');
  const titleEnRaw = textOf('previewTitleEn');

  const name = primaryPart(nameZhRaw) || 'Name';
  const title = primaryPart(titleZhRaw) || 'Title';

  const theme = parseInt(window.currentCardTheme || 1, 10);
  const phone = window.__uvacoCardPhone || '';
  const email = window.__uvacoCardEmail || '';

  // åµæ¸¬å…¬å¸åç¨± (Canonical)
  // å„ªå…ˆå¾å…¬å¸è³‡è¨Šå€å¡Šçš„å…¬å¸åç¨±æ¬„ä½æŠ“å–ï¼Œå…¶æ¬¡ Slogan DOMï¼Œæœ€å¾Œç”¨é¸æ“‡å™¨çš„
  const companyCanonical = (function () {
    // å„ªå…ˆä½¿ç”¨å…¬å¸è³‡è¨Šå€å¡Šçš„å…¬å¸åç¨±æ¬„ä½
    const zhEl = document.getElementById('previewCompanyNameZh');
    const enEl = document.getElementById('previewCompanyNameEn');
    const fromFieldZh = zhEl ? zhEl.textContent.trim() : '';
    const fromFieldEn = enEl ? enEl.textContent.trim() : '';
    if (fromFieldZh) return fromFieldZh;
    if (fromFieldEn) return fromFieldEn;
    
    // Fallback åˆ°æ¨™èªä¸­çš„å…¬å¸åç¨±
    const zhStrong = getSloganStrong('zh');
    const enStrong = getSloganStrong('en');
    const fromDomZh = getCanonicalCompanyFromStrongText(zhStrong ? zhStrong.textContent : '');
    const fromDomEn = getCanonicalCompanyFromStrongText(enStrong ? enStrong.textContent : '');
    const fromDom = fromDomZh || fromDomEn || '';
    
    if (fromDom) return fromDom;
    
    const picked = String(window.__uvacoSelectedCompany || '').trim();
    if (picked) return picked;
    
    return '';
  })();
  
  const company = companyCanonical || 'Personal'; // Allow empty company, default to 'Personal'
  console.log('Company detection:', { company, companyCanonical });

  // Company lock logic temporarily commented out
  /*
  const adminModeForCompany = isAdminModeFromUrl() || (function () {
    const params = new URLSearchParams(window.location.search || '');
    const targetUserId = params.get('targetUserId') || params.get('uid') || params.get('id');
    const myUserId = (window.__uvacoLoadedProfileJson && window.__uvacoLoadedProfileJson.user_id) || ''; // Need verify
    return (targetUserId && myUserId && targetUserId !== myUserId);
  })();
  const isActuallyLocked = window.__uvacoCompanyLocked && !adminModeForCompany && params.get('mode') !== 'onboarding';
  
  if (isActuallyLocked) {
    // æª¢æŸ¥å…¬å¸æ˜¯å¦è¢«æ›´æ”¹
    const original = String(window.__uvacoOriginalCompanyCanonical || '').trim();
    if (original && companyCanonical !== original) {
      alert('æ‚¨çš„å…¬å¸å·²é–å®šç‚ºã€Œ' + original + 'ã€ï¼Œç„¡æ³•è®Šæ›´ã€‚\nå¦‚éœ€æ›´æ”¹è«‹è¯çµ¡ç®¡ç†å“¡ã€‚');
      // é‚„åŸ
      window.__uvacoSelectedCompany = original;
      applyCompanyToUI(original);
      return; 
    }
  }
  */

  // 4. æº–å‚™ JSON (profile_json)
  // å…ˆè¨ˆç®— adminModeForCompanyï¼Œå› ç‚º profile_json éœ€è¦ç”¨åˆ°
  const params = new URLSearchParams(window.location.search || '');
  const targetUserId = params.get('targetUserId') || params.get('uid') || params.get('id');
  let adminMode = params.get('adminMode') === 'true';
  let adminModeForCompany = adminMode;
  try {
    // é€™è£¡ç„¡æ³•åŒæ­¥å–å¾— sessionï¼Œåªèƒ½ä¾è³´åŒæ­¥é‚è¼¯æˆ–é å…ˆè¼‰å…¥çš„è³‡è¨Š
    // å¦‚æœéœ€è¦åš´æ ¼æª¢æŸ¥ï¼Œæ‡‰è©²æ—©åœ¨é€²å…¥ edit é é¢æ™‚å°±ç¢ºèªæ¬Šé™
    // é€™è£¡åšä¸€å€‹ç°¡å–®çš„åŒæ­¥æª¢æŸ¥ (å‡è¨­ window.__uvacoSupabaseSession å·²å­˜åœ¨)
    if (targetUserId && window.__uvacoSupabaseSession && window.__uvacoSupabaseSession.user) {
       const myUserId = window.__uvacoSupabaseSession.user.id;
       if (String(targetUserId) !== String(myUserId)) {
         adminMode = true;
         adminModeForCompany = true;
       }
    }
  } catch (e) {}

  const profile_json = (function () {
    const card = document.getElementById('previewCard');
    const logo = document.getElementById('previewLogo');
    const avatar = document.getElementById('previewAvatar');
    const contacts = document.getElementById('previewContacts');
    const companyInfo = document.getElementById('companyInfoSection');
    const slogansZh = document.getElementById('previewSlogansZh');
    const slogansEn = document.getElementById('previewSlogansEn');

    // å–å¾—ä¹¾æ·¨çš„ HTML å­—ä¸²ï¼ˆç§»é™¤ç·¨è¼¯å±¬æ€§ï¼‰
    const slogansZhClean = getCleanSloganHtml('previewSlogansZh');
    const slogansEnClean = getCleanSloganHtml('previewSlogansEn');

    const prevPj = (window.__uvacoLoadedProfileJson && typeof window.__uvacoLoadedProfileJson === 'object') 
      ? window.__uvacoLoadedProfileJson 
      : {};

    const logoSrcRaw = String(logo?.getAttribute('src') || '');
    const avatarSrcRaw = String(avatar?.getAttribute('src') || '');
    const logoSrcSafe = (logoSrcRaw.startsWith('blob:') || logoSrcRaw.startsWith('data:')) ? logoSrcRaw : '';
    const avatarSrcSafe = (avatarSrcRaw.startsWith('blob:') || avatarSrcRaw.startsWith('data:')) ? avatarSrcRaw : '';
    
    // æ”¶é›†å­—é«”æ¨£å¼
    const nameEl = document.getElementById('previewNameZh');
    const titleZhEl = document.getElementById('previewTitleZh');
    const titleEnEl = document.getElementById('previewTitleEn');
    
    const fontStyles = {
      name: {
        size: nameEl?.dataset.fontSize || 'medium',
        weight: nameEl?.dataset.fontWeight || 'normal',
        color: nameEl?.dataset.fontColor || ''
      },
      titleZh: {
        size: titleZhEl?.dataset.fontSize || 'medium',
        weight: titleZhEl?.dataset.fontWeight || 'normal',
        color: titleZhEl?.dataset.fontColor || ''
      },
      titleEn: {
        size: titleEnEl?.dataset.fontSize || 'medium',
        weight: titleEnEl?.dataset.fontWeight || 'normal',
        color: titleEnEl?.dataset.fontColor || ''
      }
    };
    
    // æ”¶é›†æ¨™èªæ¨£å¼
    const sloganStyles = [];
    document.querySelectorAll('#previewSlogansZh .tagline, #previewSlogansEn .tagline').forEach((el, idx) => {
      sloganStyles.push({
        index: idx,
        size: el.dataset.fontSize || 'medium',
        weight: el.dataset.fontWeight || 'normal',
        color: el.dataset.fontColor || ''
      });
    });
    
    return {
      lang: currentLang,
      contactLayout: (window.__uvacoContactLayout === 'grid') ? 'grid' : 'list',
      nameZh: nameZhRaw,
      nameEn: nameEnRaw,
      titleZh: titleZhRaw,
      titleEn: titleEnRaw,
      companyCanonical: companyCanonical,
      companyLocked: false, // æ°¸é ä¸é–å®š
      companyZh: (function () {
        // å„ªå…ˆä½¿ç”¨å…¬å¸è³‡è¨Šå€å¡Šçš„å…¬å¸åç¨±æ¬„ä½
        const el = document.getElementById('previewCompanyNameZh');
        if (el && el.textContent.trim()) return el.textContent.trim();
        // Fallback åˆ°æ¨™èª
        const s = getSloganStrong('zh');
        return s ? String(s.textContent || '').trim() : '';
      })(),
      companyEn: (function () {
        // å„ªå…ˆä½¿ç”¨å…¬å¸è³‡è¨Šå€å¡Šçš„å…¬å¸åç¨±æ¬„ä½
        const el = document.getElementById('previewCompanyNameEn');
        if (el && el.textContent.trim()) return el.textContent.trim();
        // Fallback åˆ°æ¨™èª
        const s = getSloganStrong('en');
        return s ? String(s.textContent || '').trim() : '';
      })(),
      theme: theme,
      logoSrc: logoSrcSafe, // base64 (è‹¥å¤ªå¤§å»ºè­°æ”¹ç”¨ uploadMyAsset)
      avatarSrc: avatarSrcSafe,
      // ä¿ç•™ storage path (è‹¥æœ¬æ¬¡æ²’è®Šæ›´åœ–ç‰‡ï¼Œæ²¿ç”¨èˆŠçš„ path)
      logoPath: logoSrcSafe ? '' : (prevPj.logoPath || ''),
      avatarPath: avatarSrcSafe ? '' : (prevPj.avatarPath || ''),
      
      // å­—é«”æ¨£å¼
      fontStyles: fontStyles,
      sloganStyles: sloganStyles,
      
      // HTML Fragments (Cleaned)
      previewCardHtml: card ? card.innerHTML : '',
      contactsHtml: contacts ? getCleanHtmlFragment(contacts) : '',
      companyInfoHtml: companyInfo ? getCleanHtmlFragment(companyInfo) : '',
      slogansZhHtml: slogansZhClean,
      slogansEnHtml: slogansEnClean,
      
      savedAt: new Date().toISOString()
    };
  })();
  console.log('Profile JSON prepared:', profile_json);

  // é›²ç«¯å„²å­˜ï¼šè‹¥æœªè¨­å®š Supabaseï¼Œä»å…è¨±é›¢ç·šå„²å­˜æç¤º
  if (!window.UVACO_CLOUD || !UVACO_CLOUD.hasConfig()) {
    alert(currentLang === 'zh' ? 'åç‰‡å·²å„²å­˜ï¼ˆé›¢ç·šæ¨¡å¼ï¼‰' : 'Saved (offline mode)');
    try { localStorage.setItem('UVACO_ONBOARDED', '1'); } catch (e) {}
    return;
  }

  // éœ€ç™»å…¥
  const here = 'edit.html' + (window.location.search || '');
  const auth = await UVACO_CLOUD.requireAuth(here);
  if (!auth.ok) return;

  // åˆè¦ï¼šé¦–æ¬¡/ç‰ˆæœ¬è®Šæ›´éœ€è¦åŒæ„ï¼ˆä»¥ confirm æœ€å°åŒ– UI è®Šæ›´ï¼‰
  const consentVersion = 'v1.0';
  const policyUrl = (UVACO_CLOUD.getBaseUrl ? UVACO_CLOUD.getBaseUrl() : '') + 'privacy.html';
  const needConfirm = params.get('mode') === 'onboarding';
  
  // å†æ¬¡ç¢ºèª session (ç¢ºä¿ä¸Šè¿° adminMode åˆ¤æ–·æ­£ç¢ºï¼Œè‹¥æœ‰éåŒæ­¥å•é¡Œå¯åœ¨é€™è£¡è£œæ•‘ï¼Œä½† adminModeForCompany å·²ç¶“ç”¨åœ¨ profile_json äº†ï¼Œæ‰€ä»¥ä¸Šé¢çš„åŒæ­¥åˆ¤æ–·æœ€é‡è¦)
  // é€™è£¡ä¸å†é‡è¤‡å®£å‘Š targetUserId å’Œ adminMode
  
  if (needConfirm) {
    const ok = confirm(
      currentLang === 'zh'
        ? 'å„²å­˜å‰è«‹å…ˆåŒæ„éš±ç§æ¬Šæ”¿ç­–ï¼ˆv1.0ï¼‰ã€‚\næŒ‰ã€Œç¢ºå®šã€ä»£è¡¨ä½ å·²é–±è®€ä¸¦åŒæ„ã€‚'
        : 'Please agree to the Privacy Policy (v1.0) before saving.\nClick OK to continue.'
    );
    if (!ok) return;
  }

  try {
    // å¯«å…¥åŒæ„ç´€éŒ„ï¼ˆè‹¥å·²åŒæ„åŒç‰ˆæœ¬å‰‡æœƒç•¥éï¼‰
    await UVACO_CLOUD.ensureConsent(consentVersion, policyUrl);

    // ç®¡ç†å“¡æ¨¡å¼ï¼šä¸æ”¯æ´æ›¿ä»–äººä¸Šå‚³åœ–ç‰‡ï¼ˆStorage è·¯å¾‘èˆ‡æ¬Šé™ä»¥ auth.uid() ç‚ºæº–ï¼‰
    if (adminMode && targetUserId) {
      if (window.__uvacoPendingAssets && (window.__uvacoPendingAssets.logo || window.__uvacoPendingAssets.avatar)) {
        alert(currentLang === 'zh'
          ? 'ç®¡ç†å“¡æ¨¡å¼ç›®å‰ä¸æ”¯æ´æ›¿ä»–äººä¸Šå‚³åœ–ç‰‡ï¼Œè«‹ç”±æœ¬äººç™»å…¥å¾Œæ›´æ–°é ­åƒ/Logoã€‚'
          : 'Admin mode does not support uploading images for other users. Please ask the owner to update avatar/logo.'
        );
        return;
      }
    }

    // åœ–ç‰‡ä¸Šå‚³ï¼šè‹¥æœ‰é¸æ–°åœ–ï¼Œå…ˆä¸Šå‚³åˆ° Supabase Storageï¼Œå†æŠŠ path å¯«å…¥ profile_json
    // åŠ å…¥é‡è©¦æ©Ÿåˆ¶è™•ç†ç¶²è·¯ä¸ç©©å®š
    if (!adminMode && window.__uvacoPendingAssets && (window.__uvacoPendingAssets.logo || window.__uvacoPendingAssets.avatar)) {
      const uploadWithRetry = async (type, asset) => {
        const maxRetries = 3;
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            console.log(`ä¸Šå‚³ ${type} å˜—è©¦ ${attempt}/${maxRetries}...`);
            return await UVACO_CLOUD.uploadMyAsset(type, asset.blob, {
              bucket: 'card-assets',
              ext: asset.ext,
              contentType: asset.contentType
            });
          } catch (e) {
            console.error(`${type} upload failed (attempt ${attempt}/${maxRetries})`, e);
            if (attempt < maxRetries) {
              await new Promise(resolve => setTimeout(resolve, attempt * 1000));
            } else {
              throw e;
            }
          }
        }
      };
      
      try {
        if (window.__uvacoPendingAssets.logo) {
          const up = await uploadWithRetry('logo', window.__uvacoPendingAssets.logo);
          profile_json.logoPath = up.path;
        }
        if (window.__uvacoPendingAssets.avatar) {
          const up = await uploadWithRetry('avatar', window.__uvacoPendingAssets.avatar);
          profile_json.avatarPath = up.path;
        }
        profile_json.assetsUpdatedAt = new Date().toISOString();
      } catch (e) {
        // å¸¸è¦‹åŸå› ï¼šå°šæœªåœ¨ Supabase åŸ·è¡Œ Storage bucket/RLS çš„ SQLï¼ˆcard-assets / storage.objects policiesï¼‰
        console.error('Storage upload failed', e);
        const detail = (e && (e.message || e.error_description)) ? String(e.message || e.error_description) : String(e || '');
        const lower = detail.toLowerCase();
        const status = String(e?.statusCode ?? e?.status ?? '');

        let hintZh = 'åœ–ç‰‡ä¸Šå‚³å¤±æ•—ã€‚';
        let hintEn = 'Image upload failed.';

        if (detail.includes('Bucket not found') || status === '404') {
          hintZh = "åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼šæ‰¾ä¸åˆ° Storage bucket 'card-assets'ã€‚è«‹åˆ° Supabase Dashboard â†’ Storage â†’ Buckets ç¢ºèªå·²å»ºç«‹ 'card-assets'ã€‚";
          hintEn = "Image upload failed: Storage bucket 'card-assets' was not found. Please create/confirm a bucket named 'card-assets' in Supabase Dashboard â†’ Storage â†’ Buckets.";
        } else if (status === '403' || lower.includes('permission') || lower.includes('policy') || lower.includes('not authorized') || lower.includes('unauthorized')) {
          hintZh = "åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼šStorage æ¬Šé™ä¸è¶³ï¼ˆRLS policy deniedï¼‰ã€‚è«‹ç¢ºèªä½ å‰›å‰›å·²åœ¨ Storage â†’ Policies é‡å° 'card-assets' å»ºç«‹ SELECT/INSERT/UPDATE/DELETE å››æ¢ policiesï¼Œä¸” INSERT/UPDATE/DELETE é™åˆ¶ç‚ºè‡ªå·±çš„è·¯å¾‘ auth.uid()/...ã€‚";
          hintEn = "Image upload failed: Storage permission denied (RLS policy). Please ensure you created the 4 policies (SELECT/INSERT/UPDATE/DELETE) for 'card-assets', and INSERT/UPDATE/DELETE are restricted to auth.uid()/... paths.";
        } else if (lower.includes('jwt') || lower.includes('token') || lower.includes('session')) {
          hintZh = 'åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼šç™»å…¥ç‹€æ…‹å¯èƒ½å·²å¤±æ•ˆï¼Œè«‹é‡æ–°ç™»å…¥å¾Œå†è©¦ä¸€æ¬¡ã€‚';
          hintEn = 'Image upload failed: session may be expired. Please re-login and try again.';
        }

        alert(currentLang === 'zh'
          ? `${hintZh}\n\nç´°ç¯€ï¼š${detail}`
          : `${hintEn}\n\nDetail: ${detail}`
        );
        return;
      }
    }

    // é‡è©¦æ©Ÿåˆ¶ï¼šæœ€å¤šå˜—è©¦ 3 æ¬¡
    const maxRetries = 3;
    let lastError = null;
    
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        console.log(`å„²å­˜å˜—è©¦ ${attempt}/${maxRetries}...`);
        
        if (adminMode && targetUserId) {
          console.log('Calling adminUpdateCard...', targetUserId);
          await UVACO_CLOUD.adminUpdateCard(targetUserId, { name, phone, email, company, title, theme, profile_json });
        } else {
          console.log('Calling upsertMyCard...');
          await UVACO_CLOUD.upsertMyCard({ name, phone, email, company, title, theme, profile_json });
        }
        console.log('Database write successful.');
        lastError = null;
        break; // æˆåŠŸï¼Œè·³å‡ºé‡è©¦è¿´åœˆ
      } catch (e) {
        lastError = e;
        console.error(`Card upsert failed (attempt ${attempt}/${maxRetries})`, e);
        
        if (attempt < maxRetries) {
          // ç­‰å¾…å¾Œé‡è©¦ï¼ˆæŒ‡æ•¸é€€é¿ï¼š1ç§’ã€2ç§’ï¼‰
          const waitTime = attempt * 1000;
          console.log(`ç­‰å¾… ${waitTime}ms å¾Œé‡è©¦...`);
          await new Promise(resolve => setTimeout(resolve, waitTime));
        }
      }
    }
    
    if (lastError) {
      const detail = (lastError && (lastError.message || lastError.error_description)) 
        ? (lastError.message || lastError.error_description) : '';
      const code = lastError?.code || '';
      
      // æª¢æŸ¥æ˜¯å¦ç‚º JWT éæœŸéŒ¯èª¤
      const isAuthError = 
        code === 'PGRST303' ||
        (detail && (detail.includes('JWT expired') || detail.includes('JWT')));
      
      if (isAuthError) {
        alert(currentLang === 'zh'
          ? 'ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥ã€‚'
          : 'Session expired. Please log in again.'
        );
        const returnUrl = encodeURIComponent(location.pathname + location.search);
        window.location.href = 'auth.html?next=' + returnUrl;
        return;
      }
      
      alert(currentLang === 'zh'
        ? `åç‰‡å¯«å…¥è³‡æ–™åº«å¤±æ•—ï¼ˆå·²é‡è©¦ ${maxRetries} æ¬¡ï¼‰ï¼š\n${detail}\n\nè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œå†è©¦ã€‚`
        : `Failed to write card to database (retried ${maxRetries} times):\n${detail}\n\nPlease check your network connection.`
      );
      return;
    }

    if (adminMode && targetUserId) {
      alert(currentLang === 'zh' ? 'ç®¡ç†å“¡ï¼šåç‰‡å·²æ›´æ–°ï¼' : 'Admin: card updated!');
      setTimeout(() => {
        window.location.href = 'admin.html';
      }, 200);
    } else {
      alert(currentLang === 'zh' ? 'åç‰‡å·²å„²å­˜ï¼å³å°‡å‰å¾€é è¦½é é¢...' : 'Business card saved! Redirecting to preview...');
      try { localStorage.setItem('UVACO_ONBOARDED', '1'); } catch (e) {}
      setTimeout(() => {
        // å„²å­˜å¾Œä¸€å¾‹å°å‘ã€Œæˆ‘çš„åç‰‡ã€ï¼šcard.html?id=<ç›®å‰ç™»å…¥è€…>
        // éœ€æ±‚ï¼šé¿å… next åƒæ•¸æŠŠä½¿ç”¨è€…å¸¶å› edit.html æˆ–å…¶ä»–é ï¼Œé€ æˆã€Œå„²å­˜å¾Œåˆå›ç·¨è¼¯é ã€çš„å›°æƒ‘ã€‚
        (async function () {
          try {
            const s = await UVACO_CLOUD.getSession();
            const uid = s && s.session && s.session.user ? s.session.user.id : '';
            if (uid) {
              // åŠ å…¥æ™‚é–“æˆ³è¨˜å¼·åˆ¶åˆ·æ–°ï¼Œé¿å… card.html è®€åˆ°å¿«å–
              window.location.href = 'card.html?id=' + encodeURIComponent(uid) + '&t=' + Date.now();
              return;
            }
          } catch (e) {}
          // æœ€å¾Œé€€å›ï¼šé€šè¨ŠéŒ„
          window.location.href = 'directory.html';
        })();
      }, 500);
    }
  } catch (e) {
    console.error('saveCard failed', e);
    const detail = (e && (e.message || e.error_description)) ? (e.message || e.error_description) : '';
    const code = e?.code || '';
    const reason = e?.reason || '';
    
    // æª¢æŸ¥æ˜¯å¦ç‚º JWT éæœŸæˆ–ç™»å…¥å¤±æ•ˆ
    const isAuthError = 
      reason === 'JWT_EXPIRED' ||
      reason === 'NO_SESSION' ||
      code === 'PGRST303' ||
      (detail && (detail.includes('JWT expired') || detail.includes('JWT')));
    
    if (isAuthError) {
      alert(currentLang === 'zh'
        ? 'ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥ã€‚'
        : 'Session expired. Please log in again.'
      );
      // å°å‘ç™»å…¥é ï¼Œä¸¦å¸¶ä¸Šè¿”å›ç¶²å€
      const returnUrl = encodeURIComponent(location.pathname + location.search);
      window.location.href = 'auth.html?next=' + returnUrl;
      return;
    }
    
    alert(currentLang === 'zh'
      ? `å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\n${detail}`
      : `Save failed. Please try again.\n${detail}`
    );
  }
}


// ============= é¦–æ¬¡ä½¿ç”¨æ•™å­¸ (Onboarding) =============
function checkOnboarding() {
  try {
    // å¦‚æœå·²ç¶“å®Œæˆéæ•™å­¸ï¼Œä¸å†é¡¯ç¤º
    if (localStorage.getItem('UVACO_ONBOARDED') === '1') return;
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°ç”¨æˆ¶ï¼ˆåç‰‡å°šæœªå¡«å¯«ï¼‰
    const nameZh = document.getElementById('previewNameZh')?.textContent?.trim();
    const nameEn = document.getElementById('previewNameEn')?.textContent?.trim();
    
    // å¦‚æœåå­—æ˜¯é è¨­å€¼æˆ–ç‚ºç©ºï¼Œè¦–ç‚ºæ–°ç”¨æˆ¶
    if (!nameZh || nameZh === '-' || nameZh === 'æ‚¨çš„å§“å') {
      setTimeout(showOnboardingModal, 800);
    }
  } catch (e) {
    console.log('[Onboarding] æª¢æŸ¥å¤±æ•—:', e);
  }
}

function showOnboardingModal() {
  const modal = document.getElementById('onboardingModal');
  if (modal) {
    modal.style.display = 'flex';
  }
}

function closeOnboarding() {
  const modal = document.getElementById('onboardingModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

function skipOnboarding() {
  try {
    localStorage.setItem('UVACO_ONBOARDED', '1');
  } catch (e) {}
  closeOnboarding();
}

function startOnboardingGuide() {
  closeOnboarding();
  // èšç„¦åˆ°å§“åæ¬„ä½
  const nameField = document.querySelector('[contenteditable][id*="Name"]') || 
                    document.querySelector('.editable-text');
  if (nameField) {
    nameField.focus();
    // é¡¯ç¤ºæç¤º
    showOnboardingTip('name');
  }
}

let currentTip = null;
function showOnboardingTip(step) {
  // ç§»é™¤èˆŠæç¤º
  if (currentTip) currentTip.remove();
  
  const tips = {
    name: { text: 'ğŸ‘‹ å…ˆå¡«å¯«æ‚¨çš„å§“å', target: '.name' },
    title: { text: 'âœï¸ å¡«å¯«æ‚¨çš„è·ç¨±', target: '.tagline' },
    theme: { text: 'ğŸ¨ é»æ“Šé¸æ“‡å–œæ­¡çš„ä¸»é¡Œ', target: '.edit-top-header button' },
    save: { text: 'ğŸ’¾ å®Œæˆå¾Œé»æ“Šå„²å­˜', target: '.edit-save-btn' }
  };
  
  const tip = tips[step];
  if (!tip) return;
  
  const target = document.querySelector(tip.target);
  if (!target) return;
  
  const tipEl = document.createElement('div');
  tipEl.className = 'onboarding-tip';
  tipEl.innerHTML = tip.text;
  tipEl.style.cssText = `
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--uvaco-green);
    color: white;
    padding: 12px 20px;
    border-radius: 24px;
    font-size: 14px;
    font-weight: 600;
    z-index: 9999;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    animation: tipBounce 0.5s ease;
  `;
  document.body.appendChild(tipEl);
  currentTip = tipEl;
  
  // 5 ç§’å¾Œè‡ªå‹•ç§»é™¤
  setTimeout(() => {
    if (tipEl.parentNode) tipEl.remove();
  }, 5000);
}

// é é¢è¼‰å…¥å¾Œæª¢æŸ¥æ˜¯å¦éœ€è¦é¡¯ç¤ºæ•™å­¸
setTimeout(checkOnboarding, 1500);
</script>

<!-- é¦–æ¬¡ä½¿ç”¨æ•™å­¸å½ˆçª— -->
<div id="onboardingModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:9998;align-items:center;justify-content:center;padding:20px;">
  <div style="background:var(--ui-surface-bg, #1a1a1a);border:1px solid var(--ui-surface-border, rgba(255,255,255,0.1));border-radius:20px;padding:32px 28px;max-width:400px;width:100%;text-align:center;">
    <!-- æ­¡è¿åœ–ç¤º -->
    <div style="font-size:48px;margin-bottom:16px;">ğŸ‰</div>
    
    <!-- æ¨™é¡Œ -->
    <h2 style="color:var(--uvaco-green);font-size:22px;font-weight:800;margin-bottom:12px;">
      <span class="lang-zh">æ­¡è¿ä½¿ç”¨æ•¸ä½åç‰‡ï¼</span>
      <span class="lang-en">Welcome to Digital Card!</span>
    </h2>
    
    <!-- èªªæ˜ -->
    <p style="color:var(--ui-muted, #9ca3af);font-size:14px;line-height:1.7;margin-bottom:24px;">
      <span class="lang-zh">åªéœ€ 3 å€‹æ­¥é©Ÿï¼Œå³å¯å»ºç«‹æ‚¨çš„å°ˆå±¬é›»å­åç‰‡</span>
      <span class="lang-en">Create your digital business card in just 3 steps</span>
    </p>
    
    <!-- æ­¥é©Ÿåˆ—è¡¨ -->
    <div style="text-align:left;margin-bottom:28px;">
      <div style="display:flex;align-items:flex-start;gap:14px;margin-bottom:16px;">
        <span style="width:28px;height:28px;min-width:28px;background:var(--uvaco-green);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;">1</span>
        <div>
          <div style="color:var(--ui-text, #fff);font-weight:600;font-size:14px;">
            <span class="lang-zh">å¡«å¯«åŸºæœ¬è³‡æ–™</span>
            <span class="lang-en">Enter Basic Info</span>
          </div>
          <div style="color:var(--ui-muted, #9ca3af);font-size:12px;">
            <span class="lang-zh">å§“åã€è·ç¨±ã€è¯çµ¡æ–¹å¼</span>
            <span class="lang-en">Name, title, contact info</span>
          </div>
        </div>
      </div>
      
      <div style="display:flex;align-items:flex-start;gap:14px;margin-bottom:16px;">
        <span style="width:28px;height:28px;min-width:28px;background:var(--uvaco-green);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;">2</span>
        <div>
          <div style="color:var(--ui-text, #fff);font-weight:600;font-size:14px;">
            <span class="lang-zh">é¸æ“‡åç‰‡ä¸»é¡Œ</span>
            <span class="lang-en">Choose Theme</span>
          </div>
          <div style="color:var(--ui-muted, #9ca3af);font-size:12px;">
            <span class="lang-zh">9 ç¨®ç²¾ç¾ä¸»é¡Œä»»æ‚¨æŒ‘é¸</span>
            <span class="lang-en">9 beautiful themes to choose</span>
          </div>
        </div>
      </div>
      
      <div style="display:flex;align-items:flex-start;gap:14px;">
        <span style="width:28px;height:28px;min-width:28px;background:var(--uvaco-green);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;">3</span>
        <div>
          <div style="color:var(--ui-text, #fff);font-weight:600;font-size:14px;">
            <span class="lang-zh">å„²å­˜ä¸¦åˆ†äº«</span>
            <span class="lang-en">Save & Share</span>
          </div>
          <div style="color:var(--ui-muted, #9ca3af);font-size:12px;">
            <span class="lang-zh">ä½¿ç”¨ NFC æˆ– QR Code åˆ†äº«</span>
            <span class="lang-en">Share via NFC or QR Code</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æŒ‰éˆ• -->
    <button onclick="startOnboardingGuide()" style="width:100%;padding:14px;background:var(--uvaco-green);color:white;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;margin-bottom:12px;">
      <span class="lang-zh">é–‹å§‹å»ºç«‹åç‰‡</span>
      <span class="lang-en">Start Creating</span>
    </button>
    <button onclick="skipOnboarding()" style="width:100%;padding:12px;background:transparent;color:var(--ui-muted, #9ca3af);border:1px solid var(--ui-surface-border, rgba(255,255,255,0.1));border-radius:12px;font-size:14px;cursor:pointer;">
      <span class="lang-zh">æˆ‘å·²ç¶“çŸ¥é“äº†</span>
      <span class="lang-en">I already know</span>
    </button>
  </div>
</div>

<!-- ===== æ–°å®¢æˆ¶æ­¥é©Ÿå¼•å°ç²¾éˆ ===== -->
<div id="wizardModal" class="wizard-overlay">
  <div class="wizard-container">
    <!-- é—œé–‰æŒ‰éˆ• -->
    <button class="wizard-close" onclick="closeWizard()">Ã—</button>
    
    <!-- æ­¥é©Ÿé€²åº¦æŒ‡ç¤ºå™¨ -->
    <div class="wizard-progress">
      <div class="wizard-progress-step active" data-step="1">
        <div class="wizard-step-circle">1</div>
        <div class="wizard-step-label">
          <span class="lang-zh">åŸºæœ¬è³‡æ–™</span>
          <span class="lang-en">Basic Info</span>
        </div>
      </div>
      <div class="wizard-progress-line"></div>
      <div class="wizard-progress-step" data-step="2">
        <div class="wizard-step-circle">2</div>
        <div class="wizard-step-label">
          <span class="lang-zh">é ­åƒ</span>
          <span class="lang-en">Avatar</span>
        </div>
      </div>
      <div class="wizard-progress-line"></div>
      <div class="wizard-progress-step" data-step="3">
        <div class="wizard-step-circle">3</div>
        <div class="wizard-step-label">
          <span class="lang-zh">è¯çµ¡æ–¹å¼</span>
          <span class="lang-en">Contact</span>
        </div>
      </div>
      <div class="wizard-progress-line"></div>
      <div class="wizard-progress-step" data-step="4">
        <div class="wizard-step-circle">4</div>
        <div class="wizard-step-label">
          <span class="lang-zh">ä¸»é¡Œ</span>
          <span class="lang-en">Theme</span>
        </div>
      </div>
      <div class="wizard-progress-line"></div>
      <div class="wizard-progress-step" data-step="5">
        <div class="wizard-step-circle">5</div>
        <div class="wizard-step-label">
          <span class="lang-zh">å®Œæˆ</span>
          <span class="lang-en">Done</span>
        </div>
      </div>
    </div>
    
    <!-- æ­¥é©Ÿå…§å®¹å€åŸŸ -->
    <div class="wizard-steps-container">
      <!-- æ­¥é©Ÿ 1ï¼šåŸºæœ¬è³‡æ–™ -->
      <div class="wizard-step active" data-step="1">
        <div class="wizard-step-header">
          <h2 class="wizard-step-title">
            <span class="lang-zh">å¡«å¯«åŸºæœ¬è³‡æ–™</span>
            <span class="lang-en">Enter Basic Information</span>
          </h2>
          <p class="wizard-step-desc">
            <span class="lang-zh">è«‹å¡«å¯«æ‚¨çš„å§“åå’Œè·ç¨±ï¼Œé€™å°‡é¡¯ç¤ºåœ¨åç‰‡ä¸Š</span>
            <span class="lang-en">Please enter your name and title for your business card</span>
          </p>
        </div>
        
        <div class="wizard-form">
          <div class="wizard-form-group">
            <label class="wizard-label">
              <span class="lang-zh">ä¸­æ–‡å§“å</span>
              <span class="lang-en">Chinese Name</span>
            </label>
            <input type="text" class="wizard-input" id="wizardNameZh" placeholder="ä¾‹ï¼šç‹å°æ˜ï½œKevin Wang">
            <div class="wizard-hint">
              <span class="lang-zh">æ ¼å¼å»ºè­°ï¼šä¸­æ–‡åï½œè‹±æ–‡åï¼ˆä¾‹ï¼šç‹å°æ˜ï½œKevin Wangï¼‰</span>
              <span class="lang-en">Suggested format: Chinese Name | English Name</span>
            </div>
          </div>
          
          <div class="wizard-form-group">
            <label class="wizard-label">
              <span class="lang-zh">è·ç¨±ï¼ˆä¸­æ–‡ï¼‰</span>
              <span class="lang-en">Title (Chinese)</span>
            </label>
            <input type="text" class="wizard-input" id="wizardTitleZh" placeholder="ä¾‹ï¼šæ¥­å‹™ç¶“ç†">
          </div>
          
          <div class="wizard-form-group">
            <label class="wizard-label">
              <span class="lang-zh">è·ç¨±ï¼ˆè‹±æ–‡ï¼‰</span>
              <span class="lang-en">Title (English)</span>
            </label>
            <input type="text" class="wizard-input" id="wizardTitleEn" placeholder="e.g. Sales Manager">
          </div>
        </div>
      </div>
      
      <!-- æ­¥é©Ÿ 2ï¼šä¸Šå‚³é ­åƒ -->
      <div class="wizard-step" data-step="2">
        <div class="wizard-step-header">
          <h2 class="wizard-step-title">
            <span class="lang-zh">ä¸Šå‚³é ­åƒç…§ç‰‡</span>
            <span class="lang-en">Upload Your Photo</span>
          </h2>
          <p class="wizard-step-desc">
            <span class="lang-zh">ä¸Šå‚³ä¸€å¼µå°ˆæ¥­çš„å€‹äººç…§ç‰‡ï¼Œè®“æ‚¨çš„åç‰‡æ›´åŠ å€‹äººåŒ–</span>
            <span class="lang-en">Upload a professional photo to personalize your card</span>
          </p>
        </div>
        
        <div class="wizard-avatar-section">
          <div class="wizard-avatar-preview" id="wizardAvatarPreview" onclick="wizardSelectAvatar()">
            <img src="" alt="Avatar" id="wizardAvatarImg" style="display: none;">
            <div class="wizard-avatar-placeholder" id="wizardAvatarPlaceholder" style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; color: rgba(255,255,255,0.6);">
              <span style="font-size: 48px; margin-bottom: 8px;">ğŸ‘¤</span>
              <span class="lang-zh" style="font-size: 14px;">é»æ“Šä¸Šå‚³é ­åƒ</span>
              <span class="lang-en" style="font-size: 14px;">Click to Upload</span>
            </div>
            <div class="wizard-avatar-overlay" style="display: none;">
              <span class="lang-zh">é»æ“Šæ›´æ›</span>
              <span class="lang-en">Click to Change</span>
            </div>
          </div>
          <input type="file" id="wizardAvatarInput" accept="image/*" style="display:none" onchange="wizardHandleAvatarUpload(event)">
          <div class="wizard-avatar-tips">
            <div class="lang-zh">
              <p>ğŸ“· å»ºè­°ä½¿ç”¨æ­£é¢æ¸…æ™°çš„ç…§ç‰‡</p>
              <p>ğŸ“ å»ºè­°å°ºå¯¸ï¼šæ­£æ–¹å½¢ï¼ˆ1:1 æ¯”ä¾‹ï¼‰</p>
              <p>ğŸ’¾ æ”¯æ´æ ¼å¼ï¼šJPGã€PNGã€GIF</p>
            </div>
            <div class="lang-en">
              <p>ğŸ“· Use a clear front-facing photo</p>
              <p>ğŸ“ Recommended: Square ratio (1:1)</p>
              <p>ğŸ’¾ Formats: JPG, PNG, GIF</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- æ­¥é©Ÿ 3ï¼šè¯çµ¡æ–¹å¼ -->
      <div class="wizard-step" data-step="3">
        <div class="wizard-step-header">
          <h2 class="wizard-step-title">
            <span class="lang-zh">æ–°å¢è¯çµ¡æ–¹å¼</span>
            <span class="lang-en">Add Contact Methods</span>
          </h2>
          <p class="wizard-step-desc">
            <span class="lang-zh">æ–°å¢æ‚¨å¸Œæœ›åœ¨åç‰‡ä¸Šé¡¯ç¤ºçš„è¯çµ¡æ–¹å¼</span>
            <span class="lang-en">Add contact methods you want to display on your card</span>
          </p>
        </div>
        
        <div class="wizard-contact-section">
          <!-- é›»è©± -->
          <div class="wizard-contact-item">
            <div class="wizard-contact-icon">ğŸ“</div>
            <div class="wizard-contact-content">
              <label class="wizard-label">
                <span class="lang-zh">é›»è©±è™Ÿç¢¼</span>
                <span class="lang-en">Phone Number</span>
              </label>
              <input type="tel" class="wizard-input" id="wizardPhone" placeholder="ä¾‹ï¼š0912-345-678">
              <div class="wizard-hint">
                <span class="lang-zh">æ ¼å¼ï¼š0912-345-678 æˆ– 09xx-xxx-xxx</span>
                <span class="lang-en">Format: 0912-345-678</span>
              </div>
            </div>
          </div>
          
          <!-- LINE -->
          <div class="wizard-contact-item">
            <div class="wizard-contact-icon"><img src="line-logo.svg" alt="LINE" style="width:24px;height:24px;"></div>
            <div class="wizard-contact-content">
              <label class="wizard-label">
                <span class="lang-zh">LINE å€‹äººé€£çµ</span>
                <span class="lang-en">LINE Profile Link</span>
              </label>
              <input type="text" class="wizard-input" id="wizardLine" placeholder="https://line.me/ti/p/xxxxxxxx">
              <div class="wizard-line-guide">
                <div class="wizard-line-guide-title">
                  <span class="lang-zh">ğŸ“± å¦‚ä½•å–å¾— LINE å€‹äººé€£çµï¼š</span>
                  <span class="lang-en">ğŸ“± How to get your LINE link:</span>
                </div>
                <div class="wizard-line-steps">
                  <div class="wizard-line-step">
                    <span class="step-num">1</span>
                    <span class="lang-zh">é–‹å•Ÿ LINE App â†’ é»æ“Šã€Œä¸»é ã€</span>
                    <span class="lang-en">Open LINE App â†’ Tap "Home"</span>
                  </div>
                  <div class="wizard-line-step">
                    <span class="step-num">2</span>
                    <span class="lang-zh">é»æ“Šå³ä¸Šè§’ã€Œè¨­å®šã€âš™ï¸</span>
                    <span class="lang-en">Tap "Settings" âš™ï¸ (top right)</span>
                  </div>
                  <div class="wizard-line-step">
                    <span class="step-num">3</span>
                    <span class="lang-zh">é»æ“Šã€Œå€‹äººæª”æ¡ˆã€</span>
                    <span class="lang-en">Tap "Profile"</span>
                  </div>
                  <div class="wizard-line-step">
                    <span class="step-num">4</span>
                    <span class="lang-zh">é»æ“Šã€Œé¡¯ç¤ºè¡Œå‹•æ¢ç¢¼ã€</span>
                    <span class="lang-en">Tap "Show QR Code"</span>
                  </div>
                  <div class="wizard-line-step">
                    <span class="step-num">5</span>
                    <span class="lang-zh">é»æ“Šã€Œåˆ†äº«ã€â†’ã€Œè¤‡è£½é€£çµã€</span>
                    <span class="lang-en">Tap "Share" â†’ "Copy Link"</span>
                  </div>
                </div>
                <div class="wizard-line-example">
                  <span class="lang-zh">é€£çµæ ¼å¼ï¼š</span>
                  <span class="lang-en">Link format:</span>
                  <code>https://line.me/ti/p/7QENOpjTy5</code>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Email -->
          <div class="wizard-contact-item">
            <div class="wizard-contact-icon">âœ‰ï¸</div>
            <div class="wizard-contact-content">
              <label class="wizard-label">
                <span class="lang-zh">Email</span>
                <span class="lang-en">Email</span>
              </label>
              <input type="email" class="wizard-input" id="wizardEmail" placeholder="ä¾‹ï¼šyourname@email.com">
            </div>
          </div>
        </div>
      </div>
      
      <!-- æ­¥é©Ÿ 4ï¼šé¸æ“‡ä¸»é¡Œ -->
      <div class="wizard-step" data-step="4">
        <div class="wizard-step-header">
          <h2 class="wizard-step-title">
            <span class="lang-zh">é¸æ“‡åç‰‡ä¸»é¡Œ</span>
            <span class="lang-en">Choose Card Theme</span>
          </h2>
          <p class="wizard-step-desc">
            <span class="lang-zh">é¸æ“‡ä¸€å€‹æ‚¨å–œæ­¡çš„ä¸»é¡Œé¢¨æ ¼</span>
            <span class="lang-en">Select a theme style you like</span>
          </p>
        </div>
        
        <div class="wizard-theme-grid" id="wizardThemeGrid">
          <div class="wizard-theme-item active" data-theme="1" onclick="wizardSelectTheme(1)">
            <div class="wizard-theme-preview" style="background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);"></div>
            <span class="lang-zh">ç¶“å…¸é»‘</span>
            <span class="lang-en">Classic Black</span>
          </div>
          <div class="wizard-theme-item" data-theme="2" onclick="wizardSelectTheme(2)">
            <div class="wizard-theme-preview" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);"></div>
            <span class="lang-zh">å•†å‹™è—</span>
            <span class="lang-en">Business Blue</span>
          </div>
          <div class="wizard-theme-item" data-theme="3" onclick="wizardSelectTheme(3)">
            <div class="wizard-theme-preview" style="background: linear-gradient(135deg, #2d4a3e 0%, #3d6a54 100%);"></div>
            <span class="lang-zh">è‡ªç„¶ç¶ </span>
            <span class="lang-en">Nature Green</span>
          </div>
          <div class="wizard-theme-item" data-theme="4" onclick="wizardSelectTheme(4)">
            <div class="wizard-theme-preview" style="background: linear-gradient(135deg, #4a2d5f 0%, #6a3d7f 100%);"></div>
            <span class="lang-zh">å„ªé›…ç´«</span>
            <span class="lang-en">Elegant Purple</span>
          </div>
          <div class="wizard-theme-item" data-theme="5" onclick="wizardSelectTheme(5)">
            <div class="wizard-theme-preview" style="background: linear-gradient(135deg, #5f3a1e 0%, #8a5a2d 100%);"></div>
            <span class="lang-zh">æš–æ£•</span>
            <span class="lang-en">Warm Brown</span>
          </div>
          <div class="wizard-theme-item" data-theme="6" onclick="wizardSelectTheme(6)">
            <div class="wizard-theme-preview" style="background: linear-gradient(135deg, #5f1e3a 0%, #8a2d5a 100%);"></div>
            <span class="lang-zh">ç«ç‘°ç´…</span>
            <span class="lang-en">Rose Red</span>
          </div>
          <div class="wizard-theme-item" data-theme="7" onclick="wizardSelectTheme(7)">
            <div class="wizard-theme-preview" style="background: linear-gradient(135deg, #1e4a5f 0%, #2d6a87 100%);"></div>
            <span class="lang-zh">æµ·æ´‹è—</span>
            <span class="lang-en">Ocean Blue</span>
          </div>
          <div class="wizard-theme-item" data-theme="8" onclick="wizardSelectTheme(8)">
            <div class="wizard-theme-preview" style="background: linear-gradient(135deg, #4a4a1e 0%, #6a6a2d 100%);"></div>
            <span class="lang-zh">æ©„æ¬–é‡‘</span>
            <span class="lang-en">Olive Gold</span>
          </div>
          <div class="wizard-theme-item" data-theme="9" onclick="wizardSelectTheme(9)">
            <div class="wizard-theme-preview" style="background: linear-gradient(135deg, #3a3a3a 0%, #5a5a5a 100%);"></div>
            <span class="lang-zh">éŠ€ç°</span>
            <span class="lang-en">Silver Gray</span>
          </div>
        </div>
      </div>
      
      <!-- æ­¥é©Ÿ 5ï¼šå®Œæˆ -->
      <div class="wizard-step" data-step="5">
        <div class="wizard-step-header">
          <h2 class="wizard-step-title">
            <span class="lang-zh">ğŸ‰ åç‰‡å»ºç«‹å®Œæˆï¼</span>
            <span class="lang-en">ğŸ‰ Card Created!</span>
          </h2>
          <p class="wizard-step-desc">
            <span class="lang-zh">æ‚¨çš„åç‰‡å·²æº–å‚™å°±ç·’ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•å®Œæˆè¨­å®š</span>
            <span class="lang-en">Your card is ready. Click below to finish setup</span>
          </p>
        </div>
        
        <div class="wizard-complete-section">
          <div class="wizard-complete-preview" id="wizardCompletePreview">
            <div class="wizard-preview-card">
              <div class="wizard-preview-avatar">
                <img src="" alt="Avatar" id="wizardPreviewAvatar" style="display: none;">
                <div id="wizardPreviewAvatarPlaceholder" style="width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 32px;">ğŸ‘¤</div>
              </div>
              <div class="wizard-preview-name" id="wizardPreviewName" style="color: rgba(255,255,255,0.4); font-style: italic;">ï¼ˆå§“åï¼‰</div>
              <div class="wizard-preview-title" id="wizardPreviewTitle" style="color: rgba(255,255,255,0.4); font-style: italic;">ï¼ˆè·ç¨±ï¼‰</div>
              <div class="wizard-preview-contacts" id="wizardPreviewContacts"></div>
            </div>
          </div>
          
          <div class="wizard-complete-tips">
            <div class="lang-zh">
              <p>âœ… å®Œæˆå¾Œæ‚¨å¯ä»¥éš¨æ™‚åœ¨ç·¨è¼¯é é¢ä¿®æ”¹åç‰‡å…§å®¹</p>
              <p>âœ… ä½¿ç”¨ NFC æˆ– QR Code åˆ†äº«æ‚¨çš„åç‰‡</p>
            </div>
            <div class="lang-en">
              <p>âœ… You can edit your card anytime after completion</p>
              <p>âœ… Share your card via NFC or QR Code</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- å°èˆªæŒ‰éˆ• -->
    <div class="wizard-nav">
      <button class="wizard-btn wizard-btn-prev" id="wizardPrevBtn" onclick="wizardPrev()" style="visibility: hidden;">
        <span class="lang-zh">ä¸Šä¸€æ­¥</span>
        <span class="lang-en">Previous</span>
      </button>
      <button class="wizard-btn wizard-btn-next" id="wizardNextBtn" onclick="wizardNext()">
        <span class="lang-zh">ä¸‹ä¸€æ­¥</span>
        <span class="lang-en">Next</span>
      </button>
      <button class="wizard-btn wizard-btn-finish" id="wizardFinishBtn" onclick="finishWizard()" style="display: none;">
        <span class="lang-zh">å®Œæˆå»ºç«‹</span>
        <span class="lang-en">Finish</span>
      </button>
    </div>
  </div>
</div>

<style>
@keyframes tipBounce {
  0%, 100% { transform: translateX(-50%) translateY(0); }
  50% { transform: translateX(-50%) translateY(-8px); }
}

/* ===== æ­¥é©Ÿå¼•å°ç²¾éˆæ¨£å¼ ===== */
.wizard-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.92);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  padding: 16px;
  overflow-y: auto;
}

.wizard-overlay.show {
  display: flex;
}

.wizard-container {
  background: var(--ui-surface-bg, #1a1a1a);
  border: 1px solid var(--ui-surface-border, rgba(255,255,255,0.1));
  border-radius: 24px;
  width: 100%;
  max-width: 520px;
  max-height: 90vh;
  overflow-y: auto;
  padding: 28px 24px;
  position: relative;
  animation: wizardSlideUp 0.4s ease;
}

@keyframes wizardSlideUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

.wizard-close {
  position: absolute;
  top: 16px;
  right: 16px;
  width: 32px;
  height: 32px;
  border: none;
  background: var(--ui-btn-muted-bg, rgba(255,255,255,0.1));
  color: var(--ui-muted, #9ca3af);
  border-radius: 50%;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.wizard-close:hover {
  background: var(--ui-btn-muted-bg-hover, rgba(255,255,255,0.15));
  color: var(--ui-text, #fff);
}

/* æ­¥é©Ÿé€²åº¦æŒ‡ç¤ºå™¨ */
.wizard-progress {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 28px;
  padding: 0 8px;
}

.wizard-progress-step {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
}

.wizard-step-circle {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--ui-btn-muted-bg, rgba(255,255,255,0.1));
  color: var(--ui-muted, #9ca3af);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 700;
  transition: all 0.3s;
}

.wizard-progress-step.active .wizard-step-circle,
.wizard-progress-step.completed .wizard-step-circle {
  background: var(--uvaco-green, #00c853);
  color: #fff;
}

.wizard-progress-step.completed .wizard-step-circle::after {
  content: 'âœ“';
}

.wizard-step-label {
  font-size: 11px;
  color: var(--ui-muted, #9ca3af);
  text-align: center;
  transition: color 0.3s;
}

.wizard-progress-step.active .wizard-step-label {
  color: var(--uvaco-green, #00c853);
  font-weight: 600;
}

.wizard-progress-line {
  flex: 1;
  height: 2px;
  background: var(--ui-btn-muted-bg, rgba(255,255,255,0.1));
  margin: 0 8px;
  margin-bottom: 20px;
  transition: background 0.3s;
}

.wizard-progress-step.completed + .wizard-progress-line {
  background: var(--uvaco-green, #00c853);
}

/* æ­¥é©Ÿå…§å®¹å€åŸŸ */
.wizard-steps-container {
  min-height: 320px;
}

.wizard-step {
  display: none;
  animation: wizardFadeIn 0.3s ease;
}

.wizard-step.active {
  display: block;
}

@keyframes wizardFadeIn {
  from { opacity: 0; transform: translateX(20px); }
  to { opacity: 1; transform: translateX(0); }
}

.wizard-step-header {
  text-align: center;
  margin-bottom: 24px;
}

.wizard-step-title {
  font-size: 22px;
  font-weight: 800;
  color: var(--uvaco-green, #00c853);
  margin-bottom: 8px;
}

.wizard-step-desc {
  font-size: 14px;
  color: var(--ui-muted, #9ca3af);
  line-height: 1.5;
}

/* è¡¨å–®æ¨£å¼ */
.wizard-form {
  display: flex;
  flex-direction: column;
  gap: 18px;
}

.wizard-form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.wizard-label {
  font-size: 13px;
  font-weight: 600;
  color: var(--ui-text, #fff);
}

.wizard-input {
  width: 100%;
  padding: 12px 16px;
  border-radius: 12px;
  border: 1px solid var(--ui-field-border, rgba(255,255,255,0.15));
  background: var(--ui-field-bg, rgba(255,255,255,0.05));
  color: var(--ui-text, #fff);
  font-size: 15px;
  transition: all 0.2s;
  box-sizing: border-box;
}

.wizard-input:focus {
  outline: none;
  border-color: var(--uvaco-green, #00c853);
  box-shadow: 0 0 0 3px rgba(0, 200, 83, 0.15);
}

.wizard-input::placeholder {
  color: var(--ui-muted, #9ca3af);
  opacity: 0.7;
}

.wizard-hint {
  font-size: 12px;
  color: var(--ui-muted, #9ca3af);
  opacity: 0.8;
}

/* é ­åƒä¸Šå‚³å€åŸŸ */
.wizard-avatar-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
}

.wizard-avatar-preview {
  width: 140px;
  height: 140px;
  border-radius: 50%;
  overflow: hidden;
  position: relative;
  cursor: pointer;
  border: 3px solid var(--uvaco-green, #00c853);
  transition: transform 0.2s;
}

.wizard-avatar-preview:hover {
  transform: scale(1.05);
}

.wizard-avatar-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.wizard-avatar-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 13px;
  font-weight: 600;
  opacity: 0;
  transition: opacity 0.2s;
}

.wizard-avatar-preview:hover .wizard-avatar-overlay {
  opacity: 1;
}

.wizard-avatar-tips {
  text-align: center;
  font-size: 13px;
  color: var(--ui-muted, #9ca3af);
  line-height: 1.8;
}

/* è¯çµ¡æ–¹å¼å€åŸŸ */
.wizard-contact-section {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.wizard-contact-item {
  display: flex;
  gap: 14px;
  align-items: flex-start;
}

.wizard-contact-icon {
  width: 40px;
  height: 40px;
  min-width: 40px;
  border-radius: 10px;
  background: var(--ui-btn-muted-bg, rgba(255,255,255,0.1));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
}

.wizard-contact-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

/* LINE å¼•å°å€åŸŸ */
.wizard-line-guide {
  background: var(--ui-btn-muted-bg, rgba(255,255,255,0.05));
  border-radius: 12px;
  padding: 14px;
  margin-top: 8px;
}

.wizard-line-guide-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--uvaco-green, #00c853);
  margin-bottom: 10px;
}

.wizard-line-steps {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.wizard-line-step {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 12px;
  color: var(--ui-text, #fff);
}

.wizard-line-step .step-num {
  width: 20px;
  height: 20px;
  min-width: 20px;
  border-radius: 50%;
  background: var(--uvaco-green, #00c853);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 700;
}

.wizard-line-example {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--ui-surface-border, rgba(255,255,255,0.1));
  font-size: 12px;
  color: var(--ui-muted, #9ca3af);
}

.wizard-line-example code {
  display: block;
  margin-top: 6px;
  padding: 8px 12px;
  background: rgba(0, 200, 83, 0.1);
  border-radius: 8px;
  color: var(--uvaco-green, #00c853);
  font-size: 12px;
  word-break: break-all;
}

/* ä¸»é¡Œé¸æ“‡å€åŸŸ */
.wizard-theme-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}

.wizard-theme-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  padding: 12px;
  border-radius: 12px;
  border: 2px solid transparent;
  background: var(--ui-btn-muted-bg, rgba(255,255,255,0.05));
  cursor: pointer;
  transition: all 0.2s;
}

.wizard-theme-item:hover {
  background: var(--ui-btn-muted-bg-hover, rgba(255,255,255,0.1));
}

.wizard-theme-item.active {
  border-color: var(--uvaco-green, #00c853);
  background: rgba(0, 200, 83, 0.1);
}

.wizard-theme-preview {
  width: 50px;
  height: 50px;
  border-radius: 10px;
}

.wizard-theme-item span {
  font-size: 11px;
  color: var(--ui-muted, #9ca3af);
}

.wizard-theme-item.active span {
  color: var(--uvaco-green, #00c853);
  font-weight: 600;
}

/* å®Œæˆå€åŸŸ */
.wizard-complete-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 24px;
}

.wizard-preview-card {
  background: var(--ui-btn-muted-bg, rgba(255,255,255,0.05));
  border-radius: 16px;
  padding: 24px;
  text-align: center;
  width: 100%;
  max-width: 280px;
}

.wizard-preview-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  overflow: hidden;
  margin: 0 auto 16px;
  border: 2px solid var(--uvaco-green, #00c853);
}

.wizard-preview-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.wizard-preview-name {
  font-size: 18px;
  font-weight: 700;
  color: var(--ui-text, #fff);
  margin-bottom: 4px;
}

.wizard-preview-title {
  font-size: 14px;
  color: var(--ui-muted, #9ca3af);
  margin-bottom: 12px;
}

.wizard-preview-contacts {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 8px;
}

.wizard-preview-contact-tag {
  padding: 4px 10px;
  background: rgba(0, 200, 83, 0.15);
  border-radius: 20px;
  font-size: 11px;
  color: var(--uvaco-green, #00c853);
}

.wizard-complete-tips {
  text-align: center;
  font-size: 13px;
  color: var(--ui-muted, #9ca3af);
  line-height: 1.8;
}

/* å°èˆªæŒ‰éˆ• */
.wizard-nav {
  display: flex;
  justify-content: space-between;
  gap: 12px;
  margin-top: 28px;
  padding-top: 20px;
  border-top: 1px solid var(--ui-surface-border, rgba(255,255,255,0.1));
}

.wizard-btn {
  padding: 14px 28px;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
}

.wizard-btn-prev {
  background: var(--ui-btn-muted-bg, rgba(255,255,255,0.1));
  color: var(--ui-text, #fff);
}

.wizard-btn-prev:hover {
  background: var(--ui-btn-muted-bg-hover, rgba(255,255,255,0.15));
}

.wizard-btn-next,
.wizard-btn-finish {
  background: var(--uvaco-green, #00c853);
  color: #fff;
  flex: 1;
}

.wizard-btn-next:hover,
.wizard-btn-finish:hover {
  filter: brightness(1.1);
  transform: translateY(-1px);
}

/* éŸ¿æ‡‰å¼èª¿æ•´ */
@media (max-width: 480px) {
  .wizard-container {
    padding: 20px 16px;
  }
  
  .wizard-step-label {
    display: none;
  }
  
  .wizard-progress-line {
    margin-bottom: 0;
  }
  
  .wizard-theme-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }
  
  .wizard-theme-item {
    padding: 8px;
  }
  
  .wizard-theme-preview {
    width: 40px;
    height: 40px;
  }
}
</style>

<script>
// ===== æ­¥é©Ÿå¼•å°ç²¾éˆ JavaScript =====
let wizardCurrentStep = 1;
const wizardTotalSteps = 5;
let wizardSelectedTheme = 1;

// é–‹å•Ÿç²¾éˆ
function showWizard() {
  const modal = document.getElementById('wizardModal');
  if (modal) {
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    wizardCurrentStep = 1;
    updateWizardUI();
  }
}

// é—œé–‰ç²¾éˆ
function closeWizard() {
  const modal = document.getElementById('wizardModal');
  if (modal) {
    modal.classList.remove('show');
    document.body.style.overflow = '';
  }
  // æ¨™è¨˜å·²å®Œæˆ onboarding
  try { localStorage.setItem('UVACO_ONBOARDED', '1'); } catch (e) {}
}

// æ›´æ–°ç²¾éˆ UI
function updateWizardUI() {
  // æ›´æ–°æ­¥é©Ÿé€²åº¦æŒ‡ç¤ºå™¨
  document.querySelectorAll('.wizard-progress-step').forEach(step => {
    const stepNum = parseInt(step.dataset.step);
    step.classList.remove('active', 'completed');
    if (stepNum < wizardCurrentStep) {
      step.classList.add('completed');
    } else if (stepNum === wizardCurrentStep) {
      step.classList.add('active');
    }
  });
  
  // æ›´æ–°æ­¥é©Ÿå…§å®¹
  document.querySelectorAll('.wizard-step').forEach(step => {
    const stepNum = parseInt(step.dataset.step);
    step.classList.remove('active');
    if (stepNum === wizardCurrentStep) {
      step.classList.add('active');
    }
  });
  
  // æ›´æ–°å°èˆªæŒ‰éˆ•
  const prevBtn = document.getElementById('wizardPrevBtn');
  const nextBtn = document.getElementById('wizardNextBtn');
  const finishBtn = document.getElementById('wizardFinishBtn');
  
  if (prevBtn) {
    prevBtn.style.visibility = wizardCurrentStep === 1 ? 'hidden' : 'visible';
  }
  
  if (nextBtn && finishBtn) {
    if (wizardCurrentStep === wizardTotalSteps) {
      nextBtn.style.display = 'none';
      finishBtn.style.display = 'block';
    } else {
      nextBtn.style.display = 'block';
      finishBtn.style.display = 'none';
    }
  }
  
  // å¦‚æœæ˜¯æœ€å¾Œä¸€æ­¥ï¼Œæ›´æ–°é è¦½
  if (wizardCurrentStep === wizardTotalSteps) {
    updateWizardPreview();
  }
}

// ä¸‹ä¸€æ­¥
function wizardNext() {
  if (!validateWizardStep(wizardCurrentStep)) return;
  
  if (wizardCurrentStep < wizardTotalSteps) {
    wizardCurrentStep++;
    updateWizardUI();
  }
}

// ä¸Šä¸€æ­¥
function wizardPrev() {
  if (wizardCurrentStep > 1) {
    wizardCurrentStep--;
    updateWizardUI();
  }
}

// é©—è­‰æ­¥é©Ÿ
function validateWizardStep(step) {
  const zhElements = document.querySelectorAll('.lang-zh');
  const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';
  
  if (step === 1) {
    const nameZh = document.getElementById('wizardNameZh')?.value?.trim();
    if (!nameZh) {
      alert(currentLang === 'zh' ? 'è«‹å¡«å¯«å§“å' : 'Please enter your name');
      document.getElementById('wizardNameZh')?.focus();
      return false;
    }
  }
  
  // å…¶ä»–æ­¥é©Ÿå¯é¸å¡«ï¼Œä¸å¼·åˆ¶é©—è­‰
  return true;
}

// é¸æ“‡é ­åƒ
function wizardSelectAvatar() {
  document.getElementById('wizardAvatarInput')?.click();
}

// è™•ç†é ­åƒä¸Šå‚³
function wizardHandleAvatarUpload(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = document.getElementById('wizardAvatarImg');
      const placeholder = document.getElementById('wizardAvatarPlaceholder');
      const overlay = document.querySelector('.wizard-avatar-overlay');
      if (img) {
        img.src = e.target.result;
        img.style.display = 'block';
      }
      if (placeholder) placeholder.style.display = 'none';
      if (overlay) overlay.style.display = 'flex';
    };
    reader.readAsDataURL(file);
  }
}

// é¸æ“‡ä¸»é¡Œ
function wizardSelectTheme(theme) {
  wizardSelectedTheme = theme;
  document.querySelectorAll('.wizard-theme-item').forEach(item => {
    item.classList.remove('active');
    if (parseInt(item.dataset.theme) === theme) {
      item.classList.add('active');
    }
  });
}

// æ›´æ–°é è¦½
function updateWizardPreview() {
  const nameZh = document.getElementById('wizardNameZh')?.value?.trim() || '';
  const titleZh = document.getElementById('wizardTitleZh')?.value?.trim() || '';
  const phone = document.getElementById('wizardPhone')?.value?.trim();
  const line = document.getElementById('wizardLine')?.value?.trim();
  const email = document.getElementById('wizardEmail')?.value?.trim();
  const avatarSrc = document.getElementById('wizardAvatarImg')?.src;
  
  // æ›´æ–°é è¦½å¡ç‰‡
  const previewName = document.getElementById('wizardPreviewName');
  const previewTitle = document.getElementById('wizardPreviewTitle');
  const previewAvatar = document.getElementById('wizardPreviewAvatar');
  const previewContacts = document.getElementById('wizardPreviewContacts');
  
  if (previewName) {
    previewName.textContent = nameZh || 'ï¼ˆå§“åï¼‰';
    previewName.style.color = nameZh ? '' : 'rgba(255,255,255,0.4)';
    previewName.style.fontStyle = nameZh ? '' : 'italic';
  }
  if (previewTitle) {
    previewTitle.textContent = titleZh || 'ï¼ˆè·ç¨±ï¼‰';
    previewTitle.style.color = titleZh ? '' : 'rgba(255,255,255,0.4)';
    previewTitle.style.fontStyle = titleZh ? '' : 'italic';
  }
  const previewAvatarPlaceholder = document.getElementById('wizardPreviewAvatarPlaceholder');
  if (previewAvatar && avatarSrc && avatarSrc !== window.location.href && !avatarSrc.endsWith('/')) {
    previewAvatar.src = avatarSrc;
    previewAvatar.style.display = 'block';
    if (previewAvatarPlaceholder) previewAvatarPlaceholder.style.display = 'none';
  } else {
    if (previewAvatar) previewAvatar.style.display = 'none';
    if (previewAvatarPlaceholder) previewAvatarPlaceholder.style.display = 'flex';
  }
  
  if (previewContacts) {
    let contactsHtml = '';
    if (phone) contactsHtml += '<span class="wizard-preview-contact-tag">ğŸ“ é›»è©±</span>';
    if (line) contactsHtml += '<span class="wizard-preview-contact-tag">ğŸ’¬ LINE</span>';
    if (email) contactsHtml += '<span class="wizard-preview-contact-tag">âœ‰ï¸ Email</span>';
    previewContacts.innerHTML = contactsHtml || '<span class="wizard-preview-contact-tag">å°šæœªè¨­å®šè¯çµ¡æ–¹å¼</span>';
  }
}

// å®Œæˆç²¾éˆ
function finishWizard() {
  // åŒæ­¥è³‡æ–™åˆ°åç‰‡ç·¨è¼¯å€
  syncWizardToCard();
  
  // é—œé–‰ç²¾éˆ
  closeWizard();
  
  // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
  const zhElements = document.querySelectorAll('.lang-zh');
  const currentLang = zhElements.length > 0 && zhElements[0].style.display !== 'none' ? 'zh' : 'en';
  
  alert(currentLang === 'zh' ? 
    'åç‰‡å»ºç«‹æˆåŠŸï¼æ‚¨å¯ä»¥ç¹¼çºŒç·¨è¼¯æˆ–ç›´æ¥å„²å­˜ã€‚' : 
    'Card created! You can continue editing or save directly.');
}

// åŒæ­¥ç²¾éˆè³‡æ–™åˆ°åç‰‡
function syncWizardToCard() {
  const nameZh = document.getElementById('wizardNameZh')?.value?.trim();
  const titleZh = document.getElementById('wizardTitleZh')?.value?.trim();
  const titleEn = document.getElementById('wizardTitleEn')?.value?.trim();
  const phone = document.getElementById('wizardPhone')?.value?.trim();
  const line = document.getElementById('wizardLine')?.value?.trim();
  const email = document.getElementById('wizardEmail')?.value?.trim();
  const avatarSrc = document.getElementById('wizardAvatarImg')?.src;
  
  // æ›´æ–°å§“å
  const previewNameZh = document.getElementById('previewNameZh');
  if (previewNameZh && nameZh) {
    previewNameZh.innerHTML = nameZh;
  }
  
  // æ›´æ–°è·ç¨±
  const previewTitleZh = document.getElementById('previewTitleZh');
  const previewTitleEn = document.getElementById('previewTitleEn');
  if (previewTitleZh && titleZh) previewTitleZh.textContent = titleZh;
  if (previewTitleEn && titleEn) previewTitleEn.textContent = titleEn;
  
  // æ›´æ–°é ­åƒ
  if (avatarSrc && avatarSrc !== window.location.href && !avatarSrc.endsWith('/')) {
    const previewAvatar = document.getElementById('previewAvatar');
    const avatarPlaceholder = document.getElementById('avatarPlaceholder');
    if (previewAvatar) {
      previewAvatar.src = avatarSrc;
      previewAvatar.style.display = 'block';
    }
    if (avatarPlaceholder) avatarPlaceholder.style.display = 'none';
  }
  
  // æ›´æ–°ä¸»é¡Œ
  if (wizardSelectedTheme && typeof setCardTheme === 'function') {
    setCardTheme(wizardSelectedTheme);
  }
  
  // æ·»åŠ è¯çµ¡æ–¹å¼
  const contacts = document.getElementById('previewContacts');
  if (contacts) {
    // é›»è©±
    if (phone) {
      const phoneLink = 'tel:' + phone.replace(/-/g, '');
      const phoneBtn = contacts.querySelector('a[href^="tel:"]');
      if (phoneBtn) {
        phoneBtn.href = phoneLink;
      } else {
        addContactButtonToPreview('call', phoneLink, '<img src="phone-icon.svg" alt="Phone" class="btn-icon-phone"> ç«‹å³ä¾†é›»', '<img src="phone-icon.svg" alt="Phone" class="btn-icon-phone"> Call Now');
      }
    }
    
    // LINE
    if (line) {
      let lineLink = line;
      // å¦‚æœæ²’æœ‰ http é–‹é ­ï¼Œå˜—è©¦è£œå…¨
      if (!lineLink.startsWith('http')) {
        lineLink = 'https://line.me/ti/p/' + line;
      }
      const lineBtn = contacts.querySelector('a[href*="line.me"]');
      if (lineBtn) {
        lineBtn.href = lineLink;
      } else {
        addContactButtonToPreview('line', lineLink, '<img src="line-logo.svg" alt="LINE" class="btn-icon-line"> LINE', '<img src="line-logo.svg" alt="LINE" class="btn-icon-line"> LINE');
      }
    }
    
    // Email
    if (email) {
      const emailLink = 'mailto:' + email;
      const emailBtn = contacts.querySelector('a[href^="mailto:"]');
      if (emailBtn) {
        emailBtn.href = emailLink;
      } else {
        addContactButtonToPreview('email', emailLink, '<img src="email-icon.svg" alt="Email" class="btn-icon-email"> å¯„é€ Email', '<img src="email-icon.svg" alt="Email" class="btn-icon-email"> Send Email');
      }
    }
  }
}

// ä¿®æ”¹ startOnboardingGuide å‡½æ•¸ï¼Œæ”¹ç‚ºå•Ÿå‹•æ­¥é©Ÿç²¾éˆ
const originalStartOnboardingGuide = typeof startOnboardingGuide === 'function' ? startOnboardingGuide : null;
function startOnboardingGuide() {
  // é—œé–‰åŸæœ‰çš„ onboarding modal
  closeOnboarding();
  // é–‹å•Ÿæ­¥é©Ÿç²¾éˆ
  showWizard();
}
</script>

</body>
</html>

